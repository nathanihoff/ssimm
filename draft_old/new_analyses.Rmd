---
output:
  bookdown::pdf_document2:
    toc: no
    number_sections: yes
    pandoc_args: !expr rmdfiltr::add_wordcount_filter(rmdfiltr::add_citeproc_filter(args = NULL))
    latex_engine: xelatex
    keep_tex: yes
    #template: svm-latex-ms.tex
# output: 
#   pdf_document:
#     citation_package: natbib
#     keep_tex: true
#     fig_caption: true
#     latex_engine: pdflatex
#     template: svm-latex-ms.tex
header-includes:
  # - \usepackage{setspace}\doublespace
  # - \usepackage{endnotes}
  #- \let\footnote=\endnote
  #- \usepackage{endfloat}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \setlength{\headheight}{13.6pt}
  - \rhead{\textit{Hoffmann and Velasco}}
  - \lhead{\textit{PAA 2021 Annual Meeting}}
  #- \lhead{\textit{`r format(Sys.time(), '%B %e, %Y')`}}
editor_options: 
  chunk_output_type: console
  
citeproc: no
fontfamily: mathpazo
fontsize: 11pt
geometry: margin=1in
indent: yes
link-citations: yes
linkcolor: blue
bibliography: zotero.bib  
csl: apa.csl


title: "Making Migration Sexy: How State and National Policies Influence Migration of Same-Sex Couples"
subtitle: "New Analyses"
date: "`r format(Sys.time(), '%B %e, %Y')`"
# author:
# - name: Nathan I. Hoffmann
#   affiliation: Department of Sociology, University of California, Los Angeles
# - name: Kristopher Velasco
#   affiliation: Department of Sociology, University of Texas at Austin
 
---

<!-- Turn off hyphenation -->
<!-- \usepackage[none]{hyphenat} -->


```{r setup, include=F}
knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = T, results = 'asis',
                      cache.lazy = F)

library(MASS)
library(janitor)
library(priceR)
library(kableExtra)
library(huxtable)
library(jtools)
library(sjstats)
library(imputeTS)
library(mvtnorm)
library(ordinal)
library(lme4)
library(countrycode)
library(knitr)
library(RColorBrewer)
library(haven)
library(cowplot)
library(srvyr)
library(lmtest)
library(sandwich)
library(here)
library(plm)
library(stargazer)
library(tidyverse)

# knitr::opts_chunk$set(error=TRUE) 

options("yaml.eval.expr" = TRUE)

# theme_set(theme_cowplot(font_family = 'Palatino') + 
theme_set(theme_classic(base_family = 'Palatino') + 
            theme(legend.title=element_blank(), 
                  panel.grid.major.y = element_line('grey80'),
                  legend.background = element_rect(fill = "transparent")))
ggplot <- function(...) ggplot2::ggplot(...) + scale_color_brewer(palette="Dark2") + 
  scale_fill_brewer(palette="Dark2")

options(scipen=1, digits=2)
knit_hooks$set(inline = function(x) {
  prettyNum(x, big.mark=",")
})
knitr::opts_chunk$set(error=TRUE) 


```

```{r load, include = F}

acs_wide <- read.csv(here('data', 'acs_wide.csv'))
acs_couple_policy <- readRDS(here('data', 'acs_couple_policy.rds'))
acs_prop_yrimmig_policy <- read.csv(here('data', 'acs_prop_yrimmig_policy.csv'))
acs_dyad_policy <- read.csv(here('data', 'acs_dyad_policy.csv'))

# acs_oneimm <- read.csv(here('data', 'acs_oneimm.csv'))
# acs_coupled_imms <- read.csv(here('data', 'acs_coupled_imms.csv'))
# acs_prop_yrimmig <- read.csv(here('data', 'acs_prop_yrimmig.csv'))
# acs_dyad <- read.csv(here('data', 'acs_dyad.csv'))


acs_wide_survey <- acs_wide %>% as_survey_design(ids = cluster, weights = hhwt)
acs_ind_survey <- acs_couple_policy %>% as_survey_design(ids = cluster, weights = perwt)

# Smaller dataset for initial ordered logit analyses
set.seed(1859)
acs_couple_policy_small <- bind_rows(
  filter(acs_couple_policy, same_sex == T, yrimmig >= 1991),
  sample_n(filter(acs_couple_policy, same_sex == F), 1e5)
)


```


## Model Results
### Country-of-Origin Effects
```{r country-props-mods}
# acs_prop_yrimmig_policy <- acs_prop_yrimmig_policy %>%
#   filter(yrimmig >= 1992)

# ag <- lm(I(log(n_same_sex+1)) ~ origin_score + I(log(n_total+1)), 
#          data = acs_prop_yrimmig_policy) 
# 
# 
# ag_country_orig <- lm(I(log(n_same_sex+1))  ~ distw + contig + comlang_off + comlang_ethno + colony +
#                    wage_dif + unemp_dif + polity5 + origin_score + stock_prop+ I(log(n_total+1)), 
#          data = acs_prop_yrimmig_policy)
# 
# ag_country_orig_fe <- lm(I(log(n_same_sex+1))  ~ distw + contig + comlang_off + comlang_ethno + colony +
#                    wage_dif + unemp_dif + polity5 + origin_score + stock_prop + bpld+ I(log(n_total+1)), 
#          data = acs_prop_yrimmig_policy)



ag <- lm(prop_same_sex ~ origin_score,
         data = acs_prop_yrimmig_policy)


ag_country_orig <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + polity5 + origin_score + stock_prop,
         data = acs_prop_yrimmig_policy)

ag_country_orig_fe <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + polity5 + origin_score + stock_prop + bpld,
         data = acs_prop_yrimmig_policy)



# Add binary indicator for post-2013
# ag_country_orig_2013 <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
#                    wage_dif + unemp_dif + polity5 + origin_score + stock_prop +
#                      post_2013,
#          data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))

ag_country_orig_fe_2013 <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + polity5 + origin_score + stock_prop + bpld +
                     post_2013,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))


ag_2013_int_fe <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + polity5  + stock_prop + bpld +
                     post_2013*origin_score,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))



```

Our first set of models predicts the percent of immigrants in same-sex couples by country of origin and year of immigration (Table \ref{tab:country-props}). Model 1 regresses this proportion on only our variable of interest, LGB policy score in country of origin. We see that countries with more progressive LGB policies tend to send more immigrants to the U.S. who end up in same-sex couples. The average country-level proportion of immigrants in same-sex couples is only `r mean(acs_prop_yrimmig_policy$prop_same_sex, na.rm = T)` percent, so an increase of `r coef(ag)[[2]]` percent per point increase in LGB policy score represents a substantive effect.  

Models 2 and 3 in Table \ref{tab:country-props} assess the robustness of this finding. Model 2 includes controls from gravity models, including economic differentials, distance, immigrant networks, and democracy. The coefficient for country-of-origin score reduces slightly but remains highly significant. Notably, it is estimated to be more than twice the effect size of the score for democracy; the LGB policy environment matters much more than the overall progressiveness of government policy. Model 3 adds country-of-origin fixed effects. Although in this model coefficient for origin score is reduced by half compared to Model 1, it remains statistically significant.


```{r country-props}
se_list <- list()
mod_list <- list(ag, ag_country_orig, ag_country_orig_fe,
                 ag_country_orig_fe_2013, ag_2013_int_fe)
for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], cluster = c("bpld")))[, 2]
}


stargazer(mod_list,
          header = F,
          model.names = F,
          keep = c('origin_score', 'polity5', 'post_2013'),
          order = paste0("^", c('origin_score', 'polity5', 'post_2013TRUE', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('Country LGB policy score', 'Polity5 democracy score',
                                'Post-2013', 'Country score × Post-2013'),
          dep.var.labels   = "Percent in same-sex couples by country-year",
          add.lines = list(c('Country controls?', 'no', rep('yes', 4)),
                           c('Country FEs?', 'no', 'no', rep('yes', 3))),
          se = se_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("Note: †p<0.1; *p<0.05; **p<0.01; ***p<0.001",
                    "Source: American Community Survey 2008-2019"),
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          label = 'tab:country-props',
          title = 'OLS regressions of percent of immigrants in same-sex couples by year of immigration and country of origin. Country-clustered standard errors shown in parentheses. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.')


# mod_list <- list(ag, ag_country_orig, ag_country_orig_fe, 
#                  ag_country_orig_fe_2013, ag_2013_int_fe, ag_2013_spouse_int)
# for(mod_num in 1:length(mod_list)){
#   mod_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], cluster = c("bpld")))
# }
# 
# keep_coefs <- c('Country LGB policy score' = 'origin_score', 
#                 'Polity5 democratization' = 'polity5', 
#                 'Post-2013' = 'post_2013TRUE', 
#                 'Country score × Post-2013' = 'post_2013TRUE:origin_score')
#    
# 
# export_summs(mod_list,
#        coefs = keep_coefs,
#        statistics = c('N' = 'nobs'),
#        stars = c(`†`= 0.1, `*`= 0.05, `**` = 0.01, `***` = 0.001),
#        note = '{stars}. 
#                Source: American Community Survey 2008-2019') %>%
#   set_caption('OLS regressions of percent of immigrants in same-sex couples by year of immigration and country of origin. Country-clustered standard errors shown in parentheses. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.') %>%
#   add_rows(matrix(c('Country controls?', 'no', rep('yes', 5),
#                 'Country FEs?', 'no', 'no', rep('yes', 4)),
#            byrow = T, nrow = 2) , 
#            after = nrow(.) - 1)

```


Models 4 and 5 assess how the 2013 Supreme Court decision striking down DOMA figures into these processes. Model 4 is the same as Model 3, but with a dichotomous "Post-2013" variable added. The influence of sending-country policy loses its significance in this model: 2013 was a significant turning point for LGB immigrants to the U.S., with the average representation from a given country growing by a quarter of a percent. Model 5 adds an interaction between sending-country LGB policy score and the post-2013 dichotomous variable. This variable is significant and positive, while the other variables of interest lose significance. Sending-country policy and the post-2013 era both matter, but solely in tandem: Only LGB immigrants from progressive countries see a boost in representation after the DOMA decision.^[The Supplementary Material also includes a model with only married couples and one with only couples that include one immigrant and one U.S.-born citizen. Results are nearly identical to models fit to the full sample.]  

<!-- Finally, Model 6 restricts the sample to only married same-sex couples. Since the DOMA decision permitted visa sponsorship for same-sex spouses, we would expect to see the greatest discontinuity pre- and post-2013 for this sub-population. Indeed, for immigrants married to same-sex spouses the post-2013 variable, and its interaction with sending-country policy score, are both significant and positive. Although before 2013 progressive countries did not send more same-sex married couples, after 2013 these numbers grew sharply, and more progressive countries received an extra boost.  -->


```{r state-props}
state_prop <- lm(same_prop ~ state_policy, data = acs_dyad_policy)

state_prop2 <- lm(same_prop ~ origin_score + state_policy, data = acs_dyad_policy)

state_prop_fe <- lm(same_prop ~ state_unemploy + state_income + state + 
                        origin_score + state_policy, 
                       data = acs_dyad_policy)

state_prop_fe2 <- lm(same_prop ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + polity5 + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_dyad_policy)

state_prop_2013 <- lm(same_prop ~ post_2013 + state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + polity5 + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013)))

state_prop_2013_int <- lm(same_prop ~ post_2013*origin_score + state_policy + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + polity5 + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013)))

# state_prop_2013 <- lm(same_prop ~ post_2013*(state_policy + origin_score), 
#                        data = mutate(acs_dyad_policy, post_2013 = (year > 2013)))
# state_prop_2013_2 <- lm(same_prop ~ post_2013*(state_policy + origin_score) + distw + contig + 
#                           comlang_off + comlang_ethno + colony +
#                           wage_dif + unemp_dif + polity5 + 
#                            state_unemploy + state_income + Country + state, 
#                        data = mutate(acs_dyad_policy, post_2013 = (year > 2013)))

se_list <- list()
mod_list <- list(state_prop, state_prop2, state_prop_fe, state_prop_fe2, 
                 state_prop_2013, state_prop_2013_int)

for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], cluster = c("state")))[, 2]
}


stargazer(mod_list,
          header = F, 
          keep = c('origin_score', 'state_policy', 'post_2013'),
          # omit = c('Country', 'state'),
          order = paste0("^", c('state_policy', 'origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('State LGB policy score', 'Country LGB policy score',
                                'Post-2013', 'Country score × Post-2013'),
          dep.var.labels = "Percent in same-sex couples by state-country-year",
          add.lines = list(c('State controls and FEs?', 'no', 'no', rep('yes', 4)),
                           c('Country controls and FEs?', rep('no', 3), rep('yes', 3))),
          se = se_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("Note: †p<0.1; *p<0.05; **p<0.01; ***p<0.001", 
                    "Source: American Community Survey 2008-2019"), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          label = 'tab:state-props',
          title = 'Percent same-sex in by country of origin, U.S. state, and survey year. Country-clustered standard errors are shown in parentheses. State controls include unemployment rate and per-capita income. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.')

origin_effect <- sd(acs_couple_policy$origin_score, na.rm = T)*coef(state_prop2)[['origin_score']]
state_effect <- sd(acs_couple_policy$state_policy, na.rm = T)*coef(state_prop2)[['state_policy']]

```

### State Effects
We next turn to the effects of U.S. state LGB policy. Table \ref{tab:state-props} presents models of U.S. state-level proportion of immigrants in same-sex couples, from a given country of origin in a given survey year. Model 1 contains only one predictor: U.S. state policy score in the survey year. We see that, on average, states with more friendly LGB policies have somewhat higher proportions of immigrants in same-sex couples. Model 2 adds a predictor for country-of-origin policy score at the mean year of immigration. Although the coefficient for country of origin score is more precisely estimated, the two variables have effects of roughly equal size. A one-standard deviation (`r sd(acs_couple_policy$origin_score, na.rm = T)`-point) increase origin score is associated with a `r origin_effect` percentage-point increase of immigrants in same-sex couples, whereas the corresponding state policy standard deviation increase of `r sd(acs_couple_policy$state_policy, na.rm = T)` points is `r state_effect` percentage points.   

<!-- Although more LGB-friendly policies in both locations are associated with higher numbers of immigrants in same-sex couples, country-of-origin LGB policy is a stronger predictor than U.S. state policy, even considering the somewhat different scale of these variables.    -->

According to the descriptive analysis above, immigrants in same-sex couples tend to have higher incomes and hold more prestigious occupations than immigrants in different-sex couples. This implies that immigrants in same-sex couples may be attracted to progressive states for their economic rather than political benefits, so Model 3 adds state-level controls and fixed effects. Indeed, in this model, the coefficient for state policy is reduced and rendered insignificant. Model 4 adds country-of-origin controls and fixed effects. The state policy effect remains imprecisely estimated, but country-of-origin policy has increased in strength. More progressive sending countries are represented by greater proportions of same-sex couples, while U.S. state policy appears to have little influence on their settlement patterns, at least in the aggregate.  

Model 5 includes a dichotomous variable for the post-2013 DOMA decision era, and Model 6 interacts this with sending-country score. Unlike for the country-level models in Table \ref{tab:country-props}, both the time variable and its interaction remain significant in the final model. After 2013, the proportion of immigrants in same-sex couples increased within states, but this was especially true for immigrants from more progressive countries.

### Individual Analysis
```{r ord-1}

ord_basic <- polr(state_policy_binned ~ same_sex + as.factor(year),
                data = acs_couple_policy_small, Hess = T)
ord_orig <- polr(state_policy_binned ~ same_sex*origin_score + as.factor(year),
                data = acs_couple_policy_small, Hess = T)
ord_interact <- polr(state_policy_binned ~ 
                       same_sex*(origin_score + gender + age + educ + 
                   nchild + log_income + no_income + yrimmig) + as.factor(year),
                data = rename(acs_couple_policy_small, gender = sex), Hess = T)

# ord_interact_controls <- polr(state_policy_binned ~ same_sex*origin_score + gender + age + educ +
#                      nchild + log_income + no_income + yrimmig + as.factor(year) +
#                      # distw + contig + comlang_off + comlang_ethno +
#                      # wage_dif + unemp_dif + polity5 + stock_prop + bpld +
#                      state_unemploy + state_income +state,
#                 data = rename(acs_couple_policy_small, gender = sex), Hess = T)
#
# ols_interact_controls <- lm(state_policy ~ same_sex*origin_score + gender + age + educ +
#                      nchild + log_income + no_income + yrimmig + as.factor(year) +
#                      # distw + contig + comlang_off + comlang_ethno +
#                      # wage_dif + unemp_dif + polity5 + stock_prop +
#                      state_unemploy + state_income + state,
#                 data = rename(acs_couple_policy, gender = sex))

se_list <- list()
mod_list <- list(ord_basic, ord_orig, ord_interact)
for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], 
                                     cluster = c('bpld', 'state')))[, 2]
}


newdat <- data.frame(same_sex = rep(c(F, T), 12), year = rep(2008:2019, each = 2))
ord_probs <- cbind(newdat,
      predict(ord_basic, 
        newdat,
        type = 'probs')) %>%
  group_by(same_sex) %>%
  summarize(Repressive = mean(Repressive),
            Neutral = mean(Neutral),
            Progressive = mean(Progressive)) 

```


Our final set of models focuses on the individual. Conditional on migrating to the U.S., do immigrants in same-sex couples choose to live in more progressive states than their heterosexual counterparts? Table \ref{tab:ord} presents ordered logit models predicting whether an individual partnered immigrant lives in a U.S. state with repressive, neutral, or progressive LGB policies, pooling data across survey years. Model 1 includes only one regressor: an indicator for whether the immigrant is in a same-sex couple. The positive coefficient indicates that immigrants in same-sex couples indeed tend to live in states with more LGB-friendly policies. The predicted probability for an immigrant in a different-sex couple to live in a state with progressive LGB policies is `r ord_probs[[1, 'Progressive']]`, whereas the corresponding probability for those in same-sex couples is `r ord_probs[[2, 'Progressive']]`. At the repressive end of the policy spectrum, the predicted probabilities are `r ord_probs[[1, 'Repressive']]` and `r ord_probs[[2, 'Repressive']]` for different- and same-sex couples, respectively.  

How does country-of-origin context mediate this results? Model 2 adds sending-country LGB policy score at the time of immigration to the regression, interacting it with the same-sex indicator. The coefficient for the same-sex indicator remains positive and significant, but we see opposite effects of the origin-score coefficient for immigrants in different- and same-sex couples. For different-sex couples, hailing from a more progressive country is associated with living in a more repressive U.S. state. For same-sex couples, the result is in the opposite direction: those from progressive countries tend to live in more progressive U.S. states.  

Model 3 controls for possible individual confounders, interacting them with the same-sex indicator. If immigrants in same-sex couples also tend to have more education, higher income, different family structures, or less years of age, they may be choosing more progressive states due to other policies or economic conditions. As shown in Table \ref{tab:ord}, our variables of interest remain strong and in the same directions in this final model.  

```{r ord, results = 'asis'}

stargazer(mod_list,
          header = F, 
          add.lines = list(c('Survey year FEs?', rep('yes', 3)),
                           c('Individual controls?', 'no', 'no', 'yes')),
          se = se_list,
          omit = c('gender', 'age', 'educ', 'nchild', 'log_income', 'no_income', 
                   'yrimmig', 'Constant', 'year'),
                   # 'distw', 'contig', 'comlang_off', 'comlang_ethno', 
                   #  'wage_dif', 'unemp_dif', 'polity5', 'stock_prop', 
                   #   'state_unemploy', 'state_income', 'state'),
          dep.var.labels = c("Binned state LGB policy score"),
          covariate.labels = c('Same-sex', 'Country LGB policy score', 
                               'Same-sex × country score'),
          keep.stat = 'n',
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("Note: †p<0.1; *p<0.05; **p<0.01; ***p<0.001", 
                    "Source: American Community Survey 2008-2019"), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          #no.space = T,
          label = 'tab:ord',
          title = 'Individual ordered logit analysis of three-category state policy score. Country-clustered standard errors are shown in parentheses. Individual controls include sex, age, education, number of children, log(income), indicator for no income, and year of immigration, which are all interacted with the indicator for same-sex couple.')
```


```{r sim1, eval = F}

## Simulation
set.seed(185)
sims <- 250
sim <- list()
sim_mod <- list(sims)
pseudeo_mod <- ord_interact
k <- length(coef(ord_interact))
theta_mat <- rmvnorm(sims, mean=c(coef(ord_interact), ord_interact$zeta),
                              sigma=vcovCL(ord_interact, cluster = ~ bpld))

var <- 'origin_score'

for (i in 1:sims) {
  if(i %% 10 == 0) print(i)
  theta <- as.numeric(theta_mat[i,])
  pseudeo_mod$coefficients <- theta[1:k]
  pseudeo_mod$zeta <- theta[(k+1):length(theta)]

  for(same_loop in unique(acs_couple_policy_small$same_sex)){
      var_vals <- seq(min(acs_couple_policy_small[,var]), 
                      max(acs_couple_policy_small[,var]), 
                      length.out = 10)
      for(val in var_vals){
          sim_dat <- acs_couple_policy_small %>%
            rename(gender = sex) %>%
            select(all.vars(formula(ord_interact)))
          sim_dat[, 'same_sex'] <- same_loop
          sim_dat[, var] <- val

          pred_dat <- predict(pseudeo_mod, newdata = sim_dat, type = 'probs')
          # pred_dat <- data.frame(t(apply(pred_dat, 2, mean))) %>%
          #   pivot_longer(cols = everything(), names_to = 'state_policy', values_to = 'fit')
          
         sim[[paste0(var,same_loop, val, i)]] <-
          data.frame(t(apply(pred_dat, 2, mean)),
                            same_sex = same_loop,
                            # variable = var,
                            origin_score = val)
      }
  }
}

sim_df <- bind_rows(sim) %>%
  pivot_longer(1:3, names_to = 'state_policy', values_to = 'fit') %>%
  group_by(same_sex, origin_score, state_policy) %>%
  summarize(fit.low = quantile(fit, .025), fit.high = quantile(fit, .975), fit = mean(fit))

write_csv(sim_df, here('draft', 'sim_df.csv'))
```

```{r sim, fig.cap = 'Predicted probabilities of U.S. state LGB policy progressiveness for individual immigrants in different- and same-sex couples, based on policy score of sending country, with 95% confidence intervals.'}
# Mode <- function(x) {
#   ux <- unique(x)
#   ux[which.max(tabulate(match(x, ux)))]
# }
# 
# acs.means <- acs_couple_policy %>% 
#   summarize(across(c(age, origin_score, yrimmig, nchild, log_income), mean, na.rm = T))
# acs.modes <- acs_couple_policy %>% 
#   rename(gender = sex) %>%
#   summarize(across(c(educ, no_income, gender), Mode))
# 
# #Make a dataframe that's the mode of the factor variables vs. mean - one row data frame
# #Two dataframes, one for same-sex and one for not. And then make two plots.
# plot.dat <- bind_rows(rep(list(bind_cols(acs.means, acs.modes)),14)) %>%
#   mutate(origin_score = -3:10, year = 2014)
# 
# plot.dat.same <- plot.dat %>%
#   mutate(same_sex = T)
# plot.dat.dif <- plot.dat %>%
#   mutate(same_sex = F)
# 
# # Confidence intervals
# set.seed(1858)
# sims <- 500
# sim_mod <- list(sims)
# pseudeo_mod <- ord_interact
# k <- length(coef(ord_interact))
# theta_mat <- rmvnorm(sims, mean=c(coef(ord_interact), ord_interact$zeta),
#                               sigma=vcovCL(ord_interact, cluster = ~ bpld))
# 
# for (i in 1:sims) {
#   theta <- as.numeric(theta_mat[i,])
#   pseudeo_mod$coefficients <- theta[1:k]
#   pseudeo_mod$zeta <- theta[(k+1):length(theta)]
#   sim_mod[[i]] <- as.data.frame(cbind(i,-3:10, predict(pseudeo_mod, 
#                                    newdata=plot.dat.same, type="probs")))
#   names(sim_mod[[i]]) <- c("iter","origin_score", names(sim_mod[[i]])[3:5]) 
# }
# sim_mod_same <- bind_rows(sim_mod) %>%
#   pivot_longer(3:5, names_to = 'state_policy_binned', values_to = 'phat') %>%
#   #gather(state_policy_binned, phat, -iter, -origin_score) %>%
#   group_by(origin_score, state_policy_binned) %>%
#   dplyr::summarize(phat.se = sd(phat),
#                    phat.mean = mean(phat),
#                    phat.lo = phat.mean - 1.96*phat.se,
#                    phat.hi = phat.mean + 1.96*phat.se) %>%
#   mutate(same_sex = 'Same-Sex')
# 
# 
# sims <- 250
# sim_mod <- list(sims)
# pseudeo_mod <- ord_interact
# k <- length(coef(ord_interact))
# theta_mat <- rmvnorm(sims, mean=c(coef(ord_interact), ord_interact$zeta),
#                               sigma=vcovCL(ord_interact, cluster = ~ bpld))
# 
# for (i in 1:sims) {
#   theta <- as.numeric(theta_mat[i,])
#   pseudeo_mod$coefficients <- theta[1:k]
#   pseudeo_mod$zeta <- theta[(k+1):length(theta)]
#   sim_mod[[i]] <- as.data.frame(cbind(i,-3:10, predict(pseudeo_mod, 
#                                    newdata=plot.dat.dif, type="probs")))
#   names(sim_mod[[i]]) <- c("iter","origin_score", names(sim_mod[[i]])[3:5]) 
# }
# sim_mod_dif<- bind_rows(sim_mod) %>%
#   pivot_longer(3:5, names_to = 'state_policy_binned', values_to = 'phat') %>%
#   #gather(state_policy_binned, phat, -iter, -origin_score) %>%
#   group_by(origin_score, state_policy_binned) %>%
#   dplyr::summarize(phat.se = sd(phat),
#                    phat.mean = mean(phat),
#                    phat.lo = phat.mean - 1.96*phat.se,
#                    phat.hi = phat.mean + 1.96*phat.se) %>%
#   mutate(same_sex = 'Different-Sex')
# 
# sim_df <- bind_rows(sim_mod_same, sim_mod_dif)
# 
# sim_df %>%
#   ggplot(aes(x=origin_score, y=phat.mean, col=state_policy_binned)) +
#   geom_line() + 
#   geom_ribbon(aes(ymin=phat.lo, ymax=phat.hi, 
#                   fill = state_policy_binned, col = NULL), alpha = .2) +
#   facet_wrap(~same_sex) +
#   xlab('LGB policy score for country of origin') +
#   ylab('Predicted probability of U.S. state residence') +
#   theme(legend.justification=c(1,0),
#         legend.position=c(.95,.38))


sim_df <- read_csv(here('draft', 'sim_df.csv')) %>%
    mutate(same_sex = case_when(same_sex == T ~ 'Same-sex',
                                same_sex == F ~ 'Different-sex'))


sim_df %>%
  ggplot(aes(x=origin_score, y=fit, col=state_policy)) +
  geom_line() + 
  geom_ribbon(aes(ymin=fit.low, ymax=fit.high, 
                  fill = state_policy, col = NULL), alpha = .2) +
  facet_wrap(~same_sex) +
  xlab('LGB policy score for country of origin') +
  ylab('Predicted probability of U.S. state residence') +
  theme(legend.justification=c(1,0),
        legend.position=c(.95,.38))

orig_max <- max(sim_df$origin_score)
same_pred <- filter(sim_df, same_sex == 'Same-sex', origin_score == orig_max, 
       state_policy == 'Progressive') %>% 
  pull(fit)

dif_pred <- filter(sim_df, same_sex == 'Different-sex', origin_score == orig_max, 
       state_policy == 'Progressive') %>% 
  pull(fit)

same_pred2 <- filter(sim_df, same_sex == 'Same-sex', origin_score == orig_max, 
       state_policy == 'Repressive') %>% 
  pull(fit)

dif_pred2 <- filter(sim_df, same_sex == 'Different-sex', origin_score == orig_max, 
       state_policy == 'Repressive') %>% 
  pull(fit)
```

To help interpret these results, Figure \ref{fig:sim} contains predicted probabilities of residing in progressive, neutral, or repressive U.S. states. For each of 250 simulations, the coefficients are drawn from this covariance matrix as estimated in Model 3 in Table \@ref(tab:ord). These are used to predict the probability of being in each type of state for each member in the complete dataset, with their couple type set to same- or different-sex and their origin score varied from the minimum to maximum. The predicted probabilities are are averaged across the entire dataset for each of these manipulated values. After 250 simulations, the distribution of predicted values is used to find means and 95-percent confidence intervals. The only difference between the two panels is the value for the same-sex indicator in the simulations.  

The figure shows opposite trends for same- and different-sex couples. Overall, immigrants tend to live in more progressive states, but the moderating effect of origin score is quite different for the two groups. The panel for same-sex couples shows that these immigrants tend to live in U.S. states with similar LGB policy contexts to those of their countries of origin. Immigrants in same-sex couples from repressive countries are less likely to live in progressive U.S. states, but as the origin-country score increases, so does the probability of living in a progressive state. For immigrants in different-sex couples, on the other hand, increasingly progressive country-of-origin policies are associated with a *lower* probability of residing in a progressive U.S. state, accompanied by a *higher* probability of living in a repressive U.S. state. At the high end of the origin-score policy range, the difference in predicted probabilities is significant: Typical immigrants in same-sex couples are `r 100*(same_pred - dif_pred)` percentage points more likely to live in progressive states and  `r 100*(dif_pred2 - same_pred2)` percentage points less likely to live in repressive states than similar immigrants in different-sex couples. Though the pattern for same-sex couples is understandable and expected, the lower probabilities for different-sex couples raises important questions. Regardless, these results demonstrate that sexuality, and the governance of it, influences migration patters for those in both same-sex and different-sex relationships.

# Discussion
In 2013, there were `r round(same_2013 /1e3, 1)` thousand same-sex couples that included immigrants in the U.S. By 2019, this number had nearly doubled to `r round(same_2019 /1e3, 1)` thousand. Despite this expansive growth of same-sex immigrant couples in the U.S. far outpacing overall migration rates, there is little demographic research understanding the characteristics of these couples or the factors influencing their migratory patterns. The research on queer migrants that does exist is largely qualitative and focused on asylum claims. Consequently, we know little about who these migrants are, why they are choosing to leave their home countries, or where they are choosing to locate once in the U.S. Answering these questions is important, not just because this represents an increasing number of border crossers, but because this process has the potential to reshape our conceptualization of who immigrants are, their motivations for moving, and how policy apparently unrelated to migration can shape the aspirations and capacities of would-be migrants [@dehaas_2021].  

The rising number of same-sex immigrant couples has coincided with a dramatic change in policy environments governing LGB communities, both within the U.S. and abroad. Thanks to the 2013 DOMA Supreme Court case, same-sex couples now have a broader legal pathway into the U.S. [@edwards_2013]. Therefore, although there are numerous perspectives to take in understanding the migratory patterns of these couples, this project investigates how changing LGB policies at both country of origin and residing U.S. state pattern these migratory pathways. Engaging in such a question adds to emerging scholarship trying to understand how dramatic policy changes are influencing the health, well-being, and lifestyles of LGB people while also recognizing that these policies differentially impact people within this broad umbrella based on different social positions [@boertien_2019; @carpenter_2020; @kail_2015; @levy_2017]. Moreover, this project helps address an important gap within migration studies, a field that too often discounts the role of the state and the salience of sexuality in conditioning migratory patterns [@carrillo_2018; @fitzgerald_2014].  

To answer our questions, we take advantage of an underutilized data source: self-reports of same-sex immigrant couples in the American Community Survey from 2008 to 2019. Despite this resource being one of the few national surveys to identify same-sex immigrant couples, these data are virtually untapped for this purpose. In light of possible reporting issues with these data [@gates_2013; @goodnature_2021], in the Supplemental Material we probe the sensitivity of our findings only to find remarkable robustness to high levels of misreporting. As such, these data allow for us to make one of the first large-$N$ investigations of same-sex immigrant couples within the U.S. and to make an important addition to this area of scholarship, even descriptively.  

Using these data, we make a number of findings worth detailing. First, existing scholarship on same-sex immigrant couples, and queer migration more broadly, largely focuses on the asylum and refugee processes [@luibheid_2008; @vogler_2016]. This is because this was one of the only mechanisms for getting into the U.S. [@humanrightswatch_2006]. Furthermore, even research on non-refugee LGB immigrants tends to select cases from relatively repressive contexts [@cantu_2009; @carrillo_2018]. Consequently, this over-representation distorts our understanding of who same-sex immigrant couples are, the types of environments they are leaving, and their motivations to seek entry into the U.S. Indeed, when comparing the demographics of same-sex immigrant couples to different-sex immigrant couples, we find same-sex couples generally have higher incomes and occupational prestige and are somewhat more educated. Understanding this profile alone is an important insight as it reveals that these communities are of privileged social standing. This is a corrective to the queer migration literature that has yet to highlight this profile. 

Understanding who these migrants are, how do LGB policies in their countries-of-origin influence their desires to come to the U.S.? Despite existing scholarship portraying a story of LGB couples fleeing repression, as necessary for refugee claims, LGB couples are leaving countries with more progressive policy environments. As results in Table \ref{tab:country-props} and trendlines in Figure \ref{fig:policy-desc} reveal, couples are coming from more open environments. This is true even after accounting for traditional gravity model explanations that primarily focus on economic costs and benefits and established sociological determinants like networks and cultural proximity. Though more research is needed, these results, in conjunction with the fact that these same-sex couples achieve higher incomes and greater occupational prestige, describe a situation in which perhaps it is a supportive policy environment, such as employment protections, access to the material benefits of marriage, and so forth, that enable same-sex couples to achieve greater social standing and the resources necessary to migrate. Or, instead of the immediate benefits of the policy itself, these supportive environments may simply encourage LGB people to feel comfortable openly identifying as being in a relationship when responding to surveys. Regardless, it appears that same-sex couples are more apt to follow the lifestyle migration pathways and motivations when coming to the U.S. as opposed to explicitly trying to leave more repressive contexts in hopes of living more open lives.    

One unexpected finding is that different-sex couples from more LGB-friendly countries are likelier to reside in states with increasingly less LGB-friendly policies. These patterns in Figure \ref{fig:sim} are peculiar because we suspected that state LGB policies to have no association with how different-sex couples are making decisions as to where to reside. This is not the case. One immediate question this raises is if this is a case of “straight flight.” White flight is a well-research process in which white people leave diversifying communities. After straight couples experience liberalized conditions for gay couples, do they intentionally seek to leave such conditions by moving to states that are less supportive? Alternatively, it may be that the economic and social forces pulling different-sex immigrants to these particular states may spuriously be associated with less progressive LGB policies. More research is needed to understand this interesting pattern.  

Recent research has argued that sexuality is a salient factor determining immigration decisions. We show that differences between immigrants in same-sex couples and those in different-sex couples cannot be explained solely using classic theories of migration; policy context and sexuality interact in complicated ways to shape migratory flows. Though our primary focus is on same-sex couples, this study contributes toward the broader literature offering a correction to standard models of migration. Lifestyle migration is often used to describe affluent people moving in search of a better way of life [@benson_2009]. But what the present scholarship contributes is that sexuality shapes how that "better way of life" is conceptualized and motivated, contributing toward our understanding these dynamics [@dixon_2020]. The present findings raise additional questions as to how sexuality motivates migration patterns and are (in)directly influencing seemingly economic or networked dynamics, even for heterosexual couples. Finally, to borrow the line from Theda Skocpol, we are "bringing the state back in" [@skocpol_1985]. Typically, state policies are less integrated within models of migration. When they are, the policies under examination are usually those specific to migration. But what this study demonstrates is that, for same-sex couples, once the legal opening to migration occurred after the DOMA ruling, it was policy specific to LGB issues, rather than just migration, that influenced their "push" to the U.S. This opens up questions as to how state policies relative to a particular group, but not explicitly in the domain of immigration, create structural conditions for which some communities choose to leave their home country. This points to the importance of further studying identity, and the state's governance of it, in migratory processes.


# References
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\noindent


