---
output:
  bookdown::pdf_document2:
    toc: yes
    number_sections: yes
    pandoc_args: !expr rmdfiltr::add_wordcount_filter(rmdfiltr::add_citeproc_filter(args = NULL))
    latex_engine: xelatex
    keep_tex: yes
    #template: svm-latex-ms.tex
# output: 
#   pdf_document:
#     citation_package: natbib
#     keep_tex: true
#     fig_caption: true
#     latex_engine: pdflatex
#     template: svm-latex-ms.tex
header-includes:
  # - \usepackage{setspace}\doublespace
  # - \usepackage{endnotes}
  #- \let\footnote=\endnote
  #- \usepackage{endfloat}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \setlength{\headheight}{13.6pt}
  - \rhead{\textit{Hoffmann and Velasco}}
editor_options: 
  
  chunk_output_type: console
citeproc: no
fontfamily: mathpazo
fontsize: 11pt
geometry: margin=1in
indent: yes
link-citations: yes
linkcolor: blue
bibliography: zotero.bib  
csl: apa.csl
title: "Supplementary Material"
subtitle: "Making Migration Sexy"
date: "`r format(Sys.time(), '%B %e, %Y')`"
# author:
# - name: Nathan I. Hoffmann
#   affiliation: Department of Sociology, University of California, Los Angeles
# - name: Kristopher Velasco
#   affiliation: Department of Sociology, University of Texas at Austin
 
author:
- Nathan I. Hoffmann, Department of Sociology, University of California, Los Angeles
- Kristopher Velasco, Department of Sociology, Princeton University
---

<!-- Turn off hyphenation -->
<!-- \usepackage[none]{hyphenat} -->


```{r setup, include=F}
knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = T, results = 'asis',
                      cache.lazy = F)


library(janitor)
library(priceR)
library(kableExtra)
library(sjstats)
library(imputeTS)
library(mvtnorm)
library(ordinal)
library(lme4)
library(MASS)
library(countrycode)
library(knitr)
library(RColorBrewer)
library(haven)
library(cowplot)
library(srvyr)
library(lmtest)
library(sandwich)
library(here)
library(plm)
library(patchwork)
library(stargazer)
library(gtsummary)
library(tidyverse)

# knitr::opts_chunk$set(error=TRUE) 

options("yaml.eval.expr" = TRUE)

# theme_set(theme_cowplot(font_family = 'Palatino') + 
theme_set(theme_classic(base_family = 'Palatino') + 
            theme(legend.title=element_blank(), 
                  panel.grid.major.y = element_line('grey80'),
                  legend.background = element_rect(fill = "transparent")))
ggplot <- function(...) ggplot2::ggplot(...) + scale_color_brewer(palette="Dark2") + 
  scale_fill_brewer(palette="Dark2")

options(scipen=1, digits=2)
knit_hooks$set(inline = function(x) {
  prettyNum(x, big.mark=",")
})
knitr::opts_chunk$set(error=TRUE) 


```

```{r load, include = F}
acs_wide <- read.csv(here('data', 'acs_wide.csv'))
acs_couple_policy <- readRDS(here('data', 'acs_couple_policy.rds'))
acs_prop_yrimmig_policy <- read.csv(here('data', 'acs_prop_yrimmig_policy.csv'))
acs_dyad_policy <- read.csv(here('data', 'acs_dyad_policy.csv'))

# acs_oneimm <- read.csv(here('data', 'acs_oneimm.csv'))
# acs_coupled_imms <- read.csv(here('data', 'acs_coupled_imms.csv'))
# acs_prop_yrimmig <- read.csv(here('data', 'acs_prop_yrimmig.csv'))
# acs_dyad <- read.csv(here('data', 'acs_dyad.csv'))




acs_wide_survey <- acs_wide %>% as_survey_design(ids = cluster, weights = hhwt)
acs_ind_survey <- acs_couple_policy %>% as_survey_design(ids = cluster, weights = perwt)


# Smaller dataset for initial ordered logit analyses
set.seed(1859)
acs_couple_policy_small <- bind_rows(
  filter(acs_couple_policy, same_sex == T),
  sample_n(filter(acs_couple_policy, same_sex == F), 1e5)
)


```



# Descriptive Statistics
```{r desc-table-country}
theme_gtsummary_compact()

acs_prop_yrimmig_policy %>%
  select(prop_same_sex, distw, contig, comlang_off, comlang_ethno, colony,
                   wage_dif, unemp_dif, vdem, origin_score, stock_prop) %>%
  tbl_summary() %>%
  modify_caption('Summary statistics for country-level analysis') %>%
  as_kable_extra(booktabs = T)
```

```{r desc-table-state}

acs_dyad_policy %>%
  select(same_prop, state_policy, origin_score, distw, contig, 
                          comlang_off, comlang_ethno, colony,
                          wage_dif, unemp_dif, vdem, stock_prop,
                           state_unemploy, state_income) %>%
  tbl_summary() %>%
  modify_caption('Summary statistics for state-level analysis')  %>%
  as_kable_extra(booktabs = T)
```

```{r desc-table-ind}
acs_couple_policy %>%
  labelled::remove_labels() %>%
  select(state_policy_binned, same_sex, origin_score, sex, age, educ,
                     nchild, ihs_income, no_income, yrimmig,
                     distw, contig, comlang_off, comlang_ethno,
                     wage_dif, unemp_dif, vdem, stock_prop,
                     state_unemploy, state_income) %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-sex', 'Different-sex')) %>%
  tbl_summary(by = same_sex) %>%
  add_overall() %>%
  modify_caption('Summary statistics for individual-level analysis')  %>%
  as_kable_extra(booktabs = T)
```

\newpage

# Additional Descriptive Trends
```{r desc-top1}
acs_couple_policy %>%
  filter(same_sex == T) %>%
  group_by(bpld) %>%
  count() %>%
  rename(`Birth country` = bpld) %>%
  arrange(desc(n)) %>%
  head(10) %>%
  kable(booktabs = T,
        caption = 'Top 10 sending countries of immigrants in same-sex couples in the American Community Survey 2008-2019')
```

```{r desc-top2}
acs_couple_policy %>%
  filter(same_sex == F)%>%
  group_by(bpld) %>%
  count() %>%
  rename(`Birth country` = bpld) %>%
  arrange(desc(n))%>%
  head(10) %>%
  kable(booktabs = T,
        caption = 'Top 10 sending countries of immigrants in different-sex couples in the American Community Survey 2008-2019')
```

```{r desc-fig, fig.cap = 'Additional descriptive statistics for immigrants in couples 2008-2019, with survey weights and 95% confidence intervals. All currency in 1000s of 1999 dollars.'}
hwsei <- acs_ind_survey %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(hwsei, vartype = "ci", na.rm = T)) %>%
  mutate(var_name = 'Hauser and Warren Socioeconomic Index')

nchild <- acs_ind_survey %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(nchild, vartype = "ci", na.rm = T)) %>%
  mutate(var_name = 'Number of Children')

years <- acs_ind_survey %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(years_in_us, vartype = "ci", na.rm = T)) %>%
  mutate(var_name = 'Years in U.S.')

distance <- acs_ind_survey %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(distw, vartype = "ci", na.rm = T)) %>%
  mutate(var_name = 'Distance to Country of Origin (KM)')

unemp <- acs_ind_survey %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(unemp_dif, vartype = "ci", na.rm = T)) %>%
  mutate(var_name = 'Difference in Unemployment Rates')

state_income <- acs_ind_survey %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(state_income, vartype = "ci", na.rm = T)) %>%
  mutate(var_name = 'U.S. State of Residence Per Capita Income')


bind_rows(hwsei, nchild, years, distance, unemp, state_income) %>%
  rename(Year = year) %>%
  ggplot(aes(x = Year, y = var, color = same_sex)) +
  geom_line() +
  geom_ribbon(aes(ymin = var_low, ymax = var_upp, fill = same_sex, col = NULL), alpha = .2) +
  facet_wrap(~var_name, scales = "free", ncol = 2) +
  ylab('') +
  theme(legend.justification=c(1,0),
      legend.position=c(.24,.085))
```

\newpage

# Robustness Checks

## Adjusting proportions based on empirical mismatch rates




Published papers using the ACS to study same-sex couples overwhelmingly use the method by @gates_2009 employed our main paper to adjust for misreporting. However here we implement a novel method to adjust proportions of estimated immigrants in same-sex couples, based on the estimated mismatch rates from two U.S. Census Bureau studies.  Beginning in 2019, the ACS provides explicit categories for "Opposite-sex husband/wife/spouse," "Opposite-sex unmarried partner," "Same-sex husband/wife/spouse," and "Same-sex unmarried partner" [@walker_2021], so sex misreporting in the 2019 data is unlikely. Hence in most sensitivity analyses below, 2019 estimates are not adjusted for misreporting.  

In a Census Bureau working paper, @kreider_2015 use personal information such as names and addresses match same-sex couples from the 2010 ACS to Social Security administrative data. They find that 57 percent of married couples coded as same-sex in the ACS are coded as different-sex in the administrative data. The corresponding sex mismatch rate for unmarried same-sex couples is 7 percent. (Our data include `r sum(acs_wide$related_partner == 'Spouse' & acs_wide$same_sex == T)` married and `r sum(acs_wide$related_partner == 'Unmarried Partner' & acs_wide$same_sex == T)` unmarried same-sex immigrant couples.) A follow-up study [@kreider_2017] shows that these mismatch rates appear to have fallen: In a 2016 ACS test module that included explicit categories for different- and same-sex spouses and partners, 31 percent of married and 3 percent of unmarried same-sex couples had inconsistent sex responses. This decreasing mismatch rate may be due to the greater numbers of same-sex couples openly identifying themselves as well as the growing popularity of responding to the ACS via Internet (see Supplementary Material), a response mode introduced in 2013 which is now the default [@u.s.censusbureau_2017]. In the 2016 test of the ACS, the mismatch rate for mail-in responses was 47 and 6 percent for married and unmarried same-sex couples, respectively, whereas for Internet responses they were only 22 and 2.4 percent [@kreider_2017]. A computer-assisted telephone interviewing (CATI) or computer-assisted personal interviewing (CAPI) response mode is sometimes administered as well, but the 2016 study did not assess its error rate. In the 2010 ACS, @kreider_2015 find CATI/CAPI sex reporting mismatch for 46 and 13 percent for married and unmarried same-sex couples, respectively. In our sample of immigrants in same-sex couples, `r sum(acs_couple_policy$respmode == 'Mail' & acs_couple_policy$same_sex == T)` responded by mail, `r with(filter(acs_couple_policy, same_sex == T), sum(respmode == 'CATI/CAPI'))` responded by CAPI/CATI, and `r sum(acs_couple_policy$respmode == 'Internet' & acs_couple_policy$same_sex == T)` responded by Internet survey. Response mode proportions by couple type are shown in Table \ref{tab:respmode}.  

Table \ref{tab:mismatch} shows the mismatch rates estimated by @kreider_2015 and @kreider_2015. In the supplemental analysis below (Table \ref{tab:country-props-adj}), we use these apparent mismatch rates to adjust proportions used in models in Table 3 of the main paper. Each proportion is adjusted separately by marital status and response mode. For example, all internet respondents coded as being in married same-sex couples have their final proportion reduced by 22.5%. For mail-in responses, the proportions are reduced by the average between the two studies (`r (59+47.4)/2` percent for married and `r (7+5.6)/2` percent for unmarried couples). 

```{r respmode}
tabyl(acs_couple_policy, respmode, year, same_sex) %>%
  adorn_percentages('col') %>%
  bind_rows() %>%
  mutate(same_sex = c(F, F, F, T, T, T)) %>%
  select(respmode, same_sex, everything()) %>%
  kable(booktabs = T,
        caption = 'Response mode proportions for different- and same-sex couples, by year. Proportions are within couple type and year.') %>%
  kable_styling(font_size = 9)
```

```{r mismatch}

tibble(`Study Year` = c(2010, 2010, 2016, 2016),
       Relationship = c('Married', 'Unmarried Partner', 'Married', 'Unmarried Partner'),
       `Mail` = c('59%', '7%', '47.4%', '5.6%'), 
       `Internet` = c('NA', 'NA', '22.5%', '2.4%'), 
       `CAPI/CATI` = c('46%', '13%', 'Unknown', 'Unknown'),
       Overall = c('57.3%', '7%', '35%', '3.4%')) %>%
  kable(booktabs = T, 
        caption = 'Mismatch rates from Kreider \\& Lofquist (2015) and Kreider et al. (2017)') %>%
      footnote(general = "American Community Survey 2008-2019. Authors\' calculations.",
           general_title = 'Source:',
           footnote_as_chunk = T) 
```

```{r country-props-adj}
ag <- lm(prop_same_sex_adj ~ origin_score,
         data = acs_prop_yrimmig_policy)


ag_country_orig <- lm(prop_same_sex_adj ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop,
         data = acs_prop_yrimmig_policy)

ag_country_orig_fe <- lm(prop_same_sex_adj ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld,
         data = acs_prop_yrimmig_policy)



ag_country_orig_fe_2013 <- lm(prop_same_sex_adj ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld +
                     post_2013,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))


ag_2013_int_fe <- lm(prop_same_sex_adj ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem  + stock_prop + bpld +
                     post_2013*origin_score,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))

se_list <- list()
mod_list <- list(ag, ag_country_orig, ag_country_orig_fe,
                 ag_country_orig_fe_2013, ag_2013_int_fe)
for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], cluster = c("bpld")))[, 2]
}


stargazer(mod_list,
          header = F,
          model.names = F,
          keep = c('origin_score',  'post_2013'),
          order = paste0("^", c('origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('Country LGB policy score', 
                                'Post-2013', 'Country score × Post-2013'),
          dep.var.labels   = "Percent in same-sex couples by country-year",
          add.lines = list(c('Country controls?', 'no', rep('yes', 4)),
                           c('Country FEs?', 'no', 'no', rep('yes', 3))),
          se = se_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("Note: †p<0.1; *p<0.05; **p<0.01; ***p<0.001",
                    "Source: American Community Survey 2008-2019"),
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          label = 'tab:country-props-adj',
          title = 'Adjusted by rates of empirical sex mismatch by married, unmarried, and response mode. OLS regressions of percent of immigrants in same-sex couples by year of immigration and country of origin, adjusted. Country-clustered standard errors shown in parentheses. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.')
```

```{r state-props-adj}

state_prop <- lm(prop_same_sex_adj ~ state_policy, data = acs_dyad_policy)

state_prop2 <- lm(prop_same_sex_adj ~ origin_score + state_policy, data = acs_dyad_policy)

state_prop_fe <- lm(prop_same_sex_adj ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_dyad_policy)

state_prop_fe2 <- lm(prop_same_sex_adj ~ state_policy*origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_dyad_policy)

state_prop_2013 <- lm(prop_same_sex_adj ~ post_2013 + state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013)))

state_prop_2013_int <- lm(prop_same_sex_adj ~ post_2013*origin_score + state_policy + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013)))

state_prop_2013_int2 <- lm(prop_same_sex_adj ~ post_2013*state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013)))

se_list <- list()
mod_list <- list(state_prop, state_prop2, state_prop_fe, state_prop_fe2, 
                 state_prop_2013, state_prop_2013_int2, state_prop_2013_int)

for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], cluster = c("state", "Country")))[, 2]
}


stargazer(mod_list,
          header = F, 
          keep = c('origin_score', 'state_policy', 'post_2013'),
          # omit = c('Country', 'state'),
          order = paste0("^", c('state_policy', 'origin_score', 
                                'state_policy:origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:state_policy', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('State LGB policy score', 'Country LGB policy score',
                                'State score × country-score', 'Post-2013', 
                               'State score × post-2013', 'Country score × post-2013'),
          dep.var.labels = "Percent in same-sex couples by state-country-year",
          add.lines = list(c('State controls and FEs?', 'no', 'no', rep('yes', 5)),
                           c('Country controls and FEs?', 'no', 'no', rep('yes', 5))),
          se = se_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("Note: †p<0.1; *p<0.05; **p<0.01; ***p<0.001", 
                    "Source: American Community Survey 2008-2019"), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          label = 'tab:state-props-adj',
          title = 'Adjusted by rates of empirical sex mismatch by married, unmarried, and response mode. Percent same-sex in by country of origin, U.S. state, and survey year. Country and state two-way clustered standard errors are shown in parentheses. State controls include unemployment rate and per-capita income. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.')

```

## Relative immmigrant population-weighted regressions
We perform the same regressions with proportion in same-sex couples by country or state, but weighted by the relative size of the immigrant stock.
```{r country-weights}
ag <- lm(prop_same_sex ~ origin_score,
         data = acs_prop_yrimmig_policy, weights = stock_prop)

ag_country_orig <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop,
         data = acs_prop_yrimmig_policy, weights = stock_prop)

ag_country_orig_fe <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld,
         data = acs_prop_yrimmig_policy, weights = stock_prop)



ag_country_orig_fe_2013 <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld +
                     post_2013,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)), weights = stock_prop)


ag_2013_int_fe <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem  + stock_prop + bpld +
                     post_2013*origin_score,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)), weights = stock_prop)


se_list <- list()
mod_list <- list(ag, ag_country_orig, ag_country_orig_fe,
                 ag_country_orig_fe_2013, ag_2013_int_fe)
for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], cluster = c("bpld")))[, 2]
}


stargazer(mod_list,
          header = F,
          model.names = F,
          keep = c('origin_score',  'post_2013'),
          order = paste0("^", c('origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('Country LGB policy score',
                                'Post-2013', 'Country score × Post-2013'),
          dep.var.labels   = "Percent in same-sex couples by country-year",
          add.lines = list(c('Country controls?', 'no', rep('yes', 4)),
                           c('Country FEs?', 'no', 'no', rep('yes', 3))),
          se = se_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("Note: †p<0.1; *p<0.05; **p<0.01; ***p<0.001",
                    "Source: American Community Survey 2008-2019"),
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          label = 'tab:country-props',
          title = 'Weighted OLS regressions of percent of immigrants in same-sex couples by year of immigration and country of origin. Country-clustered standard errors shown in parentheses.')

```

```{r state-props}
state_prop <- lm(same_prop ~ state_policy, data = acs_dyad_policy, weights = stock_prop)

state_prop2 <- lm(same_prop ~ origin_score + state_policy, data = acs_dyad_policy, weights = stock_prop)

state_prop_fe <- lm(same_prop ~ state_unemploy + state_income + state + 
                        origin_score + state_policy, 
                       data = acs_dyad_policy, weights = stock_prop)

state_prop_fe2 <- lm(same_prop ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_dyad_policy, weights = stock_prop)

state_prop_2013 <- lm(same_prop ~ post_2013 + state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013)), weights = stock_prop)

state_prop_2013_int <- lm(same_prop ~ post_2013*origin_score + state_policy + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013)), weights = stock_prop)


se_list <- list()
mod_list <- list(state_prop, state_prop2, state_prop_fe, state_prop_fe2, 
                 state_prop_2013, state_prop_2013_int)

for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], cluster = c("state")))[, 2]
}


stargazer(mod_list,
          header = F, 
          keep = c('origin_score', 'state_policy', 'post_2013'),
          # omit = c('Country', 'state'),
          order = paste0("^", c('state_policy', 'origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('State LGB policy score', 'Country LGB policy score',
                                'Post-2013', 'Country score × Post-2013'),
          dep.var.labels = "Percent in same-sex couples by state-country-year",
          add.lines = list(c('State controls and FEs?', 'no', 'no', rep('yes', 4)),
                           c('Country controls and FEs?', rep('no', 3), rep('yes', 3))),
          se = se_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("Note: †p<0.1; *p<0.05; **p<0.01; ***p<0.001", 
                    "Source: American Community Survey 2008-2019"), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          label = 'tab:state-props',
          title = 'Weighted regression of percent same-sex in by country of origin, U.S. state, and survey year. Country-clustered standard errors are shown in parentheses.')
```

\newpage

## Alternate specifications of country proportion models
```{r country-props-alt}

# Spouse
ag_2013_spouse1 <- lm(prop_spouse_same_sex ~ distw + contig + comlang_off + 
                        comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))

# Spouse, + 2013
ag_2013_spouse2 <- lm(prop_spouse_same_sex ~ distw + contig + comlang_off + 
                        comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld +
                     post_2013,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))

# Spouse + interaction
ag_2013_spouse_int <- lm(prop_spouse_same_sex ~ distw + contig + comlang_off + 
                           comlang_ethno + colony + bpld +
                   wage_dif + unemp_dif + vdem  + stock_prop +
                     post_2013*origin_score,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))

# One immigrant
ag_oneimm <- lm(prop_same_sex_oneimm ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld,
         data = acs_prop_yrimmig_policy)

ag_oneimm_2013 <- lm(prop_same_sex_oneimm ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + stock_prop + bpld + 
                     post_2013 + origin_score,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))

ag_oneimm_2013_int <- lm(prop_same_sex_oneimm ~ distw + contig + comlang_off + 
                           comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + stock_prop + bpld + 
                     post_2013*origin_score,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))



se_list <- list()
mod_list <- list(ag_2013_spouse1, ag_2013_spouse2, ag_2013_spouse_int, 
                 ag_oneimm, ag_oneimm_2013, ag_oneimm_2013_int)
for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], cluster = c("bpld")))[, 2]
}

stargazer(mod_list,
          header = F, 
          model.names = F,
          keep = c('origin_score', 'post_2013'),
          order = paste0("^", c('origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('Country LGB policy score', 
                                'Post-2013', 'Country score × Post-2013'),
          dep.var.labels   = c("Married", "One Immigrant"),
          add.lines = list(c('Country controls?', rep('yes', 6)),
                           c('Country FEs?', rep('yes', 6))),
          se = se_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("Note: †p<0.1; *p<0.05; **p<0.01; ***p<0.001", 
                    "Source: American Community Survey 2008-2019"), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          label = 'tab:country-props-alt',
          title = 'Alternate Specifications of OLS regressions of percent of immigrants in same-sex couples by year of immigration and country of origin, using only proportions of married couples or couples with one immigrant and one U.S.-born citizen. Country-clustered standard errors shown in parentheses. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and Polity 5 measure of democracy.')
```

\newpage



## OLS models of individual state of residence
```{r ols-ind}

ols_basic <- lm(state_policy ~ same_sex,
                data = acs_couple_policy_small)
ols_orig <- lm(state_policy ~ same_sex*origin_score,
                data = acs_couple_policy_small)
ols_interact <- lm(state_policy ~ 
                       same_sex*(origin_score + gender + age + educ + 
                   nchild + ihs_income + no_income + yrimmig),
                data = rename(acs_couple_policy_small, gender = sex))

ols_interact_controls <- lm(state_policy ~ same_sex*(origin_score + gender + age + educ +
                     nchild + ihs_income + no_income + yrimmig) +
                     distw + contig + comlang_off + comlang_ethno +
                     wage_dif + unemp_dif + vdem + stock_prop +  #bpld + state +
                     state_unemploy + state_income ,
                data = rename(acs_couple_policy_small, gender = sex))

se_list <- list()
mod_list <- list(ols_basic, ols_orig, ols_interact, ols_interact_controls)
for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], 
                                     cluster = c('bpld', 'state')))[, 2]
}


stargazer(mod_list,
          header = F, 
          add.lines = list(#c('Survey year FEs?', rep('yes', 3)),
                           c('Individual controls?', 'no', 'no', 'yes', 'yes'),
                           c('State controls and FEs?', 'no', 'no', 'no', 'yes'),
                           c('Country controls and FEs?', 'no', 'no', 'no', 'yes')),
          se = se_list,
          omit = c('gender', 'age', 'educ', 'nchild', 'ihs_income', 'no_income', 
                   'yrimmig', 'Constant', 
                   'distw', 'contig', 'comlang_off', 'comlang_ethno',
                    'wage_dif', 'unemp_dif', 'vdem', 'stock_prop',
                     'state_unemploy', 'state_income', 'state', 'bpld'),
          dep.var.labels = c("Binned state LGB policy score"),
          covariate.labels = c('Same-sex', 'Country LGB policy score', 
                               'Same-sex × country score'),
          keep.stat = 'n',
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("Note: †p<0.1; *p<0.05; **p<0.01; ***p<0.001", 
                    "Source: American Community Survey 2008-2019"), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          #no.space = T,
          label = 'tab:ols',
          title = 'Individual OLS analysis of state policy score. Country-clustered standard errors are shown in parentheses. Individual controls include sex, age, education, number of children, log(income), indicator for no income, and year of immigration, which are all interacted with the indicator for same-sex couple.')
```

```{r ols-ind-sim, eval = F}
## Simulation
set.seed(185)
sims <- 250
sim <- list()
sim_mod <- list(sims)
pseudeo_mod <- ols_interact_controls
k <- length(coef(ols_interact_controls))
sigma_twoway <- vcovCL(ols_interact_controls, cluster = ~ state + bpld)
theta_mat <- rmvnorm(sims, mean=ols_interact_controls$coefficients,
                              sigma = sigma_twoway)

var <- 'origin_score'

for (i in 1:sims) {
  # if(i %% 10 == 0) print(i)
  print(i)
  theta <- as.numeric(theta_mat[i,])
  pseudeo_mod$coefficients <- theta[1:k]
  pseudeo_mod$zeta <- theta[(k+1):length(theta)]

  for(same_loop in unique(acs_couple_policy_small$same_sex)){
      var_vals <- seq(min(acs_couple_policy_small[,var]), 
                      max(acs_couple_policy_small[,var]), 
                      length.out = 10)
      for(val in var_vals){
          sim_dat <- acs_couple_policy_small %>%
            rename(gender = sex) %>%
            select(all.vars(formula(ols_interact_controls)))
          sim_dat[, 'same_sex'] <- same_loop
          sim_dat[, var] <- val

          pred_dat <- predict(pseudeo_mod, newdata = sim_dat)
          # pred_dat <- data.frame(t(apply(pred_dat, 2, mean))) %>%
          #   pivot_longer(cols = everything(), names_to = 'state_policy', values_to = 'fit')
          
         sim[[paste0(var,same_loop, val, i)]] <-
          data.frame(fit = mean(pred_dat, na.rm = T),
                            same_sex = same_loop,
                            # variable = var,
                            origin_score = val)
      }
  }
}

sim_df <- bind_rows(sim) %>%
  group_by(same_sex, origin_score) %>%
  summarize(fit.low = quantile(fit, .025), fit.high = quantile(fit, .975), fit = mean(fit)) %>%
    mutate(same_sex = case_when(same_sex == T ~ 'Same-sex',
                                same_sex == F ~ 'Different-sex'))

write_csv(sim_df, here('supp', 'sim_df_ols.csv'))
```

```{r ols-ind-sim2, eval = F}

read_csv(here('supp', 'sim_df_ols.csv')) %>%
  ggplot(aes(x=origin_score, y=fit, col=same_sex)) +
  geom_line() + 
  geom_ribbon(aes(ymin=fit.low, ymax=fit.high, 
                  fill = same_sex, col = NULL), alpha = .2) +
  xlab('LGB policy score for country of origin') +
  ylab('Predicted U.S. state LGB policy score') +
  theme(legend.justification=c(1,0),
        legend.position=c(.95,.38))
```


\newpage



<!-- We next text the robustness of our results to omitted variable bias. -->

# Full Regression Tables
```{r country-props-full}
ag <- lm(prop_same_sex ~ origin_score,
         data = acs_prop_yrimmig_policy)


ag_country_orig <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop,
         data = acs_prop_yrimmig_policy)

ag_country_orig_fe <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld,
         data = acs_prop_yrimmig_policy)

ag_country_orig_fe_2013 <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld +
                     post_2013,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))


ag_2013_int_fe <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem  + stock_prop + bpld +
                     post_2013*origin_score,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))

se_list <- list()
mod_list <- list(ag, ag_country_orig, ag_country_orig_fe,
                 ag_country_orig_fe_2013, ag_2013_int_fe)
for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], cluster = c("bpld")))[, 2]
}


stargazer(mod_list,
          header = F,
          model.names = F,
          omit = 'bpld',
          order = paste0("^", c('origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('Country LGB policy score',
                                'Post-2013', 'Country score × Post-2013'),
          dep.var.labels   = "Percent in same-sex couples by country-year",
          add.lines = list(c('Country controls?', 'no', rep('yes', 4)),
                           c('Country FEs?', 'no', 'no', rep('yes', 3))),
          se = se_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("Note: †p<0.1; *p<0.05; **p<0.01; ***p<0.001",
                    "Source: American Community Survey 2008-2019"),
          no.space = T,
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          label = 'tab:country-props-full',
          title = 'OLS regressions of percent of immigrants in same-sex couples by year of immigration and country of origin. Country-clustered standard errors shown in parentheses. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.')


```

```{r state-props-full}
state_prop <- lm(same_prop ~ state_policy, data = acs_dyad_policy)

state_prop2 <- lm(same_prop ~ origin_score + state_policy, data = acs_dyad_policy)



state_prop_fe <- lm(same_prop ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + bpld + sname, 
                       data = mutate(acs_dyad_policy, bpld = Country, sname = state))

state_prop_fe2 <- lm(same_prop ~ state_policy*origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + bpld + sname, 
                       data = mutate(acs_dyad_policy, bpld = Country, sname = state))

state_prop_2013 <- lm(same_prop ~ post_2013 + state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + bpld + sname, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013),bpld = Country, sname = state))

state_prop_2013_int <- lm(same_prop ~ post_2013*origin_score + state_policy + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + bpld + sname, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013),bpld = Country, sname = state))

state_prop_2013_int2 <- lm(same_prop ~ post_2013*state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + bpld + sname, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013), bpld = Country, sname = state))


se_list <- list()
mod_list <- list(state_prop, state_prop2, state_prop_fe, state_prop_fe2, 
                 state_prop_2013, state_prop_2013_int2, state_prop_2013_int)

for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], cluster = c("sname", "bpld")))[, 2]
}


stargazer(mod_list,
          header = F, 
          omit = c('bpld', 'sname'),
          order = paste0("^", c('state_policy', 'origin_score', 
                                'state_policy:origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:state_policy', 
                                'post_2013TRUE:origin_score') , "$"),
          # covariate.labels = c('State LGB policy score', 'Country LGB policy score',
          #                       'State score × country-score', 'Post-2013', 
          #                      'State score × post-2013', 'Country score × post-2013'),
          dep.var.labels = "Percent in same-sex couples by state-country-year",
          add.lines = list(c('State controls and FEs?', 'no', 'no', rep('yes', 5)),
                           c('Country controls and FEs?', 'no', 'no', rep('yes', 5))),
          se = se_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("Note: †p<0.1; *p<0.05; **p<0.01; ***p<0.001", 
                    "Source: American Community Survey 2008-2019"), 
          no.space = T,
          column.sep.width = '2pt',
          font.size = 'footnotesize',
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          label = 'tab:state-props-full',
          title = 'Percent same-sex in by country of origin, U.S. state, and survey year. Country and state two-way clustered standard errors are shown in parentheses. State controls include unemployment rate and per-capita income. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.')

```

```{r ord-full}

ord_basic <- polr(state_policy_binned ~ same_sex,
                data = acs_couple_policy_small, Hess = T, weights = perwt/12)
ord_orig <- polr(state_policy_binned ~ same_sex*origin_score,
                data = acs_couple_policy_small, Hess = T, weights = perwt/12)
ord_interact <- polr(state_policy_binned ~ 
                       same_sex*(origin_score + gender + age + educ + 
                   nchild + ihs_income + no_income + yrimmig),
                data = rename(acs_couple_policy_small, gender = sex), Hess = T, weights = perwt/12)

ord_interact_controls <- polr(state_policy_binned ~ 
                                same_sex*(origin_score + gender + age + educ +
                     nchild + ihs_income + no_income + yrimmig) +
                     distw + contig + comlang_off + comlang_ethno +
                     wage_dif + unemp_dif + vdem + stock_prop + #  bpld + state +
                     state_unemploy + state_income,
                data = rename(acs_couple_policy_small, gender = sex), Hess = T, weights = perwt/12)

se_list <- list()
mod_list <- list(ord_basic, ord_orig, ord_interact, ord_interact_controls)
for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], 
                                     cluster = c('bpld', 'state')))[, 2]
}

newdat <- data.frame(same_sex = rep(c(F, T), 12), year = rep(2008:2019, each = 2))
ord_probs <- cbind(newdat,
      predict(ord_basic, 
        newdat,
        type = 'probs')) %>%
  group_by(same_sex) %>%
  summarize(Repressive = mean(Repressive),
            Neutral = mean(Neutral),
            Progressive = mean(Progressive)) 


obs <- paste0(substr(nrow(acs_couple_policy_small), 1, 3), ',', 
              substr(nrow(acs_couple_policy_small), 4, 6))

stargazer(mod_list,
          header = F, 
          add.lines = list(#c('Survey year FEs?', rep('yes', 3)),
                           c('Individual controls?', 'no', 'no', 'yes', 'yes'),
                           c('State and country controls?', 'no', 'no', 'no', 'yes'),
                           c('Observations', rep(obs, length(mod_list)))
                           ),
          se = se_list,
          dep.var.labels = c("Binned state LGB policy score"),
          order = paste0("^", c('same_sex', 'origin_score', 'same_sexTRUE:origin_score') , "$"),
          covariate.labels = c('Same-sex', 'Country LGB policy score', 
                               'Same-sex × country score'),
          omit.stat = 'n',
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("Note: †p<0.1; *p<0.05; **p<0.01; ***p<0.001", 
                    "Source: American Community Survey 2008-2019"), 
          no.space = T,
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          font.size = 'footnotesize',
          label = 'tab:ord-full',
          title = 'Individual ordered logit analysis of three-category state policy score. Country and state two-way clustered standard errors are shown in parentheses. Individual controls include sex, age, education, number of children, IHS-transformed income, indicator for no income, and year of immigration, which are all interacted with the indicator for same-sex couple. State controls include unemployment rate and per-capita income. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.')
```


\newpage

# References
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\noindent


