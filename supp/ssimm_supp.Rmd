---
output:
  bookdown::pdf_document2:
    toc: yes
    number_sections: yes
    pandoc_args: !expr rmdfiltr::add_wordcount_filter(rmdfiltr::add_citeproc_filter(args = NULL))
    latex_engine: xelatex
    keep_tex: yes
    extra_dependencies: ["float"]
    #template: svm-latex-ms.tex
# output: 
#   pdf_document:
#     citation_package: natbib
#     keep_tex: true
#     fig_caption: true
#     latex_engine: pdflatex
#     template: svm-latex-ms.tex
header-includes:
  # - \usepackage{setspace}\doublespace
  # - \usepackage{endnotes}
  #- \let\footnote=\endnote
  #- \usepackage{endfloat}
  # - \usepackage{fancyhdr}
  # - \pagestyle{fancy}
  # - \setlength{\headheight}{13.6pt}
  # - \rhead{\textit{Hoffmann and Velasco}}
  # - \lhead{\textit{`r format(Sys.time(), '%B %e, %Y')`}}
  - \usepackage{float}
  # - \let\counterwithout\relax
  # - \let\counterwithin\relax
  # - \usepackage{chngcntr}
  - \counterwithin{figure}{section}
  - \counterwithin{table}{section}
  # - \usepackage{flafter}
editor_options: 
  
  chunk_output_type: console
citeproc: no
fontfamily: mathpazo
fontsize: 11pt
geometry: margin=1in
indent: yes
link-citations: yes
linkcolor: blue
bibliography: zotero.bib  
csl: apa.csl
title: "Supplementary Material"
subtitle: "Making Migration Sexy: How LGB Policies Influence International Migration"
# date: "`r format(Sys.time(), '%B %e, %Y')`"
 
# author:
# - Nathan I. Hoffmann, Department of Sociology, University of California, Los Angeles
# - Kristopher Velasco, Department of Sociology, Princeton University
---

<!-- Turn off hyphenation -->
<!-- \usepackage[none]{hyphenat} -->


```{r setup, include=F}
knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = T, results = 'asis',
                      cache.lazy = F)
# knitr::opts_chunk$set(fig.pos = "h", out.extra = "")

library(broom)
library(janitor)
library(priceR)
library(kableExtra)
library(sjstats)
library(imputeTS)
library(mvtnorm)
library(ordinal)
library(lme4)
library(MASS)
library(countrycode)
library(knitr)
library(RColorBrewer)
library(haven)
library(cowplot)
library(srvyr)
library(lmtest)
library(sandwich)
library(here)
library(plm)
library(patchwork)
library(stargazer)
library(gtsummary)
library(tidyverse)

# knitr::opts_chunk$set(error=TRUE) 

options("yaml.eval.expr" = TRUE)

# theme_set(theme_cowplot(font_family = 'Palatino') + 
theme_set(theme_classic(base_family = 'Palatino') + 
            theme(legend.title=element_blank(), 
                  panel.grid.major.y = element_line('grey80'),
                  legend.background = element_rect(fill = "transparent")))
ggplot <- function(...) ggplot2::ggplot(...) + scale_color_brewer(palette="Dark2") + 
  scale_fill_brewer(palette="Dark2")

options(scipen=1, digits=2)
knit_hooks$set(inline = function(x) {
  prettyNum(x, big.mark=",")
})
knitr::opts_chunk$set(error=TRUE) 


```

```{r load, include = F}
acs_wide <- read.csv(here('data', 'acs_wide.csv'))
acs_couple_policy <- readRDS(here('data', 'acs_couple_policy.rds'))
acs_prop_yrimmig_policy <- read.csv(here('data', 'acs_prop_yrimmig_policy.csv')) %>%
  mutate(post_2013 = (yrimmig > 2013),
         n_same_sex_coupled = n_spouse_same_sex + n_partner_same_sex)
acs_dyad_policy <- read.csv(here('data', 'acs_dyad_policy.csv'))

# acs_oneimm <- read.csv(here('data', 'acs_oneimm.csv'))
# acs_coupled_imms <- read.csv(here('data', 'acs_coupled_imms.csv'))
# acs_prop_yrimmig <- read.csv(here('data', 'acs_prop_yrimmig.csv'))
# acs_dyad <- read.csv(here('data', 'acs_dyad.csv'))




acs_wide_survey <- acs_wide %>% as_survey_design(ids = cluster, weights = hhwt)
acs_ind_survey <- acs_couple_policy %>% as_survey_design(ids = cluster, weights = perwt)


# Smaller dataset for initial ordered logit analyses
set.seed(1859)
# acs_couple_policy_small <- bind_rows(
#   filter(acs_couple_policy, same_sex == T),
#   sample_n(filter(acs_couple_policy, same_sex == F), 1e5)
# )
acs_couple_policy_small <- acs_couple_policy
# acs_couple_policy_small <- bind_rows(
#   filter(acs_couple_policy, same_sex == T, yrimmig >= 1991),
#   sample_n(filter(acs_couple_policy, same_sex == F), 1e5)
# ) 

```

# (APPENDIX) Appendix {-} 

# Descriptive Statistics
```{r desc-table-country}
theme_gtsummary_compact()

acs_prop_yrimmig_policy %>%
  select(`Percent in same-sex couples` = prop_same_sex, `Country LGB policy score` = origin_score,
         `Distance (km)` = distw, 
         `Contiguous border` = contig, `Common official language` = comlang_off, 
         `Common ethnic language` = comlang_ethno, `Ever colonial relationship` = colony,
         `Per-cap. GDP difference` = wage_dif, `Unemployment difference` = unemp_dif, 
         `Liberal democracy (V-Dem)` = vdem, `Proportion same-country stock` = stock_prop) %>%
  tbl_summary() %>%
  modify_caption('Summary statistics for country-level analysis') %>%
  as_kable_extra(booktabs = T) %>%
  kable_styling(latex_options = "hold_position")

```

```{r desc-table-state}

acs_dyad_policy %>%
  select(`Percent in same-sex couples` = same_prop, `State LGB policy score` = state_policy,
         `Country LGB policy score` = origin_score,
         `Distance (km)` = distw, 
         `Contiguous border` = contig, `Common official language` = comlang_off, 
         `Common ethnic language` = comlang_ethno, `Ever colonial relationship` = colony,
         `Per-cap. GDP difference` = wage_dif, `Unemployment difference` = unemp_dif, 
         `Liberal democracy (V-Dem)` = vdem, `Proportion same-country stock` = stock_prop,
         `State unemployment rate` = state_unemploy, `State per-capita income` = state_income) %>%
  tbl_summary() %>%
  modify_caption('Summary statistics for state-level analysis')  %>%
  as_kable_extra(booktabs = T) %>%
  kable_styling(latex_options = "hold_position")
```

```{r desc-table-ind}
acs_couple_policy %>%
  labelled::remove_labels() %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-sex', 'Different-sex')) %>%
  select(`State LGB policy` = state_policy_binned, `Same-sex` = same_sex, 
         `Country LGB policy score` = origin_score, 
         `Sex` = sex, `Age` = age, `Education` = educ,
         `Number of children` = nchild, `IHS-transformed income` = ihs_income, 
         `No income` = no_income, `Year of immigration` = yrimmig,
         `Distance (km)` = distw, 
         `Contiguous border` = contig, `Common official language` = comlang_off, 
         `Common ethnic language` = comlang_ethno, `Ever colonial relationship` = colony,
         `Per-cap. GDP difference` = wage_dif, `Unemployment difference` = unemp_dif, 
         `Liberal democracy (V-Dem)` = vdem, `Proportion same-country stock` = stock_prop,
         `State unemployment rate` = state_unemploy, `State per-capita income` = state_income) %>%
  tbl_summary(by = `Same-sex`) %>%
  add_overall() %>%
  modify_caption('Summary statistics for individual-level analysis')  %>%
  as_kable_extra(booktabs = T) %>%
  kable_styling(latex_options = "hold_position")
```




\newpage

# Additional Descriptive Trends
Figure \ref{fig:scatter-country} relies on the data used in the country-level models. The vertical axis represents the proportion of immigrants from each country in same-sex couples in each year of immigration, from 1991 to 2019, while the horizontal axis indicates the policy score of the country of origin in the year of immigration. The line shows the bivariate regression line. Percentages above 5 are not shown (hiding `r sum(acs_prop_yrimmig_policy$prop_same_sex > 5)` out of `r nrow(acs_prop_yrimmig_policy)` country-years).  

Figure \ref{fig:scatter-state} relies on the data used in the state-level models, with the vertical axis showing the proportion of immigrants from each country in same-sex couples in each state, in each survey year, from 2008 to 2019. In the left panel, the horizontal axis represents the origin country policy score in the mean year of immigration for that group, while the right panel's horizontal axis represents the state policy score in the survey year. The lines shows the bivariate regression lines.  

```{r scatter-country, fig.cap = "Proportion of immigrants from each country in same-sex couples in each year of immigration, from 1991 to 2019. The horizontal axis indicates the policy score of the country of origin in the year of immigration. Points are jittered for clarity, and percentages above 5 are not shown."}

acs_prop_yrimmig_policy %>%
  filter(prop_same_sex <= 5) %>%
  ggplot(aes(x = origin_score, y = prop_same_sex, color = yrimmig)) +
  geom_jitter(alpha = .5) + 
  scale_color_continuous() +
  geom_smooth(method = "lm", color = 'black') +
  ylim(0,5) +
  labs(x= 'LGB policy score for country of origin', 
        y = 'Percentage of immigrants in same-sex couples')




```



```{r scatter-state, fig.cap = "Proportion of immigrants from each country in same-sex couples in each state, in each survey year, from 2008 to 2019. The left panel's horizontal axis represents the origin country policy score in the mean year of immigration for that group, while the right panel's horizontal axis represents the state policy score in the survey year. Points are jittered for clarity, and percentages above 5 are not shown."}
state_plot_1 <- acs_dyad_policy %>%
  filter(same_prop <= 5) %>%
  ggplot(aes(x = state_policy, y = same_prop, color = year)) +
  geom_jitter(alpha = .5) +
  geom_smooth(method = "lm", color = 'black') +
  scale_color_continuous(low = 'black', high = 'green') +
    labs(x= 'LGB policy score for country of origin', 
        y = 'Percentage of immigrants in same-sex couples')

state_plot_2 <- acs_dyad_policy %>%
  filter(same_prop <= 5) %>%
  ggplot(aes(x = origin_score, y = same_prop, color = mean_year_immig)) +
  geom_jitter(alpha = .5) +
  geom_smooth(method = "lm", color = 'black') +
  scale_color_continuous() +
    labs(x= 'LGB policy score for U.S. state of residence', 
        y = '')



state_plot_1 + state_plot_2

```

```{r desc-top1}
acs_couple_policy %>%
  filter(same_sex == T) %>%
  group_by(bpld) %>%
  count() %>%
  rename(`Birth country` = bpld) %>%
  arrange(desc(n)) %>%
  head(10) %>%
  kable(booktabs = T,
        caption = 'Top 10 sending countries of immigrants in same-sex couples in the American Community Survey 2008-2019') %>%
  kable_styling(latex_options = "hold_position")
```

```{r desc-top2}
acs_couple_policy %>%
  filter(same_sex == F)%>%
  group_by(bpld) %>%
  count() %>%
  rename(`Birth country` = bpld) %>%
  arrange(desc(n))%>%
  head(10) %>%
  kable(booktabs = T,
        caption = 'Top 10 sending countries of immigrants in different-sex couples in the American Community Survey 2008-2019') %>%
  kable_styling(latex_options = "hold_position")
```

```{r desc-fig, fig.cap = 'Additional descriptive statistics for immigrants in couples 2008-2019, with survey weights and 95% confidence intervals. All currency in 1000s of 1999 dollars.'}
hwsei <- acs_ind_survey %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(hwsei, vartype = "ci", na.rm = T)) %>%
  mutate(var_name = 'Hauser and Warren Socioeconomic Index')

nchild <- acs_ind_survey %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(nchild, vartype = "ci", na.rm = T)) %>%
  mutate(var_name = 'Number of Children')

years <- acs_ind_survey %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(years_in_us, vartype = "ci", na.rm = T)) %>%
  mutate(var_name = 'Years in U.S.')

distance <- acs_ind_survey %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(distw, vartype = "ci", na.rm = T)) %>%
  mutate(var_name = 'Distance to Country of Origin (KM)')

unemp <- acs_ind_survey %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(unemp_dif, vartype = "ci", na.rm = T)) %>%
  mutate(var_name = 'Difference in Unemployment Rates')

state_income <- acs_ind_survey %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(state_income, vartype = "ci", na.rm = T)) %>%
  mutate(var_name = 'U.S. State of Residence Per Capita Income')


bind_rows(hwsei, nchild, years, distance, unemp, state_income) %>%
  rename(Year = year) %>%
  ggplot(aes(x = Year, y = var, linetype = same_sex)) +
  geom_line() +
  geom_ribbon(aes(ymin = var_low, ymax = var_upp, group = same_sex, col = NULL), alpha = .2) +
  facet_wrap(~var_name, scales = "free", ncol = 2) +
  ylab('') +
  theme(#legend.justification=c(1,0),
      #legend.position=c(.24,.085)
    legend.position="bottom")
```

\newpage


# Robustness Checks

## Adjusting proportions based on empirical mismatch rates



Published papers using the ACS to study same-sex couples overwhelmingly use the method by @gates_2009 employed our main paper to adjust for misreporting. However here we implement a novel method to adjust proportions of estimated immigrants in same-sex couples, based on the estimated mismatch rates from two U.S. Census Bureau studies.  Beginning in 2019, the ACS provides explicit categories for "Opposite-sex husband/wife/spouse," "Opposite-sex unmarried partner," "Same-sex husband/wife/spouse," and "Same-sex unmarried partner" [@walker_2021], so sex misreporting in the 2019 data is unlikely. Hence in most sensitivity analyses below, 2019 estimates are not adjusted for misreporting.  

In a Census Bureau working paper, @kreider_2015 use personal information such as names and addresses match same-sex couples from the 2010 ACS to Social Security administrative data. They find that 57 percent of married couples coded as same-sex in the ACS are coded as different-sex in the administrative data. The corresponding sex mismatch rate for unmarried same-sex couples is 7 percent. (Our data include `r sum(acs_wide$related_partner == 'Spouse' & acs_wide$same_sex == T)` married and `r sum(acs_wide$related_partner == 'Unmarried Partner' & acs_wide$same_sex == T)` unmarried same-sex immigrant couples.) A follow-up study [@kreider_2017] shows that these mismatch rates appear to have fallen: In a 2016 ACS test module that included explicit categories for different- and same-sex spouses and partners, 31 percent of married and 3 percent of unmarried same-sex couples had inconsistent sex responses. This decreasing mismatch rate may be due to the greater numbers of same-sex couples openly identifying themselves as well as the growing popularity of responding to the ACS via Internet (see Supplementary Material), a response mode introduced in 2013 which is now the default [@u.s.censusbureau_2017]. In the 2016 test of the ACS, the mismatch rate for mail-in responses was 47 and 6 percent for married and unmarried same-sex couples, respectively, whereas for Internet responses they were only 22 and 2.4 percent [@kreider_2017]. A computer-assisted telephone interviewing (CATI) or computer-assisted personal interviewing (CAPI) response mode is sometimes administered as well, but the 2016 study did not assess its error rate. In the 2010 ACS, @kreider_2015 find CATI/CAPI sex reporting mismatch for 46 and 13 percent for married and unmarried same-sex couples, respectively. In our sample of immigrants in same-sex couples, `r sum(acs_couple_policy$respmode == 'Mail' & acs_couple_policy$same_sex == T)` responded by mail, `r with(filter(acs_couple_policy, same_sex == T), sum(respmode == 'CATI/CAPI'))` responded by CAPI/CATI, and `r sum(acs_couple_policy$respmode == 'Internet' & acs_couple_policy$same_sex == T)` responded by Internet survey. Response mode proportions by couple type are shown in Table \ref{tab:respmode}.  

Table \ref{tab:mismatch} shows the mismatch rates estimated by @kreider_2015 and @kreider_2015. In the supplemental analysis below (Table \ref{tab:country-props-adj}), we use these apparent mismatch rates to adjust proportions used in models in Table 3 of the main paper. Each proportion is adjusted separately by marital status and response mode. For example, all internet respondents coded as being in married same-sex couples have their final proportion reduced by 22.5%. For mail-in responses, the proportions are reduced by the average between the two studies (`r (59+47.4)/2` percent for married and `r (7+5.6)/2` percent for unmarried couples). 

```{r respmode}
tabyl(acs_couple_policy, respmode, year, same_sex) %>%
  adorn_percentages('col') %>%
  bind_rows() %>%
  mutate(same_sex = c(F, F, F, T, T, T)) %>%
  select(respmode, same_sex, everything()) %>%
  kable(booktabs = T,
        caption = 'Response mode proportions for different- and same-sex couples, by year. Proportions are within couple type and year.') %>%
  kable_styling(font_size = 9) %>%
  kable_styling(latex_options = "hold_position")
```

```{r mismatch}

tibble(`Study Year` = c(2010, 2010, 2016, 2016),
       Relationship = c('Married', 'Unmarried Partner', 'Married', 'Unmarried Partner'),
       `Mail` = c('59%', '7%', '47.4%', '5.6%'), 
       `Internet` = c('NA', 'NA', '22.5%', '2.4%'), 
       `CAPI/CATI` = c('46%', '13%', 'Unknown', 'Unknown'),
       Overall = c('57.3%', '7%', '35%', '3.4%')) %>%
  kable(booktabs = T, 
        caption = 'Mismatch rates from Kreider \\& Lofquist (2015) and Kreider et al. (2017)') %>%
      footnote(general = "American Community Survey 2008-2019. Authors\' calculations.",
           general_title = 'Source:',
           footnote_as_chunk = T)  %>%
  kable_styling(latex_options = "hold_position")
```

```{r country-props-adj}
ag <- lm(prop_same_sex_adj ~ origin_score,
         data = acs_prop_yrimmig_policy)


ag_country_orig <- lm(prop_same_sex_adj ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop,
         data = acs_prop_yrimmig_policy)

ag_country_orig_fe <- lm(prop_same_sex_adj ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld,
         data = acs_prop_yrimmig_policy)



ag_country_orig_fe_2013 <- lm(prop_same_sex_adj ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld +
                     post_2013,
         data = acs_prop_yrimmig_policy)


ag_2013_int_fe <- lm(prop_same_sex_adj ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem  + stock_prop + bpld +
                     post_2013*origin_score,
         data = acs_prop_yrimmig_policy)


mod_list <- list(ag, ag_country_orig, ag_country_orig_fe,
                 ag_country_orig_fe_2013, ag_2013_int_fe)
robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ bpld), 
                                     save = T)[, "Std. Error"]
}



stargazer(mod_list,
          header = F,
          model.names = F,
          keep = c('origin_score',  'post_2013'),
          order = paste0("^", c('origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('Country LGB policy score', 
                                'Post-2013', 'Country score × Post-2013'),
          dep.var.labels   = "Percent in same-sex couples by country-year",
          add.lines = list(c('Country controls?', 'no', rep('yes', 4)),
                           c('Country FEs?', 'no', 'no', rep('yes', 3))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{.8\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country-clustered standard errors shown in parentheses. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.}", 
                    "\\textit{Source}: American Community Survey 2008-2019"),
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:country-props-adj',
          title = 'OLS regressions of percent of immigrants in same-sex couples by year of immigration and country of origin, adjusted by rates of empirical sex mismatch by married, unmarried, and response mode. ')
```

```{r state-props-adj}

state_prop <- lm(prop_same_sex_adj ~ state_policy, data = acs_dyad_policy)

state_prop2 <- lm(prop_same_sex_adj ~ origin_score + state_policy, data = acs_dyad_policy)

state_prop_fe <- lm(prop_same_sex_adj ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_dyad_policy)

state_prop_fe2 <- lm(prop_same_sex_adj ~ state_policy*origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_dyad_policy)

state_prop_2013 <- lm(prop_same_sex_adj ~ post_2013 + state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013)))

state_prop_2013_int <- lm(prop_same_sex_adj ~ post_2013*origin_score + state_policy + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013)))

state_prop_2013_int2 <- lm(prop_same_sex_adj ~ post_2013*state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013)))


mod_list <- list(state_prop, state_prop2, state_prop_fe, state_prop_fe2, 
                 state_prop_2013, state_prop_2013_int2, state_prop_2013_int)


robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ state + Country), 
                                     save = T)[, "Std. Error"]
}



stargazer(mod_list,
          header = F, 
          keep = c('origin_score', 'state_policy', 'post_2013'),
          # omit = c('Country', 'state'),
          order = paste0("^", c('state_policy', 'origin_score', 
                                'state_policy:origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:state_policy', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('State LGB policy score', 'Country LGB policy score',
                                'State score × country-score', 'Post-2013', 
                               'State score × post-2013', 'Country score × post-2013'),
          dep.var.labels = "Percent in same-sex couples by state-country-year",
          add.lines = list(c('State controls and FEs?', 'no', 'no', rep('yes', 5)),
                           c('Country controls and FEs?', 'no', 'no', rep('yes', 5))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country and state two-way clustered standard errors are shown in parentheses. State controls include unemployment rate and per-capita income. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.}", 
                    "\\textit{Source}: American Community Survey 2008-2019"), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:state-props-adj',
          title = 'Adjusted by rates of empirical sex mismatch by married, unmarried, and response mode. Percent same-sex in by country of origin, U.S. state, and survey year.')

```


\newpage 

## Relative immmigrant population-weighted regressions
We perform the same regressions with proportion in same-sex couples by country or state, but weighted by the relative size of the immigrant stock.
```{r country-weights}
ag <- lm(prop_same_sex ~ origin_score,
         data = acs_prop_yrimmig_policy, weights = stock_prop)

ag_country_orig <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop,
         data = acs_prop_yrimmig_policy, weights = stock_prop)

ag_country_orig_fe <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld,
         data = acs_prop_yrimmig_policy, weights = stock_prop)



ag_country_orig_fe_2013 <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld +
                     post_2013,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)), weights = stock_prop)


ag_2013_int_fe <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem  + stock_prop + bpld +
                     post_2013*origin_score,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)), weights = stock_prop)



mod_list <- list(ag, ag_country_orig, ag_country_orig_fe,
                 ag_country_orig_fe_2013, ag_2013_int_fe)
robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ bpld), 
                                     save = T)[, "Std. Error"]
}


stargazer(mod_list,
          header = F,
          model.names = F,
          keep = c('origin_score',  'post_2013'),
          order = paste0("^", c('origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('Country LGB policy score',
                                'Post-2013', 'Country score × Post-2013'),
          dep.var.labels   = "Percent in same-sex couples by country-year",
          add.lines = list(c('Country controls?', 'no', rep('yes', 4)),
                           c('Country FEs?', 'no', 'no', rep('yes', 3))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{.8\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country-clustered standard errors shown in parentheses. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.}", 
                    "\\textit{Source}: American Community Survey 2008-2019"), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:country-props',
          title = 'Weighted OLS regressions of percent of immigrants in same-sex couples by year of immigration and country of origin.')

```


```{r country-n, eval = F}
ag <- lm(n_same_sex_coupled ~ origin_score,
         data = acs_prop_yrimmig_policy)

ag_country_orig <- lm(n_same_sex_coupled ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop,
         data = acs_prop_yrimmig_policy)

ag_country_orig_fe <- lm(n_same_sex_coupled ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld,
         data = acs_prop_yrimmig_policy)



ag_country_orig_fe_2013 <- lm(n_same_sex_coupled ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld +
                     post_2013,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))


ag_2013_int_fe <- lm(n_same_sex_coupled ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem  + stock_prop + bpld +
                     post_2013*origin_score,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))



mod_list <- list(ag, ag_country_orig, ag_country_orig_fe,
                 ag_country_orig_fe_2013, ag_2013_int_fe)
robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ bpld), 
                                     save = T)[, "Std. Error"]
}


stargazer(mod_list,
          header = F,
          model.names = F,
          keep = c('origin_score',  'post_2013'),
          order = paste0("^", c('origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('Country LGB policy score',
                                'Post-2013', 'Country score × Post-2013'),
          dep.var.labels   = "Number in same-sex couples by country-year",
          add.lines = list(c('Country controls?', 'no', rep('yes', 4)),
                           c('Country FEs?', 'no', 'no', rep('yes', 3))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{.8\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country-clustered standard errors shown in parentheses. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.}", 
                    "\\textit{Source}: American Community Survey 2008-2019"), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:country-n',
          title = 'OLS regressions of number of immigrants in same-sex couples by year of immigration and country of origin.')

```


```{r state-weights}
state_prop <- lm(same_prop ~ state_policy, data = acs_dyad_policy, weights = stock_prop)

state_prop2 <- lm(same_prop ~ origin_score + state_policy, data = acs_dyad_policy, weights = stock_prop)

state_prop_fe <- lm(same_prop ~ state_unemploy + state_income + state + 
                        origin_score + state_policy, 
                       data = acs_dyad_policy, weights = stock_prop)

state_prop_fe2 <- lm(same_prop ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_dyad_policy, weights = stock_prop)

state_prop_2013 <- lm(same_prop ~ post_2013 + state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013)), weights = stock_prop)

state_prop_2013_int <- lm(same_prop ~ post_2013*origin_score + state_policy + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013)), weights = stock_prop)



mod_list <- list(state_prop, state_prop2, state_prop_fe, state_prop_fe2, 
                 state_prop_2013, state_prop_2013_int)
robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ state + Country), 
                                     save = T)[, "Std. Error"]
}

stargazer(mod_list,
          header = F, 
          keep = c('origin_score', 'state_policy', 'post_2013'),
          # omit = c('Country', 'state'),
          order = paste0("^", c('state_policy', 'origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('State LGB policy score', 'Country LGB policy score',
                                'Post-2013', 'Country score × Post-2013'),
          dep.var.labels = "Percent in same-sex couples by state-country-year",
          add.lines = list(c('State controls and FEs?', 'no', 'no', rep('yes', 4)),
                           c('Country controls and FEs?', rep('no', 3), rep('yes', 3))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{.8\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country and state two-way clustered standard errors are shown in parentheses. State controls include unemployment rate and per-capita income. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.}", 
                    "\\textit{Source}: American Community Survey 2008-2019"), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:state-props',
          title = 'Weighted regression of percent same-sex in by country of origin, U.S. state, and survey year. ')
```

\newpage



## Alternate specifications of country proportion models
```{r country-props-alt}

# Spouse
ag_2013_spouse1 <- lm(prop_spouse_same_sex ~ distw + contig + comlang_off + 
                        comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld,
         data = acs_prop_yrimmig_policy)

# Spouse, + 2013
ag_2013_spouse2 <- lm(prop_spouse_same_sex ~ distw + contig + comlang_off + 
                        comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld +
                     post_2013,
         data = acs_prop_yrimmig_policy)

# Spouse + interaction
ag_2013_spouse_int <- lm(prop_spouse_same_sex ~ distw + contig + comlang_off + 
                           comlang_ethno + colony + bpld +
                   wage_dif + unemp_dif + vdem  + stock_prop +
                     post_2013*origin_score,
         data = acs_prop_yrimmig_policy)

# Quadratic
ag_2013_quad1 <- lm(prop_same_sex ~ distw + contig + comlang_off + 
                        comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + 
                     origin_squared + stock_prop + bpld,
         data = mutate(acs_prop_yrimmig_policy, 
                       post_2013 = (yrimmig > 2013),
                       origin_squared = origin_score^2))




# Quadratic, + 2013
ag_2013_quad2 <- lm(prop_same_sex ~ distw + contig + comlang_off + 
                        comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + origin_squared + 
                     stock_prop + bpld +
                     post_2013,
         data = mutate(acs_prop_yrimmig_policy, 
                       post_2013 = (yrimmig > 2013),
                       origin_squared = origin_score^2))

# # Quadratic + interaction
# ag_2013_quad_int <- lm(prop_same_sex ~ distw + contig + comlang_off + 
#                            comlang_ethno + colony + bpld +
#                    wage_dif + unemp_dif + vdem  + stock_prop +
#                      post_2013*origin_score + I(origin_score^2),
#          data = acs_prop_yrimmig_policy)


mod_list <- list(#ag_2013_quad1, ag_2013_quad2,
                 ag_2013_spouse1, ag_2013_spouse2, ag_2013_spouse_int)

robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ bpld), 
                                     save = T)[, "Std. Error"]
}

stargazer(mod_list,
          header = F, 
          model.names = F,
          keep = c('origin_score', 'origin_squared', 'post_2013'),
          order = paste0("^", c('origin_score', 
                                # 'origin_squared', 
                                'post_2013TRUE',
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('Country LGB policy score', 
                               # '(Country LGB policy score) $\\hat{}$ 2',
                                'Post-2013', 'Country score × Post-2013'),
          dep.var.labels   = c("Percentage same-sex (Married)"),
          add.lines = list(c('Country controls?', rep('yes', 3)),
                           c('Country FEs?', rep('yes', 3))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{.7\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country-clustered standard errors shown in parentheses. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and V-Dem measure of democracy.}", 
                    "\\textit{Source}: American Community Survey 2008-2019"), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:country-props-alt',
          title = 'Only married couples: Alternate specifications of OLS regressions of percent of immigrants in same-sex couples by year of immigration and country of origin.')
```


```{r fit, eval = F}
ag_country_orig_fe <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld,
         data = acs_prop_yrimmig_policy)

ag_country_orig_fe_2013 <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld +
                     post_2013,
         data = acs_prop_yrimmig_policy)

tibble(Model = c('Country proportions, linear', 'Country proportions, quadratic',
                     '+2013, linear', '+2013, quadratic'),
           'Log-likelihood' = c(logLik(ag_country_orig_fe), logLik(ag_2013_quad1),
                                logLik(ag_country_orig_fe_2013), logLik(ag_2013_quad2)),
           AIC = c(AIC(ag_country_orig_fe), AIC(ag_2013_quad1),
                   AIC(ag_country_orig_fe_2013), AIC(ag_2013_quad2)),
           BIC = c(BIC(ag_country_orig_fe), BIC(ag_2013_quad1),
                   BIC(ag_country_orig_fe_2013), BIC(ag_2013_quad2))) %>%
  kable(booktabs = T,
        caption = 'Goodness-of-fit statistics for linear and quadratic country proportion models.') %>%
  kable_styling(latex_options = "hold_position")
```

```{r country-props-recent}
ag <- lm(prop_same_sex_recent ~ origin_score,
         data = acs_prop_yrimmig_policy)

ag_country_orig <- lm(prop_same_sex_recent ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop,
         data = acs_prop_yrimmig_policy)

ag_country_orig_fe <- lm(prop_same_sex_recent ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld,
         data = acs_prop_yrimmig_policy)

ag_country_orig_fe_2013 <- lm(prop_same_sex_recent ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld +
                     post_2013,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))

ag_2013_int_fe <- lm(prop_same_sex_recent ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem  + stock_prop + bpld +
                     post_2013*origin_score,
         data = mutate(acs_prop_yrimmig_policy, post_2013 = (yrimmig > 2013)))

mod_list <- list(ag, ag_country_orig, ag_country_orig_fe,
                 ag_country_orig_fe_2013, ag_2013_int_fe)
robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ bpld), 
                                     save = T)[, "Std. Error"]
}

stargazer(mod_list,
          header = F,
          model.names = F,
          keep = c('origin_score',  'post_2013'),
          order = paste0("^", c('origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('Country LGB policy score',
                                'Post-2013', 'Country score × Post-2013'),
          dep.var.labels   = "Percent in same-sex couples by country-year",
          add.lines = list(c('Country controls?', 'no', rep('yes', 4)),
                           c('Country FEs?', 'no', 'no', rep('yes', 3))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{.8\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Recent immigrants are defined as those who immigrated in the year prior to the ACS survey year. Country-clustered standard errors shown in parentheses. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.}", 
                    "\\textit{Source}: American Community Survey 2008-2019"), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:country-props-pastyear',
          title = 'Only recent immigrants: Alternate specifications of OLS regressions of percent of immigrants in same-sex couples by year of immigration and country of origin.')
```

```{r country-props-alt2}
# One immigrant
ag_oneimm <- lm(prop_same_sex_oneimm ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld,
         data = acs_prop_yrimmig_policy)

ag_oneimm_2013 <- lm(prop_same_sex_oneimm ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + stock_prop + bpld + 
                     post_2013 + origin_score,
         data = acs_prop_yrimmig_policy)

ag_oneimm_2013_int <- lm(prop_same_sex_oneimm ~ distw + contig + comlang_off + 
                           comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + stock_prop + bpld + 
                     post_2013*origin_score,
         data = acs_prop_yrimmig_policy)


# Two immigrants
ag_twoimm <- lm(prop_same_sex_twoimm ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld,
         data = acs_prop_yrimmig_policy)

ag_twoimm_2013 <- lm(prop_same_sex_twoimm ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + stock_prop + bpld +
                     post_2013 + origin_score,
         data = acs_prop_yrimmig_policy)

ag_twoimm_2013_int <- lm(prop_same_sex_twoimm ~ distw + contig + comlang_off +
                           comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + stock_prop + bpld +
                     post_2013*origin_score,
         data = acs_prop_yrimmig_policy)



mod_list <- list(ag_oneimm, ag_oneimm_2013, ag_oneimm_2013_int,
                 ag_twoimm, ag_twoimm_2013, ag_twoimm_2013_int)

se_list <- list()
for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ bpld), 
                                     save = T)[,2]
}

stargazer(mod_list,
          header = F, 
          model.names = F,
          keep = c('origin_score', 'post_2013'),
          order = paste0("^", c('origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('Country LGB policy score', 
                                'Post-2013', 'Country score × Post-2013'),
          dep.var.labels   = c("Mixed-status", "Two immigrants"),
          add.lines = list(c('Country controls?', rep('yes', 6)),
                           c('Country FEs?', rep('yes', 6))),
          se = se_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. \"Mixed status\" refers to couples including one immigrant and one U.S.-born. Country-clustered standard errors shown in parentheses. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and V-Dem measure of democracy.}", 
                    "\\textit{Source}: American Community Survey 2008-2019"), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:country-props-alt2',
          title = 'Mixed-status or two-immigrant couples: Alternate specifications of OLS regressions of percent of immigrants in same-sex couples by year of immigration and country of origin.')
```




<!-- \newpage -->



<!-- ## OLS models of individual state of residence -->
```{r ols-ind, eval = F}

ols_basic <- lm(state_policy ~ same_sex,
                data = acs_couple_policy_small)
ols_orig <- lm(state_policy ~ same_sex*origin_score,
                data = acs_couple_policy_small)
ols_interact <- lm(state_policy ~ 
                       same_sex*(origin_score + gender + age + educ + 
                   nchild + ihs_income + no_income + yrimmig),
                data = rename(acs_couple_policy_small, gender = sex))

ols_interact_controls <- lm(state_policy ~ same_sex*(origin_score + gender + age + educ +
                     nchild + ihs_income + no_income + yrimmig) +
                     distw + contig + comlang_off + comlang_ethno +
                     wage_dif + unemp_dif + vdem + stock_prop +  #bpld + state +
                     state_unemploy + state_income ,
                data = rename(acs_couple_policy_small, gender = sex))

se_list <- list()
mod_list <- list(ols_basic, ols_orig, ols_interact, ols_interact_controls)
for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], 
                                     cluster = c('bpld', 'state')))[, "Std. Error"]
}


stargazer(mod_list,
          header = F, 
          add.lines = list(#c('Survey year FEs?', rep('yes', 3)),
                           c('Individual controls?', 'no', 'no', 'yes', 'yes'),
                           c('State controls and FEs?', 'no', 'no', 'no', 'yes'),
                           c('Country controls and FEs?', 'no', 'no', 'no', 'yes')),
          # se = se_list,
          omit = c('gender', 'age', 'educ', 'nchild', 'ihs_income', 'no_income', 
                   'yrimmig', 'Constant', 
                   'distw', 'contig', 'comlang_off', 'comlang_ethno',
                    'wage_dif', 'unemp_dif', 'vdem', 'stock_prop',
                     'state_unemploy', 'state_income', 'state', 'bpld'),
          dep.var.labels = c("Binned state LGB policy score"),
          covariate.labels = c('Same-sex', 'Country LGB policy score', 
                               'Same-sex × country score'),
          keep.stat = 'n',
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{.75\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country-clustered standard errors are shown in parentheses. Individual controls include sex, age, education, number of children, log(income), indicator for no income, and year of immigration, which are all interacted with the indicator for same-sex couple.}", 
                    "\\textit{Source}: American Community Survey 2008-2019"), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          #no.space = T,
          label = 'tab:ols',
          title = 'Individual OLS analysis of state policy score.')
```

```{r ols-ind-sim, eval = F}
## Simulation
set.seed(185)
sims <- 250
sim <- list()
sim_mod <- list(sims)
pseudeo_mod <- ols_interact_controls
k <- length(coef(ols_interact_controls))
sigma_twoway <- vcovCL(ols_interact_controls, cluster = ~ state + bpld)
theta_mat <- rmvnorm(sims, mean=ols_interact_controls$coefficients,
                              sigma = sigma_twoway)

var <- 'origin_score'

for (i in 1:sims) {
  # if(i %% 10 == 0) print(i)
  print(i)
  theta <- as.numeric(theta_mat[i,])
  pseudeo_mod$coefficients <- theta[1:k]
  pseudeo_mod$zeta <- theta[(k+1):length(theta)]

  for(same_loop in unique(acs_couple_policy_small$same_sex)){
      var_vals <- seq(min(acs_couple_policy_small[,var]), 
                      max(acs_couple_policy_small[,var]), 
                      length.out = 10)
      for(val in var_vals){
          sim_dat <- acs_couple_policy_small %>%
            rename(gender = sex) %>%
            select(all.vars(formula(ols_interact_controls)))
          sim_dat[, 'same_sex'] <- same_loop
          sim_dat[, var] <- val

          pred_dat <- predict(pseudeo_mod, newdata = sim_dat)
          # pred_dat <- data.frame(t(apply(pred_dat, 2, mean))) %>%
          #   pivot_longer(cols = everything(), names_to = 'state_policy', values_to = 'fit')
          
         sim[[paste0(var,same_loop, val, i)]] <-
          data.frame(fit = mean(pred_dat, na.rm = T),
                            same_sex = same_loop,
                            # variable = var,
                            origin_score = val)
      }
  }
}

sim_df <- bind_rows(sim) %>%
  group_by(same_sex, origin_score) %>%
  summarize(fit.low = quantile(fit, .025), fit.high = quantile(fit, .975), fit = mean(fit)) %>%
    mutate(same_sex = case_when(same_sex == T ~ 'Same-sex',
                                same_sex == F ~ 'Different-sex'))

write_csv(sim_df, here('supp', 'sim_df_ols.csv'))
```

```{r ols-ind-sim2, eval = F}

read_csv(here('supp', 'sim_df_ols.csv')) %>%
  ggplot(aes(x=origin_score, y=fit, col=same_sex)) +
  geom_line() + 
  geom_ribbon(aes(ymin=fit.low, ymax=fit.high, 
                  fill = same_sex, col = NULL), alpha = .2) +
  xlab('LGB policy score for country of origin') +
  ylab('Predicted U.S. state LGB policy score') +
  theme(legend.justification=c(1,0),
        legend.position=c(.95,.38))
```

\newpage

## Placebo Tests of Post-2013 Dichotomous Variable
```{r placebo-country, fig.cap = 'Country model placebo test of replacing the post-2013 dichotomous variable with 1991 through 2018, showing coefficient values with 95% confidence intervals.. Model numbers refer to Table 3 in the main paper.'}

placebo_list <- list()

for(year_loop in 1991:2018){
  placebo_list[[paste0(year_loop, 'simple')]] <- 
    lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                     wage_dif + unemp_dif + vdem + origin_score + stock_prop + post_year + bpld,
           data = mutate(acs_prop_yrimmig_policy, post_year = (yrimmig > year_loop))) %>%
    coeftest(vcov = vcovCL(., cluster = ~ bpld)) %>%
    tidy() %>% 
    filter(term %in% c('post_yearTRUE', 'post_yearTRUE:origin_score')) %>%
    mutate(model = '4: Simple', year = year_loop)
  
  placebo_list[[paste0(year_loop, 'int')]] <-  
    lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                     wage_dif + unemp_dif + vdem  + stock_prop + bpld +
                       post_year*origin_score,
           data = mutate(acs_prop_yrimmig_policy, post_year = (yrimmig > year_loop)))%>%
      coeftest(vcov = vcovCL(., cluster = ~ bpld)) %>%
    tidy() %>%
    filter(term %in% c('post_yearTRUE', 'post_yearTRUE:origin_score')) %>%
    mutate(model = '5: Interaction', year = year_loop) 
}
placebo_df <- bind_rows(placebo_list) %>%
    mutate(Coefficient = case_when(term == 'post_yearTRUE' ~ 'Post-year',
                          term == 'post_yearTRUE:origin_score' ~ 'Country score × post-year'),
         Coefficient = factor(Coefficient, levels = c('Post-year', 'Country score × post-year')))

placebo_df %>%
  ggplot(aes(x = year, y = estimate, color = Coefficient)) +
  geom_line() +
  geom_ribbon(aes(ymin = estimate - 1.96*std.error, ymax = estimate + 1.96*std.error, 
                  fill = Coefficient, col = NULL), alpha = .2) +
  geom_vline(xintercept = 2013, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 1) +
  facet_wrap(~model) +
  labs(x = 'Year for post-year variable', y = 'Estimate') +
  theme(legend.title = element_text(),
        legend.position="bottom")
```

```{r placebo-state, fig.cap = 'State model placebo test of replacing the post-2013 dichotomous variable with 2008 through 2018, showing coefficient values with 95% confidence intervals. Model numbers refer to Table 4 in the main paper.'}

placebo_list <- list()

for(year_loop in 2008:2018){
  placebo_list[[paste0(year_loop, 'simple')]]  <- 
    lm(same_prop ~ post_year + state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = mutate(acs_dyad_policy, post_year = (year > year_loop))) %>%
      coeftest(vcov = vcovCL(., cluster = ~ state + Country)) %>%
      tidy() %>% 
      filter(term %in% c('post_yearTRUE', 'post_yearTRUE:origin_score', 'post_yearTRUE:state_policy')) %>%
      mutate(model = '5: Simple', year = year_loop)

  placebo_list[[paste0(year_loop, 'int1')]]  <- 
    lm(same_prop ~ post_year*state_policy + origin_score + distw + contig + 
                            comlang_off + comlang_ethno + colony +
                            wage_dif + unemp_dif + vdem + stock_prop +
                             state_unemploy + state_income + Country + state, 
                         data = mutate(acs_dyad_policy, post_year = (year > year_loop))) %>%
      coeftest(vcov = vcovCL(., cluster = ~ state + Country)) %>%
      tidy() %>% 
      filter(term %in% c('post_yearTRUE', 'post_yearTRUE:origin_score', 'post_yearTRUE:state_policy')) %>%
      mutate(model = '6: State Interaction', year = year_loop)
  
  placebo_list[[paste0(year_loop, 'int2')]]  <- 
    lm(same_prop ~ post_year*origin_score + state_policy + distw + contig + 
                            comlang_off + comlang_ethno + colony +
                            wage_dif + unemp_dif + vdem + stock_prop +
                             state_unemploy + state_income + Country + state, 
                         data = mutate(acs_dyad_policy, post_year = (year > year_loop))) %>%
      summary(cluster = c("bpld")) %>%
      tidy() %>% 
      filter(term %in% c('post_yearTRUE', 'post_yearTRUE:origin_score', 'post_yearTRUE:state_policy')) %>%
      mutate(model = '7: Country Interaction', year = year_loop)
}
placebo_df2 <- bind_rows(placebo_list) %>%
  rename(`Year for post-year variable` = year, Estimate = estimate) %>%
  mutate(term = case_when(term == 'post_yearTRUE' ~ 'Post-year',
                          term == 'post_yearTRUE:origin_score' ~ 'Country score × post-year',
                          term == 'post_yearTRUE:state_policy' ~ 'State score × post-year'),
         Coefficient = factor(term, levels = c('Post-year', 'State score × post-year', 
                                               'Country score × post-year')))

placebo_df2 %>%
  ggplot(aes(x = `Year for post-year variable`, y = Estimate, color = Coefficient)) +
  geom_line() +
  geom_ribbon(aes(ymin = Estimate - 1.96*std.error, ymax = Estimate + 1.96*std.error, 
                  fill = Coefficient, col = NULL), alpha = .2) +
  geom_vline(xintercept = 2013, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 1) +
  facet_wrap(~model) +
  theme(legend.title = element_text(),
        legend.position="bottom")
```








\newpage




# Full Regression Tables
```{r country-props-full}
ag <- lm(prop_same_sex ~ origin_score,
         data = acs_prop_yrimmig_policy)


ag_country_orig <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop,
         data = acs_prop_yrimmig_policy)

ag_country_orig_fe <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld,
         data = acs_prop_yrimmig_policy)

ag_country_orig_fe_2013 <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld +
                     post_2013,
         data = acs_prop_yrimmig_policy)


ag_2013_int_fe <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem  + stock_prop + bpld +
                     post_2013*origin_score,
         data = acs_prop_yrimmig_policy)


mod_list <- list(ag, ag_country_orig, ag_country_orig_fe,
                 ag_country_orig_fe_2013, ag_2013_int_fe)

robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ bpld), 
                                     save = T)[, "Std. Error"]
}


stargazer(mod_list,
          header = F,
          model.names = F,
          omit = 'bpld',
          order = paste0("^", c('origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('Country LGB policy score',
                                'Post-2013', 
                               'Country score × Post-2013',
                               'Distance (km)',
                               'Contiguous border',
                               'Common official language',
                               'Common ethnic language',
                               'Ever colonial relationship',
                               'Per-cap. GDP difference',
                               'Unemployment difference',
                               'Liberal democracy (V-Dem)',
                               'Proportion same-country stock'),
          dep.var.labels   = "Percent in same-sex couples by country-year",
          add.lines = list(c('Country controls?', 'no', rep('yes', 4)),
                           c('Country FEs?', 'no', 'no', rep('yes', 3))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{.8\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country-clustered standard errors shown in parentheses.}", 
                    "\\textit{Source}: American Community Survey 2008-2019"), 
          no.space = T,
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:country-props-full',
          title = 'OLS regressions of percent of immigrants in same-sex couples by year of immigration and country of origin.')


```


```{r state-props-full}
state_prop <- lm(same_prop ~ state_policy, data = acs_dyad_policy)

state_prop2 <- lm(same_prop ~ origin_score + state_policy, data = acs_dyad_policy)



state_prop_fe <- lm(same_prop ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + bpld + sname, 
                       data = mutate(acs_dyad_policy, bpld = Country, sname = state))

state_prop_fe2 <- lm(same_prop ~ state_policy*origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + bpld + sname, 
                       data = mutate(acs_dyad_policy, bpld = Country, sname = state))

state_prop_2013 <- lm(same_prop ~ post_2013 + state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + bpld + sname, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013),bpld = Country, sname = state))

state_prop_2013_int <- lm(same_prop ~ post_2013*origin_score + state_policy + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + bpld + sname, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013),bpld = Country, sname = state))

state_prop_2013_int2 <- lm(same_prop ~ post_2013*state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + bpld + sname, 
                       data = mutate(acs_dyad_policy, post_2013 = (year > 2013), bpld = Country, sname = state))



mod_list <- list(state_prop, state_prop2, state_prop_fe, state_prop_fe2, 
                 state_prop_2013, state_prop_2013_int2, state_prop_2013_int)


robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ Country + state), 
                                     save = T)[, "Std. Error"]
}

stargazer(mod_list,
          header = F, 
          omit = c('bpld', 'sname'),
          order = paste0("^", c('state_policy', 'origin_score', 
                                'state_policy:origin_score', 'post_2013TRUE', 
                                'post_2013TRUE:state_policy', 
                                'post_2013TRUE:origin_score') , "$"),
          covariate.labels = c('State LGB policy score', 
                               'Country LGB policy score',
                               'State score × country-score', 
                               'Post-2013',
                               'State score × post-2013', 
                               'Country score × post-2013',
                               'Distance (km)',
                               'Contiguous border',
                               'Common official language',
                               'Common ethnic language',
                               'Ever colonial relationship',
                               'Per-cap. GDP difference',
                               'Unemployment difference',
                               'Liberal democracy (V-Dem)',
                               'Proportion same-country stock',
                               'State unemployment rate',
                               'State per-capita income'),
          dep.var.labels = "Percent in same-sex couples by state-country-year",
          add.lines = list(c('State controls and FEs?', 'no', 'no', rep('yes', 5)),
                           c('Country controls and FEs?', 'no', 'no', rep('yes', 5))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country and state two-way clustered standard errors are shown in parentheses.}", 
                     "\\textit{Source}: American Community Survey 2008-2019"), 
          no.space = T,
          column.sep.width = '2pt',
          font.size = 'footnotesize',
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:state-props-full',
          title = 'Percent same-sex in by country of origin, U.S. state, and survey year.')

```

```{r ord-full}

# ord_basic <- polr(state_policy_binned ~ same_sex,
#                 data = acs_couple_policy_small, Hess = T, weights = perwt/12)
ord_basic_controls <- polr(state_policy_binned ~ same_sex + sex + age + educ + 
                   nchild + ihs_income + no_income + yrimmig,
                 data = acs_couple_policy_small, Hess = T, weights = perwt/12)

# ord_orig <- polr(state_policy_binned ~ same_sex*origin_score,
#                 data = acs_couple_policy_small, Hess = T, weights = perwt/12)

ord_interact <- polr(state_policy_binned ~ 
                       same_sex*origin_score + sex + age + educ + 
                   nchild + ihs_income + no_income + yrimmig,
                data = acs_couple_policy_small, Hess = T, weights = perwt/12)

ord_interact_country <- polr(state_policy_binned ~ 
                                same_sex*origin_score + sex + age + educ +
                     nchild + ihs_income + no_income + yrimmig +
                     distw + contig + comlang_off + comlang_ethno + colony +
                     wage_dif + unemp_dif + vdem + stock_prop, 
                data = acs_couple_policy_small, Hess = T, weights = perwt/12)

ord_interact_controls <- polr(state_policy_binned ~ 
                                same_sex*origin_score + sex + age + educ +
                     nchild + ihs_income + no_income + yrimmig +
                     distw + contig + comlang_off + comlang_ethno + colony +
                     wage_dif + unemp_dif + vdem + stock_prop + #  bpld + state +
                     state_unemploy + state_income,
                data = acs_couple_policy_small, Hess = T, weights = perwt/12)

# ord_interact_state <- polr(state_policy_binned ~ 
#                                 same_sex*(origin_score + sex + age + educ +
#                      nchild + ihs_income + no_income + yrimmig) +
#                      state_unemploy + state_income,
#                 data = acs_couple_policy_small, Hess = T, weights = perwt/12)



mod_list <- list(ord_basic_controls, ord_interact, ord_interact_country, ord_interact_controls)

robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     #vcov = vcov(mod_list[[mod_num]]),
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ bpld), 
                                     save = T)[, "Std. Error"]
}


obs <- paste0(substr(nrow(acs_couple_policy_small), 1, 3), ',', 
              substr(nrow(acs_couple_policy_small), 4, 6))

stargazer(mod_list,
          header = F, 
          add.lines = list(#c('Survey year FEs?', rep('yes', 3)),
                           c('Individual controls?', 'no', 'no', 'yes', 'yes'),
                           c('State and country controls?', 'no', 'no', 'no', 'yes'),
                           c('Observations', rep(obs, length(mod_list)))
                           ),
          se = robust_list,
          dep.var.labels = c("Binned state LGB policy score"),
          # order = paste0("^", c('same_sex', 'origin_score', 'same_sexTRUE:origin_score') , "$"),
          covariate.labels = c('Same-sex',
                               'Country LGB policy score',
                               'Male',
                               'Age',
                               'Education: college',
                               'Education: high school',
                               'Education: some college',
                               'Number of children',
                               'IHS-transformed income',
                               'No income',
                               'Year of immigration',
                               'Distance (km)',
                               'Contiguous border',
                               'Common official language',
                               'Common ethnic language',
                               'Ever colonial relationship',
                               'Per-cap. GDP difference',
                               'Unemployment difference',
                               'Liberal democracy (V-Dem)',
                               'Proportion same-country stock',
                               'State unemployment rate',
                               'State per-capita income',
                               'Same-sex × country score'
          #                      'Same-sex × Male',
          #                      'Same-sex × Age',
          #                      'Same-sex × Education: college',
          #                      'Same-sex × Education: high school',
          #                      'Same-sex × Education: some college',
          #                      'Same-sex × Number of children',
          #                      'Same-sex × IHS-transformed income',
          #                      'Same-sex × No income',
          #                      'Same-sex × Year of immigration'
                                ),
          omit.stat = 'n',
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country-clustered standard errors are shown in parentheses.}", 
                     "\\textit{Source}: American Community Survey 2008-2019"),  
          no.space = T,
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          single.row = T,
          font.size = 'footnotesize',
          label = 'tab:ord-full',
          title = 'Individual ordered logit analysis of three-category state policy score.')
```


\newpage

# References
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\noindent


