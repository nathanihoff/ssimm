---
title: "Same-Sex Immigrant Couples"
subtitle: "Analyses"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  bookdown::pdf_document2:
    toc: yes
    number_sections: yes
    pandoc_args: !expr rmdfiltr::add_wordcount_filter(rmdfiltr::add_citeproc_filter(args = NULL))
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = T, results = 'asis',
                      cache.lazy = FALSE)
library(knitr)
library(RColorBrewer)
library(haven)
library(cowplot)
library(srvyr)
library(lmtest)
library(sandwich)
library(here)
library(plm)
library(stargazer)
library(tidyverse)

# theme_set(theme_cowplot(font_family = 'Palatino') + 
theme_set(theme_classic() + 
            theme(#legend.title=element_blank(), 
                  panel.grid.major.y = element_line('grey80'),
                  legend.background = element_rect(fill = "transparent")))
ggplot <- function(...) ggplot2::ggplot(...) #+ scale_color_brewer(palette="Dark2")

options(scipen=1, digits=2)
knit_hooks$set(inline = function(x) {
  prettyNum(x, big.mark=",")
})
```

```{r load, include = F}
# top_countries <- read_csv(here('data', 'top_countries.csv')) %>%
#   pull(1)
# top_countries <- c("Mexico", "India",  "Philippines", "China",              "El Salvador", "Vietnam",
#                    "Cuba",               "Korea",              "Dominican Republic", "Guatemala" ) 
# acs_wide <- read_csv(here('data', 'acs_wide.csv'))
# acs_oneimm <- read_csv(here('data', 'acs_oneimm.csv'))
# acs_coupled_imms <- read_csv(here('data', 'acs_coupled_imms.csv'))
acs_prop_yrimmig <- read_csv(here('data', 'acs_prop_yrimmig.csv'))

acs_dyad <- read_csv(here('data', 'acs_dyad.csv')) %>%
  mutate(mean_year_immig = ifelse(mean_year_immig >= 1991, 
                                  round(mean_year_immig),
                                  1991))

lgbt_policy <- read_csv(here('data', 'LGBT Data w IPUMS Code.csv')) %>%
  select(Country, year, Code, origin_score = total_score)
state_policy <- read_csv(here('data', 'state_policy.csv'))

state_policy[is.na(state_policy)] <- 0

state_policy <- state_policy %>%
  mutate(state_policy = -sodomy_illega + -marriage_ban + marriage_equality + civil_union + 
           employment_discrim_so + hate_crime_so + joint_adoption + -adoption_religious_freedom +
           conversion_therapy_ban + housing_discrim_so + state_ban_local_nondiscrimimation) %>%
  select(State, Year, state_policy)

acs_dyad_policy <- acs_dyad %>%
  left_join(lgbt_policy, by = c('mean_year_immig' = 'year', 'bpldid' = 'Code')) %>%
  left_join(state_policy,by = c('mean_year_immig' = 'Year', 'state' = 'State')) %>%
  filter(!is.na(origin_score))
```



# Aggregate data by year of immigration (focus on origin effects)
This analysis focuses on origin effects: how does the proportion of immigrants from country $x$ in year $y$ vary by origin-country LGBT policy? For this analysis we pool all available years of ACS data, so we are unable to use survey weights. The proportion is multiplied by 100 to be interpretable as percentage points. 

```{r agg-yrimmig}
acs_prop_yrimmig_policy <- acs_prop_yrimmig %>%
  left_join(lgbt_policy, by = c('yrimmig' = 'year', 'bpldid' = 'Code')) %>%
  filter(!is.na(origin_score)) %>%
  mutate(prop_same_sex = prop_same_sex*100,
         prop_dif_sex = prop_dif_sex*100,
         prop_same_std = (prop_same_sex - mean(prop_same_sex))/sd(prop_same_sex),
         prop_dif_std = (prop_dif_sex - mean(prop_dif_sex))/sd(prop_dif_sex),
         origin_std = (origin_score - mean(origin_score))/sd(origin_score))

ag <- lm(prop_same_sex ~ origin_score, data = acs_prop_yrimmig_policy)
ag_time <- lm(prop_same_sex ~ origin_score + yrimmig, data = acs_prop_yrimmig_policy)
ag_time2 <- lm(prop_same_sex ~ origin_score + yrimmig + I(yrimmig^2), data = acs_prop_yrimmig_policy)

ag_std <- lm(prop_same_std ~ origin_std, data = acs_prop_yrimmig_policy)
ag_time_std <- lm(prop_same_std ~ origin_std + yrimmig, data = acs_prop_yrimmig_policy)
ag_time2_std <- lm(prop_same_std ~ origin_std + yrimmig + I(yrimmig^2), data = acs_prop_yrimmig_policy)

stargazer(ag, ag_time, ag_time2, ag_std, ag_time_std, ag_time2_std,
          header = F, 
          keep.stat = c('n', 'rsq'),
          label = 'tab:agg-yrimmig',
          title = '100*Proportion same-sex in a country-year of immigration')

```

```{r dif-agg-yrimmig}
ag <- lm(prop_dif_sex ~ origin_score, data = acs_prop_yrimmig_policy)
ag_time <- lm(prop_dif_sex ~ origin_score + yrimmig, data = acs_prop_yrimmig_policy)
ag_time2 <- lm(prop_dif_sex ~ origin_score + yrimmig + I(yrimmig^2), data = acs_prop_yrimmig_policy)

ag_std <- lm(prop_dif_std ~ origin_std, data = acs_prop_yrimmig_policy)
ag_time_std <- lm(prop_dif_std ~ origin_std + yrimmig, data = acs_prop_yrimmig_policy)
ag_time2_std <- lm(prop_dif_std ~ origin_std + yrimmig + I(yrimmig^2), data = acs_prop_yrimmig_policy)

stargazer(ag, ag_time, ag_time2, ag_std, ag_time_std, ag_time2_std,
          header = F, 
          keep.stat = c('n', 'rsq'),
          label = 'tab:dif-agg-yrimmig',
          title = '100*Proportion different-sex in a country-year of immigration')

```




# Dyadic data: by survey year (focus on state effects)
We reshape the data so that is yearly dyads: each observation is the proportion of immigrants that is in same-sex couples out of all those from country $x$ in state $y$ in survey year $z$ (using survey weights). We multiply this proportion by 100 for interpretability as percentage points. We merge in the sending-country policy index for the average year of immigration for these immigrants.  
```{r same-fixed, results = 'asis'}
acs_dyad_policy$same_prop <- acs_dyad_policy$same_sex_stock/acs_dyad_policy$state_stock_year * 100
acs_dyad_policy$dif_prop <- acs_dyad_policy$opp_sex_stock/acs_dyad_policy$state_stock_year * 100

# Same-sex models
same_dyad_origin <- lm(same_prop ~ origin_score, data = acs_dyad_policy)
same_dyad_state <- lm(same_prop ~ state_policy, data = acs_dyad_policy)
same_dyad_origin_state <- lm(same_prop ~ origin_score + state_policy, data = acs_dyad_policy)
same_dyad_fixed_state <- lm(same_prop ~ origin_score + state_policy + state, data = acs_dyad_policy)
same_dyad_fixed_state_year <- lm(same_prop ~ origin_score + state_policy + state + as.factor(year), data = acs_dyad_policy)
same_dyad_stock <- lm(same_prop ~ origin_score + state_policy + state_stock_year + state + as.factor(year), data = acs_dyad_policy)

stargazer(same_dyad_origin, same_dyad_state, same_dyad_origin_state, same_dyad_fixed_state,
          same_dyad_fixed_state_year, same_dyad_stock,
          header = F, 
          keep = c('origin_score', 'state_policy', 'state_stock_year'),
          add.lines = list(c('State FEs?', 'no', 'no', 'no', 'yes', 'yes', 'yes'),
                           c('Year FEs?', 'no', 'no', 'no', 'no', 'yes', 'yes')),
          keep.stat = c('n', 'rsq'),
          label = 'tab:same-fixed',
          title = '100*Proportion same-sex in a country-state-year')
```

```{r dif-fixed, results = 'asis', eval = T} 
# Diff-sex "placebo" models
dif_dyad_origin <- lm(dif_prop ~ origin_score, data = acs_dyad_policy)
dif_dyad_state <- lm(dif_prop ~ state_policy, data = acs_dyad_policy)
dif_dyad_origin_state <- lm(dif_prop ~ origin_score + state_policy, data = acs_dyad_policy)
dif_dyad_fixed_state <- lm(dif_prop ~ origin_score + state_policy + state, data = acs_dyad_policy)
dif_dyad_fixed_state_year <- lm(dif_prop ~ origin_score + state_policy + state + as.factor(year), data = acs_dyad_policy)
dif_dyad_stock <- lm(dif_prop ~ origin_score + state_policy + state_stock_year + state + as.factor(year), data = acs_dyad_policy)


stargazer(dif_dyad_origin, dif_dyad_state, dif_dyad_origin_state, dif_dyad_fixed_state,
          dif_dyad_fixed_state_year, dif_dyad_stock,
          header = F, 
          keep = c('origin_score', 'state_policy', 'state_stock_year'),
          add.lines = list(c('State FEs?', 'no', 'no', 'no', 'yes', 'yes', 'yes'),
                           c('Year FEs?', 'no', 'no', 'no', 'no', 'yes', 'yes')),
          keep.stat = c('n', 'rsq'), 
          label = 'tab:dif-fixed',
          title = '100*Proportion different-sex in a country-state-year')

percent_same_sex <- sum(acs_dyad$same_sex_stock)/sum(acs_dyad$state_stock_year) *100

```
Table \ref{tab:same-fixed} shows a significant, positive effect for LGBT policy score of the host country, implying that an increase in policy friendliness by 1 point in an origin country is associated with a 0.04 to 0.06 percentage point increase in proportion of immigrants from that country in same-sex couples. Since the proportion of immigrants in same-sex couples is only `r percent_same_sex` percent, this constitutes a substantive effect. LGB immigrants tend to come from countries with more queer-friendly policies. The coefficient for state policy is insignificant in most models.  

As a comparison, Table \ref{tab:dif-fixed} fits the same models, but with proportion immigrants in different-sex couples as an outcome. Interestingly, here origin score is in the opposite direction, and state policy is now significant, and highly positive when fixed effects are included. This implies that immigrants in different-sex couples are more likely to come from countries with more oppressive LGBT laws and tend to live in more accepting areas in the U.S. This could be because these areas are more accepting generally, including to immigrants.


# Individual analysis 

```{r, eval = F}
# state policy as outcome, individual level


state_policy <- read_csv(here('data', 'state_policy.csv'))

state_policy[is.na(state_policy)] <- 0

state_policy <- state_policy %>%
  mutate(state_policy = -sodomy_illega + -marriage_ban + marriage_equality + civil_union + 
           employment_discrim_so + hate_crime_so + joint_adoption + -adoption_religious_freedom +
           conversion_therapy_ban + housing_discrim_so + state_ban_local_nondiscrimimation) %>%
  select(State, Year, state_policy)

hist(state_policy$state_policy)

state_policy$cat <- cut(state_policy$state_policy, breaks = c(-2,0,2, Inf), labels = c("Repressive", "Neutral", "Progressive"))    

## Getting this onto the ACS data now
acs_coupled_imms <- read.csv(here("data", "acs_coupled_imms.csv")) %>%
  mutate(yrimmig = ifelse(yrimmig >= 1991, 
                                  round(yrimmig),
                                  1991))

lgbt_policy <- read_csv(here('data', 'LGBT Data w IPUMS Code.csv')) %>%
  select(Country, year, Code, origin_score = total_score)

acs_couple_policy <- acs_coupled_imms  %>%
  left_join(lgbt_policy, by = c('yrimmig' = 'year', 'bpldid' = 'Code')) %>%
  left_join(state_policy,by = c('year' = 'Year', 'state' = 'State')) %>%
  mutate(log_income = ifelse(ftotinc >=0, log(ftotinc+1), 1),
         no_income = (log_income == log(1)))

lm(state_policy ~ age + factor(educ) + factor(same_sex)*origin_score + factor(nchild) + yrimmig,
   data = acs_couple_policy) %>%
  summary()

lm(state_policy ~ age  + same_sex*(origin_score + log_income + no_income) + yrimmig,
   data = acs_couple_policy) %>%
  summary()


```

