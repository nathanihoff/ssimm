---
title: "Same-Sex Immigrant Couples"
subtitle: "Descriptive Statistics"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, cache = F,
                      cache.lazy = FALSE)

library(RColorBrewer)
library(haven)
library(cowplot)
library(srvyr)
library(here)
library(tidyverse)

# theme_set(theme_cowplot(font_family = 'Palatino') + 
theme_set(theme_classic() + 
            theme(#legend.title=element_blank(), 
                  panel.grid.major.y = element_line('grey80'),
                  legend.background = element_rect(fill = "transparent")))
ggplot <- function(...) ggplot2::ggplot(...) #+ scale_color_brewer(palette="Dark2")

options(scipen=999)
```

```{r load}
top_countries <- read_csv(here('data', 'top_countries.csv')) %>%
  pull(1)
# top_countries <- c("Mexico", "India",  "Philippines", "China",              "El Salvador", "Vietnam",
#                    "Cuba",               "Korea",              "Dominican Republic", "Guatemala" ) 
acs_wide <- read_csv(here('data', 'acs_wide.csv'))
acs_oneimm <- read_csv(here('data', 'acs_oneimm.csv'))

acs_oneimm <- read_csv(here('data', 'acs_oneimm.csv'))
acs_coupled_imms <- read_csv(here('data', 'acs_coupled_imms.csv'))


acs_coupled_imms <- acs_coupled_imms %>%
  filter(older18 == T) %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same Sex', 'Different Sex')) %>%
  mutate(years_in_us = year - yrimmig) 

```

# Scale of migration
## Different- and same-sex couples containing one or two immigrants
```{r}
acs_wide %>%
  filter(imm_couple != "none") %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, imm_couple, same_sex) %>%
  count(wt = hhwt) %>%
  mutate(`Total population (thousands)` = n/1000,
         Year = year) %>%
  # summarize(n = survey_total())
  ggplot(aes(x = Year, y = `Total population (thousands)`, color = imm_couple)) +
  geom_line() + geom_point() +
  facet_wrap(~same_sex, scales = "free") +
  labs(color = 'Number of immigrants\nin couple') +
  xlim(2007, 2019) +
  theme(legend.position=c(.15,.35))
  # ggtitle('Total couples with immigrants')
```

## Only 18+ at time of immigration
```{r}
acs_wide %>%
  filter(imm_couple != "none") %>%
  filter(as.numeric(age_main) - (year - yrimmig_main) >= 18 |
           as.numeric(age_partner) - (year - yrimmig_partner) >= 18) %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, imm_couple, same_sex) %>%
  count(wt = hhwt) %>%
  mutate(`Total population (thousands)` = n/1000,
         Year = year) %>%
  # summarize(n = survey_total())
  ggplot(aes(x = Year, y = `Total population (thousands)`, color = imm_couple)) +
  geom_line() + geom_point() +
  facet_wrap(~same_sex, scales = "free") +
  labs(color = 'Number of immigrants\nin couple') +
  xlim(2007, 2019) +
  theme(legend.position=c(.15,.35))
```

## Immigrants within last year
```{r}
acs_wide %>%
  filter(imm_couple != "none") %>%
  filter(year - yrimmig_partner <= 1 | year - yrimmig_main <= 1) %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, imm_couple, same_sex) %>%
  count(wt = hhwt) %>%
  mutate(`Total population (thousands)` = n/1000,
         Year = year) %>%
  # summarize(n = survey_total())
  ggplot(aes(x = Year, y = `Total population (thousands)`, color = imm_couple)) +
  geom_line() + geom_point() +
  facet_wrap(~same_sex, scales = "free") +
  labs(color = 'Number of immigrants\nin couple') +
  xlim(2007, 2019) +
  theme(legend.position=c(.15,.35))
```



# Differences in characteristics between immigrants in same- and opposite-sex couples
## Income
```{r}
acs_coupled_imms %>%
  group_by(year, same_sex) %>%
  summarize(inctot = weighted.mean(inctot, w = hhwt, na.rm = T)) %>%
  ggplot(aes(x = year, y = inctot)) +
  geom_line() +
  facet_wrap(~same_sex) +
  ggtitle('Total Income')
```


## Occupational score
```{r}
acs_coupled_imms %>%
  group_by(year, same_sex) %>%
  summarize(occscore = weighted.mean(occscore, w = hhwt, na.rm = T)) %>%
  ggplot(aes(x = year, y = occscore)) +
  geom_line() +
  facet_wrap(~same_sex) +
  ggtitle('Occupational Score')
```

## Years in US
```{r}
acs_coupled_imms %>%
  ggplot(aes(x = years_in_us)) +
  geom_histogram() +
  facet_wrap(~same_sex, scales = 'free', nrow = 2) +
  ggtitle('Years in US')

acs_coupled_imms %>%
  ggplot(aes(x = years_in_us)) +
  geom_histogram() +
  facet_wrap(~same_sex + year, scales = 'free') +
  ggtitle('Years in US')

acs_coupled_imms %>%
  group_by(year, same_sex) %>%
  summarize(years_in_us = weighted.mean(years_in_us, w = hhwt, na.rm = T)) %>%
  ggplot(aes(x = year, y = years_in_us)) +
  geom_line() +
  facet_wrap(~same_sex) +
  ggtitle('Years in US')


```

## Education
```{r}
acs_coupled_imms %>%
  group_by(year, same_sex, educ) %>%
  count(wt = hhwt) %>%
  ggplot(aes(x = year, y = n, fill = educ)) +
  geom_bar(position="fill", stat="identity") +
  facet_wrap(~same_sex) +
  ggtitle('Education')
```










