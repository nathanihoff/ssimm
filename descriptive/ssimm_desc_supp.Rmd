---
output:
  bookdown::pdf_document2:
    toc: yes
    number_sections: yes
    pandoc_args: !expr rmdfiltr::add_wordcount_filter(rmdfiltr::add_citeproc_filter(args = NULL))
    latex_engine: xelatex
    keep_tex: no
    extra_dependencies: ["float"]
    #template: svm-latex-ms.tex
# output: 
#   pdf_document:
#     citation_package: natbib
#     keep_tex: true
#     fig_caption: true
#     latex_engine: pdflatex
#     template: svm-latex-ms.tex
header-includes:
  # - \usepackage{setspace}\doublespace
  # - \usepackage{endnotes}
  #- \let\footnote=\endnote
  #- \usepackage{endfloat}
  # - \usepackage{fancyhdr}
  # - \pagestyle{fancy}
  # - \setlength{\headheight}{13.6pt}
  # - \rhead{\textit{Hoffmann and Velasco}}
  # - \lhead{\textit{`r format(Sys.time(), '%B %e, %Y')`}}
  - \usepackage{float}
  # - \let\counterwithout\relax
  # - \let\counterwithin\relax
  # - \usepackage{chngcntr}
  - \counterwithin{figure}{section}
  - \counterwithin{table}{section}
  # - \usepackage{flafter}
editor_options: 
  
  chunk_output_type: console
citeproc: no
fontfamily: mathpazo
fontsize: 11pt
geometry: margin=1in
indent: yes
link-citations: yes
linkcolor: blue
bibliography: zotero.bib  
csl: apa.csl
title: "Online Appendix"
subtitle:  "Sexuality, Migration, and LGB Policy: A Portrait of Immigrants in Same-Sex Couples in the United States"
# date: "`r format(Sys.time(), '%B %e, %Y')`"
 
# author:
# - Nathan I. Hoffmann, Department of Sociology, University of California, Los Angeles
# - Kristopher Velasco, Department of Sociology, Princeton University
---

<!-- Turn off hyphenation -->
<!-- \usepackage[none]{hyphenat} -->


```{r setup, include=F}
knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = T, results = 'asis',
                      cache.lazy = F)
# knitr::opts_chunk$set(fig.pos = "h", out.extra = "")

library(huxtable)
library(broom)
library(janitor)
library(priceR)
library(kableExtra)
library(sjstats)
library(imputeTS)
library(mvtnorm)
library(ordinal)
library(lme4)
library(MASS)
library(countrycode)
library(knitr)
library(RColorBrewer)
library(haven)
library(cowplot)
library(srvyr)
library(lmtest)
library(sandwich)
library(here)
library(plm)
library(patchwork)
library(stargazer)
library(gtsummary)
library(tidyverse)

# knitr::opts_chunk$set(error=TRUE) 

options("yaml.eval.expr" = TRUE)

# theme_set(theme_cowplot(font_family = 'Palatino') + 
theme_set(theme_classic(base_family = 'Palatino') + 
            theme(legend.title=element_blank(), 
                  panel.grid.major.y = element_line('grey80'),
                  legend.background = element_rect(fill = "transparent")))
ggplot <- function(...) ggplot2::ggplot(...) + scale_color_brewer(palette="Dark2") + 
  scale_fill_brewer(palette="Dark2")

options(scipen=1, digits=3)
knit_hooks$set(inline = function(x) {
  prettyNum(x, big.mark=",")
})
knitr::opts_chunk$set(error=TRUE) 


```

```{r load, include = F}
country_tab_ci <- read_csv(here('descriptive/files', 'country_tab_ci.csv'))
state_tab_ci <- read_csv(here('descriptive/files', 'state_tab_ci.csv'))

countries_ex <- country_tab_ci %>%
  filter(n >= 150) %>%
  pull(bpld)

states_ex <- state_tab_ci %>%
  filter(n >= 500) %>%
  pull(state)

acs_wide <- read.csv(here('data', 'acs_wide.csv'))
acs_ind <- readRDS(here('data', 'acs_ind.rds')) 
acs_prop <- read.csv(here('data', 'acs_prop.csv')) %>%
  mutate(post_2013 = (yrimmig > 2013)) 
acs_prop_state <- read.csv(here('data', 'acs_prop_state.csv')) %>%
  mutate(post_2013 = (year > 2013)) %>%
  filter(bpld %in% countries_ex,
         state %in% states_ex)


income_country <- acs_ind %>%
  group_by(year, bpld) %>%
  summarize(income_country = weighted.mean(inctot, perwt, na.rm = T)) 

hs_country <- acs_ind %>%
  mutate(hs = if_else(educ %in% c('HS', 'some col', 'college'), 1, 0)) %>%
  group_by(year, bpld) %>%
  summarize(hs_country = weighted.mean(hs, perwt, na.rm = T)) 

college_country <- acs_ind %>%
  mutate(college = if_else(educ == 'college', 1, 0)) %>%
  group_by(year, bpld) %>%
  summarize(college_country = weighted.mean(college, perwt, na.rm = T)) 

hwsei_country <- acs_ind %>%
  group_by(year, bpld) %>%
  summarize(hwsei_country = weighted.mean(hwsei, perwt, na.rm = T)) 


acs_ind <- acs_ind %>%
  left_join(income_country) %>%
  left_join(hs_country) %>%
  left_join(college_country) %>%
  left_join(hwsei_country)



acs_wide_survey <- acs_wide %>% as_survey_design(ids = cluster, weights = hhwt)
acs_ind_survey <- acs_ind %>% as_survey_design(ids = cluster, weights = perwt)

```

# (APPENDIX) Appendix {-} 

# Descriptive Statistics


```{r desc-table-state}

acs_prop_state %>%
  select(`Percent in same-sex couples` = prop_same_sex, `State LGB policy score` = state_policy,
         `Country LGB policy score` = origin_score,
         `Distance (km)` = distw, 
         `Contiguous border` = contig, `Common official language` = comlang_off, 
         `Common ethnic language` = comlang_ethno, `Ever colonial relationship` = colony,
         `Per-cap. GDP difference` = wage_dif, `Unemployment difference` = unemp_dif, 
         `Liberal democracy (V-Dem)` = vdem, `Proportion same-country stock` = stock_prop,
         `State unemployment rate` = state_unemploy, `State per-capita income` = state_income) %>%
  tbl_summary() %>%
  modify_caption('Summary statistics for state-country-survey year analysis, the data used in Table 3 in the main paper.')  %>%
  as_kable_extra(booktabs = T, linesep = "") %>%
  kable_styling(latex_options = "hold_position")
```

```{r desc-table-ind-calc}
desc_table_ind <- acs_ind %>%
  labelled::remove_labels() %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-sex', 'Different-sex'),
         state_policy = as.numeric(state_policy),
         educ = factor(educ, levels = c('< HS', 'HS', 'some col', 'college'))) %>%
  as_survey_design(ids = cluster, weights = perwt) %>%
  select(`Same-sex` = same_sex,
         `Country LGB policy score` = origin_score, `State LGB policy` = state_policy, 
         `Sex` = sex, `Age` = age, `Education` = educ,
         `Number of children` = nchild, `Annual gross income (thousands)` = inctot, 
         `IHS-transformed income` = ihs_income, 
         `No income` = no_income, `Year of immigration` = yrimmig,
         `Distance (km)` = distw, 
         `Contiguous border` = contig, `Common official language` = comlang_off, 
         `Common ethnic language` = comlang_ethno, `Ever colonial relationship` = colony,
         `Per-cap. GDP difference` = wage_dif, `Unemployment difference` = unemp_dif, 
         `Liberal democracy (V-Dem)` = vdem, `Proportion same-country stock` = stock_prop,
         `State unemployment rate` = state_unemploy, `State per-capita income` = state_income) %>%
  tbl_svysummary(by = `Same-sex`, 
                 type = list(`State LGB policy` ~ "continuous"),
                 digits = list(`Year of immigration` ~ 
                                 function(x) style_number(x, big.mark = ''))) %>%
  # add_overall() %>%
  modify_caption('Summary statistics for individual-level dataset, with survey weights applied')


# write_rds(desc_table_ind, here('descriptive', 'desc_table_ind.rds'))
# read_rds(here('descriptive', 'desc_table_ind.tex'))
```

```{r desc-table-ind}
desc_table_ind %>%
  as_kable_extra(booktabs = T, linesep = "") %>%
  kable_styling(latex_options = "hold_position")
  # kableExtra::save_kable(here('descriptive', 'desc_table_ind.tex'))

select(acs_prop_state, state, bpld, year, origin_score, origin_score_lag, 
       state_policy, state_policy_lag) %>% View()
```

\newpage

# Additional Descriptive Trends
Figure \ref{fig:desc-fig} examines within-country selection. For each immigrant in the dataset, it subtracts off their year- and country-level average for high school completion, college completion, annual income, and occupational prestige score. The figure displays results separately for immigrants in same- and different-sex couples. The lines for different-sex couples are nearly 0, since they are the overwhelming majority in the dataset. The lines for same-sex couples show clear positive selection relative to other immigrants from that country.  

Figure \ref{fig:scatter-state} relies on the data used in the regression models, with the vertical axis showing the proportion of immigrants from each country in same-sex couples in each state, in each survey year, from 2008 to 2019. In the left panel, the horizontal axis represents the origin country policy score in the mean year of immigration for that group, while the right panel's horizontal axis represents the state policy score in the survey year. The lines shows the bivariate regression lines.  

Finally, Tables \@ref(tab:desc-top-same) and \@ref(tab:desc-top-dif) show the top sending countries in the data by absolute numbers of same- and different-sex couples. Although there are some differences, the most common sending countries for immigrants to the U.S. dominate the lists.


```{r desc-fig, fig.cap = 'Selection descriptive statistics for immigrants in couples 2008-2019, with survey weights and 95% confidence intervals. Each panel subtracts the ACS year- and country-level average from each immigrant originating from that country. Values above 0 indicate positive selection. All currency in 1000s of 1999 dollars.'}


income <- acs_ind_survey %>%
  mutate(same_sex = if_else(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(inctot - income_country, vartype = "ci", na.rm = T)) %>%
  mutate(var_name = 'C. Annual Gross Income (Thousands)')

hs <- acs_ind_survey %>%
  mutate(same_sex = if_else(same_sex == T, 'Same-Sex', 'Different-Sex'),
         hs = if_else(educ %in% c('HS', 'some col', 'college'), 1, 0)) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(hs - hs_country, vartype = "ci", na.rm = T) ) %>%
  mutate(var_name = 'A. High School Completion')

college <- acs_ind_survey %>%
  mutate(same_sex = if_else(same_sex == T, 'Same-Sex', 'Different-Sex'),
         college = if_else(educ == 'college', 1, 0)) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(college - college_country, vartype = "ci", na.rm = T)) %>%
  mutate(var_name = 'B. College Completion')

hwsei <- acs_ind_survey %>%
  mutate(same_sex = if_else(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(var = survey_mean(hwsei - hwsei_country, vartype = "ci", na.rm = T)) %>%
  mutate(var_name = 'D. Hauser and Warren Socioeconomic Index')


bind_rows(income, hs, college, hwsei) %>%
  rename(Year = year) %>%
  ggplot(aes(x = Year, y = var, linetype = same_sex)) +
  geom_line() +
  geom_ribbon(aes(ymin = var_low, ymax = var_upp, group = same_sex, col = NULL), alpha = .2) +
  facet_wrap(~var_name, scales = "free", ncol = 2) +
  ylab('') +
  theme( # legend.justification=c(1,0),
  #     legend.position=c(.22,.82),
  #     legend.background = element_rect(fill = alpha("white", 0.5))
      legend.position="bottom",
      text = element_text(size = 8))


```

```{r scatter-state, fig.cap = "Proportion of immigrants from each country in same-sex couples in each state, in each survey year, from 2008 to 2019. The left panel's horizontal axis represents the origin country policy score in the mean year of immigration for that group, while the right panel's horizontal axis represents the state policy score in the survey year. Points are jittered for clarity, and percentages above 5 are not shown."}
state_plot_1 <- acs_prop_state %>%
  filter(prop_same_sex <= 5) %>%
  ggplot(aes(x = state_policy, y = prop_same_sex, color = year)) +
  geom_jitter(alpha = .5) +
  geom_smooth(method = "lm", color = 'black') +
  scale_color_continuous(low = 'black', high = 'green') +
    labs(x= 'LGB policy score for country of origin', 
        y = 'Percentage of immigrants in same-sex couples')

state_plot_2 <- acs_prop_state %>%
  filter(prop_same_sex <= 5) %>%
  ggplot(aes(x = origin_score, y = prop_same_sex, color = mean_year_immig)) +
  geom_jitter(alpha = .5) +
  geom_smooth(method = "lm", color = 'black') +
  scale_color_continuous() +
    labs(x= 'LGB policy score for U.S. state of residence', 
        y = '')



state_plot_1 + state_plot_2

```

```{r desc-top-same}
acs_ind %>%
  filter(same_sex == T) %>%
  group_by(bpld) %>%
  summarize(n = n(),
            nw = sum(perwt)) %>%
    arrange(desc(n)) %>%
  rename(`Birth country` = bpld,
          `n same-sex (unweighted)` = n,
         `n same-sex (weighted)` = nw) %>%
  head(10) %>%
  kable(booktabs = T, format.args = list(big.mark = ","), linesep = "",
        caption = 'Top 10 sending countries of immigrants in same-sex couples in the American Community Survey 2008-2019') %>%
  kable_styling(latex_options = "hold_position")
```

```{r desc-top-dif}
acs_ind %>%
  filter(same_sex == F)%>%
  group_by(bpld) %>%
  summarize(n = n(),
            nw = sum(perwt)) %>%
    arrange(desc(n))%>%
  rename(`Birth country` = bpld,
          `n different-sex (unweighted)` = n,
         `n different-sex (weighted)` = nw) %>%
  head(10) %>%
  kable(booktabs = T, format.args = list(big.mark = ","), linesep = "", 
        caption = 'Top 10 sending countries of immigrants in different-sex couples in the American Community Survey 2008-2019') %>%
  kable_styling(latex_options = "hold_position")
```



\newpage


# Robustness Checks

## Adjusting proportions based on empirical mismatch rates

Published papers using the ACS to study same-sex couples overwhelmingly use the method by @gates_2009 employed our main paper to adjust for misreporting, where we drop all respondents that had either their relationship or sex variable allocated by the Census Bureau. However here we implement a novel method to adjust proportions of estimated immigrants in same-sex couples, based on the estimated mismatch rates from two U.S. Census Bureau studies. Beginning in 2019, the ACS provides explicit categories for "Opposite-sex husband/wife/spouse," "Opposite-sex unmarried partner," "Same-sex husband/wife/spouse," and "Same-sex unmarried partner" [@walker_2021], so sex misreporting in the 2019 data is unlikely. Hence in most sensitivity analyses below, 2019 estimates are not adjusted for misreporting.  

In a Census Bureau working paper, @kreider_2015 use personal information such as names and addresses match same-sex couples from the 2010 ACS to Social Security administrative data. They find that 57 percent of married couples coded as same-sex in the ACS are coded as different-sex in the administrative data. The corresponding sex mismatch rate for unmarried same-sex couples is 7 percent. (Our data include `r sum(acs_wide$related_partner == 'Spouse' & acs_wide$same_sex == T)` married and `r sum(acs_wide$related_partner == 'Unmarried Partner' & acs_wide$same_sex == T)` unmarried same-sex immigrant couples.) A follow-up study [@kreider_2017] shows that these mismatch rates appear to have fallen: In a 2016 ACS test module that included explicit categories for different- and same-sex spouses and partners, 31 percent of married and 3 percent of unmarried same-sex couples had inconsistent sex responses. This decreasing mismatch rate may be due to the greater numbers of same-sex couples openly identifying themselves as well as the growing popularity of responding to the ACS via Internet (see Table \@ref(tab:respmode)), a response mode introduced in 2013 which is now the default [@u.s.censusbureau_2017]. In the 2016 test of the ACS, the mismatch rate for mail-in responses was 47 and 6 percent for married and unmarried same-sex couples, respectively, whereas for Internet responses they were only 22 and 2.4 percent [@kreider_2017]. A computer-assisted telephone interviewing (CATI) or computer-assisted personal interviewing (CAPI) response mode is sometimes administered as well, but the 2016 study did not assess its error rate. In the 2010 ACS, @kreider_2015 find CATI/CAPI sex reporting mismatch for 46 and 13 percent for married and unmarried same-sex couples, respectively. In our sample of immigrants in same-sex couples, `r sum(acs_ind$respmode == 'Mail' & acs_ind$same_sex == T)` responded by mail, `r with(filter(acs_ind, same_sex == T), sum(respmode == 'CATI/CAPI'))` responded by CAPI/CATI, and `r sum(acs_ind$respmode == 'Internet' & acs_ind$same_sex == T)` responded by Internet survey. Response mode proportions by couple type are shown in Table \ref{tab:respmode}.  

```{r respmode}
acs_ind %>%
  tabyl(respmode, year, same_sex) %>%
  adorn_percentages('col') %>%
  bind_rows() %>%
  mutate(`Couple type` =  c(rep('Different-sex', 3), rep('Same-sex', 3))) %>%
  select(`Response mode` = respmode, `Couple type`, everything()) %>%
  kable(booktabs = T, format.args = list(big.mark = ","), linesep = "",
        caption = 'Response mode proportions for different- and same-sex couples, by survey year. Proportions are within columns.') %>%
  kable_styling(font_size = 8) %>%
  kable_styling(latex_options = "hold_position")
```


```{r sens, fig.cap = 'Coefficients for sending-country and U.S. state LGB policy context for Model 5 from Table 3 in the main paper, adjusted for hypothetical misreporting rates of married and unmarried same-sex couples in pre-2019 data. Ribbon shows 95 percent confidence intervals and dashed bars show estimated misreporting from the 2010 and 2016 U.S. Census Bureau tests on the ACS.'}

mod <- lm(partner ~ spouse + I(spouse^2), data.frame(spouse = c(0, .573, .35),
           partner = c(0, .07, .034)))
spouse_vec <- c(.573, .35, seq(from = 0, to = .9, length.out = 20))
mis_df <- data.frame(spouse = spouse_vec,
                     partner = predict(mod, newdata = data.frame(spouse = spouse_vec)))



# mis_df <- data.frame(spouse = c(.573, .35, seq(from = 0, to = .9, length.out = 100)),
#            partner = c(.07, .034, seq(from = 0, to = .3, length.out = 100)))

sens_df <- list()


for(i in 1:nrow(mis_df)){
  sens_mod <- lm(prop_same_sex_adj2 ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + vdem  + stock_prop + bpld +
                     post_2013*origin_score,
         data = acs_prop %>%
           mutate(prop_same_sex_adj2 = (n_spouse_pre_2019_same_sex*(1-mis_df[i,1]) + 
                                         n_spouse_2019_same_sex + 
                                         n_partner_pre_2019_same_sex*(1-mis_df[i,2]) +
                                         n_partner_2019_same_sex)/n_total * 100))
  
  sens_mod2 <- lm(prop_same_sex_adj2 ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state %>%
                    mutate(prop_same_sex_adj2 = (n_spouse_pre_2019_same_sex*(1-mis_df[i,1]) + 
                                         n_spouse_2019_same_sex + 
                                         n_partner_pre_2019_same_sex*(1-mis_df[i,2]) +
                                         n_partner_2019_same_sex)/state_stock_year * 100))
  
  
  coef_os <- coeftest(sens_mod, vcov = vcovCL(sens_mod, cluster = ~ bpld))['post_2013TRUE:origin_score',]
  coef_os2 <- coeftest(sens_mod2, vcov = vcovCL(sens_mod2, cluster = ~ bpld + Country))['state_policy',]
  coef_os3 <- coeftest(sens_mod2, vcov = vcovCL(sens_mod2, cluster = ~ bpld + Country))['origin_score',]
  sens_df[[i]] <- data.frame(est = coef_os[[1]],
                             se = coef_os[[2]],
                             est2 = coef_os2[[1]],
                             se2 = coef_os2[[2]],
                             est3 = coef_os3[[1]],
                             se3 = coef_os3[[2]],
                             mis_spouse = mis_df[i,1],
                             mis_partner = mis_df[i,2])
}

sens_df <- bind_rows(sens_df) %>%
  mutate(lower = est - 1.96*se, 
         upper = est + 1.96*se,
         lower2 = est2 - 1.96*se2, 
         upper2 = est2 + 1.96*se2,
         lower3 = est3 - 1.96*se3, 
         upper3 = est3 + 1.96*se3,
         highlight = mis_spouse %in% c(.573, .35),
         facet = 'Without misreporting in 2019')

# sens_df2 <- list()
# for(i in 1:nrow(mis_df)){
#   sens_mod <- lm(prop_same_sex_adj2 ~ distw + contig + comlang_off + comlang_ethno + colony +
#                    wage_dif + unemp_dif + vdem + origin_score + stock_prop + bpld,
#          data = acs_prop %>%
#                       mutate(prop_same_sex_adj2 = (prop_spouse_same_sex*(1-mis_df[i,1]) +
#                                          prop_partner_same_sex*(1-mis_df[i,2]))))
# 
#   coef_os <- coef(summary(sens_mod, cluster = c("bpld")))['origin_score',]
#   sens_df2[[i]] <- data.frame(est = coef_os[[1]],
#                              se = coef_os[[2]],
#                              mis_spouse = mis_df[i,1],
#                              mis_partner = mis_df[i,2])
# }
# sens_df2 <- bind_rows(sens_df2) %>%
#   mutate(lower = est - 1.96*se,
#          upper = est + 1.96*se,
#          highlight = mis_spouse %in% c(.573, .35),
#          facet = 'Assuming misreporting in 2019') %>%
#   bind_rows(sens_df)



n_spouse <- sum(with(acs_ind, same_sex == T & married == T))
n_partner <- sum(with(acs_ind, same_sex == T & married == F))

add_global_label <- function(pwobj, Xlab = NULL, Ylab = NULL, Xgap = 0.03, Ygap = 0.03, ...) {
    ylabgrob <- patchwork::plot_spacer()
    if (!is.null(Ylab)) {
        ylabgrob <- ggplot() +
            geom_text(aes(x = .5, y = .5), label = Ylab, angle = 90, ...) +
            theme_void()
    }
    if (!is.null(Xlab)) {
        xlabgrob <- ggplot() +
            geom_text(aes(x = .5, y = .5), label = Xlab, ...) +
            theme_void()
    }
    if (!is.null(Ylab) & is.null(Xlab)) {
        return((ylabgrob + patchworkGrob(pwobj)) + 
            patchwork::plot_layout(widths = 100 * c(Ygap, 1 - Ygap)))
    }
    if (is.null(Ylab) & !is.null(Xlab)) {
        return((ylabgrob + pwobj) + 
            (xlabgrob) +
            patchwork::plot_layout(heights = 100 * c(1 - Xgap, Xgap),
                                   widths = c(0, 100),
                                   design = "
                                   AB
                                   CC
                                   "
            ))
    }
    if (!is.null(Ylab) & !is.null(Xlab)) {
        return((ylabgrob + pwobj) + 
            (xlabgrob) +
            patchwork::plot_layout(heights = 100 * c(1 - Xgap, Xgap),
                                   widths = 100 * c(Ygap, 1 - Ygap),
                                   design = "
                                   AB
                                   CC
                                   "
            ))
    }
    return(pwobj)
}


plot1 <- sens_df %>%
  mutate(`Misreporting rate (weighted average)` = (mis_spouse*n_spouse+mis_partner*n_partner)/(n_spouse + n_partner)) %>%
  ggplot(aes(x = `Misreporting rate (weighted average)`, y = est2)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower2, ymax = upper2), alpha = .2)  +
  geom_hline(yintercept = 0, linetype = 1) +
  geom_errorbar(aes(ymin = lower2, ymax = upper2, width = .02, color = highlight), 
                linetype = 2) +
  #facet_wrap(~facet) +
  theme(legend.position = "none") +
  scale_color_manual(values = c('transparent', 'black')) +
  labs(y = '', x = 'Misreporting rate') +
  ggtitle('State LGB policy score')

plot2 <- sens_df %>%
  mutate(`Misreporting rate (weighted average)` = (mis_spouse*n_spouse+mis_partner*n_partner)/(n_spouse + n_partner)) %>%
  ggplot(aes(x = `Misreporting rate (weighted average)`, y = est3)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower3, ymax = upper3), alpha = .2)  +
  geom_hline(yintercept = 0, linetype = 1) +
  geom_errorbar(aes(ymin = lower3, ymax = upper3, width = .02, color = highlight), 
                linetype = 2) +
  #facet_wrap(~facet) +
  theme(legend.position = "none") +
  scale_color_manual(values = c('transparent', 'black')) +
  labs(y = '', x= 'Misreporting rate') +
  ggtitle('Country LGB policy score')

(plot1 + plot2) & theme(text = element_text(size = 9))
```

Figure \@ref(fig:sens) takes Model 5 from Table 3 (which includes country and state controls and fixed effects) and reduces the proportions of same-sex couples in the data for pre-2019 data. It varies the percentage of misreported same-sex married couples from 0 to 90 percent and of unmarried couples from 0 to 14 percent; the horizontal axis shows a weighted average of misreporting between these two groups. Highlighted in dashed bars are the empirical mismatch rates found in the two studies by @kreider_2015 and @kreider_2017. We see that even extremely high misreporting rates in the pre-2019 ACS do not render these coefficients insignificant. 

Table \ref{tab:mismatch} shows the mismatch rates estimated by @kreider_2015 and @kreider_2015. In the  analysis below (Table \@ref(tab:state-props-adj)), we use these apparent mismatch rates to adjust proportions used in models in Table 3 of the main paper. Each proportion is adjusted separately by marital status and response mode. For example, all internet respondents coded as being in married same-sex couples have their final proportion reduced by 22.5%. For mail-in responses, the proportions are reduced by the average between the two studies (`r (59+47.4)/2` percent for married and `r (7+5.6)/2` percent for unmarried couples). Results are quite robust to high levels of misreporting.



```{r mismatch}

tibble(`Study Year` = c(2010, 2010, 2016, 2016),
       Relationship = c('Married', 'Unmarried Partner', 'Married', 'Unmarried Partner'),
       `Mail` = c('59%', '7%', '47.4%', '5.6%'), 
       `Internet` = c('NA', 'NA', '22.5%', '2.4%'), 
       `CAPI/CATI` = c('46%', '13%', 'Unknown', 'Unknown'),
       Overall = c('57.3%', '7%', '35%', '3.4%')) %>%
  kable(booktabs = T, format.args = list(big.mark = ","), linesep = "", 
        caption = 'Mismatch rates from Kreider \\& Lofquist (2015) and Kreider et al. (2017)') %>%
      footnote(general = "American Community Survey 2008-2019. Authors\' calculations.",
           general_title = 'Source:',
           footnote_as_chunk = T)  %>%
  kable_styling(latex_options = "hold_position")
```

```{r state-props-adj}
country_prop <- lm(prop_same_sex_adj ~ origin_score, data = acs_prop_state)

state_prop <- lm(prop_same_sex_adj ~ state_policy, data = acs_prop_state)

state_prop2 <- lm(prop_same_sex_adj ~ origin_score + state_policy, data = acs_prop_state)

# state_prop_fe <- lm(prop_same_sex ~ state_unemploy + state_income + state + 
#                         origin_score + state_policy, 
#                        data = acs_prop_state)

state_prop_fe <- lm(prop_same_sex_adj ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_fe2 <- lm(prop_same_sex_adj ~ state_policy*origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_fe2_2013 <- lm(prop_same_sex_adj ~ state_policy*origin_score + post_2013 + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_2013 <- lm(prop_same_sex_adj ~ post_2013 + state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)


mod_list <- list(country_prop, state_prop, state_prop2, state_prop_fe, state_prop_fe2, 
                 state_prop_2013, state_prop_fe2_2013)


robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ state + Country), 
                                     save = T)[, "Std. Error"]
}



stargazer(mod_list,
          header = F, 
          keep = c('origin_score', 'state_policy', 'post_2013'),
          # omit = c('Country', 'state'),
          order = paste0("^", c('origin_score', 'state_policy', 
                                'state_policy:origin_score', 'post_2013TRUE') , "$"),
          covariate.labels = c('Country LGB policy score', 'State LGB policy score', 
                                'State score × country-score', 'Post-2013'),
          dep.var.labels = "Percent in same-sex couples by state-country-year",
          add.lines = list(c('State controls and FEs?', 'no', 'no', 'no', rep('yes', 4)),
                           c('Country controls and FEs?', 'no', 'no', 'no', rep('yes', 4))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country and state two-way clustered standard errors are shown in parentheses. State controls include unemployment rate and per-capita income. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, per-capita GDP differential, unemployment differential, proportion same-country stock, and democracy.}", 
                    "\\textit{Source}: American Community Survey 2008-2019. Authors' calculations."), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:state-props-adj',
          title = 'Adjusted by rates of empirical sex mismatch by married, unmarried, and response mode. Percent same-sex in by country of origin, U.S. state, and survey year.')

```

\newpage

## Alternate specifications
### Relative immmigrant population-weighted regressions
<!-- Although our analysis for the most part has been at the country or state levels, there is the question of whether the results presented are driven by smaller, progressive countries that send relatively few immigrants. In Table \@ref(tab:state-weights), we re-specify these models using Weighted Least Squares, weighting by the relative size of the immigrant stock in the average year of immigration. Coefficients for origin-country and state policy scores become insignificant in models with controls and fixed effects, but their interaction remains significant throughout.   -->


```{r state-weights}
# acs_prop_state <- acs_prop_state %>%
  

country_prop <- lm(prop_same_sex ~ origin_score, data = acs_prop_state, weights = stock_prop)

state_prop <- lm(prop_same_sex ~ state_policy, data = acs_prop_state, weights = stock_prop)

state_prop2 <- lm(prop_same_sex ~ origin_score + state_policy, data = acs_prop_state, weights = stock_prop)

state_prop_fe <- lm(prop_same_sex ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state, weights = stock_prop)

state_prop_fe2 <- lm(prop_same_sex ~ state_policy*origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state, weights = stock_prop)

state_prop_fe2_2013 <- lm(prop_same_sex ~ state_policy*origin_score + post_2013 + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state, weights = stock_prop)

state_prop_2013 <- lm(prop_same_sex ~ post_2013 + state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state, weights = stock_prop)


mod_list <- list(country_prop, state_prop, state_prop2, state_prop_fe, state_prop_fe2, 
                 state_prop_2013, state_prop_fe2_2013)
robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ state + Country), 
                                     save = T)[, "Std. Error"]
}

stargazer(mod_list,
          header = F, 
          keep = c('origin_score', 'state_policy', 'post_2013'),
          # omit = c('Country', 'state'),
          order = paste0("^", c('origin_score', 'state_policy', 
                                'state_policy:origin_score', 'post_2013TRUE') , "$"),
          covariate.labels = c('Country LGB policy score', 'State LGB policy score',
                                'State score × country-score', 'Post-2013'),
          dep.var.labels = "Percent in same-sex couples by state-country-year",
          add.lines = list(c('State controls and FEs?', 'no', 'no', 'no', rep('yes', 4)),
                           c('Country controls and FEs?', 'no', 'no', 'no', rep('yes', 4))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country and state two-way clustered standard errors are shown in parentheses. State controls include unemployment rate and per-capita income. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.}", 
                    "\\textit{Source}: American Community Survey 2008-2019. Authors' calculations."), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:state-weights',
          title = 'Weighted regression of percent same-sex in by country of origin, U.S. state, and survey year. ')
```

\newpage 

### Married, one-immigrant, and two-immigrant couples
<!-- We assess whether the results in Table 3 are driven by trends for married couples or those with one U.S.-born partner. Table \@ref(tab:married) restricts the sample to only married couples, Table \@ref(tab:oneimm) to only couples with one immigrant and one U.S.-born member, and Table \@ref(tab:twoimm) to only couples consisting of two immigrants. Results are substantively the same for married and one-immigrant couples, and less strong for two-immigrant couples. This implies that married and mixed-nativity couples are driving the main results. -->




```{r married}
country_prop <- lm(prop_spouse_same_sex ~ origin_score, data = acs_prop_state)

state_prop <- lm(prop_spouse_same_sex ~ state_policy, data = acs_prop_state)

state_prop2 <- lm(prop_spouse_same_sex ~ origin_score + state_policy, data = acs_prop_state)


state_prop_fe <- lm(prop_spouse_same_sex ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_fe2 <- lm(prop_spouse_same_sex ~ state_policy*origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_fe2_2013 <- lm(prop_spouse_same_sex ~ state_policy*origin_score + post_2013 + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_2013 <- lm(prop_spouse_same_sex ~ post_2013 + state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)


mod_list <- list(country_prop, state_prop, state_prop2, state_prop_fe, state_prop_fe2, 
                 state_prop_2013, state_prop_fe2_2013)
robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ state + Country), 
                                     save = T)[, "Std. Error"]
}

stargazer(mod_list,
          header = F, 
          keep = c('origin_score', 'state_policy', 'post_2013'),
          # omit = c('Country', 'state'),
          order = paste0("^", c('origin_score', 'state_policy', 
                                'state_policy:origin_score', 'post_2013TRUE') , "$"),
          covariate.labels = c('Country LGB policy score', 'State LGB policy score', 
                                'State score × country-score', 'Post-2013'),
          dep.var.labels = "Percent in same-sex couples by state-country-year",
          add.lines = list(c('State controls and FEs?', 'no', 'no', 'no', rep('yes', 4)),
                           c('Country controls and FEs?', 'no', 'no', 'no', rep('yes', 4))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country and state two-way clustered standard errors are shown in parentheses. State controls include unemployment rate and per-capita income. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.}", 
                    "\\textit{Source}: American Community Survey 2008-2019. Authors' calculations."), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:married',
          title = 'Only married couples: Alternate specifications of OLS regressions of percent same-sex in by country of origin, U.S. state, and survey year.')
```

```{r oneimm}
country_prop <- lm(prop_same_sex_oneimm ~ origin_score, data = acs_prop_state)

state_prop <- lm(prop_same_sex_oneimm ~ state_policy, data = acs_prop_state)

state_prop2 <- lm(prop_same_sex_oneimm ~ origin_score + state_policy, data = acs_prop_state)


state_prop_fe <- lm(prop_same_sex_oneimm ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_fe2 <- lm(prop_same_sex_oneimm ~ state_policy*origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_fe2_2013 <- lm(prop_same_sex_oneimm ~ state_policy*origin_score + post_2013 + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_2013 <- lm(prop_same_sex_oneimm ~ post_2013 + state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)


mod_list <- list(country_prop, state_prop, state_prop2, state_prop_fe, state_prop_fe2, 
                 state_prop_2013, state_prop_fe2_2013)
robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ state + Country), 
                                     save = T)[, "Std. Error"]
}

stargazer(mod_list,
          header = F, 
          keep = c('origin_score', 'state_policy', 'post_2013'),
          # omit = c('Country', 'state'),
          order = paste0("^", c('origin_score', 'state_policy', 
                                'state_policy:origin_score', 'post_2013TRUE') , "$"),
          covariate.labels = c('Country LGB policy score', 'State LGB policy score', 
                                'State score × country-score', 'Post-2013'),
          dep.var.labels = "Percent in same-sex couples by state-country-year",
          add.lines = list(c('State controls and FEs?', 'no', 'no', 'no', rep('yes', 4)),
                           c('Country controls and FEs?', 'no', 'no', 'no', rep('yes', 4))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country and state two-way clustered standard errors are shown in parentheses. State controls include unemployment rate and per-capita income. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.}", 
                    "\\textit{Source}: American Community Survey 2008-2019. Authors' calculations."), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:oneimm',
          title = 'Only one-immigrant couples: Alternate specifications of OLS regressions of percent same-sex in by country of origin, U.S. state, and survey year.')
```

```{r twoimm}
country_prop <- lm(prop_same_sex_twoimm ~ origin_score, data = acs_prop_state)

state_prop <- lm(prop_same_sex_twoimm ~ state_policy, data = acs_prop_state)

state_prop2 <- lm(prop_same_sex_twoimm ~ origin_score + state_policy, data = acs_prop_state)


state_prop_fe <- lm(prop_same_sex_twoimm ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_fe2 <- lm(prop_same_sex_twoimm ~ state_policy*origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_fe2_2013 <- lm(prop_same_sex_twoimm ~ state_policy*origin_score + post_2013 + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_2013 <- lm(prop_same_sex_twoimm ~ post_2013 + state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)


mod_list <- list(country_prop, state_prop, state_prop2, state_prop_fe, state_prop_fe2, 
                 state_prop_2013, state_prop_fe2_2013)
robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ state + Country), 
                                     save = T)[, "Std. Error"]
}

huxtable::huxreg(robust_list,
       coefs = c('Country LGB policy score' = 'origin_score_lag', 
                 'State LGB policy score' = 'state_policy_lag',
                 'State score × country-score' = 'state_policy_lag:origin_score_lag',
                 'Post-2013' = 'post_2013TRUE'))

stargazer(mod_list,
          header = F, 
          keep = c('origin_score', 'state_policy', 'post_2013'),
          # omit = c('Country', 'state'),
          order = paste0("^", c('origin_score', 'state_policy', 
                                'state_policy:origin_score', 'post_2013TRUE') , "$"),
          covariate.labels = c('Country LGB policy score', 'State LGB policy score', 
                                'State score × country-score', 'Post-2013'),
          dep.var.labels = "Percent in same-sex couples by state-country-year",
          add.lines = list(c('State controls and FEs?', 'no', 'no', 'no', rep('yes', 4)),
                           c('Country controls and FEs?', 'no', 'no', 'no', rep('yes', 4))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country and state two-way clustered standard errors are shown in parentheses. State controls include unemployment rate and per-capita income. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.}", 
                    "\\textit{Source}: American Community Survey 2008-2019. Authors' calculations."), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:twoimm',
          title = 'Only two-immigrant couples: Alternate specifications of OLS regressions of percent same-sex in by country of origin, U.S. state, and survey year.')
```


## Lagged policy variables
```{r state-props-mods}
country_prop <- lm(prop_same_sex ~ origin_score_lag, data = acs_prop_state)

state_prop <- lm(prop_same_sex ~ state_policy_lag, data = acs_prop_state)

state_prop2 <- lm(prop_same_sex ~ origin_score_lag + state_policy_lag, data = acs_prop_state)

# state_prop_fe <- lm(prop_same_sex ~ state_unemploy + state_income + state + 
#                         origin_score_lag + state_policy_lag, 
#                        data = acs_prop_state)

state_prop_fe <- lm(prop_same_sex ~ state_policy_lag + origin_score_lag + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_fe2 <- lm(prop_same_sex ~ state_policy_lag*origin_score_lag + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_fe2_2013 <- lm(prop_same_sex ~ state_policy_lag*origin_score_lag + post_2013 + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_2013 <- lm(prop_same_sex ~ post_2013 + state_policy_lag + origin_score_lag + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)



mod_list <- list(country_prop, state_prop, state_prop2, state_prop_fe, state_prop_fe2, 
                 state_prop_2013, state_prop_fe2_2013)
robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ state + Country), 
                                     save = T)[, "Std. Error"]
}

stargazer(mod_list,
          header = F, 
          keep = c('origin_score_lag', 'state_policy_lag', 'post_2013'),
          # omit = c('Country', 'state'),
          order = paste0("^", c('origin_score_lag', 'state_policy_lag', 
                                'state_policy_lag:origin_score_lag', 'post_2013TRUE') , "$"),
          covariate.labels = c('Country LGB policy score', 
                               'State LGB policy score', 
                                'State score × country-score', 'Post-2013'),
          dep.var.labels = "Percent in same-sex couples by state-country-year",
          add.lines = list(c('State controls and FEs?', 'no', 'no', 'no', rep('yes', 4)),
                           c('Country controls and FEs?', 'no', 'no', 'no', rep('yes', 4))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country and state two-way clustered standard errors are shown in parentheses. State controls include unemployment rate and per-capita income. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.}", 
                    "\\textit{Source}: American Community Survey 2008-2019. Authors' calculations."), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:lag',
          title = 'Country-of-origin and state LGB policy scores lagged by one year: Alternate specifications of OLS regressions of percent same-sex in by country of origin, U.S. state, and survey year.')

```

<!-- \newpage  -->
<!-- ### Only recent immigrants -->
<!-- Finally, if rates of mortality and return migration differ between immigrants in same- and different-sex couples, our results for same-sex representation in year of immigration could be biased. Since there are few studies on immigrants in same-sex couples, we cannot know whether or to what extent these rates might differ. However, research on the health of people in same-sex couples more generally shows similar [@cochran_2015_mortality] or slightly higher [@fenelon_2020_samesex] mortality compared to those in different-sex couples. To the extent that these trends extend to immigrants, the ACS may undercount immigrants in same-sex couples, resulting in conservative coefficient estimates. But whether and in which direction rates of return migration differ between immigrants in same- and different-sex couples is unknown. Like other scholars limiting the bias from retrospective surveys [@riosmena_2016_potential], Table \@ref(tab:recent) replicates Table 3 with only immigrants who migrated in the year prior to each ACS survey, for years 2007 to 2018. Results are substantively the same. -->

```{r recent, eval = F}
country_prop <- lm(prop_same_sex_recent ~ origin_score, data = acs_prop_state)

state_prop <- lm(prop_same_sex_recent ~ state_policy, data = acs_prop_state)

state_prop2 <- lm(prop_same_sex_recent ~ origin_score + state_policy, data = acs_prop_state)


state_prop_fe <- lm(prop_same_sex_recent ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_fe2 <- lm(prop_same_sex_recent ~ state_policy*origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_fe2_2013 <- lm(prop_same_sex_recent ~ state_policy*origin_score + post_2013 + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)

state_prop_2013 <- lm(prop_same_sex_recent ~ post_2013 + state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + Country + state, 
                       data = acs_prop_state)


mod_list <- list(country_prop, state_prop, state_prop2, state_prop_fe, state_prop_fe2, 
                 state_prop_2013, state_prop_fe2_2013)
robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]], 
                                     vcov = vcovCL(mod_list[[mod_num]], cluster = ~ state + Country), 
                                     save = T)[, "Std. Error"]
}

stargazer(mod_list,
          header = F, 
          keep = c('origin_score', 'state_policy', 'post_2013'),
          # omit = c('Country', 'state'),
          order = paste0("^", c('origin_score', 'state_policy', 
                                'state_policy:origin_score', 'post_2013TRUE') , "$"),
          covariate.labels = c('Country LGB policy score', 'State LGB policy score', 
                                'State score × country-score', 'Post-2013'),
          dep.var.labels = "Percent in same-sex couples by state-country-year",
          add.lines = list(c('State controls and FEs?', 'no', 'no', 'no', rep('yes', 4)),
                           c('Country controls and FEs?', 'no', 'no', 'no', rep('yes', 4))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country and state two-way clustered standard errors are shown in parentheses. State controls include unemployment rate and per-capita income. Country controls include population-weighted distance, contiguous border, common official language, common ethnic language, colonial relationship, wage differential, unemployment differential, proportion same-country stock, and democracy.}", 
                    "\\textit{Source}: American Community Survey 2008-2019. Authors' calculations."), 
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:recent',
          title = 'Only recent immigrants: Alternate specifications of OLS regressions of percent same-sex in by country of origin, U.S. state, and survey year, restricting to immigrants who arrived at most one year before each survey.')

```


\newpage

# Full Regression Table


```{r state-props-full}
acs_prop_state_full <- acs_prop_state %>%
  mutate(bpld = Country, sname = state)

country_prop <- lm(prop_same_sex ~ origin_score, data = acs_prop_state_full)

state_prop <- lm(prop_same_sex ~ state_policy, data = acs_prop_state_full)

state_prop2 <- lm(prop_same_sex ~ origin_score + state_policy, data = acs_prop_state_full)

state_prop_fe <- lm(prop_same_sex ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + bpld + sname, 
                       data = acs_prop_state_full)

state_prop_fe2 <- lm(prop_same_sex ~ state_policy*origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + bpld + sname, 
                       data = acs_prop_state_full)

state_prop_fe2_2013 <- lm(prop_same_sex ~ state_policy*origin_score + post_2013 + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + bpld + sname, 
                       data = acs_prop_state_full)

state_prop_2013 <- lm(prop_same_sex ~ post_2013 + state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + vdem + stock_prop +
                           state_unemploy + state_income + bpld + sname, 
                       data = acs_prop_state_full)


mod_list <- list(country_prop, state_prop, state_prop2, state_prop_fe, state_prop_fe2, 
                 state_prop_2013, state_prop_fe2_2013)


robust_list <- list()
for(mod_num in 1:length(mod_list)){
  robust_list[[mod_num]] <- coeftest(mod_list[[mod_num]],
         vcov = vcovCL(mod_list[[mod_num]], cluster = ~ bpld + sname),
         save = T)[, "Std. Error"]
}

stargazer(mod_list,
          header = F,
          omit = c('sname', 'bpld'),
           order = paste0("^", c('origin_score', 'state_policy',
                                'state_policy:origin_score', 'post_2013TRUE') , "$"),
          covariate.labels = c('Country LGB policy score',
                               'State LGB policy score',
                               'State score × country-score',
                               'Post-2013',
                               'Distance (km)',
                               'Contiguous border',
                               'Common official language',
                               'Common ethnic language',
                               'Ever colonial relationship',
                               'Per-cap. GDP difference',
                               'Unemployment difference',
                               'Liberal democracy (V-Dem)',
                               'Proportion same-country stock',
                               'State unemployment rate',
                               'State per-capita income'),
          dep.var.labels = "Percent in same-sex couples by state-country-year",
          add.lines = list(c('State controls and FEs?', 'no', 'no', 'no', rep('yes', 4)),
                           c('Country controls and FEs?', 'no', 'no', 'no', rep('yes', 4))),
          se = robust_list,
          keep.stat = c('n'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('†', '*', '**', '***'),
          notes = c("\\parbox[t]{\\textwidth}{\\textit{Note}: †\\textit{p}<0.1; *\\textit{p}<0.05; **\\textit{p}<0.01; ***\\textit{p}<0.001. Country and state two-way clustered standard errors are shown in parentheses.}",
                     "\\textit{Source}: American Community Survey 2008-2019. Authors' calculations."),
          no.space = T,
          column.sep.width = '2pt',
          font.size = 'footnotesize',
          notes.label = '',
          notes.align = 'l',
          notes.append = F,
          table.placement = "H",
          label = 'tab:state-props-full',
          digits = 3,
          title = 'Percent same-sex in by country of origin, U.S. state, and survey year.')
```

\newpage

# Full Country and U.S. State Rankings


```{r country-tab}
country_tab_ci <- read_csv(here('descriptive/files', 'country_tab_ci.csv'))


country_tab_ci %>% 
  mutate(`_low` = ifelse(`_low` < 0, 0, `_low`),
         across(coef:`_upp`, function(x){
           x = round(x, 2) 
           x =  case_when(
            nchar(x) == 4 ~ paste0(x, ' %'),
            nchar(x) == 3 ~ paste0(x, '0 %'),
            nchar(x) == 1 ~ paste0(x, '.00 %')) }),
         `95% CI` = paste0('(', `_low`, ', ', `_upp`, ')'),
         origin_score = round(origin_score, 1)) %>%
  filter(n >= 150) %>%
  arrange(desc(coef)) %>%
  rownames_to_column('Rank') %>%
  select(Rank,
         `Country of origin` = bpld,
         `Percentage same-sex` = coef,
         `95% CI`,
         `Mean country policy score` = origin_score) %>%
  flextable::flextable() %>% 
  flextable::set_caption('Sending countries ranked by proportion immigrant couples with same-sex partners') %>%
  flextable::add_footer_lines('Source: American Community Survey 2008-2019. Authors\' calculations.') %>%
  flextable::autofit() %>%
  flextable::fit_to_width(6)
 

```

\newpage

```{r state-tab}
state_tab_ci <- read_csv(here('descriptive/files', 'state_tab_ci.csv'))


state_tab_ci %>% 
  mutate(`_low` = ifelse(`_low` < 0, 0, `_low`),
         across(coef:`_upp`, function(x){
           x = round(x, 2) 
           x =  case_when(
            nchar(x) == 4 ~ paste0(x, ' %'),
            nchar(x) == 3 ~ paste0(x, '0 %'),
            nchar(x) == 1 ~ paste0(x, '.00 %')) }),
         `95% CI` = paste0('(', `_low`, ', ', `_upp`, ')'),
         state_policy = round(state_policy, 1)) %>%
  filter(n >= 500) %>%
  arrange(desc(coef)) %>%
  rownames_to_column('Rank') %>%
  select(Rank,
         `State` = state,
         `Percentage same-sex` = coef,
         `95% CI`,
         `Mean state policy score` = state_policy) %>%
  flextable::flextable() %>% 
  flextable::set_caption('States ranked by proportion immigrant couples with same-sex partners') %>%
  flextable::add_footer_lines('Source: American Community Survey 2008-2019. Authors\' calculations.') %>%
  flextable::autofit() %>%
  flextable::fit_to_width(6)
```

\newpage

# References
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\noindent


