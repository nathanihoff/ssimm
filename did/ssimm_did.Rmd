---
output:
  # bookdown::pdf_document2:
  bookdown::word_document2:
    reference_docx: "word-template.docx"
    toc: no
    number_sections: no
    pandoc_args: !expr rmdfiltr::add_wordcount_filter(rmdfiltr::add_citeproc_filter(args = NULL))
    latex_engine: xelatex
    keep_tex: no
    #template: svm-latex-ms.tex
# output: 
#   pdf_document:
#     citation_package: natbib
#     keep_tex: true
#     fig_caption: true
#     latex_engine: pdflatex
#     template: svm-latex-ms.tex
header-includes:
  - \usepackage{setspace}\doublespace
  - \usepackage{bbm}
  - \usepackage{amsmath}
  - usepackage{endnotes}
  - \let\footnote=\endnote
  # - \usepackage{fancyhdr}
  # - \pagestyle{fancy}
  # - \setlength{\headheight}{15pt}
  # - \lhead{Hoffmann and Velasco}
  # - \rhead{`r format(Sys.time(), '%B %e, %Y')`}
editor_options: 
  chunk_output_type: console
  

citeproc: no
# fontfamily: mathpazo
mainfont: "Times New Roman"
fontsize: 12pt
geometry: margin=1in
indent: yes
# link-citations: yes
# linkcolor: blue
bibliography: "/Users/nathan/My Drive/Projects/2020 Same-Sex Immigrant Couples/Same-Sex Immigration.bib"
# csl: chicago-author-date.csl

title: "Policy Effects on Mixed-Citizenship, Same-Sex Unions: A Triple-Difference Analysis"
# subtitle: "Forthcoming in Social Forces"
# subtitle: "ASA 2022 Submission"
# date: "`r format(Sys.time(), '%B %e, %Y')`"
# author:
# - Nathan I. Hoffmann, Department of Sociology, University of California, Los Angeles
# - Kristopher Velasco, Department of Sociology, Princeton University



---

<!-- Turn off hyphenation -->

<!-- \usepackage[none]{hyphenat} -->

```{r setup, include=F}
library(knitr)
library(broom)
library(huxtable)
library(sandwich)
library(lmtest)
library(here)
library(stargazer)
library(patchwork)
library(flextable)
library(tidyverse)
library(kableExtra)

knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = T, # results = 'asis',
                      cache.lazy = F, dpi = 1200)

# knitr::opts_chunk$set(error=TRUE) 

options("yaml.eval.expr" = TRUE)

uclablue = '#2774AE'
gray = '#808080'
black = '#000000'
uclagold = '#FFB81C'
ucla_palette = c(uclablue, black, gray)
palette_dark <- rev(RColorBrewer::brewer.pal(n=3,"Dark2"))

# theme_set(theme_cowplot(font_family = 'Palatino') + 
theme_set(theme_classic(base_family = 'Palatino') + 
            theme(axis.line = element_line(size = .3), 
                  axis.ticks = element_line(size = .3), 
                  legend.title=element_blank(), 
                  panel.grid.major.y = element_line('grey80', size = .3),
                  legend.background = element_rect(fill = "transparent")))
# ggplot <- function(...) ggplot2::ggplot(...) + scale_color_manual(values = ucla_palette) +
#   scale_fill_manual(values = ucla_palette)
ggplot <- function(...) ggplot2::ggplot(...) + scale_color_brewer(palette="Dark2") +
  scale_fill_brewer(palette="Dark2")

# library(colorspace)
# colorspace_palette = 'RdPu'
# ggplot <- function(...) ggplot2::ggplot(...) +
#   scale_color_discrete_sequential(palette=colorspace_palette) +
#   scale_fill_discrete_sequential(palette=colorspace_palette)

options(scipen=1, digits=2)
knit_hooks$set(inline = function(x) {
  prettyNum(x, big.mark=",")
})
knitr::opts_chunk$set(error=TRUE) 

set_flextable_defaults(font.family = 'Times New Roman',
                       # padding.bottom = 1,
                       # padding.top = 1,
                       # padding.left = 3,
                       # padding.right = 1,
                       theme_fun = 'theme_booktabs',
                       digits = 3, 
                       big.mark = ',',
                       line_spacing = 1)


```

```{r load, include = F}
acs_count_base <- read_csv(here('data', 'acs_count_base.csv')) %>%
  filter(is.na(yrimmig) | !is.na(origin_score)) %>%
  filter(state != 'District of Columbia') %>%
  mutate(across(equal_age:propaganda, function(x) round(x)),
         yrmarr = as.numeric(yrmarr))


state_df <- read_csv(here('data', 'state_df.csv'))

count_func <- function(condition = '!is.na(state)'){
  acs_count_base %>%
    rename(mixed = mixed_citizenship) %>%
    filter(eval(rlang::parse_expr(condition))) %>%
    group_by(state, year, same_sex, mixed) %>%
    summarize(n = sum(perwt), 
              n_unweighted = n(),
              n_ar = sum(perwt[qcitizen != 'Allocated' & qeduc != 'Consistency edit' & allocated == F]), 
              n_unweighted_ar = sum(qcitizen != 'Allocated' & qeduc != 'Consistency edit' & allocated == F)) %>%
    ungroup() %>%
    complete(state, year, same_sex, mixed) %>%
    mutate(across(n:n_unweighted_ar, function(x) ifelse(is.na(x), 0, x))) %>%
    mutate(post_2013 = year > 2013,
           group_fe = paste(state, same_sex, mixed, sep = '_')) %>%
    left_join(state_df)
}

# acs_count_base %>%
#   filter(state == 'Alabama', year == 2008) %>%
#   group_by(same_sex, mixed_citizenship, bpldnew) %>%
#     summarize(n = sum(perwt), 
#               n_unweighted = n(),
#               n_ar = sum(perwt[qcitizen != 'Allocated' & qeduc != 'Consistency edit' & allocated == F]), 
#               n_unweighted_ar = sum(qcitizen != 'Allocated' & qeduc != 'Consistency edit' & allocated == F)) %>%
#   group_by(same_sex, mixed_citizenship) %>%
#    summarize(n = sum(n),
#             n_unweighted = sum(n_unweighted),
#             n_ar = sum(n_ar),
#             n_unweighted_ar = sum(n_unweighted_ar))

acs_count_mixed <- count_func()




# acs_count_mixed <- read_csv(here('data', 'acs_count_mixed.csv')) %>%
#   group_by(state, year, same_sex, mixed) %>%
#   summarize(n = sum(n),
#             n_unweighted = sum(n_unweighted),
#             n_ar = sum(n_ar),
#             n_unweighted_ar = sum(n_unweighted_ar)) %>%
#   mutate(post_2013 = year > 2013,
#          group_fe = paste(state, same_sex, mixed, sep = '_'))
# acs_prop <- read.csv(here('data', 'acs_prop_yrimmig_policy.csv')) %>%
#   mutate(post_2013 = (yrimmig > 2013))
# acs_prop_state <- read.csv(here('data', 'acs_dyad_policy.csv'))

lgb_origin_index <- read_csv(here('data', 'lgb_origin_index.csv'))
# acs_ind <- # read_rds(here('data', 'acs_couple_policy.rds'))  %>%
#   acs_count_base %>%
#   mutate(post_2013 = year > 2013
#          # mixed =  mixed_citizenship = (citizen_main == 'Not a citizen' & citizen_partner != 'Not a citizen') | 
#          #   (citizen_main != 'Not a citizen' & citizen_partner == 'Not a citizen')
#          ) %>%
#   left_join(lgb_origin_index,  by = c('yrimmig' = 'year', 'bpldid' = 'Code')) 

# acs_count_mixed_bpld <- read_csv(here('data', 'acs_count_mixed.csv'))  %>%
#   filter(state != 'District of Columbia') %>%
#   left_join(
#     acs_count_base %>%
#     # acs_ind %>%
#       group_by(year, state, bpld, same_sex) %>% 
#       summarize(across(c(equal_age:propaganda, origin_score), mean, na.rm = T))
#       #summarize(origin_score = mean(origin_score))
#   ) %>%
#   filter(!is.na(origin_score) | bpld %in% unique({.$state}))
```

```{r intro-stats}
# total_same_mixed <- acs_count_mixed_bpld %>%
#     filter(mixed == T & same_sex == T) %>%
#     group_by(year) %>%
#     summarize(n = sum(n)) %>%
#   pull(n)
# total_dif_mixed <- acs_count_mixed_bpld %>%
#     filter(mixed == T & same_sex == F) %>%
#     group_by(year) %>%
#     summarize(n = sum(n)) %>%
#   pull(n)

total_same_mixed <- acs_count_mixed %>%
    filter(mixed == T & same_sex == T) %>%
    group_by(year) %>%
    summarize(n = sum(n)) %>%
  pull(n)

total_dif_mixed <- acs_count_mixed %>%
    filter(mixed == T & same_sex == F) %>%
    group_by(year) %>%
    summarize(n = sum(n)) %>%
  pull(n)

country_count <- acs_count_base %>%
  select(bpld) %>%
  filter(!(bpld %in% unique(acs_count_base$state))) %>%
  pull(bpld) %>%
  unique() %>%
  length()

# total_counts <- acs_count_mixed %>%
#   group_by(year) %>%
#   summarize(n = sum(n)) %>%
#   pull(n)
```

**Abstract**: After the U.S. Supreme Court struck down the Defense of Marriage Act (DOMA) in 2013, same-sex partners of U.S. citizens became eligible for spousal visas. Since then, the U.S. has seen a rapid rise in same-sex, mixed-citizenship couples. However, this effect varies greatly depending on the lesbian, gay, and bisexual (LGB) policy context of the non-citizen's country of origin. Using waves 2008 to 2019 of the American Community Survey, this study employs a triple-difference design to examine how the policy environment of the origin country moderates the effect of the end of DOMA on incidence of mixed-citizenship, same-sex couples in the U.S. Quasi-Poisson models with two-way fixed effects show that, after 2013, individuals in mixed-citizenship, same-sex couples coming from countries with progressive LGB policy saw a more than 60-percent increase in incidence relative to those in different-sex or same-citizenship couples. Meanwhile, those from countries with regressive laws experienced no significant increase. These results are corroborated by analyses of individual policies. We argue that the country-of-origin policy context impacts and is impacted by local norms and attitudes as well as individuals' material circumstances. This nexus of factors leaves a lasting impact on immigrants that shapes migration decisions, union formation, and responses to policy shifts.  


# Introduction
<!-- Unions, "a term encompassing marriage and nonmarital cohabitation" [@bloome_2020_marriage, p. 1754], are of central concern to many sociologists and demographers. This is because unions provide meaningful life experiences for those who enter them, but also because they are demonstrated to influence a range of important quality-of-life indicators. Studying how union formations change across populations can reveal other social processes of particular concern to a variety of sociologists: changing migration flows, gendered workforce participation, (de)institutionalization of cultural norms, and shifts in state governance and public policy, to name a few. -->

<!-- In the United States, research on unions, "a term encompassing marriage and nonmarital cohabitation" [@bloome_2020_marriage, p. 1754], historically privileges those in different-sex relationships. But following pioneering work, this line of research is increasingly recognizing the importance of incorporating same-sex couples [@baumle_2009; @carrington_1999_no; @rosenfeld_2005_independence; @kolk_2020_two; @moore_2011_invisible; @sullivan_2004_family; @umberson_2015_challenges]. New cultural and legal recognition of these alternative family formations helps drive more research into this domain. Now, studies seek to understand how previous demographic and sociological theories are strengthened or must be re-imagined when considering these alternative arrangements [@martell_2020; @reczek_2017_promise; @manning_2016]. We contribute to this rich scholarly tradition by considering an additional union type: those containing individuals of the same sex but of mixed citizenship statuses -- where one partner is a U.S. citizen and the other a non-U.S. citizen. -->

While mixed-citizenship couples generally face barriers to union formation [@lopez_2021_unauthorized], numbers of same-sex couples containing one U.S. citizen and one non-citizen are dramatically increasing. This has co-occurred with an important policy change: In 2013, the U.S. Supreme Court ruled the Defense of Marriage Act (DOMA) unconstitutional.^1^ For the first time, U.S. citizens could sponsor the visa of their same-sex fiancé or spouse [@edwards_2013; @carron_2015_marriagebased]. In the years since, the U.S. population of immigrant-containing same-sex couples has grown rapidly [@hoffmann_2023_sexuality; @redpath_2022_spousal]. Data on cohabiting partners and spouses from the American Community Survey [ACS, @ruggles_2021] show that numbers of individuals in different-sex, mixed-citizenship couples grew by `r round((total_dif_mixed[12]/total_dif_mixed[5]-1) * 100)` percent from 2013 to 2019 (from `r total_dif_mixed[5]/1e6` million to `r total_dif_mixed[12]/1e6` million), while those in corresponding same-sex couples increased by `r round((total_same_mixed[12]/total_same_mixed[5]-1) * 100)` percent (from `r total_same_mixed[5]/1e3` thousand to `r total_same_mixed[12]/1e3` thousand) in the same period. Despite this rapid increase, research on this population has been limited; existing work has largely focused on such unions only outside of the U.S. [@chauvin_2021_class; @salcedorobledo_2013_couples; @badgett_2011_separated].  

The growth of this union type calls for additional research to understand how this population confirms or complicates existing theory. While the DOMA decision opened this union pathway to all, uptake is unlikely to be homogeneous and may reinforce existing inequalities. Namely, we bring in theories from cultural sociology to argue that, like all relationship forms, same-sex unions are cultural objects specific to time and place [@kalmijn_2007_explaining; @treas_2014_attitudes; @wang_2018_coming; @perelli-harris_2015_exploring]. These cultural objects impact and are impacted by prevailing attitudes and norms as well as individuals' material circumstances. By defining what is possible, state policies that exist at an immigrant's country of origin shape the cultural products to which they aspire and have the capacity to actualize. For example, legally entering a same-sex union was neither thinkable nor desirable for many until quite recently; progressive LGB policies institutionalize this new cultural form and then expand support and participation in a recursive process [@baiocco_2014_desire; @abou-chadi_2019_rights]. On the other hand, regressive LGB policies can limit the horizon of union possibilities, instill fear of state or familial punishment for disclosing one's same-sex union, cut off resources that can enable migration, and negatively influence whether U.S. immigration officials view same-sex relationships from these countries as credible [@carron_2015_marriagebased]. Therefore, we ask: How do country-of-origin policies influence the incidence of mixed-citizenship, same-sex couples in the U.S. following the repeal of DOMA? Ultimately, we argue that the repeal of DOMA likely functions as a pathway to spousal visas only when an immigrant's country of origin's institutional context is affirming of LGB communities.  

**[Figure \@ref(fig:desc) about here]**


To test our argument and address our research question, we apply cutting-edge methods of causal inference. Using waves 2008 to 2019 of the ACS, we employ a triple-difference, quasi-Poisson model with two-way fixed effects to estimate the effect of the post-2013 legal context in the U.S. on numbers of mixed-citizenship, same-sex couples reported in the ACS. By controlling for incidence of mixed-citizenship and same-citizenship couples that we would not expect to be impacted by this policy, this design allows us to isolate the effect of DOMA's repeal specifically on unions of interest [@redpath_2022_spousal]. We proxy the cultural environment at the country of origin through LGB policies, relying on an original dataset indexing LGB policy changes in `r country_count` countries from 1991 to 2019 [@velasco_2018_human]. We stratify the sample by the LGB policy context at the country of origin to examine how the policy environment of the origin country moderates the effect of the end of DOMA on the incidence of mixed-citizenship, same-sex couples in the U.S.

Our findings reveal that, after 2013, individuals in mixed-citizenship, same-sex couples hailing from countries with progressive LGB policies saw a more than 60-percent increase in incidence relative to those in different-sex or same-citizenship couples. Meanwhile, those from countries with regressive laws experienced no significant increase. Affirming, family-oriented policies seem to be particularly influential.  

Our work adds to and connects the burgeoning literature on the importance of culture in shaping both migration [@benson_2009; @dixon_2020; @thompson_2017_migration] and union decisions [@wang_2018_coming; @msibi_2013_denied]. Mixed-citizenship unions constitute a test case for examining the relationship between culture and union formation: Do the norms and values learned in the country of origin continue to exert influence in the destination country? We show how local norms and values -- proxied by LGB legislation -- exhibit close ties with family formation decisions, even years after immigrants leave their countries of origin. In addition, our work shows another way that access to benefits that enable migration, such as spousal and fiancé(e) visas, is unequal due to how the state categorizes claimants and thus contributes to overall stratification.  

# Background

## The Overturning of Defense of Marriage Act and Expansion of Mixed-Citizenship, Same-Sex Unions

The U.S. Supreme Court overturned the Defense of Marriage Act (DOMA) in *United States v. Windsor* in 2013. Enacted in 1996, DOMA prevented the recognition of same-sex marriages by instilling a heterosexual definition of marriage across the federal government. Even after same-sex marriages were legalized at the state level, this recognition did not open access to federal marriage benefits. Not until after the 2013 *Windsor* decision could same-sex couples file federal tax returns jointly, secure Social Security benefits, or participate in federal programs like the Supplemental Nutrition Assistance Program.

The DOMA ruling had another important consequence: unlocking spousal visas for same-sex couples [@edwards_2013]. The federal government has long provided a pathway for U.S. citizens to secure permanent residency, and eventual citizenship, for their migrant spouses and fiancé(e)s. Indeed, family reunification is privileged in U.S. migration law, and such cases represent the majority of U.S. immigrant visas issued.^2^ However, DOMA categorically denied access to these visas to partners of the same sex because the federal government did not recognize same-sex unions as legitimate. Additionally, DOMA had a downstream effect where, even if a U.S. state legalized same-sex marriage, mixed-citizenship couples were unlikely to take advantage of state-level benefits. This is because a condition of non-permanent residents' visas is to not show intent on staying in the U.S. permanently -- something marriage to a U.S. citizen could potentially violate. The *Windsor* decision allowed mixed-citizenship couples access to spousal visas and, where legal, for such couples to get married and switch visa types. Following the 2013 end of DOMA, @redpath_2022_spousal finds a 36 percent relative increase in partnering of mixed-citizenship, same-sex couples and a 78 percent increase in these types of marriages.  

The dramatic rise in mixed-citizenship, same-sex unions found by @redpath_2022_spousal may result from two distinct mechanisms: (1) increased entry into such unions of individuals already residing in the U.S. or (2) new immigration of one or both members of the couple into the U.S. as a result of the policy shift.^3^ Regardless of pathway, rising trends invite us to ask new questions: What are the characteristics of immigrants selecting into same-sex relationships with a U.S.-citizen partner? How does one's country of origin condition entering into such a union?

As shown in Figure \@ref(fig:desc), the rapid increase after 2013 was not uniform across immigrants from all countries. For those hailing from countries with relatively progressive LGB policies, the increase was indeed rapid after 2013. However, from those with regressive LGB policies, no increase occurred. Why do we see so much variation by policy context at the country of origin?

<!-- the value in considering broader cultural and legal contexts, even aspects seemingly unrelated to the matter at hand; -->

## Intersections of Culture, Law, and Sexuality in Understanding Union Formation

Family formation -- especially processes related to unions -- remains a central concern of many sociologists and demographers. There are a number of reasons for this attention: Unions are subjectively important to many individuals' everyday lives, they influence a range of outcomes (e.g., health and well-being, economic mobility, social integration), and their formation and structure reveal ongoing social transformations in society (e.g., gendered labor force participation, (de)institutionalization of cultural norms, changing migration patterns). We weave together different threads of union formation scholarship -- especially those relating to culture and policy -- to provide a theoretical framework for answering our research question.

Marriage and cohabitation are inextricably woven into cultural processes operating at multiple scales. For example, the notion that individuals enter and leave unions according to their individual volition is a distinct cultural product formed as part of expanding liberalism, consumer logics, and self-expressive values [@wang_2018_coming; @sassler_2020_cohabitation; @perelli-harris_2015_exploring]. These global processes have weakened family-arranged marriages and created the space for individual preferences to hold greater significance in union formation [@desai_2010_gender; @yu_2015_changes]. Yet "individual preferences" regarding partner selection are influenced by the cultural environment in which people are embedded [@hiekel_2014_understanding; @lappegard_2018_why]. Even at the most intimate of scales, the "when, where, how, why, and with whom" of sexual behaviors themselves are culturally determined [@ahmadi_2003_migration]. 

Public policy is an important lever that both reflects and alters cultural understandings of unions and stratifies access to benefits based precisely on such cultural understandings. While certainly not perfectly determinative, laws are nevertheless meaningfully driven by underlying cultural values pre-existing in a society [@adamczyk_2019_examining; @lax_2009_gay]. But policies are also an important trigger to shape subsequent cultural possibilities in an interactive, recursive process [@abou-chadi_2019_rights; @hiller_2013_changes; @hooghe_2013_samesex; @kazyak_2018_backlash]. For example, interracial marriages, same-sex marriages, divorce proceedings that confer women greater autonomy, and the rise in nonmarital cohabitation in the U.S. reflect evolving cultural values that connect to changes in these arrangements' legal governance [@emens_2009_intimate; @sassler_2020_cohabitation; @perelli-harris_2015_exploring]. Moreover, public policies that touch on unions -- such as paid family leave, welfare programs, health insurance, hospital visitation, and foster care -- all have embedded assumptions regarding an ideal family type [@levitt_2020_how; @cahill_2005_welfare]. Consequently, ostensibly "neutral" policies result in stratified participation based on how couples both fit these ideal types and have the requisite resources to access their benefits. The close interactions between public policy and the cultural norms societies place onto unions mean that "values and behavioral expectations about marriage and cohabitation, and about appropriate partners, are likely to be at the forefront of cultural and political clashes around the world" [@sassler_2020_cohabitation, p.49]. While the adoption of any one policy is subject to several factors, a substantial swath of literature details that, broadly, public policies and cultural environments are inextricably linked [@burstein_1991_policy; @minkenberg_2002_religion].

We aim to understand this interaction of policy and culture as it relates to mixed-citizenship, same-sex unions. Research centering this union type is limited (see below for some exceptions); as such, we draw from existing research on mixed-citizenship and same-sex unions, generally. First, a significant body of research focuses on unions between citizens by birth and non-citizen immigrants, both in the U.S. [@lopez_2015_impossible; @lopez_2021_unauthorized; @lichter_2015_whom; @lee_1990_patterns] and elsewhere [@bonjour_2021_intimate; @medrano_2020_europe; @hoogenraad_2021_marriage]. Historically, such research has focused on "marital assimilation" -- i.e., marriage to a native-born citizen -- as an important measure of immigrant integration [@lichter_2015_whom; @gordon_1964_assimilation; @lee_1990_patterns]. But more recent work has highlighted the particular stressors and barriers that mixed-citizenship couples face. Despite a pathway to citizenship being legally codified for spouses of U.S. citizens, mixed-citizenship couples face scrutiny and suspicion by the state, and their eventual success in acquiring citizenship is shaped by the timing and strategy that couples deploy as well as the resources they possess [@lopez_2015_impossible; @lopez_2021_unauthorized; @hoogenraad_2021_marriage].  

Second, a burgeoning area of research focuses on same-sex unions [@baumle_2009; @carrington_1999_no; @rosenfeld_2005_independence; @kolk_2020_two; @moore_2011_invisible; @sullivan_2004_family; @umberson_2015_challenges]. Especially following recent U.S. state and federal legalizations in marriage equality, this work compares same-sex to different-sex couples across a range of outcomes, including patterns of assortative mating [@schwartz_2009; @jepsen_2002]; division of household labor [@giddings_2014; @goldberg_2013_doing; @vandervleuten_2021_samesex]; relationship satisfaction [@mackey_2004_relational; @holmberg_2009_sexual]; and relationship stability [@manning_2016; @manning_2022_cohabitation; @joyner_2017_gender]. Recent research also seeks to understand how legalization of marriage equality affects propensity to marry [@carpenter_2020], interstate migration [@marcen_2019], and earnings [@martell_2020], as well as how shifting legal environments alter LGB individuals' desire to join such a union or alters their behaviors in the union once legal recognition is conferred [@ocobock_2020_leveraging].

Although studies investigate different dimensions of each union type, these lines of research have largely proceeded on independent paths. This separation is due to research on mixed-citizenship couples assuming heterosexuality and research on same-sex unions assuming U.S. citizenship of both partners [@luibheid_2008]. Queer migration research is expanding, yet this area of research largely focuses on refugees and asylum seekers in the U.S. [@sam_2015_teacher; @luibheid_2008; @vogler_2016] or qualitative studies into the motivations and experiences of queer migrants [@manalansaniv_2003; @carrillo_2018; @choi_2022_global; @cantu_2009]. Thus, scholarship sitting at the intersection of these fields is limited -- especially quantitative work. A 2006 report [@long_2006_family] documents the hardship that 33 binational couples faced during the DOMA era. Small-scale work in France [@salcedorobledo_2013_couples] and the Netherlands [@chauvin_2021_class] suggests that -- even when a legal pathway to partner residency exists -- same-sex, mixed-citizenship couples face greater bureaucratic suspicion of the legitimacy of their relationships than different-sex couples do. As such, other scholars question the extent to which marriage equality has actually provided pathways to citizenship for same-sex, non-citizen partners [@badgett_2011_separated; @carron_2015_marriagebased]. Consequently, attending to this union type is important due to its rapid growth in the U.S. and because we do not know the degree to which these unions confirm or challenge existing theories of how culture sets up participation in particular union types and stratifies access to public policy benefits.

<!-- Research in this area demonstrates that rates of intermarriages between foreign-born and native-born populations reflects the degree to which foreign-born individuals are socially integrated into broader U.S. society or remain bounded within ethnic or class enclaves [@lichter_2015_whom].  -->

## Country of Origin and Selection into Same-Sex Unions

Although the DOMA decision applied equally to all mixed-citizenship couples, Figure \@ref(fig:desc) highlights an important line of differentiation: There is a distinct rise in couples where the non-U.S. citizen came from a country with more progressive LGB policies. Numbers of couples where the non-U.S. citizen came from a country with regressive LGB policies -- such as bans on sodomy or anti-LGB "propaganda" laws -- remain virtually unchanged. Why might this be? Why would conditions at the immigrant partner's country of origin influence the distribution of same-sex union formation across the population of mixed-citizen couples in the U.S.? We argue that by investigating the interplay between law and culture, we can understand these diverging trends.

Romantic relationships, and marriage specifically, are unique cultural products [@rosenfeld_2007_age]. The rituals, symbols, norms, and laws that govern them have different instantiations depending on time and place. These cultural products then influence and are influenced by the legal expectations and conditions associated with relationships [@kalmijn_2007_explaining; @treas_2014_attitudes; @wang_2018_coming]. This is especially true for same-sex unions in the present historical moment [@hull_2003_cultural; @ocobock_2020_leveraging]. The assimilation of same-sex couples into existing marriage and relationship programs is an ongoing, dynamic process [@bernstein_2013_marrying; @saez_2011_samesex]. Denmark became the first country to recognize civil unions for same-sex partners in 1989, while the Netherlands became the first to grant full marriage equality in 2001. Pre-existing self-expression values are seen as instrumental toward this legal expansion, but also of general LGBT+ rights and adjacent family-related policies like divorce and reproduction [@cheng_2016_changing; @dion_2017_democratic; @fernandez_2013_supranational; @wang_2018_coming]. This consequently allows both legal adoption and cultural change related to these issues to occur relatively quickly [@inglehart_2017_cultural]. At the end of 2019, 26 countries had recognized marriage equality nationally with an additional 13 recognizing civil unions. 

Of the many consequences of these shifts toward more progressive policies, one is that they shift understandings of what is permissible and seen as possible. Prior to state recognition, there are often public campaigns by LGBT+ organizers seeking to influence broad support. While geared toward the general public, this campaign rhetoric and imagery also socializes LGB individuals into the appropriateness of participating in institutions long exclusive to heterosexuals [@bernstein_2013_marrying]. This is particularly important as participation in same-sex unions by LGB individuals is a critical strategy to normalize and secure such legal advancements [@ocobock_2020_leveraging]. State recognition of same-sex couples also takes on a recursive process of increasing desirability of forming such a union as participation becomes a real option [@baiocco_2014_desire]. Immigrants coming from countries with affirming policy environments, generally, and those that specifically recognize and reinforce the validity of same-sex unions and families may be more inclined to establish and desire such a union once permitted to do so following the end of DOMA. Moreover, when policy affirms identity, individuals may have greater access to material resources and social connections that enable emigration.  

Conversely, policy environments that are especially regressive may hinder the formation of mixed-citizenship, same-sex unions by immigrants in the U.S. First, regressive contexts can potentially limit the desirability of forming a same-sex union by limiting what is seen as possible [@herek_2011_antiequality]. At the end of 2019, roughly 68 countries still criminalized same-sex sexual acts between consenting adults [@velasco_2023_transnational]. While in some countries these laws are rarely enforced, in others, such as Cameroon, there has been an active revival of these laws to terrorize LGB populations [@bongmba_2021_samesex]. Moreover, the DOMA legislation in the U.S. was not a unique act. More than 30 countries since the 1990s have similarly re-codified a "one man, one woman" definition of marriage either through federal law like DOMA or through constitutional amendments [@velasco_2023_transnational].  

Second, even if individuals from these contexts desire a same-sex relationship, there are other social and familial obligations and considerations that can take priority [@vanzyl_2011_are]. As mentioned, the liberalization of LGBT+ rights and same-sex union laws strongly correspond to existing levels of individualistic, self-expression values within society [@cheng_2016_changing; @dion_2017_democratic; @fernandez_2013_supranational; @wang_2018_coming]. Consequently, immigrants coming from repressive policy contexts are less likely to have a self-expressive orientation where their individual desire surpasses concerns over familial obligation.  

Third, repressive legal environments can influence how the cultural norms, rituals, and performances of same-sex relationships manifest when they do exist. In the U.S. and many Western countries with marriage equality, mainstream LGB cultures emphasize publicly "coming out" and sameness with heterosexuals using language such as "love is love." But LGB cultures can look quite different in places where "coming out" risks vulnerability to state-sponsored violence [@msibi_2013_denied]. These different cultures can negatively influence whether U.S. immigration bureaucrats in charge of issuing visas perceive relationships as legitimate [@carron_2015_marriagebased]. When couple photos, disclosure to friends and family, and other public evidence are used to evaluate if a relationship is valid and worthy of a visa, immigrants coming from countries where possession of such evidence can be dangerous are at a systematic disadvantage. Thus, for all of these reasons, mixed-citizen, same-sex unions following the 2013 DOMA decision are likely to contain fewer immigrant partners from regressive contexts.  

Consequently, we expect that affirming LGB policies at the non-citizen partner's country of origin will be associated with greater increases in same-sex, mixed-citizenship unions. We further hypothesize that policies specifically affirming of queer families and relationships will have the largest effect. This is because such policies may both increase the likelihood of an immigrant participating in these cultural objects and increase the legibility of the relationship to U.S. officials.  

Of course, other factors may be confounding the relationship between LGB policy and incidence of same-sex, mixed-citizenship unions. Economically disadvantaged countries are somewhat more likely to have regressive LGB policies, while countries with progressive policies may be more embedded in a global network that enables migration. As described below, our research design accounts for these possible confounders by controlling for the incidence of mixed-citizenship couples more broadly.

<!-- The triple-difference method controls for incidence of *different-sex*, mixed citizenship couples that are affected by these same economic and network forces. In addition, by modeling a Poisson distribution, our design is unaffected by the small absolute numbers of same-sex, mixed-citizenship couples, focusing on *relative* changes instead.    -->

# Data and Methods

## Sample

We employ data from the 2008 to 2019 American Community Survey [@ruggles_2021]. Each year, the ACS surveys a 1-percent representative sample of the U.S. population about a variety of individual and household attributes. We focus on counts of individuals in mixed-citizenship, same-sex couples, comparing to those in same-citizenship or different-sex couples. Our counts include only cohabiting individuals who identify themselves as spouses or unmarried partners, since the ACS does not allow identification of same-sex couples that do not reside together. "Mixed-citizenship" couples include one citizen and one non-citizen while "same-sex" couples include two individuals who report the same sex. We exclude individuals younger than 18 or older than 64 in each survey year, and for immigrants we exclude those who immigrated before the age of 18.

Beginning in 2008, the Census Bureau made changes to ACS gender and partnership questions in order to prevent errors on these questions [@u.s.censusbureau_2013], so we rely on data only from 2008 onward. In addition, following @gates_2009, we remove all respondents who had either their relationship or sex variable imputed by the Census Bureau. We test sensitivity to hypothetical sex misreporting in Section B of the Online Appendix. See Table \@ref(tab:data-tab) for sample sizes.  

**[Table \@ref(tab:data-tab) about here]**  



## Analytic Strategy

Our analytic strategy proceeds in two parts. First, how does LGB policy at countries of origin moderate the effect of the repeal of DOMA on the incidence of same-sex, mixed-citizenship couples in the U.S.? To isolate the effect of the 2013 DOMA repeal, we employ a triple difference, or difference-in-differences-in-differences (DDD), quasi-Poisson design [@hausman_1984_econometric; @olden_2022_triple].  

This design has a number of advantages over other choices, which we compare conceptually in Figure \@ref(fig:method-desc). A simple difference (D) design compares numbers of mixed-citizenship, same-sex couples before and after 2013, descriptively quantifying the trend show in Figure \@ref(fig:desc). But it fails to account for numbers of mixed-citizenship or same-sex couples overall, which both rose in this period as well. A difference-in-differences (DD) design accounts for one of these: Among individuals in same-sex couples, we calculate the post-2013 rise for mixed- and same-citizenship couples separately, and then we take the difference in these differences. If numbers in mixed-citizenship couples rose more quickly after 2013, then we should see a positive effect. But perhaps the effect is relevant to all mixed-citizenship couples, rather than specific for those in same-sex couples. Or the apparent effect could reflect changes in economic dynamics or networks that are confounding the relationship. In order to account for these possibilities, a DDD design takes yet another difference: Starting with the same-sex-only DD quantity, we subtract it from a corresponding DD estimate for different-sex couples. This results in a triple-difference (DDD) that isolates the rise in same-sex, mixed-citizenship couples relative to different-sex or same-citizenship couples.  

Estimating this difference using a linear model is not ideal because absolute numbers of same-sex couples are small. We are instead interested in the *relative* rise in incidence of mixed-citizenship, same-sex couples. Hence we model counts as draws from a Poisson distribution, which is unaffected by the small absolute numbers of same-sex, mixed-citizenship couples; after transformation, coefficients from a Poisson model can be interpreted as percent increases.^4^ We estimate the Poisson model using quasi-maximum likelihood estimation (QMLE). Unlike Maximum Likelihood Estimation, QMLE does not assume the mean and variance of the distribution are equal [@cameron_2005_microeconometrics, p. 667]. This allows better estimation of standard errors for data containing many small or zero counts, as is the case in our sample. We include two-way fixed effects for survey year and state-group to remove sources of time-invariant confounding. We also cluster standard errors at the state-group level.  

**[Figure \@ref(fig:method-desc) about here]**  

Our estimand is the relative change in incidence of individuals in mixed-citizenship, same-sex couples following the repeal of DOMA in 2013. We estimate this as the coefficient to a three-way interaction between indicators for same-sex, mixed-citizenship, and post-2013 survey year. We write our model as  

$$\begin{aligned}
y_{gst} = &\exp[\beta_0 + \beta_1 post_t + \beta_2 (post_t \times M_g) + \beta_3 (post_t \times S_g) \quad \quad (1) \\
&+ \delta (post_t \times M_g \times S_g ) + \alpha_{gs} + \gamma_{t} + \zeta ' \mathbf x_{st}]  + \epsilon_{gst}
\end{aligned}$$

where $y_{gst}$ is the count of individuals in group $g$ in state $s$ in survey year $t$; $post_t$ is an indicator variable for $t > 2013$; $M_g$ is an indicator variable for group $g$ being mixed-citizenship; $S_g$ is an indicator variable for group $g$ being same-sex; $\alpha_{gs}$ are group-state fixed effects; $\gamma_t$ are survey year fixed effects; and $\epsilon_{gst}$ is an error term such that $\mathbb E(\epsilon_{gst} \mid post_t, M_g, S_g, \alpha_{gs}, \gamma_{t}, \mathbf x_{st}) = 0$. In our final models, we add $\mathbf x_{st}$, a vector of state-level controls in year $t$: unemployment rate, per capita income, and local LGB policy. The coefficient of interest is $\delta$; the incidence ratio $\exp(\delta)$ estimates the relative increase of individuals in mixed-citizenship, same-sex couples after 2013, relative to other couples. We assume parallel trends in log counts; we provide support for this assumption by conducting pre-trend $\chi^2$ tests for pre-2013 coefficients from dynamic (event-study) models.

<!-- $$\mathbb E[y_{gst}] = \exp(\beta_0 + \beta_1 \bbm 1_{\{t \geq 2013\}} + \beta_2 \bbm 1_{\{t \geq 2013\}}$$ -->

We focus on heterogeneity of this effect: how it varies by the LGB policy context of non-citizens' country of origin. We use LGB policy contexts as an approximation of the latent cultural environment of these countries. We measure the origin-country policy environment using a modified LGBT Policy Index [@velasco_2018_human] for 1991 to 2019. The index comprises 16 policies, with both progressive policies (civil unions, constitutional protection, conversion therapy ban, employment protection, equal age of consent, hate-crime protection, incitement to hate banned, joint adoption, LGB military, marriage equality, same-sex acts legal) and regressive ones (anti-propaganda laws, death penalty, LGB military ban, marriage ban, unequal age of consent). The index is created by summing the net total of progressive policies (scored $+1$) over regressive policies (scored $-1$). For policies that exist in only certain parts of a country, fractional values are used. For the `r country_count` countries of origin for our sample, the country index ranges from `r min(acs_count_base$origin_score, na.rm = T)` to `r max(acs_count_base$origin_score, na.rm = T)`, with a mean of `r mean(acs_count_base$origin_score, na.rm = T)`. Individuals are assigned the policy score for their country of origin in their year of immigration.^5^ Immigrants who arrived in the U.S. before 1991 are assigned the score for 1991; national LGB policy was generally very stable before the 1990s.  

To see how the incidence of mixed-citizenship, same-sex unions varies by origin-country LGB policy context, we stratify our sample by this index. Foreign-born respondents are labeled depending on the LGB policy score at their year of immigration: Individuals coming from countries with a policy score less than 0 get a "regressive" label, while those with a score greater than 3 get a "progressive" label.^6^

U.S.-born respondents do not receive a label and are included in all analyses. We then estimate equation 1 twice more: once for counts including only "progressive"-origin respondents (plus U.S.-born), and once for only "repressive"-origin respondents (plus U.S.-born). 

We are also interested in which specific LGB policies of country of origin are most relevant in shaping entry into same-sex unions. To examine the influence of individual policies, we follow a similar procedure. Instead of stratifying by policy score, we stratify by whether individuals had one of the relevant policies in place in their year of immigration in at least the majority of their country of origin (as opposed to only in one state or province, for example). This allows us to study the descriptive trends for numbers of individuals from countries with these policies.

However, these policies often co-occur. To obtain a quantity similar to an average partial effect of a given policy, we consider every existing policy combination in the sample (e.g., marriage equality co-occurring with employment protections or sodomy bans co-occurring with propaganda laws). Only 148 are present in the sample out of thousands of possible combinations. We stratify the sample again for each of these combinations, including only foreign-born individuals originating in countries with each unique combination, along with all U.S.-born individuals. We then estimate the same quasi-Poisson model as in equation 1 for each of these stratified samples. Next, for each policy, we find the average effect size for the three-way interaction of interest for all regressions on samples that include the policy and all regressions that do not. These averages are weighted by the inverse variance of the coefficients [@borenstein_2010_basic] as follows: Let $\delta_{ij}$ be the coefficient of interest for policy combinations $i=1, \ldots, m$ containing policy $j$ and $\text{se}_{ij}$ be its standard error. We combine the results of $m$ regressions to obtain the average coefficient and standard error:  

$$\begin{aligned}
\delta_j = \frac{\sum_{i=1}^m \delta_{ij} \text{se}_{ij}^{-2}}{\sum_{i=1}^m \text{se}_{ij}^{-2}}, &&
\text{se}_j = \sqrt{\frac{1}{\sum_{i=1}^m \text{se}_{ij}^{-2}}}.
\end{aligned}$$

Finally, we calculate the difference between the average coefficient for samples that include the policy and those that do not. The resulting quantity is then the average effect of a given policy on the log relative incidence of same-sex, mixed-citizenship couples.

## Control Variables

We rely on three U.S. state-level controls to account for alternative explanations. While the two-way fixed effects in our models account for time-invariant confounders, time-varying confounders may still be at play. If individuals in mixed-citizenship, same-sex couples seek higher wages, lower unemployment rates, or more progressive local environments than other people, then these factors may confound our models. Hence we use state per capita income by year from the Bureau of Economic Analysis [@bea_2020] and state-level annual unemployment rates from the Bureau of Labor Statistics [@bls_2020]. All monetary variables are adjusted to 1999 U.S. dollars. To create the U.S. state LGB policy index, we compile data from the Movement Advancement Project,^7^ a leading LGB organization in the U.S. that collects data on a number of relevant policies. Our state index comprises both progressive policies (full marriage equality, recognition of civil unions and domestic partnerships, ban on employment and housing discrimination based on sexual orientation, hate crime protections based on sexual orientation, legal joint adoption by same-sex couples, and a ban on conversation therapy for minors) and regressive policies (criminalization of sodomy, state constitutional bans of marriage equality, religious freedom exemptions to discriminate against same-sex couples in adoption, and state-level bans on local non-discrimination ordinances encompassing sexual orientation). This index is based on enforceable laws; for example, the index accounts for when a federal law or precedent invalidates state laws. In the years we consider, the state index ranges from `r min(acs_count_mixed$state_policy, na.rm = T)` to `r max(acs_count_mixed$state_policy, na.rm = T)`, with a mean of `r mean(acs_count_mixed$state_policy, na.rm = T)`.

# Results

## Main Effects



```{r mod-setup}
count_origin_high <- count_func('origin_score > 3 | is.na(origin_score)') 
count_origin_low <- count_func('origin_score < 0 |  is.na(origin_score)')

# D
mod_mixed <- acs_count_mixed %>%
  filter(same_sex == T, mixed == T) %>%
  glm(n ~ post_2013 + group_fe + as.factor(year), 
                        data = ., 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 

mod_os_high <- count_origin_high %>%
  filter(same_sex == T, mixed == T) %>%
  glm(n ~ post_2013 + 
        group_fe + as.factor(year), 
        data = ., 
        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe))

mod_os_low <- count_origin_low %>%
  filter(same_sex == T, mixed == T) %>%
  glm(n ~ post_2013 + 
        group_fe + as.factor(year), 
        data = ., 
        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe))

dlist <- list('Full sample' = mod_mixed, 'Progressive' = mod_os_high, 'Regressive' = mod_os_low)

base_effect_d <- tidy(mod_mixed) %>%
  filter(term == 'post_2013TRUE') %>%
  pull(estimate) 
high_effect_d <- tidy(mod_os_high) %>%
  filter(term == 'post_2013TRUE') %>%
  pull(estimate)

## DD
mod_mixed <- acs_count_mixed %>%
  filter(same_sex == T) %>%
  glm(n ~ I(post_2013*mixed) + 
        post_2013 + group_fe + as.factor(year), 
                        data = ., 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 

mod_os_high <- count_origin_high %>%
  filter(same_sex == T) %>%
  glm(n ~  I(post_2013*mixed) + 
        post_2013 + 
        group_fe + as.factor(year), 
        data = ., 
        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe))


mod_os_low <- count_origin_low %>%
  filter(same_sex == T) %>%
  glm(n ~  I(post_2013*mixed) + 
        post_2013 + 
        group_fe + as.factor(year), 
        data = ., 
        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe))

ddlist <- list('Full sample' = mod_mixed, 'Progressive' = mod_os_high, 'Regressive' = mod_os_low)

base_effect_dd <- tidy(mod_mixed) %>%
  filter(term == 'I(post_2013 * mixed)') %>%
  pull(estimate) 
high_effect_dd <- tidy(mod_os_high) %>%
  filter(term == 'I(post_2013 * mixed)') %>%
  pull(estimate) 


# DDD
mod_mixed <- acs_count_mixed %>%
  glm(n ~ I(post_2013*same_sex*mixed) + I(post_2013*same_sex) + I(post_2013*mixed) + 
        post_2013 + group_fe + as.factor(year), 
                        data = ., 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 



mod_os_high <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + 
                        group_fe + as.factor(year), 
                        data = count_origin_high, 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe))


mod_os_low <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + 
                        group_fe + as.factor(year), 
                        data = count_origin_low, 
                        family = 'quasipoisson') %>%
coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 

dddlist <- list('Full sample' = mod_mixed, 'Progressive' = mod_os_high, 'Regressive' = mod_os_low)

base_effect <- tidy(mod_mixed) %>%
  filter(term == 'I(post_2013 * same_sex * mixed)') %>%
  pull(estimate) 
high_effect <- tidy(mod_os_high) %>%
  filter(term == 'I(post_2013 * same_sex * mixed)') %>%
  pull(estimate) 
```


We first present simple-difference (D) and difference-in-differences (DD) results, before presenting the more rigorous triple-difference (DDD) results. All of these models include two-way fixed effects and cluster standard errors at the state-group level. Table \@ref(tab:D-mod) shows the simple-difference result. The coefficient for post-2013 represents the log-change in incidence of individuals in mixed-citizenship, same-sex couples. For the full sample, this group saw a $100 \times [\exp(`r base_effect_d`) -1] =$ `r 100*(exp(base_effect_d) - 1)` percent increase after 2013. But for those originating in countries with progressive LGB policy (defined as those with an LGB policy score greater than 3), the increase was much greater, at `r 100*(exp(high_effect_d) - 1)` percent. The increase for those coming from regressive countries (those with a policy score less than 0) is not significant.  

**[Table \@ref(tab:D-mod) about here]**  

**[Table \@ref(tab:DD-mod) about here]**  

Table \@ref(tab:DD-mod) shows corresponding results for the DD analysis. These models control for the rise in same-sex, *same-citizenship* couples, since their numbers also rose after the end of DOMA. Now the coefficient of interest is the two-way interaction between indicators for post-2013 and mixed-citizenship. The relative rise is less strong than in the D models, but the relative increase for progressive countries is still striking. Relative to same-citizenship same-sex couples, mixed-citizenship, same-sex couples saw a `r 100*(exp(base_effect_dd) - 1)` percent increase overall but a `r 100*(exp(high_effect_dd) - 1)` percent increase for those originating in progressive countries.^8^   

**[Table \@ref(tab:DDD-mod) about here]**



Finally, Table \@ref(tab:DDD-mod) presents results from our DDD specifications. While the DD models control for numbers in same-sex couples overall, the DDD models also control for numbers in mixed-citizenship couples, regardless of sex composition. Here, the coefficient of interest is the three-way interaction between indicators for post-2013, same-sex, and mixed-citizenship. For the full sample, the incidence of individuals in mixed-citizenship, same-sex couples grew by $100 \times [\exp(`r base_effect`) -1] =$ `r 100*(exp(base_effect) - 1)` percent after 2013, relative to those in couples that were not same-sex or mixed-citizenship. When we focus on individuals from progressive countries, the result is even stronger, at `r 100*(exp(high_effect) - 1)` percent. However, those from regressive countries saw no significant increase.  

Although the two-way fixed effects in our specifications help allay concerns of confounders, it is still possible that time-varying state- and group-level variables may be confounding results. We test the robustness of our results by re-specifying our models while adjusting for state per capita income, annual unemployment rates, and state LGB policy. Table \@ref(tab:controls-tab) replicates Table \@ref(tab:DDD-mod), but with these additional controls. Substantive conclusions do not change. Notably, the coefficient for state LGB policy is small and nonsignificant; in these models, state LGB policy does not appear related to the incidence of same-sex unions.

<!-- ^[In the Online Appendix, we also respecify the simple-difference and difference-in-differences models with these state-level controls. Coefficients of interest shift only slightly.]  -->

Figure \@ref(fig:lag-plot) presents dynamic models of the effect of interest, with state controls. These models replace the post-2013 indicator variable with a categorical variable for survey year, with years grouped into pairs for statistical power. The left panel shows this lag-lead specification for the full sample. We see that coefficients for the three-way interaction between year, same-sex, and mixed-citizenship become significantly positive only after 2013. The right panel presents the same specification, but for the stratified samples as in Table \@ref(tab:controls-tab). Here, we see a clear upward trend for non-citizens from progressive countries, while the trend for those from regressive countries hovers close to 0. Also, it is worth noting the lower coefficient for the years 2018-2019 across all samples, perhaps suggesting an effect of the Trump Administration's approach to immigration reducing LGB immigration or the willingness of LGB citizens and non-citizens to enter into unions here. In addition, the fairly flat trends before 2013 give support to the parallel trends assumption. Formally, coefficients for years before 2013 are nonsignificant in all models, and a pre-trend  $\chi^2$ test shows they are also jointly nonsignificant.^9^  

<!-- Even though parallel trends hold pre-2013, it is possible that time-varying confounders exist that affect the relative incidence of same-sex, mixed-citizenship couples. We believe that the descriptive trendlines in Figure \@ref(fig:desc) as well as the dynamic models plotted in Figure \@ref(fig:lag-plot) show a discontinuity around 2013, and we cannot think of another momentous event at the same time that would yield the same divergence in incidence of mixed- and same-citizenship same-sex couples. However, one possible candidate is the 2015 Supreme Court ruling in *Obergefell v. Hodges* that legalized same-sex marriage in all 50 U.S. states. In the Online Appendix, we conduct a placebo test where we use 2015 instead of 2013 as the cutpoint for the DDD models. The coefficient for the progressive sample falls to 0.416, although it is still significant and not significantly different from the post-2013 effect. -->


**[Table \@ref(tab:controls-tab) about here]**  

**[Figure \@ref(fig:lag-plot) about here]**  


In Section E of the Online Appendix, we compare these results to two alternative specifications that model counts of individuals in different types of same-sex couples. First, we consider same-sex couples containing one U.S.-born and one foreign-born person ("mixed-nativity"). Second we consider couples containing one or two immigrants ("immigrant-containing") compared to couples containing only U.S.-born members. For both mixed-nativity and immigrant-containing same-sex couples, trends are similar, but coefficients are smaller. This is in line with our theory: After DOMA, the benefits of union formation were greatest for noncitizens who formed unions with citizens, as this provided pathways to immediate lawful residence and eventual citizenship. Considering nativity rather than citizenship neglects the fact that many foreign-born people residing in the U.S. have already secured citizenship.  




## Which Policies are Responsible?

Clearly, the post-2013 rise in mixed-citizenship, same-sex unions was much stronger for immigrants from countries with overall progressive LGB policies. But are there some policies that matter more than others? Whereas Table \@ref(tab:DDD-mod) stratified the sample by values of the policy index, here we stratify the sample by specific policies. We first descriptively present how the incidence of our population of interest varies by specific policies. Figure \@ref(fig:policies-desc-plot) shows the numbers of individuals in mixed-citizenship, same-sex couples originating in countries that had each specific policy in their year of immigration. For almost all progressive policies, rises in numbers are greater than for repressive policies. However, many of these policies co-occur in the sample, so from this figure it is difficult to determine which policies are driving the results.  

<!-- Within each cell, we include only mixed-citizenship couples for whom the non-citizen country of origin has an average value greater than 0 for the policy of interest -- i.e., where immigrants in that group tended to experience the given policy in their year of immigration.  -->

**[Figure \@ref(fig:policies-desc-plot) about here]**  

**[Figure \@ref(fig:policy-combos) about here]**  

As described above, we estimate individual policy effects by considering every existing policy combination in the sample to obtain a quantity similar to an average partial effect. Focusing on the coefficient from the three-way interaction of interest, we estimate the inverse variance-weighted average difference between regressions for individuals originating in countries that include a given policy and those that do not. Results from this analysis are displayed in Figure \@ref(fig:policy-combos). As shown in the left panel, estimates for progressive policies are mostly positive: The post-2013 change in relative incidence was greater for foreign-born individuals originating in countries with these policies. Notably, the average effects for family-oriented policies like marriage equality and joint parental adoption are especially high, albeit not significantly more than other progressive policies like civil unions. For almost all progressive policies, we see greater incidence of mixed-citizenship, same-sex couples. The similar overall effect sizes may be because each policy manifests from similar underlying cultural values within a country. In contrast, the right panel of Figure \@ref(fig:policy-combos) shows nonsignificant or negative coefficients for all regressive policies.


# Discussion and Conclusion

When two people of different nationalities fall in love, finding a way to live together is no small feat. Even when marriage appears to be a clear legal path to residency for the foreign-born partner, bureaucratic hurdles abound. The burden of proof weighs heavily on the couple, and those without sufficient economic and cultural resources may fail to muster sufficient evidence to satisfy the scrutiny of the state [@lopez_2021_unauthorized; @hoogenraad_2021_marriage]. Yet one particular type of mixed-citizenship union has seen a spectacular rise in the U.S.: Numbers of same-sex, mixed-citizenship couples grew from `r total_same_mixed[5]/1e3` thousand to `r total_same_mixed[12]/1e3` thousand between 2013 and 2019, far outpacing growth of corresponding different-sex couples. This rise aligns with the 2013 repeal of DOMA, which for the first time allowed U.S. citizens to sponsor the visa of a foreign-born spouse or fiancé(e) [@redpath_2022_spousal; @edwards_2013]. But this rise was not uniform across all countries of origin: This rapid rise occurred for couples containing non-citizen partners from countries with progressive LGB policies, while those with members from regressive countries saw very little increase after 2013.

We use triple-difference, quasi-Poisson models to formally test how LGB policy -- a proxy for the underlying cultural environments -- moderates the incidence of mixed-citizenship, same-sex unions following the 2013 repeal of DOMA. Stratifying the sample by the country-of-origin policy of foreign-born partners demonstrates that the relative incidence of individuals in mixed-citizenship, same-sex unions grew by nearly 70 percent after 2013 when a partner originated from a country with progressive policies. Partners originating in countries with regressive policies saw no significant increase. Stratifying by specific policies produces strong positive effects for most progressive policies, with family-oriented policies such as marriage equality and joint adoption yielding the largest point estimates.  

We bring a cultural perspective to understand these findings. Unions are cultural objects; the composition, timing, motivation, and other norms regarding socially codified unions are place- and time-specific [@kalmijn_2007_explaining; @treas_2014_attitudes]. We argue that public policy both affects cultural understandings of unions and is shaped by them. By defining what is possible or acceptable, laws relating to same-sex unions and affirming of LGB people, generally, leave lasting cultural impacts on those under their jurisdiction. Indeed, while there are several factors that explain the adoption of any one policy, substantial research demonstrates a tight link between policy and culture -- especially for LGB topics [@adamczyk_2019_examining; @lax_2009_gay; @abou-chadi_2019_rights; @hooghe_2013_samesex; @kazyak_2018_backlash]. Individuals originating in countries with progressive LGB policies may be less likely to hide their queer identities and codify their same-sex relationships openly through same-sex unions. Furthermore, when policy affirms identity, benefits may spill over into other domains of life: Protection from discrimination leads to greater economic gains, access to social networks broadens, and the resulting resources enable emigration. Although individual progressive policy effects are for the most part not statistically distinguishable, large point estimates for marriage and adoption support this cultural argument. If country-of-origin policies are affirming of the traditional nuclear family -- as both of a product of and influence on local norms affirming this family structure -- it is understandable why this effect would translate to union types in the U.S. On the other hand, policy environments that repress LGB identities limit the unions that locals see as possible or desirable and deny LGB individuals the resources necessary to migrate. Furthermore, when individuals originate in places where "coming out" risks vulnerability to state violence, they may fail to muster enough evidence of queer identity or a legitimate same-sex relationship to satisfy U.S. immigration officials [@carron_2015_marriagebased; @msibi_2013_denied].  

Our analyses open the door for future investigations to both overcome the limitations in our research design and expand our understanding of union formation and LGB migration. First, our analysis cannot assess the pathway through which a mixed-citizenship, same-sex union came to be. For example, we cannot ascertain whether the non-citizen partner already resided in the U.S. on another visa (e.g., employment-based) or came to the U.S. directly from their country of origin on a spousal or fiancé(e) visa. Supplemental analyses in the Online Appendix show that, among married, same-sex, mixed citizenship couples, immigration tends to precede marriage, but this provides only partial evidence for union formation pathways. Future research should collect the necessary data to investigate this.  

Second, the use of the ACS constrains our sample to only cohabiting couples and not the entire population of mixed-citizenship, same-sex unions in the U.S. Previous research shows that the vast majority of both same- and different-sex couples are cohabiting, although the former do so at somewhat lower rates [@strohm_2009_living]. The minority of same-sex, mixed-citizenship couples that do not cohabit may be consciously opting out of "traditional" union arrangements, or they may be awaiting an appropriate time in the relationship to move in together. Whether this status cleanly maps onto the cultural and policy environment at country of origin is fodder for future research.  

Third, this investigation prioritizes country-level interactions between policy and culture to explain increases in mixed-citizenship, same-sex unions. Although macro-level considerations are important for understanding union formation -- especially for LGB individuals, as national policies have been rapidly changing -- we do not attend to individual-level characteristics. Attending to these characteristics can give insights into whether LGB migrants select on similar attributes as their straight co-nationals when forming unions with U.S. citizens. Moreover, while we do not see significant increases from repressive countries following DOMA, these individuals are still in the data. Who are they? As @kong_2010_chinese documents, it may be the most privileged individuals with a cosmopolitan cultural orientation who end up in cross-national relationships. If so, this would strengthen the current study by demonstrating that these cultural processes operate at the individual-level as well.  

Finally, our findings suggest the importance of identity-based policies in understanding migration and union formation, but cross-national data are needed to assess whether these results generalize to similar policy shifts in countries besides the U.S. Relatedly, these results highlight the complicated relationship between country-of-origin policies, country-of-destination policies, migration decisions, and union formation for queer couples. While our focus has been on country-of-origin processes for migrants in a single destination country, similar forces likely affect choice of destination country and how and whether non-migrants select partners -- including whether these are same-sex or non-citizen. Within the U.S., recent work suggests that LGB migrants tend to settle in more progressive U.S. states [@hoffmann_2023_sexuality]; do they similarly choose more progressive countries? In addition, the end of DOMA presents one occasion where the dynamic interplay between LGB policies around the world crystallized into an auspicious opportunity for queer union formation and migration. Cross-national research should assess other instances where this interplay has resulted in similar opportunities.  

Our findings contribute to sociology of the family by building on recent work examining the relationship between culture and union formation [@wang_2018_coming; @sassler_2020_cohabitation; @perelli-harris_2015_exploring]. Scholars have tied culture to a number of recently proliferating forms of unions, including cohabitation [@sassler_2020_cohabitation], marriage across racial and ethnic lines [@kalmijn_2010_comparative], and the redefinition of gender roles within unions [@goldscheider_2015_gender]. Less work has connected culture to same-sex or mixed-citizenship relationships. Mixed-citizenship unions offer an interesting test case of the impact of culture on union formation: Do origin-country norms and values endure in the destination country? By assessing the relationship between LGB policy and incidence of same-sex unions in the population of mixed-citizenship couples, we find evidence that the culture of the origin country and choice of union in the destination country are closely linked.


These findings also amend a dominant narrative in migration studies that LGB migrants to the U.S. tend to be fleeing repression [@murray_2014_real; @sam_2015_teacher; @dhoest_2019_learning; @saleh_2020_queer]. Instead, this paper supports the notion that migration of advantaged queer individuals -- as explored in some recent ethnographic work [@difeliciantonio_2016_situating; @choi_2022_global] -- may in fact be the principal form of LGB migration to the U.S., at least for those in cohabiting same-sex relationships. While LGB refugees are certainly an important group, they are numerically small. Rather, dynamics for LGB migrants are similar to other migrants: We see stratification of LGB individuals around the world by the cultural and economic advantages that LGB policy affords. This stratification affects both migration capabilities as well as the horizon of possibilities for union formation.

# Data Availability
The American Community Survey data underlying this article are available from IPUMS, at https://usa.ipums.org/usa/. Other data and replication code are available from the first author's website.


\newpage

# Notes

```{r parallel-test}
dynamic_mod <- acs_count_mixed %>%
  mutate(year = floor(year/2)*2) %>%
  group_by(state, year, same_sex, mixed, group_fe, state_policy, state_income, state_unemploy) %>%
  summarize(n = sum(n)) %>%
  ungroup() %>%
  mutate(year = factor(floor(year/2)*2, 
            levels = c('2018', '2016', '2014', '2012', '2010', '2008'))) %>%
  glm(n ~ as.factor(year):same_sex:mixed + 
                        as.factor(year):same_sex + 
                        as.factor(year):mixed + 
                        as.factor(year) + group_fe + state_policy + state_income + state_unemploy,
                        data = ., 
                        family = 'quasipoisson')

extra_pois_mixed_high <- glm(n ~ as.factor(year):same_sex:mixed + 
                        as.factor(year):same_sex + 
                        as.factor(year):mixed + 
                        as.factor(year) + group_fe + state_policy + state_income + state_unemploy,
                        data = mutate(count_origin_high, 
                                      year = factor(floor(year/2)*2, 
                                                    levels = c('2018', '2016', '2014', '2012', '2010', '2008'))), 
                        family = 'quasipoisson')

extra_pois_mixed_low <- glm(n ~ as.factor(year):same_sex:mixed + 
                        as.factor(year):same_sex + 
                        as.factor(year):mixed + 
                        as.factor(year) + group_fe + state_policy + state_income + state_unemploy,
                        data = mutate(count_origin_low, 
                                      year = factor(floor(year/2)*2, 
                                                    levels = c('2018', '2016', '2014', '2012', '2010', '2008'))), 
                        family = 'quasipoisson')

base_test <- car::linearHypothesis(dynamic_mod, c('as.factor(year)2012:same_sexTRUE:mixedTRUE=0',
                                     'as.factor(year)2010:same_sexTRUE:mixedTRUE=0'),
                      singular.ok = TRUE)
base_test_p <- base_test$`Pr(>Chisq)`[2]

high_test <- car::linearHypothesis(extra_pois_mixed_high, c('as.factor(year)2012:same_sexTRUE:mixedTRUE=0',
                                     'as.factor(year)2010:same_sexTRUE:mixedTRUE=0'),
                      singular.ok = TRUE)

high_test_p <- high_test$`Pr(>Chisq)`[2]

low_test <- car::linearHypothesis(extra_pois_mixed_low, c('as.factor(year)2012:same_sexTRUE:mixedTRUE=0',
                                     'as.factor(year)2010:same_sexTRUE:mixedTRUE=0'),
                      singular.ok = TRUE)

low_test_p <- low_test$`Pr(>Chisq)`[2]
```

1. The U.S. Congress legislatively re-affirmed marriage equality in 2022.

2. For example, in 2019, the U.S. issued 186,584 visas for immediate relatives of U.S. citizens and 190,938 for other family members, out of a total of 462,422 immigrant visas issued [@u.s.departmentofstate_2022_immigrant].  

3. Although the ACS has data on year of immigration and year of marriage, it does not have year of partnership for unmarried couples, which are the predominant relationship type for individuals in same-sex couples in our sample: `r sum(acs_count_base$same_sex == T & acs_count_base$married == T)` are married while `r sum(acs_count_base$same_sex == T & acs_count_base$married == F)` are unmarried. Even so, in Section A of the Online Appendix we investigate the ordering of marriage and immigration for the subset of couples in our sample who are married. Most married same-sex, mixed-citizenship couples married after immigration, and our DDD results hold for those who married at the time of or after immigration but not those who married before.  

4. Although modeling logged counts allows a similar interpretation of coefficients, the presence of cells with zero counts precludes this option.  

5. In Section C of the Online Appendix, we conduct additional DDD analyses where individuals who migrated in year $t$ are assigned the country-of-origin LGB policy score of year $t-1$, $t-2$, or $t-5$. Results are very similar across specifications.

6. These cut-points were chosen in the following way: LGB policy scores that are less than 0 indicate a clearly regressive context, with on balance more regressive than progressive policies. Defining the regressive subsample this way comprises `r sum(acs_count_base$origin_score < 0, na.rm = T)` individuals. Defining the progressive subsample as having a policy score greater than 3 produces a group of roughly equal size (`r sum(acs_count_base$origin_score > 3, na.rm = T)` individuals).

7. <https://www.lgbtmap.org/>  

8. We include evidence for the parallel trends assumption for the DD models in Section D of the Online Appendix; a pre-trend test provides support for parallel trends.

9.  We test that coefficients for 2010 and 2012 are both equal to 0, $\delta_{2010} = \delta_{2012} = 0$. This pre-trend test follows a $\chi^2$ distribution. For the full sample, the $\chi^2$ value is `r base_test$Chisq[2]` with a p-value of `r base_test_p`. For the progressive subsample, the $\chi^2$ value is `r high_test$Chisq[2]` with a p-value of `r high_test_p`. In both cases, we fail to reject the hypothesis that both coefficients are equal to 0, providing support for the parallel trends assumption.

\newpage

# About the Authors

Nathan I. Hoffmann is a doctoral candidate in the Department of Sociology at the University of California, Los Angeles. Nathan studies how state policies affect the decisions and well-being of immigrants, with a focus on schoolchildren and queer migrants. Recently his work has been published in *International Migration Review*, *Ethnic and Racial Studies*, and *Journal of Ethnic and Migration Studies*.

Kristopher Velasco is an Assistant Professor of Sociology at Princeton University. Kristopher uses the case of LGBT+ rights to illuminate changes within international organizations, civil society, transnational processes, and world culture. His recent work appears in *American Sociological Review*, *American Journal of Sociology*, and *International Migration Review*. Kristopher received his BA from the University of Kansas and MA and PhD from the University of Texas at Austin.

\newpage

# References

<div id="refs"></div>

\newpage

# Tables

```{r data-tab}
acs_count_mixed %>%
  mutate(Composition = if_else(same_sex == T, 'Same sex', 'Different sex'),
         Citizenship = if_else(mixed == T, 'Mixed citizenship', 'Same citizenship')) %>%
  group_by(Composition, Citizenship) %>%
  summarize(`n (unweighted)` = sum(n_unweighted),
            `Percent (unweighted)` = round(100* 
                   `n (unweighted)`/sum(acs_count_mixed$n_unweighted), 2),
            `n (weighted)` = sum(n),
            `Percent (weighted)` = round(100* `n (weighted)`/sum(acs_count_mixed$n), 2),
            ) %>%
  mutate(
    `Unweighted count` = paste0(
      scales::comma_format()(`n (unweighted)`), 
      ' (',
      `Percent (unweighted)`,
      '%)'),
    `Weighted count` = paste0(
      scales::comma_format()(`n (weighted)`), 
      ' (',
      `Percent (weighted)`,
      '%)')
    ) %>%
  select(Composition, Citizenship, `Unweighted count`, `Weighted count`) %>%
  flextable() %>%
  flextable::autofit() %>%
  flextable::set_caption('Unweighted and weighted sample sizes of cohabiting individuals by type of couple, from American Community Survey (ACS) data 2008-2019')
```

\newpage

```{r D-mod}
huxreg(dlist,
       coefs = c('Post-2013' = 'post_2013TRUE'),
  note = '{stars}. The "Regressive" sample includes only countries with a LGB policy score less than 0, and the "Progressive" sample includes only those with a score greater than 3. Group-clustered standard errors shown in parentheses. Source: American Community Survey 2008-2019. Authors\' calculations.',
       stars = c(`†` = 0.1, `*` = 0.05, `**` = 0.01, `***` = 0.001),
       statistics = c('Observations' = 'nobs')) %>%
  huxtable::set_width(1) %>%
  set_wrap(T) %>%
  set_all_padding(0) %>% set_caption_pos('topleft') %>%
  huxtable::set_caption('Simple-difference (D), quasi-Poisson regressions of counts of 
                        individuals in mixed-citizenship, same-sex couples, stratifying the sample by policy environment at year of immigration. The sample includes only mixed-citizenship, same-sex couples.')

```

\newpage

```{r DD-mod}
huxreg(ddlist,
       coefs = c('Post-2013 × Mixed-citizenship' = 'I(post_2013 * mixed)',
                'Post-2013' = 'post_2013TRUE'),
  note = '{stars}. The "Regressive" sample includes only countries with a LGB policy score less than 0, and the "Progressive" sample includes only those with a score greater than 3. Group-clustered standard errors shown in parentheses. Source: American Community Survey 2008-2019. Authors\' calculations.',
       stars = c(`†` = 0.1, `*` = 0.05, `**` = 0.01, `***` = 0.001),
       statistics = c('Observations' = 'nobs')) %>%
  huxtable::set_width(1) %>%
  set_wrap(T) %>%
  set_all_padding(0) %>% set_caption_pos('topleft') %>%
  huxtable::set_caption('Difference-in-difference (DD), quasi-Poisson regressions of counts of individuals in 
                        mixed-citizenship, same-sex couples, stratifying the sample by policy environment at year of immigration')


```

\newpage

```{r DDD-mod}
huxreg(dddlist,
       coefs = c('Post-2013 × Same-sex × Mixed-citizenship' = 'I(post_2013 * same_sex * mixed)',
                'Post-2013 × Same-sex'  = 'I(post_2013 * same_sex)',
                'Post-2013 × Mixed-citizenship'  = 'I(post_2013 * mixed)',
                'Post-2013' = 'post_2013TRUE'),
  note = '{stars}. The "Regressive" sample includes only countries with a LGB policy score less than 0, and the "Progressive" sample includes only those with a score greater than 3. Group-clustered standard errors shown in parentheses. Source: American Community Survey 2008-2019. Authors\' calculations.',
       stars = c(`†` = 0.1, `*` = 0.05, `**` = 0.01, `***` = 0.001),
       statistics = c('Observations' = 'nobs')) %>%
  huxtable::set_width(1) %>%
  set_wrap(T) %>%
  set_all_padding(0) %>% set_caption_pos('topleft') %>%
  huxtable::set_caption('Triple-differences (DDD), quasi-Poisson regressions of counts of 
                        individuals in mixed-citizenship, same-sex couples, stratifying the sample by policy environment at year of immigration')

```

\newpage

```{r controls-tab}
mod_mixed <- acs_count_mixed %>%
  glm(n ~ I(post_2013*same_sex*mixed) + 
        I(post_2013*same_sex) + 
        I(post_2013*mixed) + 
        post_2013 + 
        state_policy + state_income + state_unemploy +
        group_fe + as.factor(year), 
                        data = ., 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 


mod_os_high <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + 
                        state_policy + state_income + state_unemploy +
                        group_fe + as.factor(year), 
                        data = count_origin_high, 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe))


mod_os_low <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + 
                        state_policy + state_income + state_unemploy +
                        group_fe + as.factor(year), 
                        data = count_origin_low, 
                        family = 'quasipoisson') %>%
coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 


huxreg(list('Full sample' = mod_mixed, 'Progressive' = mod_os_high, 'Regressive' = mod_os_low),
       coefs = c('Post-2013 × Same-sex × Mixed-citizenship' = 'I(post_2013 * same_sex * mixed)',
                'Post-2013 × Same-sex'  = 'I(post_2013 * same_sex)',
                'Post-2013 × Mixed-citizenship'  = 'I(post_2013 * mixed)',
                'Post-2013' = 'post_2013TRUE',
                'State LGB policy' = 'state_policy',
                'State unemployment' = 'state_unemploy',
                'State per capita income' = 'state_income'),
  note = '{stars}. The "Regressive" sample includes only countries with a LGB policy score less than 0, and the "Progressive" sample includes only those with a score greater than 3. Group-clustered standard errors shown in parentheses. Source: American Community Survey 2008-2019. Authors\' calculations.',
       stars = c(`†` = 0.1, `*` = 0.05, `**` = 0.01, `***` = 0.001),
       statistics = c('Observations' = 'nobs')) %>%
  huxtable::set_width(1) %>%
  set_wrap(T) %>%
  set_all_padding(0) %>% set_caption_pos('topleft') %>%
  huxtable::set_caption('With state-level controls: triple-difference (DDD), quasi-Poisson 
  regressions of counts of individuals in mixed-citizenship, same-sex couples, stratifying by 
  state-country-year-group average policy environment')
```

\newpage

# Figures 

```{r desc, fig.height = 3, fig.cap = 'Estimated counts of individuals in mixed-citizenship, same-same couples from the American Community Survey. The "Regressive" sample includes only countries with a LGB policy score less than 0, and the "Progressive" sample includes only those with a score greater than 3. The sample is limited to individuals aged 18 to 64 in the 50 U.S. states. Immigrants in the sample are limited to those who immigrated at age 18 or older.'}
bind_rows(
  acs_count_base %>%
    mutate(cat = case_when(origin_score > 3 ~ 'Progressive',
                             origin_score < 0 ~ 'Regressive')) %>%
    filter(mixed_citizenship == T & same_sex == T & !is.na(cat)) %>%
    group_by(year, cat) %>%
    summarize(n = sum(perwt)),
  acs_count_base %>%
    filter(mixed_citizenship == T & same_sex == T) %>%
    group_by(year) %>%
    summarize(n = sum(perwt)) %>%
    mutate(cat = 'Full sample')) %>%
  ggplot(aes(x = year, y = n/1000, color = cat, linetype = cat)) +
  geom_line(linewidth = .3, ) +
  geom_vline(linewidth = .3, xintercept = 2013, linetype = 2) +
  labs(x = 'Year', y = 'n (thousands)') +
  theme(legend.text=element_text(size = 8))
```

\newpage

```{r method-desc, fig.height = 3.5, fig.cap = 'Conceptual comparison of simple-difference (D), difference-in-differences (DD), and triple-difference (DDD) designs. The trend of interest is shown in orange, and the vertical, dashed lines represent the moment the treatment is applied. Authors\' creation.'}
library(ggbrace)

df <- data.frame(year = c(2008, 2013, 2019),
           same_mixed = c(100, 150, 250),
           same_same = c(300, 310, 330),
           dif_mixed= c(400, 420, 450),
           dif_same = c(580, 600, 620)) %>%
  pivot_longer(-year, names_to = 'group', values_to = 'n')%>%
  arrange(group)

dplot <- df %>%
  filter(group == 'same_mixed') %>%
  ggplot(aes(x = year, y = n)) +
  geom_line(linewidth = .3, color = palette_dark[2]) +
  scale_y_continuous(limits = c(0, 650), breaks = NULL) +
  scale_x_continuous(limits = c(2007, 2022), breaks = NULL) +
  labs(x = 'Time', y = 'n',
       title = 'Simple difference (D)') +
  theme(panel.grid.major.y = element_line(size = .3), axis.line = element_line(size = .3), axis.ticks = element_line(size = .3), text = element_text(size = 8)) +
  geom_vline(linewidth = .3, xintercept = 2013, linetype = 2) +
  #ggbrace::geom_brace(size = .3, aes(c(4,7), c(4, 4.5), label="my label"), inherit.data=F, labelsize=5)
  # ggbrace::stat_brace(rotate = 90, labelsize = 2, width = 2,
  #                     aes(label = "simple difference")) +
  ggbrace::geom_brace(size = .3, aes(c(2020, 2021), c(100, 250),
                           label="A"),
                       rotate = 90,
                       inherit.data=F, labelsize = 2)
  # ggbrace::geom_brace(size = .3, aes(c(2020, 2021), c(100, 250), 
  #                         label="A"), 
  #                     rotate = 90,
  #                     inherit.data=F, labelsize = 2)

df2 <-  df %>%
  filter(group %in% c('same_mixed', 'same_same'))
ddplot <- df2 %>%
  ggplot(aes(x = year, y = n, group = group)) +
  geom_line(linewidth = .3, color = ifelse(df2$group == 'same_mixed', palette_dark[2], black)) +
  scale_y_continuous(limits = c(0, 650), breaks = NULL) +
  scale_x_continuous(limits = c(2007, 2022), breaks = NULL) +
  labs(x = 'Time', y = '',
       title = 'Diff-in-diff (DD)') +
  theme(panel.grid.major.y = element_line(size = .3), axis.line = element_line(size = .3), axis.ticks = element_line(size = .3), text = element_text(size = 8)) +
  geom_vline(linewidth = .3, xintercept = 2013, linetype = 2) +
  ggbrace::geom_brace(size = .3, aes(c(2020, 2021), c(100, 250),
                           label="A"),
                       rotate = 90,
                       inherit.data=F, labelsize = 2) +
  ggbrace::geom_brace(size = .3, aes(c(2020, 2021), c(300, 330),
                          label = "B"),
                      rotate = 90,
                      inherit.data=F, labelsize = 2)
  # ggbrace::geom_brace(size = .3, aes(c(2006, 2007), c(100, 300), 
  #                          label="B"), 
  #                      rotate = 270, 
  #                      inherit.data=F, labelsize = 2) +
  # ggbrace::geom_brace(size = .3, aes(c(2020, 2021), c(250, 330), 
  #                         label = "C"), 
  #                     rotate = 90, 
  #                     inherit.data=F, labelsize = 2)

dddplot <- df %>%
   ggplot(aes(x = year, y = n, group = group)) +
   geom_line(linewidth = .3, color = ifelse(df$group == 'same_mixed', palette_dark[2], black)) +
   scale_y_continuous(limits = c(0, 650), breaks = NULL) +
   scale_x_continuous(limits = c(2007, 2022), breaks = NULL) +
   labs(x = 'Time', y = '',
        title = 'Triple-diff (DDD)') +
  theme(panel.grid.major.y = element_line(size = .3), axis.line = element_line(size = .3), axis.ticks = element_line(size = .3), text = element_text(size = 8)) +
   geom_vline(size = .3, xintercept = 2013, linetype = 2) +
  ggbrace::geom_brace(size = .3, aes(c(2020, 2021), c(100, 250),
                           label="A"),
                       rotate = 90,
                       inherit.data=F, labelsize = 2) +
  ggbrace::geom_brace(size = .3, aes(c(2020, 2021), c(300, 330),
                          label = "B"),
                      rotate = 90,
                      inherit.data=F, labelsize = 2) +
  ggbrace::geom_brace(size = .3, aes(c(2020, 2021), c(400, 450),
                           label="C"),
                       rotate = 90,
                       inherit.data=F, labelsize = 2) +
  ggbrace::geom_brace(size = .3, aes(c(2020, 2021), c(580, 620),
                          label = "D"),
                      rotate = 90,
                      inherit.data=F, labelsize = 2)
   # ggbrace::geom_brace(size = .3, aes(c(2006, 2007), c(100, 300), 
   #                         label="B"), 
   #                     rotate = 270, 
   #                     inherit.data=F, labelsize = 2) +
   # ggbrace::geom_brace(size = .3, aes(c(2020, 2021), c(250, 330), 
   #                         label = "C"), 
   #                     rotate = 90, 
   #                     inherit.data=F, labelsize = 2) +
   # ggbrace::geom_brace(size = .3, aes(c(2006, 2007), c(400, 600), 
   #                         label="D"), 
   #                     rotate = 270, 
   #                     inherit.data=F, labelsize = 2) +
   # ggbrace::geom_brace(size = .3, aes(c(2020, 2021), c(450, 620), 
   #                         label = "E"), 
   #                     rotate = 90, 
   #                     inherit.data=F, labelsize = 2)

textsize <- 3
  
dplot_text <- ggplot() +                      
   annotate("text",
            x = 1,
            y = 1,
            size = textsize,
            label = latex2exp::TeX("\\delta = A")) + 
   theme_void() 

ddplot_text <- ggplot() +                      
  annotate("text",
           x = 1,
           y = 1,
           size = textsize,
           label = latex2exp::TeX("\\delta = A - B")) + 
  theme_void() 

dddplot_text <- ggplot() +                      
  annotate("text",
           x = 1,
           y = 1,
           size = textsize,
           label = latex2exp::TeX("\\delta = (A - B) - (C - D)")) + 
  theme_void() 
 
(dplot + ddplot + dddplot) /
  (dplot_text + ddplot_text + dddplot_text) +
  plot_layout(heights = c(6,1))
```

\newpage


```{r lag-plot, fig.height = 3.5, fig.cap = 'Dynamic specification of quasi-Poisson regression with two-way fixed effects, displaying the coefficient for the Year × Same-sex × Mixed-citizenship interaction. Survey years are aggregated into pairs, with 2008-2009 as the base category.'}
base_plot <- acs_count_mixed %>%
  mutate(year = floor(year/2)*2) %>%
  group_by(state, year, same_sex, mixed, group_fe, state_policy, state_income, state_unemploy) %>%
  summarize(n = sum(n)) %>%
  ungroup() %>%
  mutate(year = factor(floor(year/2)*2, 
            levels = c('2018', '2016', '2014', '2012', '2010', '2008'))) %>%
  glm(n ~ as.factor(year):same_sex:mixed + 
                        as.factor(year):same_sex + 
                        as.factor(year):mixed + 
                        as.factor(year) + group_fe + state_policy + state_income + state_unemploy,
                        data = ., 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe)) %>%
  tidy(conf.int = T) %>% 
  filter(str_detect(term, ':same_sexTRUE:mixedTRUE')) %>%
  mutate(term = str_extract(term, '\\d\\d\\d\\d'),
         year = as.numeric(term)) %>%
  ggplot(aes(x = year, y = estimate)) +
    geom_pointrange(aes(ymin = conf.low, ymax = conf.high), size = .3) +
    geom_hline(yintercept = 0) +
    geom_vline(size = .3, xintercept = 2013, linetype = 2) +
    theme(panel.grid.major.y = element_line(size = .3), axis.line = element_line(size = .3), axis.ticks = element_line(size = .3), legend.position = "none") +
    labs(x = 'Year', y = 'Estimate', title = 'Full sample') +
    theme(panel.grid.major.y = element_line(size = .3), axis.line = element_line(size = .3), axis.ticks = element_line(size = .3), text = element_text(size = 8))



extra_pois_mixed_high <- glm(n ~ as.factor(year):same_sex:mixed + 
                        as.factor(year):same_sex + 
                        as.factor(year):mixed + 
                        as.factor(year) + group_fe + state_policy + state_income + state_unemploy,
                        data = mutate(count_origin_high, 
                                      year = factor(floor(year/2)*2, 
                                                    levels = c('2018', '2016', '2014', '2012', '2010', '2008'))), 
                        family = 'quasipoisson')

extra_pois_mixed_low <- glm(n ~ as.factor(year):same_sex:mixed + 
                        as.factor(year):same_sex + 
                        as.factor(year):mixed + 
                        as.factor(year) + group_fe + state_policy + state_income + state_unemploy,
                        data = mutate(count_origin_low, 
                                      year = factor(floor(year/2)*2, 
                                                    levels = c('2018', '2016', '2014', '2012', '2010', '2008'))), 
                        family = 'quasipoisson')

strat_plot <- bind_rows(
  extra_pois_mixed_high %>%
    coeftest(., vcov = vcovCL(., cluster = ~group_fe)) %>%
    tidy(conf.int = T) %>% 
    filter(str_detect(term, ':same_sexTRUE:mixedTRUE')) %>%
    mutate(year = as.numeric(str_extract(term, '\\d\\d\\d\\d')),
           mod = 'Score > 3'),
  extra_pois_mixed_low %>%
    coeftest(., vcov = vcovCL(., cluster = ~group_fe)) %>%
    tidy(conf.int = T) %>%  
    filter(str_detect(term, ':same_sexTRUE:mixedTRUE')) %>%
    mutate(year = as.numeric(str_extract(term, '\\d\\d\\d\\d')),
           mod = 'Score < 0')) %>%
  mutate(mod = factor(mod, levels = c('Score > 3', 'Score < 0'))) %>%
  ggplot(aes(x = year, y = estimate, color = mod, shape = mod)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high), 
                  position=position_dodge(width=.5), size = .3) +
  geom_hline(yintercept = 0) +
  geom_vline(size = .3, xintercept = 2013, linetype = 2)  + 
  theme(panel.grid.major.y = element_line(size = .3), axis.line = element_line(size = .3), axis.ticks = element_line(size = .3), legend.position=c(.18,.9)) +
  labs(x = 'Year', y = 'Estimate', title = 'Stratified') +
  theme(panel.grid.major.y = element_line(size = .3), axis.line = element_line(size = .3), axis.ticks = element_line(size = .3), text = element_text(size = 8))



p_combined <- base_plot + strat_plot
p_ranges_y <- c(ggplot_build(p_combined[[1]])$layout$panel_scales_y[[1]]$range$range,
                ggplot_build(p_combined[[2]])$layout$panel_scales_y[[1]]$range$range)
p_combined & 
  ylim(min(p_ranges_y), max(p_ranges_y))
```

\newpage 
```{r policies-desc-calc, eval = F}
# policy_df <- read_csv(here('did', 'policy_df.csv'))

variables <- names(subset(acs_count_base, select = equal_age:propaganda))
dataset_policy_list <- list()

for(var_name in variables){
  print(var_name)
  dataset_policy_list[[var_name]] <- count_func(paste0('round(', var_name, ') > 0 | is.na(', var_name , ')'))
}

prog_policies <- c('equal_age', 'constitution', 'employment_discrim', 'hate_crimes',
                   'incite_hate', 'joint_adoption', 'lgb_military', 'marriage_equality',
                   'samesex_legal', 'civil_unions', 'conversion_therapies')
rep_policies <- c('unequal_age', 'death_penalty', 'lgb_military_ban', 
                  'marriage_ban', 'propaganda')


policy_desc_df <- list()
for(var_name in variables){
 policy_desc_df[[var_name]] <- dataset_policy_list[[var_name]] %>%
    filter(mixed == T & same_sex == T) %>%
    group_by(year) %>%
    summarize(n = sum(n)) %>%
    mutate(cat = var_name)
}

bind_rows(policy_desc_df) %>%
  mutate(policy_name = recode(cat, 
                         equal_age = 'Equal age of consent', 
                         unequal_age = 'Unequal age of consent',
                         constitution = 'Constitutional protection',
                         conversion_therapies = 'Conversion therapy ban',
                         death_penalty = 'Death penalty',
                         employment_discrim = 'Employment protection',
                         hate_crimes = 'Hate-crime protection',
                         incite_hate = 'Incitement to hate ban',
                         joint_adoption = 'Joint adoption',
                         lgb_military = 'LGB military',
                         lgb_military_ban = 'LGB military ban',
                         marriage_equality = 'Marriage equality',
                         marriage_ban = 'Marriage ban',
                         samesex_legal = 'Same-sex acts legal',
                         civil_unions = 'Civil unions',
                         propaganda = 'Anti-propaganda laws'),
         progressive = cat %in% prog_policies) %>%
  write_csv(here('did', 'policy_desc_df.csv'))
```

```{r policies-desc-plot, fig.height = 6, fig.cap = 'Estimated counts of individuals in mixed-citizenship couples originating in countries with specific LGB policies. Progressive policies are shown in green and regressive policies are shown in orange.'}

policy_desc_df <- read_csv(here('did', 'policy_desc_df.csv')) 

policy_order <- policy_desc_df %>%
  group_by(policy_name, progressive) %>%
  summarize(dif = n[year == 2019] - n[year == 2008]) %>%
  arrange(desc(progressive), desc(dif))

policy_desc_df <- policy_desc_df %>%
  mutate(policy_name = factor(policy_name, levels = policy_order$policy_name))
  

bind_rows(policy_desc_df) %>%
  ggplot(aes(x = year, y = n/1000)) +
  geom_line(size = .3, aes(color = ifelse(progressive == T, 
                           palette_dark[1], palette_dark[2]))) +
  geom_vline(size = .3, xintercept = 2013, linetype = 2) +
  facet_wrap(~policy_name) +
  labs(x = 'Year', y = 'n (thousands)')  +
  theme(panel.grid.major.y = element_line(size = .3), axis.line = element_line(size = .3), axis.ticks = element_line(size = .3), legend.position = "none",
        text = element_text(size = 8))

# p1 <- bind_rows(policy_desc_df) %>%
#   filter(cat %in% prog_policies) %>%
#   ggplot(aes(x = year, y = n/1000)) +
#   geom_line(size = .3, color = palette_dark[1]) +
#   geom_vline(size = .3, xintercept = 2013, linetype = 2) +
#   facet_wrap(~policy_name) +
#   labs(x = 'Year', y = 'n (thousands)', title = 'Progressive')
# 
# p2 <- bind_rows(policy_desc_df) %>%
#   filter(!(cat %in% prog_policies)) %>%
#   ggplot(aes(x = year, y = n/1000)) +
#   geom_line(size = .3, color = palette_dark[2]) +
#   geom_vline(size = .3, xintercept = 2013, linetype = 2) +
#   facet_wrap(~policy_name) +
#   labs(x = 'Year', y = 'n (thousands)', title = 'Regressive')  
# 
# p1 / p2 &
#   ylim(c(0, 80)) 

# bind_rows(policy_desc_df) %>%
#   mutate(type = ifelse(cat %in% prog_policies, 'Progressive', 'Regressive')) %>%
#   ggplot(aes(x = year, y = n/1000, color = type)) +
#   geom_line(size = .3, ) +
#   geom_vline(size = .3, xintercept = 2013, linetype = 2) +
#   facet_wrap(~cat) +
#   labs(x = 'Year', y = 'n (thousands)')  

```

\newpage

```{r policy-combos-setup, eval = F}

lgbt_policy <- read.csv(here('data', 'lgb_origin_index.csv'))
policy_list <- list()
variables <- names(subset(acs_count_base, select = equal_age:propaganda))

policy_combos <- acs_count_base %>%
  filter(!is.na(origin_score)) %>%
  select(equal_age:propaganda) %>%
  group_by(across(everything())) %>%
  count() %>%
  ungroup() %>%
  mutate(id = 1:nrow(.)) %>%
  as.data.frame() 


for(i in 1:nrow(policy_combos)){
  var_names <- variables[as.logical(policy_combos[i, variables])]
  print(paste0(i, ' out of ', nrow(policy_combos)))
  print(var_names)

  var_names_formula <- data.frame(policy = variables,
             operator = '==',
             val = as.numeric(policy_combos[i,variables])) %>%
    mutate(exp = paste(policy, operator, val)) %>%
    pull(exp) %>%
    paste(collapse = ' & ')
  var_names_formula <- paste0('(', var_names_formula, ') | is.na(origin_score)') 
  
  # if(length(var_names) == 0){
  #   var_names_formula <- '!is.na(state)'
  #   } else {
  #     var_names_formula <- paste0('(', paste(var_names, collapse = ' > 0 & '), 
  #                                 ' > 0) | is.na(origin_score)')
  #   }
  
  tryCatch({
    dataset_policy <- count_func(var_names_formula)
  
    policy_list[[policy_combos[i, 'id']]] <- glm(n ~  I(post_2013*same_sex*mixed) + 
                          I(post_2013*same_sex) + 
                          I(post_2013*mixed) + 
                          post_2013 + state_policy + state_income + state_unemploy +
                          group_fe + as.factor(year), 
                          data = dataset_policy, 
                          family = 'quasipoisson') %>%
    coeftest(., vcov = vcovCL(., cluster = ~group_fe))
  }, error=function(e){
        cat("ERROR :",conditionMessage(e), "\n")
        })

}

lapply(policy_list, function(x){
  if(!is.null(x)){
    tidy(x)[2, 2:3]
  } else {
      data.frame(estimate = NA, std.error = NA)
    }}
  ) %>%
  bind_rows() %>%
  mutate(id = 1:nrow(.)) %>%
  left_join(policy_combos) %>%
  write_csv(here('did', 'policy_combos_controls.csv'))
```

```{r policy-combos, fig.cap = 'Specific policy-stratified quasi-Poisson DDD regressions of counts of individuals in mixed-citizenship, same-sex couples, with state-level controls. Estimates and 95-percent confidence intervals are for the inverse variance-weighted average difference between samples that include individuals experiencing a policy and those who are not, for coefficients for the three-way interaction between indicators for same-sex, mixed-citizenship, and post-2013 survey year'}
policy_combos_out <- read_csv(here('did', 'policy_combos_controls.csv')) 
  # group_by(n) %>% 
  # slice(rep(1:n(), first(n))) %>% ungroup()

variables <- names(subset(policy_combos_out, select = equal_age:propaganda))

policy_dif_list <- list()
for(var_name in variables){
  policy_est_df <- policy_combos_out %>%
    mutate(weight = 1/std.error^2) %>%
    group_by(!!sym(var_name)) %>%
    summarize(estimate = sum(estimate*weight)/sum(weight),
              std.error = sqrt(1/sum(weight)))
    #summarize(estimate = mean(estimate), std.error = sqrt(mean(std.error^2)), n())
  # print(var_name)
  # print(policy_est_df)
  policy_dif_list[[var_name]] <- data.frame(policy = names(policy_est_df)[1],
             est_dif = policy_est_df$estimate[2] - policy_est_df$estimate[1],
             est_dif_se = sqrt(policy_est_df$std.error[2]^2 +
                                 policy_est_df$std.error[1]^2))

}

# # Weighted
# policy_dif_list <- list()
# for(var_name in variables){
#   policy_est_df <- policy_combos_out %>%
#     group_by(!!sym(var_name)) %>%
#     summarize(estimate = weighted.mean(estimate, w = n), 
#               std.error = weighted.mean(std.error^2, w = n))
#   policy_dif_list[[var_name]] <- data.frame(policy = names(policy_est_df)[1],
#              est_dif = policy_est_df$estimate[2] - policy_est_df$estimate[1],
#              est_dif_se = sqrt(policy_est_df$std.error[2]^2 + 
#                                  policy_est_df$std.error[1]^2))
#   
# }

prog_policies <- c('equal_age', 'constitution', 'employment_discrim', 'hate_crimes',
                   'incite_hate', 'joint_adoption', 'lgb_military', 'marriage_equality',
                   'samesex_legal', 'civil_unions', 'conversion_therapies')
rep_policies <- c('unequal_age', 'death_penalty', 'lgb_military_ban', 
                  'marriage_ban', 'propaganda')

bind_rows(policy_dif_list) %>%
  mutate(type = if_else(policy %in% prog_policies, 'Progressive', 'Regressive'),
         policy_name = recode(policy, 
                         equal_age = 'Equal age of consent', 
                         unequal_age = 'Unequal age of consent',
                         constitution = 'Constitutional protection',
                         conversion_therapies = 'Conversion therapy ban',
                         death_penalty = 'Death penalty',
                         employment_discrim = 'Employment protection',
                         hate_crimes = 'Hate-crime protection',
                         incite_hate = 'Incitement to hate banned',
                         joint_adoption = 'Joint adoption',
                         lgb_military = 'LGB military',
                         lgb_military_ban = 'LGB military ban',
                         marriage_equality = 'Marriage equality',
                         marriage_ban = 'Marriage ban',
                         samesex_legal = 'Same-sex acts legal',
                         civil_unions = 'Civil unions',
                         propaganda = 'Anti-propaganda laws'),
         lower = est_dif - 1.96*est_dif_se,
         upper = est_dif + 1.96*est_dif_se) %>%
  ggplot(aes(reorder(policy_name, est_dif), y = est_dif)) +
  geom_hline(yintercept = 0, linetype = 2, linewidth = .3) +
  geom_pointrange(aes(ymin = lower, ymax = upper), linewidth = .3) +
  coord_flip() +
  facet_wrap(~type, scales = 'free_y') +
  labs(x = '', y = '') +
  theme(panel.grid.major.y = element_line(size = .3), axis.line = element_line(size = .3), axis.ticks = element_line(size = .3), text = element_text(size = 8))

```