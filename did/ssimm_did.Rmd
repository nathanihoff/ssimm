---
output:
  bookdown::pdf_document2:
  # bookdown::word_document2:
  #   reference_docx: "word-template.docx"
    toc: no
    number_sections: yes
    pandoc_args: !expr rmdfiltr::add_wordcount_filter(rmdfiltr::add_citeproc_filter(args = NULL))
    latex_engine: xelatex
    keep_tex: no
    #template: svm-latex-ms.tex
# output: 
#   pdf_document:
#     citation_package: natbib
#     keep_tex: true
#     fig_caption: true
#     latex_engine: pdflatex
#     template: svm-latex-ms.tex
header-includes:
  - \usepackage{setspace}\doublespace
  - \usepackage{bbm}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \setlength{\headheight}{15pt}
  - \lhead{Hoffmann and Velasco}
  - \rhead{`r format(Sys.time(), '%B %e, %Y')`}
editor_options: 
  
  chunk_output_type: console
citeproc: no
# fontfamily: mathpazo
mainfont: "Times New Roman"
fontsize: 12pt
geometry: margin=1in
indent: yes
link-citations: yes
linkcolor: blue
bibliography: "/Users/nathan/Google Drive/Projects/2020 Same-Sex Immigrant Couples/ssimm/Same-Sex Immigration.bib"
csl: apa.csl
title: "Policy Effects on Mixed-Citizenship, Same-Sex Unions: A Triple-Difference Analysis"
# subtitle: "ASA 2022 Submission"
date: "`r format(Sys.time(), '%B %e, %Y')`"
author:
- Nathan I. Hoffmann, Department of Sociology, University of California, Los Angeles
- Kristopher Velasco, Department of Sociology, Princeton University

abstract: "After the U.S. Supreme Court struck down the Defense of Marriage Act (DOMA) in 2013, same-sex partners of U.S. citizens became eligible for spousal visas. Since then, the U.S. has a seen a rapid rise in same-sex, mixed-citizenship couples. However, this effect varies greatly depending on the LGB policy context of the non-citizen's country of origin. Using waves 2008 to 2019 of the American Community Survey, this study employs a triple-difference design to examine how the policy environment of the origin country moderates the effect of the end of DOMA. Quasi-Poisson models with two-way fixed effects show that, after 2013, individuals in mixed-citizenship same-sex couples coming from countries with progressive LGB policy saw a more than 50-percent increase in incidence relative to those in different-sex or same-citizenship couples. Meanwhile, those from countries with regressive laws experienced no relative increase. Furthermore, effects appear greatest for laws around same-sex civil unions and marriage. We argue that the policy context of country of origin leaves a lasting cultural impact on immigrants that shapes their response to policy shifts in their country of residence, even many years after migration."
 

---

<!-- Turn off hyphenation -->
<!-- \usepackage[none]{hyphenat} -->


```{r setup, include=F}
library(knitr)
library(broom)
library(huxtable)
library(sandwich)
library(lmtest)
library(here)
library(stargazer)
library(patchwork)
library(flextable)
library(tidyverse)
library(kableExtra)

knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = T, # results = 'asis',
                      cache.lazy = F, dpi = 600)

# knitr::opts_chunk$set(error=TRUE) 

options("yaml.eval.expr" = TRUE)

uclablue = '#2774AE'
gray = '#808080'
black = '#000000'
uclagold = '#FFB81C'
ucla_palette = c(uclablue, black, gray)

# theme_set(theme_cowplot(font_family = 'Palatino') + 
theme_set(theme_classic(base_family = 'Palatino') + 
            theme(legend.title=element_blank(), 
                  panel.grid.major.y = element_line('grey80'),
                  legend.background = element_rect(fill = "transparent")))
# ggplot <- function(...) ggplot2::ggplot(...) + scale_color_manual(values = ucla_palette) +
#   scale_fill_manual(values = ucla_palette)
ggplot <- function(...) ggplot2::ggplot(...) + scale_color_brewer(palette="Dark2") +
  scale_fill_brewer(palette="Dark2")

# library(colorspace)
# colorspace_palette = 'RdPu'
# ggplot <- function(...) ggplot2::ggplot(...) +
#   scale_color_discrete_sequential(palette=colorspace_palette) +
#   scale_fill_discrete_sequential(palette=colorspace_palette)

options(scipen=1, digits=2)
knit_hooks$set(inline = function(x) {
  prettyNum(x, big.mark=",")
})
knitr::opts_chunk$set(error=TRUE) 

set_flextable_defaults(font.family = 'Times New Roman',
                       # padding.bottom = 1,
                       # padding.top = 1,
                       # padding.left = 3,
                       # padding.right = 1,
                       theme_fun = 'theme_booktabs',
                       digits = 3, 
                       big.mark = ',',
                       line_spacing = 1)

defOut <- knitr::knit_hooks$get("plot")  # save the default plot hook 
knitr::knit_hooks$set(plot = function(x, options) {  # set new plot hook ...
  x <- defOut(x, options)  # first apply the default hook
  if(!is.null(options$wrapfigure)) {  # then, if option wrapfigure is given ...
    # create the new opening string for the wrapfigure environment ...
    wf <- sprintf("\\begin{wrapfigure}{%s}{%g\\textwidth}", options$wrapfigure[[1]], options$wrapfigure[[2]])
    x  <- gsub("\\begin{figure}", wf, x, fixed = T)  # and replace the default one with it.
    x  <- gsub("{figure}", "{wrapfigure}", x, fixed = T)  # also replace the environment ending
  }
  return(x)
})
```

```{r load, include = F}
acs_count_base <- read_csv(here('data', 'acs_count_base.csv'))
state_df <- read_csv(here('data', 'state_df.csv'))

count_func <- function(condition = '!is.na(state)'){
  acs_count_base %>%
    rename(mixed = mixed_citizenship) %>%
    filter(eval(rlang::parse_expr(condition))) %>%
    group_by(state, year, same_sex, mixed) %>%
    summarize(n = sum(perwt), 
              n_unweighted = n(),
              n_ar = sum(perwt[qcitizen != 'Allocated' & qeduc != 'Consistency edit' & allocated == F]), 
              n_unweighted_ar = sum(qcitizen != 'Allocated' & qeduc != 'Consistency edit' & allocated == F)) %>%
    ungroup() %>%
    complete(state, year, same_sex, mixed) %>%
    mutate(across(n:n_unweighted_ar, function(x) ifelse(is.na(x), 0, x))) %>%
    mutate(post_2013 = year > 2013,
           group_fe = paste(state, same_sex, mixed, sep = '_')) %>%
    left_join(state_df)
}

# acs_count_base %>%
#   filter(state == 'Alabama', year == 2008) %>%
#   group_by(same_sex, mixed_citizenship, bpldnew) %>%
#     summarize(n = sum(perwt), 
#               n_unweighted = n(),
#               n_ar = sum(perwt[qcitizen != 'Allocated' & qeduc != 'Consistency edit' & allocated == F]), 
#               n_unweighted_ar = sum(qcitizen != 'Allocated' & qeduc != 'Consistency edit' & allocated == F)) %>%
#   group_by(same_sex, mixed_citizenship) %>%
#    summarize(n = sum(n),
#             n_unweighted = sum(n_unweighted),
#             n_ar = sum(n_ar),
#             n_unweighted_ar = sum(n_unweighted_ar))

acs_count_mixed <- count_func()




# acs_count_mixed <- read_csv(here('data', 'acs_count_mixed.csv')) %>%
#   group_by(state, year, same_sex, mixed) %>%
#   summarize(n = sum(n),
#             n_unweighted = sum(n_unweighted),
#             n_ar = sum(n_ar),
#             n_unweighted_ar = sum(n_unweighted_ar)) %>%
#   mutate(post_2013 = year > 2013,
#          group_fe = paste(state, same_sex, mixed, sep = '_'))
# acs_prop <- read.csv(here('data', 'acs_prop_yrimmig_policy.csv')) %>%
#   mutate(post_2013 = (yrimmig > 2013))
# acs_prop_state <- read.csv(here('data', 'acs_dyad_policy.csv'))

lgb_origin_index <- read_csv(here('data', 'lgb_origin_index.csv'))
acs_ind <- read_rds(here('data', 'acs_couple_policy.rds'))  %>%
  mutate(post_2013 = year > 2013
         # mixed =  mixed_citizenship = (citizen_main == 'Not a citizen' & citizen_partner != 'Not a citizen') | 
         #   (citizen_main != 'Not a citizen' & citizen_partner == 'Not a citizen')
         ) %>%
  left_join(lgb_origin_index,  by = c('yrimmig' = 'year', 'bpldid' = 'Code')) 

acs_count_mixed_bpld <- read_csv(here('data', 'acs_count_mixed.csv'))  %>%
  left_join(
    acs_ind %>%
      group_by(year, state, bpld, same_sex) %>% 
      summarize(across(c(equal_age:propaganda, origin_score), mean, na.rm = T))
      #summarize(origin_score = mean(origin_score))
  )



```

```{r intro-stats}
total_same_mixed <- acs_count_mixed_bpld %>%
    filter(mixed == T & same_sex == T) %>%
    group_by(year) %>%
    summarize(n = sum(n)) %>%
  pull(n)

total_dif_mixed <- acs_count_mixed_bpld %>%
    filter(mixed == T & same_sex == F) %>%
    group_by(year) %>%
    summarize(n = sum(n)) %>%
  pull(n)
```



# Introduction
Unions, “a term encompassing marriage and nonmarital cohabitation” [@bloome_2020_marriage, p. 1754], are of central concern to many sociologists and demographers. This is because unions provide meaningful life experiences for those who enter them, but also because they are demonstrated to influence a range of important quality-of-life indicators. Moreover, studying how union formations change across populations can reveal other social processes of particular concern to a variety of sociologists: changing migration flows, gendered workforce participation, (de)institutionalization of cultural norms, and shifts in state governance and public policy – to name a few.

While research on unions in the United States historically privileges those in different-sex relationships, this line of research has recently expanded to include those in same-sex unions [@baumle_2009; @rosenfeld_2005_independence; @kolk_2020_two]. Research into this new domain is, in part, driven by both cultural and legal recognition of these alternative family formations. Now, studies seek to understand how previous demographic and sociological theories are strengthened or must be re-imagined when considering these additional arrangements [@martell_2020; @reczek_2017_promise; @manning_2016]. We contribute to this rich scholarly domain by considering an additional union type: those containing individuals of the same sex but mixed citizenship statuses.

While mixed-citizenship couples generally face particular barriers to union formation [@lopez_2021_unauthorized], numbers of mixed-citizenship, same-sex unions in the U.S. have been on a dramatic rise in recent years. This is likely due to an important policy change: In 2013, the U.S. Supreme Court ruled the Defense of Marriage Act (DOMA) unconstitutional. For the first time, U.S. citizens could sponsor the visa of their same-sex fiancé or spouse [@edwards_2013; @carron_2015_marriagebased]. In the years since, the U.S. population of immigrant-containing same-sex couples has grown rapidly [@hoffmann_2021_making; @redpath_2022_spousal]. Data on cohabiting partners and spouses from the American Community Survey [ACS, @ruggles_2021] show that numbers of different-sex, mixed-citizenship couples grew by `r round((total_dif_mixed[12]/total_dif_mixed[5]-1) * 100)` percent from 2013 to 2019 (from `r total_dif_mixed[5]/1e6` million to `r total_dif_mixed[12]/1e6` million), while corresponding same-sex couples increased by `r round((total_same_mixed[12]/total_same_mixed[5]-1) * 100)` percent (from `r total_same_mixed[5]/1e3` thousand to `r total_same_mixed[12]/1e3` thousand) in the same period. Despite this rapid increase, research on this population has been limited; existing work has largely focused on such unions only outside of the U.S. [@chauvin_2021_class; @salcedorobledo_2013_couples; @badgett_2011_separated].  

<!-- Furthermore, @redpath_2022_spousal convincingly demonstrates that 2013 constituted a watershed moment for mixed-citizenship same-sex couples -->

The growth of this new union type calls for additional research to again understand how this population confirms or complicates existing theory. While the DOMA decision opened this union pathway to all, uptake is unlikely to be homogeneous and may reinforce existing inequalities. Namely, we bring in theories from cultural sociology to argue that, like all relationship forms, same-sex unions are a cultural object specific to time and place [@kalmijn_2007_explaining; @treas_2014_attitudes; @wang_2018_coming]. By defining what is possible, state policies that exist at an immigrant’s country of origin shape the cultural products to which they aspire. For example, legally entering into a same-sex union was neither thinkable nor desirable for many until quite recently; progressive LGB policies institutionalizes this new cultural form and then expand support and participation in a recursive process [@baiocco_2014_desire;@abou-chad_2019_rights]. On the other hand, regressive LGB policies can limit the horizon of union possibilities, instill fear of punishment for disclosing one's same-sex union, and negatively influence whether U.S. immigration officials view same-sex relationships from these countries as credible [@carron_2015_marriagebased]. Hence, we argue that the repeal of DOMA will likely function as a pathway to spousal visas only when an immigrant's country of origin’s institutional context is affirming of LGB communities.


```{r desc, fig.height = 3, fig.cap = 'Estimated counts of individuals in mixed-citizenship, same-same couples from the American Community Survey. The "Regressive" sample includes only countries with a LGB policy score less than 0, and the "Progressive" sample includes only those with a score greater than 3.'}

# bind_rows(
#   acs_count_base %>%
#     mutate(cat = case_when(origin_score > 3 ~ 'Progressive',
#                              origin_score < 0 ~ 'Regressive')) %>%
#     filter(mixed_citizenship == T & same_sex == T & !is.na(cat)) %>%
#     group_by(year, cat) %>%
#     summarize(n = sum(perwt)),
#   acs_count_base %>%
#     filter(mixed_citizenship == T & same_sex == T) %>%
#     group_by(year) %>%
#     summarize(n = sum(perwt)) %>%
#     mutate(cat = 'Full sample')) %>%
#   ggplot(aes(x = year, y = n/1000, color = cat, linetype = cat)) +
#   geom_line() +
#   geom_vline(xintercept = 2013, linetype = 2) +
#   labs(x = 'Year', y = 'n (thousands)')



bind_rows(
  acs_count_mixed_bpld %>%
    mutate(cat = case_when(origin_score > 3 ~ 'Progressive',
                           origin_score < 0 ~ 'Regressive')) %>%
    filter(!is.na(cat) & mixed == T & same_sex == T) %>%
    group_by(year, cat) %>%
    summarize(n = sum(n)),
   acs_count_mixed_bpld %>%
    filter(mixed == T & same_sex == T) %>%
    group_by(year) %>%
    summarize(n = sum(n)) %>%
    mutate(cat = 'Full sample')
) %>% 
  ggplot(aes(x = year, y = n/1000, color = cat, linetype = cat)) +
  geom_line() +
  geom_vline(xintercept = 2013, linetype = 2) +
  labs(x = 'Year', y = 'n (thousands)')
  


# Individual -level
# bind_rows(
#   count_origin_high %>%
#     filter(mixed == T & same_sex == T) %>%
#     group_by(year) %>%
#     summarize(n = sum(n)) %>%
#     mutate(cat = 'Progressive'),
#   count_origin_low %>%
#     filter(mixed == T & same_sex == T) %>%
#     group_by(year) %>%
#     summarize(n = sum(n)) %>%
#     mutate(cat = 'Regressive'),
#   acs_count_mixed %>%
#     filter(mixed == T & same_sex == T) %>%
#     group_by(year) %>%
#     summarize(n = sum(n)) %>%
#     mutate(cat = 'Full sample')) %>% 
#   ggplot(aes(x = year, y = n/1000, color = cat, linetype = cat)) +
#   geom_line() +
#   geom_vline(xintercept = 2013, linetype = 2) +
#   labs(x = 'Year', y = 'n (thousands)')

# acs_count_mixed_bpld %>% 
#   filter(origin_score > 3)
```

To test our theory, we apply cutting-edge methods of causal inference. Using waves 2008 to 2019 of the ACS, we employ a triple-difference, quasi-Poisson model with two-way fixed effects to estimate the effect of the post-2013 legal context in the U.S. on numbers of mixed-citizenship same-sex couples reported in the ACS. By controlling for incidence of mixed-citizenship and same-citizenship couples that we would not expect to be impacted by this policy, this design allows us to isolate the effect of DOMA's repeal specifically on unions of interest [@redpath_2022_spousal]. To assess the role of LGB policy at the country of origin, we rely on an original dataset indexing LGB policy changes in `r length(unique(acs_count_mixed_bpld$bpld[!is.na(acs_count_mixed_bpld$origin_score)]))` countries from 1991 to 2019. We stratify the sample by the LGB policy context at the country of origin to examine how the policy environment of the origin country moderates the effect of the end of DOMA. 

Our findings reveal that, after 2013, individuals in mixed-citizenship same-sex couples hailing from countries with progressive LGB policies saw a more than 50-percent increase in incidence relative to those in different-sex or same-citizenship couples. Meanwhile, those from countries with regressive laws experienced no significant increase. Stratifying by specific policy shows that effects are greatest for laws legalizing same-sex civil unions and marriage. This suggests that the country-of-origin policy context leaves a lasting cultural impact on immigrants that shapes their response to policy shifts in their country of residence, even many years after migration.  

Our work adds to and connects the burgeoning literature on the importance of culture in shaping both migration [@benson_2009; @dixon_2020; @thompson_2017_migration] and union decisions [@wang_2018_coming; @msibi_2013_denied]. These results support the notion that institutional forms may be relevant outside of their obvious domain of influence.


# Background  

## The Overturning of Defense of Marriage Act and Expansion of Mixed-Citizenship, Same-Sex Unions  

The United States Supreme Court overturned the Defense of Marriage Act (DOMA) in United States v. Windsor in 2013. Enacted in 1996, DOMA prevented the recognition of same-sex marriages by instilling a heterosexual definition of marriage and spouse across the federal government. Even after same-sex marriages were legalized at the state level, this recognition did not open access to federal marriage benefits. So same-sex couples could only file federal tax returns jointly, secure Social Security benefits, and participate in numerous other federal programs like the Supplemental Nutrition Assistance Program after the 2013 Windsor decision.

The DOMA ruling also had another important consequence of unlocking spousal visas for same-sex couples [@edwards_2013]. The federal government has long provided a pathway for U.S. citizens to secure permanent residency, and eventual citizenship, for their migrant spouses and fiancés. Indeed, family reunification is privileged within U.S. migration law and such cases represent the vast majority of U.S. immigrant visas issued.^[For example, in 2019, The U.S. issued 186,584 visas for immediate relatives of U.S. citizens and 190,938 for other family members, out of a total of 462,422 immigrant visas issued [@u.s.departmentofstate_2022_immigrant].] However, DOMA categorically denied access to these visas because the federal government did not recognize same-sex unions as legitimate or valid. Additionally, DOMA had a downstream effect where even if a U.S. state were to legalize marriage, mixed-citizenship couples (where one partner is a U.S. citizen and the other is a non-citizen) were unlikely to take advantage of these state-level benefits. This is because a condition of non-permanent residents’ visas is to not show intent on staying in the U.S. permanently -- something marriage to a U.S. citizen can potentially violate. The Windsor decision allowed mixed-citizenship couples access to spousal visas and, where legal, for such couples to get married and switch visa types. Following the 2013 end of DOMA, @redpath_2022_spousal finds a 36 percent relative increase in partnering of mixed-citizenship same-sex couples and a 78 percent increase in these types of marriages.  

The dramatic rise in mixed-citizenship, same-sex couplings found by Redpath can be the result of two distinct mechanisms. First, an increased entry into such unions of individuals already residing in the U.S; or. second, new immigration of one or both members of the couple into the U.S. as a result of the policy shift. Regardless of pathway, rising trends invite us to ask new questions like: What are the characteristics of immigrants selecting into these relationships? How does one’s country-of-origin condition entering into such a union? 

Indeed, as shown in Figure \@ref(fig:desc), the rapid increase after 2013 was not uniform across immigrants from all countries. For those hailing from countries with progressive LGB policies, the increase was indeed rapid after 2013. However, from those with regressive LGB policies, no increase occurred. Why do we see so much variation by policy context at the country of origin?  


<!-- the value in considering broader cultural and legal contexts, even aspects seemingly unrelated to the matter at hand; -->

## Intersections of Culture, Law, and Sexuality in Understanding Union Formation
Family formation, especially processes related to unions, remains a central concern of many sociologists and demographers. There are a number of reasons for this attention to unions: They are subjectively important to many individuals’ everyday lives, they are an important mechanism that influence a range of outcomes (e.g., health and well-being, economic mobility, social integration), and because their formation and structure reveal on-going social transformations in society (e.g., gendered labor force participation, (de)institutionalization of cultural norms, changing migration patterns). We weave together different threads of union formation scholarship to provide a general theoretical framework for understanding the significance of our research question. As explained below, we specifically examine the interactions between culture and policy to understand the less-studied union-type of mixed-citizenship, same-sex couples and the divergent trends in Figure \@ref(fig:desc).

Marriage and cohabitation are inextricably woven into cultural processes operating at multiple scales. For example, the notion that one enters into and out of unions based on their own individual volition is a distinct cultural product formed as part of expanding liberalism and consumer logics [@wang_2018_coming; @sassler_2020_cohabitation]. These global processes have weakened family-arranged marriages and created the space for individual preferences to hold greater significance in union formation [@yu_2015_changes]. Yet, “individual preferences” regarding partner selection are also influenced by the cultural environment in which people are embedded [@hiekel_2014_understanding; @lappegard_2018_why]. Even at the most intimate of scales, the “when, where, how, why, and with whom” of sexual behaviors themselves are culturally determined [@Ahmadi_2003migration].

Within this vein, public policy is an important lever that both reflects and alters cultural understandings of unions and stratifies access to their benefits based precisely on such cultural understandings. Often, these laws both reflect cultural understandings yet can also be an important trigger to shape subsequent possibilities [@hiller_2013_changes]. For example, just within the U.S., interracial marriages, same-sex marriages, "no fault" divorce, and the rise in nonmarital cohabitation reflect evolving cultural values that connect to changes within these arrangements' legal governance [@emens__2009_intimate; @sassler_2020_cohabitation]. Moreover, public policies that touch on unions like paid family leave, welfare programs, health insurance and hospital visitation, and foster care, to name a few, all have embedded assumptions regarding an ideal family type [@levitt_2020_how; @cahill_2005_welfare]. Consequently, ostensibly "neutral" policies result in stratified participation based on how couples both fit within these ideal types and have the requisite resources to access their benefits. The close interactions between public policy and the cultural norms societies place onto unions means that "values and behavioral expectations about marriage and cohabitation, and about appropriate partners, are likely to be at the forefront of cultural and political clashes around the world" [ @sassler_2020_cohabitation, p.49].

Now, we turn to understanding this policy and culture interaction regarding mixed-citizenship, same-sex unions. Unfortunately, research centering this specific union type is limited; as such, we draw from existing research on mixed-citizenship and same-sex unions, generally. First, a significant body of research focuses on unions between citizens by birth and non-citizen immigrants, both in the U.S. [@lopez_2015_impossible; @lopez_2021_unauthorized; @qian_2001_measuring; @lichter_2015_whom; @bohra-mishra_2015_intermarriage; @lee_1990_patterns] and elsewhere [@bonjour_2021_intimate; @medrano_2020_europe; @hoogenraad_2021_marriage; @rodriguez-garcia_2015_contesting]. Historically, such research has focused on "marital assimilation" -- i.e., marriage to a native-born citizen -- as an important measure of immigrant integration [@qian_2007_social; @lichter_2015_whom; @gordon_1964_assimilation; @lee_1990_patterns; @bohra-mishra_2015_intermarriage; see @rodriguez-garcia_2015_contesting for a critique]. But more recent work has highlighted the particular stressors and barriers that mixed-citizenship couples face [@lopez_2015_impossible; @lopez_2021_unauthorized; @hoogenraad_2021_marriage]. Despite a pathway to citizenship being legally codified for spouses of U.S. citizens, mixed-citizenship couples face scrutiny and suspicion by the state, and their eventual success in acquiring citizenship is shaped by the timing and strategy that couples deploy as well as the resources they possess.  

Second, a burgeoning area of research focuses on same-sex unions [@gates_2015; @reczek_2020_sexual; @baumle_2009; @baumle_2013]. Especially following recent state and federal legalizations in marriage equality, this work compares same-sex to different-sex couples across a range of outcomes, including patterns of assortative mating [@schwartz_2009; @jepsen_2002]; division of household labor [@giddings_2014; @goldberg_2012_division; @goldberg_2013_doing; @vandervleuten_2021_samesex]; relationship satisfaction [@mackey_2004_relational; @holmberg_2009_sexual]; and relationship stability [@manning_2016; @manning_2022_cohabitation; @joyner_2017_gender]. Recent research also seeks to understand how legalization of marriage equality affects propensity to marry [@carpenter_2020], interstate migration [@marcen_2019], and earnings [@martell_2020], as well as how shifting legal environments alter LGB individuals’ desire to join such a union or alters their behaviors in the union once legal recognition is conferred.  

Though studies investigate different dimensions of each union type, these lines of research have largely proceeded on independent paths. This separation is due to research on mixed-citizenship couples assuming heterosexuality and research on same-sex unions assuming U.S. citizenship [@luibheid_2008]. While queer migration research is expanding, this area of research largely focuses on refugees seeking asylum in the U.S. or qualitative studies into the motivations and experiences of queer migrants. Thus, scholarship sitting at the intersection of these fields -- on mixed-citizenship, same-sex couples -- is limited. Small-scale work in France [@salcedorobledo_2013_couples] and the Netherlands [@chauvin_2021_class] suggests that same-sex, mixed-citizenship couples face even higher bureaucratic suspicion of the legitimacy of their relationships, while other scholars question the extent to which marriage equality has actually allowed provided pathways to citizenship for same-sex non-citizen partners [@badgett_2011_separated; @carron_2015_marriagebased]. Attending to this union type is important due to its rapid growth in the U.S., as demonstrated in Figure \@ref(fig:desc), and because we do not know the degree to which these unions confirm or challenge existing theories in how culture sets up participation in particular union types and stratifies access to benefits of public policy.

<!-- Research in this area demonstrates that rates of intermarriages between foreign-born and native-born populations reflects the degree to which foreign-born individuals are socially integrated into broader U.S. society or remain bounded within ethnic or class enclaves [@lichter_2015_whom].  -->

## Country of Origin and Selection into Same-Sex Unions
Although the DOMA decision equally applied to all mixed-citizenship couples, Figure \@ref(fig:desc) highlights an important line of differentiation: There is a distinct rise in couples where the non-U.S. citizen came from a country with more progressive LGB policies. Numbers of couples where the non-U.S. citizen came from a country with regressive LGB policies -- such as bans on sodomy, or anti-LGB "propaganda" laws -- remain unchanged. Why might this be? Why would conditions at the immigrant partner’s country of origin influence the distribution of same-sex union formation across the population of mixed-citizen couples in the U.S.? We argue that by investigating the interplay between law and culture, we can understand these diverging trends. 

Relationships, and marriage specifically, are unique cultural products [@rosenfeld_2007_age]. The rituals, symbols, norms, and laws that govern them have different instantiations depending on the time and place. These cultural products then influence and are influenced by the legal expectations and conditions associated with relationships [@kalmijn_2007_explaining; @treas_2014_attitudes; @wang_2018_coming]. This is especially true for same-sex unions in the present historical moment [@hull_2003_cultural; @ocobock_2020_leveraging]. The assimilation of same-sex couples into existing marriage and relationship programs is a current, dynamic process [@bernstein_2013_marrying; @saez_2011_samesex]. Denmark became the first country to recognize civil unions for same-sex partners in 1989 while Netherlands became the first to grant full marriage equality in 2001. At the end of 2019, 26 countries had recognized marriage equality nationally with an additional 13 recognizing civil unions.  
Of the many consequences of these shifts toward more progressive policies, one is that they shift our understanding of what it permissible and seen as possible. Prior to state recognition, there are often public campaigns by LGBT+ organizers seeking to influence broad support. While geared toward the general public, this campaign rhetoric and imagery also socializes LGB individuals into the appropriateness of participating in institutions long exclusive to heterosexuals [@bernstein_2013_marrying]. This is particularly important as participation in same-sex unions by LGB individuals is a critical strategy to normalize and secure such legal advancements [@ocobock_2020_leveraging].  State recognition of same-sex couples also takes on a recursive process of increasing desirability of forming such a union as participation becomes a real option [@baiocco_2014_desire]. Thus, immigrants coming from a country with an affirming policy environment that recognizes the validity of same-sex unions may be more inclined to establish and desire such a union once permitted to do so following DOMA.  

Conversely, policy environments that are especially regressive can hinder the formation of mixed-citizenship, same-sex unions by immigrants in the U.S. This can operate in multiple ways. First, regressive contexts can potentially limit the desirability of forming a same-sex union by limiting what is seen as possible. At the end of 2019, roughly 68 countries still criminalized same-sex sexual acts between two consenting adults [@velasco_forthcoming_transnational]. While in some countries these laws are rarely enforced, in others, such as Cameroon, there has been an active revival of these laws to terrorize LGB populations [@bongmba_2021_samesex]. Moreover, the DOMA legislation in the U.S. was not a unique act. More than 30 countries since the 1990s have similarly re-codified a “one man, one woman” definition of marriage either through federal law like DOMA or through constitutional amendments [@velasco_forthcoming_transnational]. Second, these legal environments can influence how the cultural norms, rituals, and performances of relationships manifest. In the U.S. and many Western countries where marriage equality exists, mainstream LGB cultures emphasize publicly “coming out” and sameness with heterosexuals using language such as “love is love.” But LGB cultures where “coming out” risks vulnerability state-sponsored violence can look quite different [@msibi_2013_denied]. Third, and relatedly, these different cultures can negatively influence whether U.S. immigration bureaucrats in charge of issuing visas perceive relationships as legitimate [@carron_2015_marriagebased]. When couple photos, disclosure to friends and family, and other public evidence are used to evaluate if a relationship is valid and worthy of a visa, immigrants coming from countries where such pieces of evidence can be harmful are at a systematic disadvantage. Thus, for all of these reasons, mixed-citizen, same-sex unions following the 2013 DOMA decision are likely to contain fewer immigrant partners from regressive contexts.

Consequently, we expect that affirming LGB policies, generally, at the non-citizen partner's country-of-origin will be associated with greater increases in same-sex, mixed-citizenship unions. We further hypothesize that policies relating specifically to unions -- such as a provision for civil partnerships -- are most important. In addition, we will examine the effect of one specific regressive policy -- same-sex marriage bans -- to test the implications of our theory. If it is correct, then even negative reinforcement of the institution of same-sex unions may have a lasting impact on immigrants' cultural repertoires.


# Data and Methods
## Data

We employ data from the 2008 to 2019 American Community Survey [@ruggles_2021]. Each year, the ACS surveys a 1-percent representative sample of the U.S. population about a variety of individual and household attributes. We focus on counts of individuals in mixed-citizenship same-sex couples, comparing to those in same-citizenship or different-sex couples. Our counts include only cohabiting individuals who identify themselves as spouses or unmarried partners, since the ACS does not allow identification of same-sex couples that do not reside together. "Mixed-citizenship" couples include either two citizens or two non-citizens, and "same-sex" couples include two individuals who report the same sex. We exclude individuals who immigrated before the age of 18 as well as those younger than 18 or older than 64 in each survey year.   

Beginning in 2008 the Census Bureau made changes to ACS gender and partnership questions in order to prevent such errors [@u.s.censusbureau_2013], so we rely on data only from 2008 onward. In addition, following @gates_2009, we remove all respondents that had either their relationship or sex variable imputed by the Census Bureau. See Table \@ref(tab:data-tab) for sample sizes. 

```{r data-tab}
acs_count_mixed %>%
  mutate(Composition = if_else(same_sex == T, 'Same sex', 'Different sex'),
         Citizenship = if_else(mixed == T, 'Mixed citizenship', 'Same citizenship')) %>%
  group_by(Composition, Citizenship) %>%
  summarize(`n (unweighted)` = sum(n_unweighted),
            `n (weighted)` = sum(n)) %>%
  flextable() %>%
  flextable::autofit() %>%
  flextable::set_caption('Unweighted and weighted sample sizes from American Community Survey (ACS) data, 2008-2019')
```

Our analytic strategy proceeds in two parts. First, how does LGB policy at country of origin moderate the effect of the repeal of DOMA on the incidence of same-sex, mixed-citizenship couples in the U.S.?  Second, which specific LGB policies of country of origin are most relevant in shaping entry into same-sex unions?

To isolate the effect of the 2013 DOMA repeal, we employ a triple difference, or  difference-in-differences-in-differences (DDD), quasi-Poisson design [@hausman_1984_econometric; @olden_forthcoming_triple]. We model counts as draws from a Poisson distribution, but estimate our model more flexibly by using quasi-maximum likelihood estimation (QMLE). Unlike Maximum Likelihood Estimation (MLE), this estimation method does not assume the mean and variance of the distribution are equal, adjusting standard errors accordingly [@cameron_2005_microeconometrics, p. 667]. We include two-way fixed effects, with indicators for survey year and state-group, and cluster standard errors at the state-group level.  

Our estimand is the relative change in incidence of individual in mixed-citizenship, same-sex couples following the repeal of DOMA in 2013. We estimate this as the coefficient to a three-way interaction between indicators for same-sex, mixed-citizenship, and post-2013 survey year. We write our model as
$$\begin{aligned}
y_{gst} = &\exp[\beta_0 + \beta_1 post_t + \beta_2 (M_g \times post_t) + \beta_3 (S_g \times post_t)  \\
&+ \beta_4 ( M_g \times S_g \times post_t) + \alpha_{gs} + \gamma_{t} + \epsilon_{gst}]
\end{aligned}$$
where $y_{gst}$ is the count of individuals in group $g$ in state $s$ in survey year $t$; $post_t$ is an indicator variable for $t > 2013$; $M_g$ is an indicator variable for group $g$ being mixed-citizenship; $S_g$ is an indicator variable for group $g$ being same-sex; $\alpha_{gs}$ are group-state fixed effects; $\gamma_t$ are survey year fixed effects; and $\epsilon_{gst}$ is an error term such that $\mathbb E(\epsilon_{gst}) = 0$. The coefficient of interest is $\beta_4$; the incidence ratio $\exp(\beta_4)$ estimates the relative increase in mixed-citizenship same-sex couples after 2013, relative to other couples.

<!-- $$\mathbb E[y_{gst}] = \exp(\beta_0 + \beta_1 \bbm 1_{\{t \geq 2013\}} + \beta_2 \bbm 1_{\{t \geq 2013\}}$$ -->


We focus on heterogeneity of this effect: how it varies by the LGB policy context of non-citizens' country of origin. We measure the origin country policy environment using a modified LGBT Policy Index [@velasco_2018] for 1991 to 2019. The index comprises 16 policies, with both progressive policies (civil unions, constitutional protection, conversion therapy ban, employment protection, equal age of consent, hate-crime protection, incitement to hate banned, joint adoption, LGB military, marriage equality, same-sex acts legal) and regressive ones (anti-propaganda laws, death penalty, LGB military ban, marriage ban, unequal age of consent). The index is created by summing the net total of progressive policies (scored $+1$) over regressive policies (scored $-1$). For the `r length(unique(acs_count_mixed_bpld$bpld))` countries of origin for our sample, the country index ranges from `r min(acs_count_mixed_bpld$origin_score, na.rm = T)` to `r max(acs_count_mixed_bpld$origin_score, na.rm = T)`, with a mean of `r mean(acs_count_mixed_bpld$origin_score, na.rm = T)` in our sample. Group-state-year-country cells are assigned the average score in the year of immigration for non-citizen individuals in that cell.


# Results
## Main Effects
```{r mod-tab}
mod_mixed <- acs_count_mixed %>%
  glm(n ~ I(post_2013*same_sex*mixed) + I(post_2013*same_sex) + I(post_2013*mixed) + 
        post_2013 + group_fe + as.factor(year), 
                        data = ., 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 


# acs_count_mixed %>%
#   glm(n ~ post_2013*same_sex*mixed + group_fe + as.factor(year),
#                         data = .,
#                         family = 'quasipoisson') %>%
# coeftest(., vcov = vcovCL(., cluster = ~group_fe)) %>%
#   tidy() %>%
#   filter(!str_detect(term, 'group'), !str_detect(term, 'year'))

count_origin_high <- # count_func('origin_score > 3 | is.na(origin_score)') 
  acs_count_mixed_bpld %>%
  filter(origin_score > 3 | is.na(origin_score)) %>%
  group_by(state, year, same_sex, mixed, post_2013, group_fe) %>%
  summarize(n = sum(n)) %>%
  ungroup() %>%
  complete(state, year, same_sex, mixed) %>%
  mutate(across(n, function(x) ifelse(is.na(x), 0, x)),
         post_2013 = year > 2013,
         group_fe = paste(state, same_sex, mixed, sep = '_')) %>%
  left_join(state_df)

# acs_count_base %>%
#   select(state, year, mixed_citizenship, same_sex, bpld, bpldnew, yrimmig, yrimmigmod, origin_score) %>%
#   sample_n(10)



# count_origin_high <- acs_count_base %>%
#     rename(mixed = mixed_citizenship) %>%
#     filter(origin_score > 3 | mixed == F) %>%
#     # filter(origin_score > 3 | is.na(origin_score)) %>%
#     group_by(state, year, same_sex, mixed) %>%
#     summarize(n = sum(perwt), 
#               n_unweighted = n(),
#               n_ar = sum(perwt[qcitizen != 'Allocated' & qeduc != 'Consistency edit' & allocated == F]), 
#               n_unweighted_ar = sum(qcitizen != 'Allocated' & qeduc != 'Consistency edit' & allocated == F)) %>%
#     ungroup() %>%
#     complete(state, year, same_sex, mixed) %>%
#     mutate(across(n:n_unweighted_ar, function(x) ifelse(is.na(x), 0, x))) %>%
#     mutate(post_2013 = year > 2013,
#            group_fe = paste(state, same_sex, mixed, sep = '_')) 


mod_os_high <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + 
                        group_fe + as.factor(year), 
                        data = count_origin_high, 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe))

count_origin_low <- # count_func('origin_score < 0 |  is.na(origin_score)')
  acs_count_mixed_bpld %>%
  filter(origin_score < 0 | is.na(origin_score)) %>%
  group_by(state, year, same_sex, mixed, post_2013, group_fe) %>%
  summarize(n = sum(n)) %>%
  ungroup() %>%
  complete(state, year, same_sex, mixed) %>%
  mutate(across(n, function(x) ifelse(is.na(x), 0, x)),
         post_2013 = year > 2013,
         group_fe = paste(state, same_sex, mixed, sep = '_')) %>%
  left_join(state_df)

mod_os_low <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + 
                        group_fe + as.factor(year), 
                        data = count_origin_low, 
                        family = 'quasipoisson') %>%
coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 


huxreg(list('Full sample' = mod_mixed, 'Progressive' = mod_os_high, 'Regressive' = mod_os_low),
       coefs = c('Post-2013 × Same-sex × Mixed-citizenship' = 'I(post_2013 * same_sex * mixed)',
                'Post-2013 × Same-sex'  = 'I(post_2013 * same_sex)',
                'Post-2013 × Mixed-citizenship'  = 'I(post_2013 * mixed)',
                'Post-2013' = 'post_2013TRUE'),
  note = '{stars}. The "Regressive" sample includes only countries with a LGB policy score less than 0, and the "Progressive" sample includes only those with a score greater than 3. Group-clustered standard errors shown in parentheses. Source: American Community Survey 2008-2019. Authors\' calculations.',
       stars = c(`†` = 0.1, `*` = 0.05, `**` = 0.01, `***` = 0.001),
       statistics = c('Observations' = 'nobs')) %>%
  huxtable::set_width(1) %>%
  set_wrap(T) %>%
  set_all_padding(0) %>%
  huxtable::set_caption('Quasi-Poisson DDD regressions of counts of 
                        mixed-citizenship same-sex couples, stratifying by state-country-year-group average policy environment')
  # theme_compact()

base_effect <- tidy(mod_mixed) %>%
  filter(term == 'I(post_2013 * same_sex * mixed)') %>%
  pull(estimate) 
high_effect <- tidy(mod_os_high) %>%
  filter(term == 'I(post_2013 * same_sex * mixed)') %>%
  pull(estimate) 
```



```{r lag-plot, fig.height = 3.5, fig.cap = 'Dynamic specification of quasi-Poisson regression with two-way fixed effects, displaying the coefficient for the Year × Same-sex × Mixed-citizenship interaction. Survey years are aggregated into pairs, with 2008-2009 as the base category.'}
base_plot <- acs_count_mixed %>%
  mutate(year = floor(year/2)*2) %>%
  group_by(state, year, same_sex, mixed, group_fe) %>%
  summarize(n = sum(n)) %>%
  ungroup() %>%
  mutate(year = factor(floor(year/2)*2, 
            levels = c('2018', '2016', '2014', '2012', '2010', '2008'))) %>%
  glm(n ~ as.factor(year):same_sex:mixed + 
                        as.factor(year):same_sex + 
                        as.factor(year):mixed + 
                        as.factor(year) + group_fe,
                        data = ., 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe)) %>%
  tidy(conf.int = T) %>% 
  filter(str_detect(term, ':same_sexTRUE:mixedTRUE')) %>%
  mutate(term = str_extract(term, '\\d\\d\\d\\d'),
         year = as.numeric(term)) %>%
  ggplot(aes(x = year, y = estimate)) +
    geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 2013, linetype = 2) +
    theme(legend.position = "none") +
    labs(x = 'Year', y = 'Estimate', title = 'Full sample')



extra_pois_mixed_high <- glm(n ~ as.factor(year):same_sex:mixed + 
                        as.factor(year):same_sex + 
                        as.factor(year):mixed + 
                        as.factor(year) + group_fe,
                        data = mutate(count_origin_high, 
                                      year = factor(floor(year/2)*2, 
                                                    levels = c('2018', '2016', '2014', '2012', '2010', '2008'))), 
                        family = 'quasipoisson')

extra_pois_mixed_low <- glm(n ~ as.factor(year):same_sex:mixed + 
                        as.factor(year):same_sex + 
                        as.factor(year):mixed + 
                        as.factor(year) + group_fe,
                        data = mutate(count_origin_low, 
                                      year = factor(floor(year/2)*2, 
                                                    levels = c('2018', '2016', '2014', '2012', '2010', '2008'))), 
                        family = 'quasipoisson')

strat_plot <- bind_rows(
  extra_pois_mixed_high %>%
    coeftest(., vcov = vcovCL(., cluster = ~group_fe)) %>%
    tidy(conf.int = T) %>% 
    filter(str_detect(term, ':same_sexTRUE:mixedTRUE')) %>%
    mutate(year = as.numeric(str_extract(term, '\\d\\d\\d\\d')),
           mod = 'Score > 3'),
  extra_pois_mixed_low %>%
    coeftest(., vcov = vcovCL(., cluster = ~group_fe)) %>%
    tidy(conf.int = T) %>%  
    filter(str_detect(term, ':same_sexTRUE:mixedTRUE')) %>%
    mutate(year = as.numeric(str_extract(term, '\\d\\d\\d\\d')),
           mod = 'Score < 0')) %>%
  ggplot(aes(x = year, y = estimate, color = mod, shape = mod)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high), position=position_dodge(width=.5)) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 2013, linetype = 2)  + 
  theme(legend.position=c(.18,.9)) +
  labs(x = 'Year', y = 'Estimate', title = 'Stratified')



p_combined <- base_plot + strat_plot
p_ranges_y <- c(ggplot_build(p_combined[[1]])$layout$panel_scales_y[[1]]$range$range,
                ggplot_build(p_combined[[2]])$layout$panel_scales_y[[1]]$range$range)
p_combined & 
  ylim(min(p_ranges_y), max(p_ranges_y))
```


```{r mod-tab2, eval = F}
mod_mixed <- acs_count_mixed %>%
  glm(n ~ I(post_2013*same_sex*mixed) + I(post_2013*same_sex) + I(post_2013*mixed) + 
        post_2013 + group_fe + as.factor(year), 
                        data = ., 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 

count_origin_high <- count_func('origin_score > 3 | is.na(origin_score)') 


mod_os_high <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + 
                        group_fe + as.factor(year), 
                        data = count_origin_high, 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe))

count_origin_low <- count_func('origin_score < 0 |  is.na(origin_score)')

mod_os_low <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + 
                        group_fe + as.factor(year), 
                        data = count_origin_low, 
                        family = 'quasipoisson') %>%
coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 


huxreg(list('Full sample' = mod_mixed, 'Progressive' = mod_os_high, 'Regressive' = mod_os_low),
       coefs = c('Post-2013 × Same-sex × Mixed-citizenship' = 'I(post_2013 * same_sex * mixed)',
                'Post-2013 × Same-sex'  = 'I(post_2013 * same_sex)',
                'Post-2013 × Mixed-citizenship'  = 'I(post_2013 * mixed)',
                'Post-2013' = 'post_2013TRUE'),
  note = '{stars}. The "Regressive" sample includes only countries with a LGB policy score less than 0, and the "Progressive" sample includes only those with a score greater than 3. Group-clustered standard errors shown in parentheses. Source: American Community Survey 2008-2019. Authors\' calculations.',
       stars = c(`†` = 0.1, `*` = 0.05, `**` = 0.01, `***` = 0.001),
       statistics = c('Observations' = 'nobs')) %>%
  huxtable::set_width(1) %>%
  set_wrap(T) %>%
  set_all_padding(0) %>%
  huxtable::set_caption('INDIVIDUAL LEVEL: STRATIFYING BY INDIVIDUAL POLICY ENVIRONMENT. Quasi-Poisson DDD regressions of counts of 
                        mixed-citizenship same-sex couples')
  # theme_compact()

base_effect <- tidy(mod_mixed) %>%
  filter(term == 'I(post_2013 * same_sex * mixed)') %>%
  pull(estimate) 
high_effect <- tidy(mod_os_high) %>%
  filter(term == 'I(post_2013 * same_sex * mixed)') %>%
  pull(estimate) 
```


```{r lag-plot2, eval = F, fig.height = 3.5, fig.cap = 'INDIVIDUAL-LEVEL: Dynamic specification of quasi-Poisson regression with two-way fixed effects, displaying the coefficient for the Year × Same-sex × Mixed-citizenship interaction. Survey years are aggregated into pairs, with 2008-2009 as the base category.'}
base_plot <- acs_count_mixed %>%
  mutate(year = floor(year/2)*2) %>%
  group_by(state, year, same_sex, mixed, group_fe) %>%
  summarize(n = sum(n)) %>%
  ungroup() %>%
  mutate(year = factor(floor(year/2)*2, 
            levels = c('2018', '2016', '2014', '2012', '2010', '2008'))) %>%
  glm(n ~ as.factor(year):same_sex:mixed + 
                        as.factor(year):same_sex + 
                        as.factor(year):mixed + 
                        as.factor(year) + group_fe,
                        data = ., 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe)) %>%
  tidy(conf.int = T) %>% 
  filter(str_detect(term, ':same_sexTRUE:mixedTRUE')) %>%
  mutate(term = str_extract(term, '\\d\\d\\d\\d'),
         year = as.numeric(term)) %>%
  ggplot(aes(x = year, y = estimate)) +
    geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 2013, linetype = 2) +
    theme(legend.position = "none") +
    labs(x = 'Year', y = 'Estimate', title = 'Full sample')



extra_pois_mixed_high <- glm(n ~ as.factor(year):same_sex:mixed + 
                        as.factor(year):same_sex + 
                        as.factor(year):mixed + 
                        as.factor(year) + group_fe,
                        data = mutate(count_origin_high, 
                                      year = factor(floor(year/2)*2, 
                                                    levels = c('2018', '2016', '2014', '2012', '2010', '2008'))), 
                        family = 'quasipoisson')

extra_pois_mixed_low <- glm(n ~ as.factor(year):same_sex:mixed + 
                        as.factor(year):same_sex + 
                        as.factor(year):mixed + 
                        as.factor(year) + group_fe,
                        data = mutate(count_origin_low, 
                                      year = factor(floor(year/2)*2, 
                                                    levels = c('2018', '2016', '2014', '2012', '2010', '2008'))), 
                        family = 'quasipoisson')

strat_plot <- bind_rows(
  extra_pois_mixed_high %>%
    coeftest(., vcov = vcovCL(., cluster = ~group_fe)) %>%
    tidy(conf.int = T) %>% 
    filter(str_detect(term, ':same_sexTRUE:mixedTRUE')) %>%
    mutate(year = as.numeric(str_extract(term, '\\d\\d\\d\\d')),
           mod = 'Score > 3'),
  extra_pois_mixed_low %>%
    coeftest(., vcov = vcovCL(., cluster = ~group_fe)) %>%
    tidy(conf.int = T) %>%  
    filter(str_detect(term, ':same_sexTRUE:mixedTRUE')) %>%
    mutate(year = as.numeric(str_extract(term, '\\d\\d\\d\\d')),
           mod = 'Score < 0')) %>%
  ggplot(aes(x = year, y = estimate, color = mod, shape = mod)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high), position=position_dodge(width=.5)) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 2013, linetype = 2)  + 
  theme(legend.position=c(.18,.9)) +
  labs(x = 'Year', y = 'Estimate', title = 'Stratified')



p_combined <- base_plot + strat_plot
p_ranges_y <- c(ggplot_build(p_combined[[1]])$layout$panel_scales_y[[1]]$range$range,
                ggplot_build(p_combined[[2]])$layout$panel_scales_y[[1]]$range$range)
p_combined & 
  ylim(min(p_ranges_y), max(p_ranges_y))
```

Table \@ref(tab:mod-tab) presents results from our DDD specifications. For the full sample, the incidence of individuals in mixed-citizenship, same-sex couples grew by $100 \times [\exp(`r base_effect`) -1] =$ `r 100*(exp(base_effect) - 1)` percent after 2013, relative to those in couples that were not same-sex or mixed-citizenship. The result is even stronger if the sample is limited to individuals from progressive countries (defined as those with an LGB policy score greater than 3), at `r 100*(exp(high_effect) - 1)` percent. However, those from regressive countries (with a policy score less than 0) saw no significant increase at all.  

Figure \@ref(fig:lag-plot) presents dynamic models of the effect of interest. These models replace the post-2013 indicator variable with a categorical variable for survey year, with years grouped into pairs for statistical power. The left panel shows this lag-lead specification for the full sample. We see that coefficients for the three-way interaction between year, same-sex, and mixed-citizenship become significantly positive only after 2013. The right panel presents the same specification, but for the stratified samples as in Table \@ref(tab:mod-tab). Here, we see a clear upward trend for non-citizens from progressive countries, while the trend for those from regressive countries hovers close to 0. Also of note across all samples is the lower coefficient for the years 2018-2019, perhaps demonstrating a "Trump effect" reducing LGB immigration or the willingness of LGB citizens and non-citizens to enter into unions.


```{r mod-tab-controls, eval = F}
mod_mixed <- acs_count_mixed_bpld %>%
  group_by(state, year, same_sex, mixed) %>%
  summarize(n = sum(n),
            across(distw:stock_prop)) %>%
  ungroup() %>%
  complete(state, year, same_sex, mixed) %>%
  mutate(across(n, function(x) ifelse(is.na(x), 0, x)),
         post_2013 = year > 2013,
         group_fe = paste(state, same_sex, mixed, sep = '_'))
  glm(n ~ I(post_2013*same_sex*mixed) + I(post_2013*same_sex) + I(post_2013*mixed) + 
        post_2013 + group_fe + as.factor(year) +
                        data = ., 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 

# acs_count_mixed %>%
#   glm(n ~ post_2013*same_sex*mixed + group_fe + as.factor(year),
#                         data = .,
#                         family = 'quasipoisson') %>%
# coeftest(., vcov = vcovCL(., cluster = ~group_fe)) %>%
#   tidy() %>%
#   filter(!str_detect(term, 'group'), !str_detect(term, 'year'))

count_origin_high <- # count_func('origin_score > 3 | is.na(origin_score)') 
  acs_count_mixed_bpld %>%
  filter(origin_score > 3 | is.na(origin_score)) %>%
  group_by(state, year, same_sex, mixed, post_2013, group_fe) %>%
  summarize(n = sum(n)) %>%
  ungroup() %>%
  complete(state, year, same_sex, mixed) %>%
  mutate(across(n, function(x) ifelse(is.na(x), 0, x)),
         post_2013 = year > 2013,
         group_fe = paste(state, same_sex, mixed, sep = '_'))

# acs_count_base %>%
#   select(state, year, mixed_citizenship, same_sex, bpld, bpldnew, yrimmig, yrimmigmod, origin_score) %>%
#   sample_n(10)



# count_origin_high <- acs_count_base %>%
#     rename(mixed = mixed_citizenship) %>%
#     filter(origin_score > 3 | mixed == F) %>%
#     # filter(origin_score > 3 | is.na(origin_score)) %>%
#     group_by(state, year, same_sex, mixed) %>%
#     summarize(n = sum(perwt), 
#               n_unweighted = n(),
#               n_ar = sum(perwt[qcitizen != 'Allocated' & qeduc != 'Consistency edit' & allocated == F]), 
#               n_unweighted_ar = sum(qcitizen != 'Allocated' & qeduc != 'Consistency edit' & allocated == F)) %>%
#     ungroup() %>%
#     complete(state, year, same_sex, mixed) %>%
#     mutate(across(n:n_unweighted_ar, function(x) ifelse(is.na(x), 0, x))) %>%
#     mutate(post_2013 = year > 2013,
#            group_fe = paste(state, same_sex, mixed, sep = '_')) 


mod_os_high <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + 
                        group_fe + as.factor(year), 
                        data = count_origin_high, 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe))

count_origin_low <- # count_func('origin_score < 0 |  is.na(origin_score)')
  acs_count_mixed_bpld %>%
  filter(origin_score < 0 | is.na(origin_score)) %>%
  group_by(state, year, same_sex, mixed, post_2013, group_fe) %>%
  summarize(n = sum(n)) %>%
  ungroup() %>%
  complete(state, year, same_sex, mixed) %>%
  mutate(across(n, function(x) ifelse(is.na(x), 0, x)),
         post_2013 = year > 2013,
         group_fe = paste(state, same_sex, mixed, sep = '_'))

mod_os_low <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + 
                        group_fe + as.factor(year), 
                        data = count_origin_low, 
                        family = 'quasipoisson') %>%
coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 


huxreg(list('Full sample' = mod_mixed, 'Progressive' = mod_os_high, 'Regressive' = mod_os_low),
       coefs = c('Post-2013 × Same-sex × Mixed-citizenship' = 'I(post_2013 * same_sex * mixed)',
                'Post-2013 × Same-sex'  = 'I(post_2013 * same_sex)',
                'Post-2013 × Mixed-citizenship'  = 'I(post_2013 * mixed)',
                'Post-2013' = 'post_2013TRUE'),
  note = '{stars}. The "Regressive" sample includes only countries with a LGB policy score less than 0, and the "Progressive" sample includes only those with a score greater than 3. Group-clustered standard errors shown in parentheses. Source: American Community Survey 2008-2019. Authors\' calculations.',
       stars = c(`†` = 0.1, `*` = 0.05, `**` = 0.01, `***` = 0.001),
       statistics = c('Observations' = 'nobs')) %>%
  huxtable::set_width(1) %>%
  set_wrap(T) %>%
  set_all_padding(0) %>%
  huxtable::set_caption('Quasi-Poisson DDD regressions of counts of 
                        mixed-citizenship same-sex couples, stratifying by state-country-year-group average policy environment')
  # theme_compact()
```

Although the two-way fixed effects in our specifications allay concerns of confounders, it is still possible that time-varying state- and group-level variables may be confounding results. We test the robustness of our results by re-specifying our models while adjusting for additional variables. State-year-level per capita income by year comes from the Bureau of Economic Analysis [@bea_2020], and annual unemployment rates come from the Bureau of Labor Statistics [@bls_2020]. We also create a U.S. state-year LGB policy index by compiling data from the Movement Advancement Project^[https://www.lgbtmap.org/], a leading LGB organization in the U.S. that collects data on a number of relevant policies. Like the origin-country index, the state index comprises both progressive policies (full marriage equality, state recognition of civil unions and domestic partnerships, ban on all employment and housing discrimination based on sexual orientation, hate crime protections based on sexual orientation, legal joint adoption by same-sex couples, and a ban on conversation therapy for minors) and regressive policies (criminalization of sodomy, state constitutional bans of marriage equality, religious freedom exemptions to discriminate against same-sex couples in adoption, and state-level bans on local non-discrimination ordinances encompassing sexual orientation). The state index ranges from `r min(acs_count_mixed$state_policy, na.rm = T)` to `r max(acs_count_mixed$state_policy, na.rm = T)`, and the mean state policy score for immigrants in our sample is `r mean(acs_count_mixed$state_policy, na.rm = T)`.  

Table \@ref(tab:controls-tab) replicates Table \@ref(tab:mod-tab), but with these additional controls. Coefficients are only slightly attenuated, and substantive conclusions do not change. Notably, the coefficient for state LGB policy is small and nonsignificant; in these models, state LGB policy does not appear related to the incidence of same-sex unions.

\newpage

```{r controls-tab}
mod_mixed <- acs_count_mixed %>%
  glm(n ~ I(post_2013*same_sex*mixed) + 
        I(post_2013*same_sex) + 
        I(post_2013*mixed) + 
        post_2013 + 
        state_policy + state_income + state_unemploy +
        group_fe + as.factor(year), 
                        data = ., 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 


mod_os_high <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + 
                        state_policy + state_income + state_unemploy +
                        group_fe + as.factor(year), 
                        data = count_origin_high, 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe))


mod_os_low <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + 
                        state_policy + state_income + state_unemploy +
                        group_fe + as.factor(year), 
                        data = count_origin_low, 
                        family = 'quasipoisson') %>%
coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 


huxreg(list('Full sample' = mod_mixed, 'Progressive' = mod_os_high, 'Regressive' = mod_os_low),
       coefs = c('Post-2013 × Same-sex × Mixed-citizenship' = 'I(post_2013 * same_sex * mixed)',
                'Post-2013 × Same-sex'  = 'I(post_2013 * same_sex)',
                'Post-2013 × Mixed-citizenship'  = 'I(post_2013 * mixed)',
                'Post-2013' = 'post_2013TRUE',
                'State LGB policy' = 'state_policy',
                'State unemployment' = 'state_unemploy',
                'State per-capita income' = 'state_income'),
  note = '{stars}. The "Regressive" sample includes only countries with a LGB policy score less than 0, and the "Progressive" sample includes only those with a score greater than 3. Group-clustered standard errors shown in parentheses. Source: American Community Survey 2008-2019. Authors\' calculations.',
       stars = c(`†` = 0.1, `*` = 0.05, `**` = 0.01, `***` = 0.001),
       statistics = c('Observations' = 'nobs')) %>%
  huxtable::set_width(1) %>%
  set_wrap(T) %>%
  set_all_padding(0) %>%
  huxtable::set_caption('With state-level controls: quasi-Poisson DDD regressions 
  of counts of mixed-citizenship same-sex couples, stratifying by 
  state-country-year-group average policy environment')
```


## Which Policies are Responsible?

Clearly, the post-2013 rise in mixed-citizenship same-sex unions occurred much more strongly for immigrants from countries with overall progressive LGB policies. But are there some policies that matter more than others? Whereas Table \@ref(tab:mod-tab) stratified the sample by values of the policy index, here we stratify the sample by specific policies. Within each cell, we include only mixed-citizenship couples for whom the non-citizen country of origin has an average value greater than 0 for the policy of interest -- i.e., where immigrants in that group tended to experience the given policy in their year of immigration.  

Figure \@ref(fig:policies-plot) displays coefficients from the three-way interaction of interest, showing the logged relative incidence of mixed-citizenship same-sex couples after 2013. Coefficients in models focusing on progressive policies are mostly positive. Notably, coefficients for civil unions and marriage equality are especially high.  

The right panel of Figure \@ref(fig:policies-plot) shows mostly nonsignificant coefficients for regressive policies. Those that are significant have smaller point estimates than most progressive policies. One possible explanation for the range of results for regressive policies is that more "severe" regressive policies, such as the death penalty, are more effective at erasing the possibility of same-sex unions. Meanwhile, policies such as anti-propaganda laws are often a backlash to an already established LGB community and its cultural forms (XX).

```{r policies, eval = F}

policy_list <- list()
variables <- names(subset(acs_count_mixed_bpld, select = equal_age:propaganda))

# for(var_name in variables){
#   policy_list[[var_name]] <- acs_ind %>%
#     filter(!!sym(var_name) == 1 | is.na(!!sym(var_name))) %>%
#     group_by(state, year, same_sex, mixed, post_2013, group_fe) %>%
#     summarize(n = sum(n)) %>% 
#     ungroup() %>%
#     complete(state, year, same_sex, mixed) %>%
#     mutate(across(n, function(x) ifelse(is.na(x), 0, x)),
#            post_2013 = year > 2013,
#            group_fe = paste(state, same_sex, mixed, sep = '_'))
# }

for(var_name in variables){
  # dataset_policy <- acs_count_mixed_bpld %>%
  #   filter(!!sym(var_name) > 0 | is.na(!!sym(var_name))) %>%
  #   group_by(state, year, same_sex, mixed, post_2013, group_fe) %>%
  #   summarize(n = sum(n)) %>%
  #   ungroup() %>%
  #   complete(state, year, same_sex, mixed) %>%
  #   mutate(across(n, function(x) ifelse(is.na(x), 0, x)),
  #          post_2013 = year > 2013,
  #          group_fe = paste(state, same_sex, mixed, sep = '_'))
  
  dataset_policy <- count_func(paste0(var_name, ' > 0 | is.na( ', var_name , ')'))
  
  policy_list[[var_name]] <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + 
                        group_fe + as.factor(year), 
                        data = dataset_policy, 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe))
}

prog_policies <- c('equal_age', 'constitution', 'employment_discrim', 'hate_crimes',
                   'incite_hate', 'joint_adoption', 'lgb_military', 'marriage_equality',
                   'samesex_legal', 'civil_unions', 'conversion_therapies')
rep_policies <- c('unequal_age', 'death_penalty', 'lgb_military_ban', 
                  'marriage_ban', 'propaganda')

policy_df <- lapply(policy_list, function(x){
  tidy(x)[2, 2:3]}
  ) %>%
  bind_rows() %>%
  mutate(policy = names(policy_list),
         type = if_else(policy %in% prog_policies, 'Progressive', 'Regressive'),
         policy_name = recode(policy, 
                         equal_age = 'Equal age of consent', 
                         unequal_age = 'Unequal age of consent',
                         constitution = 'Constitutional protection',
                         conversion_therapies = 'Conversion therapy ban',
                         death_penalty = 'Death penalty',
                         employment_discrim = 'Employment protection',
                         hate_crimes = 'Hate-crime protection',
                         incite_hate = 'Incitement to hate banned',
                         joint_adoption = 'Joint adoption',
                         lgb_military = 'LGB military',
                         lgb_military_ban = 'LGB military ban',
                         marriage_equality = 'Marriage equality',
                         marriage_ban = 'Marriage ban',
                         samesex_legal = 'Same-sex acts legal',
                         civil_unions = 'Civil unions',
                         propaganda = 'Anti-propaganda laws'),
         lower = estimate - 1.96*std.error,
         upper = estimate + 1.96*std.error)

write_csv(policy_df, here('did', 'policy_df.csv'))
```

```{r policies-plot, fig.cap = 'Stratified by specific policy: quasi-Poisson DDD regressions of counts of mixed-citizenship same-sex couples, stratifying by state-country-year-groups with policy averages greater than 0. Estimates and 95-percent confidence intervals are for the three-way interaction between indicators for same-sex, mixed-citizenship, and post-2013 survey year.'}
policy_list <- list()
variables <- names(subset(acs_count_mixed_bpld, select = equal_age:propaganda))

# for(var_name in variables){
#   policy_list[[var_name]] <- acs_ind %>%
#     filter(!!sym(var_name) == 1 | is.na(!!sym(var_name))) %>%
#     group_by(state, year, same_sex, mixed, post_2013, group_fe) %>%
#     summarize(n = sum(n)) %>% 
#     ungroup() %>%
#     complete(state, year, same_sex, mixed) %>%
#     mutate(across(n, function(x) ifelse(is.na(x), 0, x)),
#            post_2013 = year > 2013,
#            group_fe = paste(state, same_sex, mixed, sep = '_'))
# }

for(var_name in variables){
  dataset_policy <- acs_count_mixed_bpld %>%
    filter(!!sym(var_name) > 0
           | is.na(!!sym(var_name))) %>%
    group_by(state, year, same_sex, mixed, post_2013, group_fe) %>%
    summarize(n = sum(n)) %>%
    ungroup() %>%
    complete(state, year, same_sex, mixed) %>%
    mutate(across(n, function(x) ifelse(is.na(x), 0, x)),
           post_2013 = year > 2013,
           group_fe = paste(state, same_sex, mixed, sep = '_'))
  
  # dataset_policy <- count_func(paste0(var_name, ' > 0 | is.na(', var_name , ')'))
  
  policy_list[[var_name]] <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + 
                        group_fe + as.factor(year), 
                        data = dataset_policy, 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe))
}

prog_policies <- c('equal_age', 'constitution', 'employment_discrim', 'hate_crimes',
                   'incite_hate', 'joint_adoption', 'lgb_military', 'marriage_equality',
                   'samesex_legal', 'civil_unions', 'conversion_therapies')
rep_policies <- c('unequal_age', 'death_penalty', 'lgb_military_ban', 
                  'marriage_ban', 'propaganda')

policy_df <- lapply(policy_list, function(x){
  tidy(x)[2, 2:3]}
  ) %>%
  bind_rows() %>%
  mutate(policy = names(policy_list),
         type = if_else(policy %in% prog_policies, 'Progressive', 'Regressive'),
         policy_name = recode(policy, 
                         equal_age = 'Equal age of consent', 
                         unequal_age = 'Unequal age of consent',
                         constitution = 'Constitutional protection',
                         conversion_therapies = 'Conversion therapy ban',
                         death_penalty = 'Death penalty',
                         employment_discrim = 'Employment protection',
                         hate_crimes = 'Hate-crime protection',
                         incite_hate = 'Incitement to hate banned',
                         joint_adoption = 'Joint adoption',
                         lgb_military = 'LGB military',
                         lgb_military_ban = 'LGB military ban',
                         marriage_equality = 'Marriage equality',
                         marriage_ban = 'Marriage ban',
                         samesex_legal = 'Same-sex acts legal',
                         civil_unions = 'Civil unions',
                         propaganda = 'Anti-propaganda laws'),
         lower = estimate - 1.96*std.error,
         upper = estimate + 1.96*std.error)

policy_df %>%
  ggplot(aes(reorder(policy_name, estimate), y = estimate)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_pointrange(aes(ymin = lower, ymax = upper)) +
  coord_flip() +
  facet_wrap(~type, scales = 'free_y') +
  labs(x = '', y = '')
```

```{r policies-plot2, eval = F, fig.cap = 'COUNTRY-LEVEL: STATE-COUNTRY-YEAR-GROUPS WITH POLICY AVERAGE GREATER THAN 0.5. Stratified by specific policy: quasi-Poisson DDD regressions of counts of mixed-citizenship same-sex couples. Estimates and 95-percent confidence intervals are for the three-way interaction between indicators for same-sex, mixed-citizenship, and post-2013 survey year'}
policy_df <- read_csv(here('did', 'policy_df.csv'))

policy_list <- list()
variables <- names(subset(acs_count_mixed_bpld, select = equal_age:propaganda))

# for(var_name in variables){
#   policy_list[[var_name]] <- acs_ind %>%
#     filter(!!sym(var_name) == 1 | is.na(!!sym(var_name))) %>%
#     group_by(state, year, same_sex, mixed, post_2013, group_fe) %>%
#     summarize(n = sum(n)) %>% 
#     ungroup() %>%
#     complete(state, year, same_sex, mixed) %>%
#     mutate(across(n, function(x) ifelse(is.na(x), 0, x)),
#            post_2013 = year > 2013,
#            group_fe = paste(state, same_sex, mixed, sep = '_'))
# }

for(var_name in variables){
  dataset_policy <- acs_count_mixed_bpld %>%
    filter(!!sym(var_name) > .5
           | is.na(!!sym(var_name))) %>%
    group_by(state, year, same_sex, mixed, post_2013, group_fe) %>%
    summarize(n = sum(n)) %>%
    ungroup() %>%
    complete(state, year, same_sex, mixed) %>%
    mutate(across(n, function(x) ifelse(is.na(x), 0, x)),
           post_2013 = year > 2013,
           group_fe = paste(state, same_sex, mixed, sep = '_'))
  
  # dataset_policy <- count_func(paste0(var_name, ' > 0 | is.na(', var_name , ')'))
  
  policy_list[[var_name]] <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + 
                        group_fe + as.factor(year), 
                        data = dataset_policy, 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe))
}

prog_policies <- c('equal_age', 'constitution', 'employment_discrim', 'hate_crimes',
                   'incite_hate', 'joint_adoption', 'lgb_military', 'marriage_equality',
                   'samesex_legal', 'civil_unions', 'conversion_therapies')
rep_policies <- c('unequal_age', 'death_penalty', 'lgb_military_ban', 
                  'marriage_ban', 'propaganda')

policy_df <- lapply(policy_list, function(x){
  tidy(x)[2, 2:3]}
  ) %>%
  bind_rows() %>%
  mutate(policy = names(policy_list),
         type = if_else(policy %in% prog_policies, 'Progressive', 'Regressive'),
         policy_name = recode(policy, 
                         equal_age = 'Equal age of consent', 
                         unequal_age = 'Unequal age of consent',
                         constitution = 'Constitutional protection',
                         conversion_therapies = 'Conversion therapy ban',
                         death_penalty = 'Death penalty',
                         employment_discrim = 'Employment protection',
                         hate_crimes = 'Hate-crime protection',
                         incite_hate = 'Incitement to hate banned',
                         joint_adoption = 'Joint adoption',
                         lgb_military = 'LGB military',
                         lgb_military_ban = 'LGB military ban',
                         marriage_equality = 'Marriage equality',
                         marriage_ban = 'Marriage ban',
                         samesex_legal = 'Same-sex acts legal',
                         civil_unions = 'Civil unions',
                         propaganda = 'Anti-propaganda laws'),
         lower = estimate - 1.96*std.error,
         upper = estimate + 1.96*std.error)

policy_df %>%
  ggplot(aes(reorder(policy_name, estimate), y = estimate)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_pointrange(aes(ymin = lower, ymax = upper)) +
  coord_flip() +
  facet_wrap(~type, scales = 'free_y') +
  labs(x = '', y = '')
```

```{r policies-plot3, eval = F, fig.cap = 'INDIVIDUAL LEVEL: ONLY INDIVIDUALS EXPERIENCING POLICY. Stratified by specific policy: quasi-Poisson DDD regressions of counts of mixed-citizenship same-sex couples. Estimates and 95-percent confidence intervals are for the three-way interaction between indicators for same-sex, mixed-citizenship, and post-2013 survey year'}
policy_df <- read_csv(here('did', 'policy_df.csv'))

policy_list <- list()
variables <- names(subset(acs_count_mixed_bpld, select = equal_age:propaganda))
dataset_policy_list <- list()

for(var_name in variables){
  #print(var_name)
  dataset_policy_list[[var_name]] <- count_func(paste0(var_name, ' > 0 | is.na(', var_name , ')'))
  
  policy_list[[var_name]] <- glm(n ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013 + #state_policy + state_income + state_unemploy +
                        group_fe + as.factor(year), 
                        data = dataset_policy_list[[var_name]], 
                        family = 'quasipoisson') %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe))
}

prog_policies <- c('equal_age', 'constitution', 'employment_discrim', 'hate_crimes',
                   'incite_hate', 'joint_adoption', 'lgb_military', 'marriage_equality',
                   'samesex_legal', 'civil_unions', 'conversion_therapies')
rep_policies <- c('unequal_age', 'death_penalty', 'lgb_military_ban', 
                  'marriage_ban', 'propaganda')


policy_df <- lapply(policy_list, function(x){
  tidy(x)[2, 2:3]}
  ) %>%
  bind_rows() %>%
  mutate(policy = names(policy_list),
         type = if_else(policy %in% prog_policies, 'Progressive', 'Regressive'),
         policy_name = recode(policy, 
                         equal_age = 'Equal age of consent', 
                         unequal_age = 'Unequal age of consent',
                         constitution = 'Constitutional protection',
                         conversion_therapies = 'Conversion therapy ban',
                         death_penalty = 'Death penalty',
                         employment_discrim = 'Employment protection',
                         hate_crimes = 'Hate-crime protection',
                         incite_hate = 'Incitement to hate banned',
                         joint_adoption = 'Joint adoption',
                         lgb_military = 'LGB military',
                         lgb_military_ban = 'LGB military ban',
                         marriage_equality = 'Marriage equality',
                         marriage_ban = 'Marriage ban',
                         samesex_legal = 'Same-sex acts legal',
                         civil_unions = 'Civil unions',
                         propaganda = 'Anti-propaganda laws'),
         lower = estimate - 1.96*std.error,
         upper = estimate + 1.96*std.error)

policy_df %>%
  ggplot(aes(reorder(policy_name, estimate), y = estimate)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_pointrange(aes(ymin = lower, ymax = upper)) +
  coord_flip() +
  facet_wrap(~type, scales = 'free_y') +
  labs(x = '', y = '')


policy_desc_df <- list()
for(var_name in variables){
 policy_desc_df[[var_name]] <- dataset_policy_list[[var_name]] %>%
    filter(mixed == T & same_sex == T) %>%
    group_by(year) %>%
    summarize(n = sum(n)) %>%
    mutate(cat = var_name)
}

bind_rows(policy_desc_df) %>%
  filter(cat %in% prog_policies) %>%
  ggplot(aes(x = year, y = n/1000)) +
  geom_line(color = 'blue') +
  geom_vline(xintercept = 2013, linetype = 2) +
  facet_wrap(~cat) +
  labs(x = 'Year', y = 'n (thousands)', title = 'Progressive') +
bind_rows(policy_desc_df) %>%
  filter(!(cat %in% prog_policies)) %>%
  ggplot(aes(x = year, y = n/1000)) +
  geom_line(color = 'red') +
  geom_vline(xintercept = 2013, linetype = 2) +
  facet_wrap(~cat) +
  labs(x = 'Year', y = 'n (thousands)', title = 'Regressive')  

bind_rows(policy_desc_df) %>%
  mutate(type = ifelse(cat %in% prog_policies, 'Progressive', 'Regressive')) %>%
  ggplot(aes(x = year, y = n/1000, color = type)) +
  geom_line() +
  geom_vline(xintercept = 2013, linetype = 2) +
  facet_wrap(~cat) +
  labs(x = 'Year', y = 'n (thousands)')  

```


```{r policy-tab, eval = F}
huxreg(policy_list[prog_policies],
       coefs = c('Post-2013 × Same-sex × Mixed-citizenship' = 'I(post_2013 * same_sex * mixed)',
                'Post-2013 × Same-sex'  = 'I(post_2013 * same_sex)',
                'Post-2013 × Mixed-citizenship'  = 'I(post_2013 * mixed)',
                'Post-2013' = 'post_2013TRUE'),
  note = '{stars}. Group-clustered standard errors shown in parentheses. Source: American Community Survey 2008-2019. Authors\' calculations.',
       stars = c(`†` = 0.1, `*` = 0.05, `**` = 0.01, `***` = 0.001),
       statistics = c('Observations' = 'nobs')) %>%
  huxtable::set_width(1) %>%
  set_wrap(T) %>%
  set_all_padding(0) %>%
  huxtable::set_caption('Stratified by progressive policies: Quasi-Poisson DDD regressions of counts of 
                        mixed-citizenship same-sex couples')


huxreg(policy_list[rep_policies],
       coefs = c('Post-2013 × Same-sex × Mixed-citizenship' = 'I(post_2013 * same_sex * mixed)',
                'Post-2013 × Same-sex'  = 'I(post_2013 * same_sex)',
                'Post-2013 × Mixed-citizenship'  = 'I(post_2013 * mixed)',
                'Post-2013' = 'post_2013TRUE'),
  note = '{stars}. Group-clustered standard errors shown in parentheses. Source: American Community Survey 2008-2019. Authors\' calculations.',
       stars = c(`†` = 0.1, `*` = 0.05, `**` = 0.01, `***` = 0.001),
       statistics = c('Observations' = 'nobs')) %>%
  huxtable::set_width(1) %>%
  set_wrap(T) %>%
  set_all_padding(0) %>%
  huxtable::set_caption('Stratified by regressive policies: Quasi-Poisson DDD regressions of counts of 
                        mixed-citizenship same-sex couples')
```




<!-- # Next steps -->
<!-- We plan to extend our analysis as well as conduct a series of robustness checks. Future analyses will incorporate ACS data from 2020 and examine whether effects vary by U.S. state of residence and local LGB policy. Finally, although the two-way fixed effects in our specifications allay concerns of time-invariant confounders, we will test the robustness of our results by including possible time-varying confounders such as state GDP. -->



```{r stratified-mixed, eval = F, fig.cap = 'Predicted numbers of individuals in mixed-citizenship couples, stratified by LGBT policy score of origin country'}

extra_pois_mixed_high <- glm(n ~ as.factor(year):same_sex:mixed + 
                        as.factor(year):same_sex + 
                        as.factor(year):mixed + 
                        as.factor(year) + group_fe,
                        data = count_origin_high, 
                        family = 'quasipoisson')

extra_pois_mixed_low <- glm(n ~ as.factor(year):same_sex:mixed + 
                        as.factor(year):same_sex + 
                        as.factor(year):mixed + 
                        as.factor(year) + group_fe,
                        data = count_origin_low, 
                        family = 'quasipoisson')

bind_rows(
  count_origin_high %>%
    filter(mixed == T, same_sex == T) %>%
    cbind(., n_fit = predict(extra_pois_mixed_high, newdata = ., type = 'response')) %>% 
    group_by(year) %>%
    summarize(n_fit = sum(n_fit)) %>%
    mutate(mod = 'Score > 3'),
  count_origin_low %>%
    filter(mixed == T, same_sex == T) %>%
    cbind(., n_fit = predict(extra_pois_mixed_low, newdata = ., type = 'response')) %>% 
    group_by(year) %>%
    summarize(n_fit = sum(n_fit)) %>%
    mutate(mod = 'Score < 0')) %>%
  ggplot(aes(x = year, y = n_fit, color = mod)) +
  geom_line() +
  geom_vline(xintercept = 2013, linetype = 2)
 
```


```{r log-prop, eval = F}
acs_count_mixed_log <- left_join(
  acs_count_mixed,
  acs_count_mixed %>%
    group_by(state, year) %>%
    summarize(n_total = sum(n))) %>%
  ungroup() %>%
  mutate(prop = n / n_total,
         log_prop = log(prop),
         log_prop1 = log(prop + 0.01) ) #log(prop + sqrt(prop^2 + 1))

  
mod_mixed <- acs_count_mixed_log %>%
  lm(log_prop1 ~ post_2013*same_sex*mixed + group_fe + as.factor(year), 
                        data = .) %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 

count_origin_high_log <- left_join(
  count_origin_high,
  count_origin_high %>%
    group_by(state, year) %>%
    summarize(n_total = sum(n))) %>%
  ungroup() %>%
  mutate(prop = n / n_total,
         log_prop = log(prop),
         log_prop1 = log(prop + 0.01))


mod_os_high <- lm(log_prop1 ~  post_2013*same_sex*mixed + group_fe + as.factor(year), 
                        data = count_origin_high_log) %>%
  coeftest(., vcov = vcovCL(., cluster = ~group_fe))

count_origin_low_log <- left_join(
  count_origin_low,
  count_origin_low %>%
    group_by(state, year) %>%
    summarize(n_total = sum(n))) %>%
  ungroup() %>%
  mutate(prop = n / n_total,
         log_prop = log(prop),
         log_prop1 = log(prop + 0.01))

mod_os_low <- lm(log_prop1 ~  post_2013*same_sex*mixed + group_fe + as.factor(year), 
                        data = count_origin_low_log) %>%
coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 


huxreg(list('Full sample' = mod_mixed, 'Progressive' = mod_os_high, 'Regressive' = mod_os_low),
       coefs = c('Post-2013 × Same-sex × Mixed-citizenship' = 'post_2013TRUE:same_sexTRUE:mixedTRUE',
                'Post-2013 × Same-sex'  = 'post_2013TRUE:same_sexTRUE',
                'Post-2013 × Mixed-citizenship'  = 'post_2013TRUE:mixedTRUE',
                'Post-2013' = 'post_2013TRUE'),
        tidy_args = list(exponentiate = TRUE),
  note = '{stars}. The "Regressive" sample includes only countries with a LGB policy score less than 0, and the "Progressive" sample includes only those with a score greater than 3. Group-clustered standard errors shown in parentheses. Source: American Community Survey 2008-2019. Authors\' calculations.',
       stars = c(`†` = 0.1, `*` = 0.05, `**` = 0.01, `***` = 0.001),
       statistics = c('Observations' = 'nobs')) %>%
  huxtable::set_width(1) %>%
  set_wrap(T) %>%
  set_all_padding(0) %>%
  huxtable::set_caption('Quasi-Poisson DDD regressions of counts of 
                        mixed-citizenship same-sex couples, stratifying by state-country-year-group average policy environment')


```


```{r country, eval = F}
mod_mixed <- acs_count_mixed %>%
  group_by(year, same_sex, mixed, post_2013) %>%
  summarize(n_country = sum(n)) %>%
  mutate(group_fe = paste0(same_sex, mixed)) %>%
  glm(n_country ~ I(post_2013*same_sex*mixed) + I(post_2013*same_sex) + I(post_2013*mixed) + 
        post_2013, 
                        data = ., 
                        family = 'quasipoisson') 
  #coeftest(., vcov = vcovCL(., cluster = ~group_fe)) 


# acs_count_mixed %>%
#   glm(n ~ post_2013*same_sex*mixed + group_fe + as.factor(year),
#                         data = .,
#                         family = 'quasipoisson') %>%
# coeftest(., vcov = vcovCL(., cluster = ~group_fe)) %>%
#   tidy() %>%
#   filter(!str_detect(term, 'group'), !str_detect(term, 'year'))

count_origin_high <- # count_func('origin_score > 3 | is.na(origin_score)') 
  acs_count_mixed_bpld %>%
  filter(origin_score > 3 | is.na(origin_score)) %>%
  group_by(state, year, same_sex, mixed, post_2013, group_fe) %>%
  summarize(n = sum(n)) %>%
  ungroup() %>%
  complete(state, year, same_sex, mixed) %>%
  mutate(across(n, function(x) ifelse(is.na(x), 0, x)),
         post_2013 = year > 2013,
         group_fe = paste(state, same_sex, mixed, sep = '_')) %>%
  left_join(state_df)

# acs_count_base %>%
#   select(state, year, mixed_citizenship, same_sex, bpld, bpldnew, yrimmig, yrimmigmod, origin_score) %>%
#   sample_n(10)



# count_origin_high <- acs_count_base %>%
#     rename(mixed = mixed_citizenship) %>%
#     filter(origin_score > 3 | mixed == F) %>%
#     # filter(origin_score > 3 | is.na(origin_score)) %>%
#     group_by(state, year, same_sex, mixed) %>%
#     summarize(n = sum(perwt), 
#               n_unweighted = n(),
#               n_ar = sum(perwt[qcitizen != 'Allocated' & qeduc != 'Consistency edit' & allocated == F]), 
#               n_unweighted_ar = sum(qcitizen != 'Allocated' & qeduc != 'Consistency edit' & allocated == F)) %>%
#     ungroup() %>%
#     complete(state, year, same_sex, mixed) %>%
#     mutate(across(n:n_unweighted_ar, function(x) ifelse(is.na(x), 0, x))) %>%
#     mutate(post_2013 = year > 2013,
#            group_fe = paste(state, same_sex, mixed, sep = '_')) 


mod_os_high <- count_origin_high %>%
   group_by(year, same_sex, mixed, post_2013) %>%
  summarize(n_country = sum(n)) %>%
  glm(n_country ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013,
                        data = ., 
                        family = 'quasipoisson')

count_origin_low <- # count_func('origin_score < 0 |  is.na(origin_score)')
  acs_count_mixed_bpld %>%
  filter(origin_score < 0 | is.na(origin_score)) %>%
  group_by(state, year, same_sex, mixed, post_2013, group_fe) %>%
  summarize(n = sum(n)) %>%
  ungroup() %>%
  complete(state, year, same_sex, mixed) %>%
  mutate(across(n, function(x) ifelse(is.na(x), 0, x)),
         post_2013 = year > 2013,
         group_fe = paste(state, same_sex, mixed, sep = '_')) %>%
  left_join(state_df)

mod_os_low <- count_origin_low %>%
   group_by(year, same_sex, mixed, post_2013) %>%
  summarize(n_country = sum(n)) %>%
  glm(n_country ~  I(post_2013*same_sex*mixed) + 
                        I(post_2013*same_sex) + 
                        I(post_2013*mixed) + 
                        post_2013,
                        data = ., 
                        family = 'quasipoisson') 


huxreg(list('Full sample' = mod_mixed, 'Progressive' = mod_os_high, 'Regressive' = mod_os_low),
       coefs = c('Post-2013 × Same-sex × Mixed-citizenship' = 'I(post_2013 * same_sex * mixed)',
                'Post-2013 × Same-sex'  = 'I(post_2013 * same_sex)',
                'Post-2013 × Mixed-citizenship'  = 'I(post_2013 * mixed)',
                'Post-2013' = 'post_2013TRUE'),
  note = '{stars}. The "Regressive" sample includes only countries with a LGB policy score less than 0, and the "Progressive" sample includes only those with a score greater than 3. Group-clustered standard errors shown in parentheses. Source: American Community Survey 2008-2019. Authors\' calculations.',
       stars = c(`†` = 0.1, `*` = 0.05, `**` = 0.01, `***` = 0.001),
       statistics = c('Observations' = 'nobs')) %>%
  huxtable::set_width(1) %>%
  set_wrap(T) %>%
  set_all_padding(0) %>%
  huxtable::set_caption('Quasi-Poisson DDD regressions of counts of 
                        mixed-citizenship same-sex couples, stratifying by state-country-year-group average policy environment')
```


\newpage

# References
