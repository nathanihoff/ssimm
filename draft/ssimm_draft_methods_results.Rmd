---
output:
  bookdown::pdf_document2:
    toc: no
    number_sections: no
    pandoc_args: !expr rmdfiltr::add_wordcount_filter(rmdfiltr::add_citeproc_filter(args = NULL))
    latex_engine: xelatex
    keep_tex: yes
    #template: svm-latex-ms.tex
    
# output: 
#   pdf_document:
#     citation_package: natbib
#     keep_tex: true
#     fig_caption: true
#     latex_engine: pdflatex
#     template: svm-latex-ms.tex

header-includes:
  # - \usepackage{setspace}\doublespace
  # - \usepackage{endnotes}
  #- \let\footnote=\endnote
  #- \usepackage{endfloat}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \setlength{\headheight}{13.6pt}
  - \rhead{\textit{Hoffmann and Velasco}}
  
editor_options: 
  chunk_output_type: console

citeproc: no
fontfamily: mathpazo
fontsize: 11pt
geometry: margin=1in
indent: yes
link-citations: yes
linkcolor: blue


bibliography: zotero.bib  
#csl: american-sociological-association.csl

title: "Making Migration Sexy: Immigrants in Same-Sex Couples in the United States"

date: "`r format(Sys.time(), '%B %d, %Y')`"

# author:
# - name: Nathan I. Hoffmann
#   affiliation: Department of Sociology, University of California, Los Angeles
# - name: Kristopher Velasco
#   affiliation: Department of Sociology, University of Texas at Austin
 
author:
- Nathan I. Hoffmann, Department of Sociology, University of California, Los Angeles
- Kristopher Velasco, Department of Sociology, University of Texas at Austin
 
---

<!-- Turn off hyphenation -->
<!-- \usepackage[none]{hyphenat} -->


```{r setup, include=F}
knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = T, results = 'asis',
                      cache.lazy = F)

library(sjstats)
library(imputeTS)
library(mvtnorm)
library(ordinal)
library(lme4)
library(MASS)
library(countrycode)
library(knitr)
library(RColorBrewer)
library(haven)
library(cowplot)
library(srvyr)
library(lmtest)
library(sandwich)
library(here)
library(plm)
library(stargazer)
library(tidyverse)

# knitr::opts_chunk$set(error=TRUE) 

options("yaml.eval.expr" = TRUE)

# theme_set(theme_cowplot(font_family = 'Palatino') + 
theme_set(theme_classic(base_family = 'Palatino') + 
            theme(legend.title=element_blank(), 
                  panel.grid.major.y = element_line('grey80'),
                  legend.background = element_rect(fill = "transparent")))
ggplot <- function(...) ggplot2::ggplot(...) + scale_color_brewer(palette="Dark2") + 
  scale_fill_brewer(palette="Dark2")

options(scipen=1, digits=2)
knit_hooks$set(inline = function(x) {
  prettyNum(x, big.mark=",")
})
knitr::opts_chunk$set(error=TRUE) 


```

```{r load, include = F}
# top_countries <- read.csv(here('data', 'top_countries.csv')) %>%
#   pull(1)
# top_countries <- c("Mexico", "India",  "Philippines", "China",              "El Salvador", "Vietnam",
#                    "Cuba",               "Korea",              "Dominican Republic", "Guatemala" ) 
acs_wide <- read.csv(here('data', 'acs_wide.csv'))
# acs_oneimm <- read.csv(here('data', 'acs_oneimm.csv'))
acs_coupled_imms <- read.csv(here('data', 'acs_coupled_imms.csv'))
acs_prop_yrimmig <- read.csv(here('data', 'acs_prop_yrimmig.csv'))
acs_dyad <- read.csv(here('data', 'acs_dyad.csv'))
# acs_dyad_policy <- read.csv(here('data', 'acs_dyad_policy.csv'))



## Gravity Variables ####
dist_dat <- read_dta(here('data', 'dist_cepii.dta')) %>%
  filter(iso_d == 'USA') %>%
  select(-iso_d)

# Wage difference = USA - country of origin
penn_wages <- read.csv(here('data', 'penn_wages.csv')) %>%
  select(iso_o = countrycode, country, year, rgdpe) %>%
  mutate(rgdpe = rgdpe/1000)
usa_wages <- filter(penn_wages, iso_o == 'USA')
penn_wages$wage_dif <- NA
for(country_loop in unique(penn_wages$country)){
  for(year in penn_wages$year[penn_wages$country == country_loop]){
    penn_wages$wage_dif[penn_wages$year == year & penn_wages$country == country_loop] <-
      usa_wages$rgdpe[usa_wages$year == year] -
      penn_wages$rgdpe[penn_wages$year == year & penn_wages$country == country_loop]
    # penn_wages$usa_rgdpe[penn_wages$year == year & penn_wages$country == country_loop] <- 
    #   usa_wages$rgdpe[usa_wages$year == year]
  }
}
# filter(penn_wages, is.na(wage_dif) & !is.na(rgdpe)) %>%
#   View()
wb_unemp <- read_csv(here('data', 'world_bank_unemployment.csv')) %>%
  pivot_longer(!1:4, names_to = 'year', values_to = 'unemployment') %>%
  select(-`Indicator Name`, -`Indicator Code`) %>%
  rename(country = `Country Name`, iso_o = `Country Code`) %>%
  mutate(year = as.numeric(year))
usa_unemp <- filter(wb_unemp, iso_o == 'USA')
wb_unemp$unemp_dif <- NA
for(year in usa_unemp$year){
  for(country in unique(wb_unemp$country)){
    wb_unemp$unemp_dif[wb_unemp$year == year & wb_unemp$country == country] <-
      usa_unemp$unemployment[usa_unemp$year == year] -
      wb_unemp$unemployment[wb_unemp$year == year & wb_unemp$country == country]
  }
}

# vdem <- read.csv(here('data', 'V-Dem-CY-Core-v10.csv'))

polity5 <- read.csv(here('data', 'polity5.csv')) %>%
  mutate(iso_o1 = countrycode(scode, origin = 'cowc', destination = 'iso3c'),
         iso_o2 = countrycode(country, origin = 'country.name', destination = 'iso3c'),
         iso_o = ifelse(!is.na(iso_o1), iso_o1, iso_o2)) %>%
  select(iso_o, country, year, polity5 = polity2) %>%
  filter(!is.na(iso_o))

# Linearly interpolate polity5 missing values during regime change
polity5_list <- list()
for(country_loop in unique(polity5$iso_o)){
  polity5_loop <- with(filter(polity5, iso_o == country_loop), 
                                         zoo(polity5, min(year):2020)) %>%
    na_interpolation(option = "linear") #%>%
    #na_locf()
  
  polity5_list[[country_loop]] <- bind_cols(iso_o = country_loop,
                                        year = index(polity5_loop), 
                                        polity5 = as.data.frame(polity5_loop)[[1]])
}
polity5 <- bind_rows(polity5_list)

# Policy variables
lgbt_policy <- read.csv(here('data', 'LGBT Data w IPUMS Code.csv')) %>%
  select(Country, year, Code, origin_score = total_score) %>%
  mutate(iso_o = countrycode(Country, origin = 'country.name', destination = 'iso3c')) %>%
  left_join(select(penn_wages, -country)) %>%
  left_join(select(wb_unemp, -country)) %>%
  left_join(polity5) %>%
  left_join(dist_dat) %>%
  arrange(Country, year)

state_policy <- read.csv(here('data', 'state_policy.csv'))

state_policy[is.na(state_policy)] <- 0

state_policy <- state_policy %>%
  mutate(state_policy = -sodomy_illega + -marriage_ban + marriage_equality + civil_union + 
           employment_discrim_so + hate_crime_so + joint_adoption + -adoption_religious_freedom +
           conversion_therapy_ban + housing_discrim_so + state_ban_local_nondiscrimimation) %>%
  select(State, Year, state_policy, state_couple_laws)

acs_prop_yrimmig_policy <- acs_prop_yrimmig %>%
  left_join(lgbt_policy, by = c('yrimmig' = 'year', 'bpldid' = 'Code')) %>%
  filter(!is.na(origin_score)) %>%
  mutate(prop_same_sex = prop_same_sex*100,
         prop_dif_sex = prop_dif_sex*100,
         prop_same_std = (prop_same_sex - mean(prop_same_sex))/sd(prop_same_sex),
         prop_dif_std = (prop_dif_sex - mean(prop_dif_sex))/sd(prop_dif_sex),
         origin_std = (origin_score - mean(origin_score))/sd(origin_score),
         yr_fac = as.factor(yrimmig))


# State-level analysis
acs_dyad_policy <- acs_dyad %>%
  mutate(mean_year_immig = ifelse(mean_year_immig >= 1991, 
                                  round(mean_year_immig),
                                  1991)) %>%
  left_join(lgbt_policy, by = c('mean_year_immig' = 'year', 'bpldid' = 'Code')) %>%
  left_join(state_policy,by = c('mean_year_immig' = 'Year', 'state' = 'State')) %>%
  filter(!is.na(origin_score))

acs_dyad_policy$same_prop <- acs_dyad_policy$same_sex_stock/acs_dyad_policy$state_stock_year * 100
acs_dyad_policy$dif_prop <- acs_dyad_policy$opp_sex_stock/acs_dyad_policy$state_stock_year * 100

unemploy <- read.table(here('data', 'la.data.3.AllStatesS.txt'), header = T,
                       fill = T) %>% 
  filter(str_detect(series_id, '00003')) %>%
  as_tibble() %>%
  mutate(value = as.numeric(value),
         state_num = as.numeric(str_extract(series_id, "\\d\\d"))) %>%
  left_join(data.frame(state = c(state.name, 'District of Columbia', 'Puerto Rico'), 
           state_num =c(1,2,4:6, 8:10, 12, 13, 15:42, 44:51, 53:56, 11, 72))) %>%
  group_by(state, year) %>%
  summarize(state_unemploy = mean(value))

state_income <- read_csv(here('data', 'state_income.csv'), na = c('', '(NA)')) %>%
  pivot_longer(!1:2, names_to = 'year', values_to = 'state_income') %>%
  mutate(year = as.integer(year)) %>%
  rename(state = GeoName) %>% 
  select(-GeoFips)

acs_dyad_policy <- acs_dyad_policy %>%
  left_join(unemploy,  by = c('mean_year_immig' = 'year', 'state')) %>%
  left_join(state_income,  by = c('mean_year_immig' = 'year', 'state')) 


# Individual dataset
# Binning state policy into three categories
state_policy$state_policy_binned <- cut(state_policy$state_policy, breaks = c(-2,0,2, Inf), 
                                        labels = c("Repressive", "Neutral", "Progressive"))    

acs_couple_policy <- acs_coupled_imms  %>%
  mutate(yrimmig = ifelse(yrimmig >= 1991, 
                          round(yrimmig),
                          1991)) %>%
  left_join(lgbt_policy, by = c('yrimmig' = 'year', 'bpldid' = 'Code')) %>%
  left_join(state_policy,by = c('year' = 'Year', 'state' = 'State')) %>%
  left_join(unemploy) %>%
  left_join(state_income) %>%
  # adding (log) income variables
  mutate(pos_income = ifelse(inctot >= 0, inctot, 0),
         no_income = (inctot <= 0),
         log_income = log(pos_income+1))

# Smaller dataset for initial ordered logit analyses
set.seed(1859)
acs_couple_policy_small <- bind_rows(
  filter(acs_couple_policy, same_sex == T),
  sample_n(filter(acs_couple_policy, same_sex == F), 1e5)
)
```

```{r total-pop, fig.cap = 'Estimated totals of different- and same-sex couples containing one or two immigrants, 2008-2019, with 95% confidence intervals. Vertical line placed at the year 2013, when DOMA was overturned.'}
acs_wide_survey <- acs_wide %>% as_survey_design(ids = cluster, weights = hhwt)

total_df <- acs_wide_survey %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, imm_couple, same_sex) %>%
  summarize(n = survey_total(vartype = "ci")) %>%
  mutate(`Total population (thousands)` = n/1000,
         n_low = n_low/1000, n_upp = n_upp/1000,
         Year = year)

total_df %>%
  ggplot(aes(x = Year, y = `Total population (thousands)`, 
             color = imm_couple)) +
  geom_line() +
  geom_ribbon(aes(ymin = n_low, ymax = n_upp, fill = imm_couple, col = NULL), alpha = .2) +
  geom_vline(xintercept = 2013, linetype = 'dashed') +
  facet_wrap(~same_sex, scales = "free") +
  xlim(2007, 2019) +
  theme(legend.justification=c(1,0),
        legend.position=c(.15,.35))
```

# Understanding Influences on Migration Patterns
## Conventional Explanations
Dominant theories in migration fail to explain the rapid rise of immigrants in same-sex couples in the U.S. For at least two decades, migration scholars have accepted the conclusion of Massey et al. [-@massey_1999, p. 50]  that "causal processes relevant to international migration might operate on multiple levels simultaneously." Whereas economic theories underscore that promise of material gain is a frequent motivation to migrate [@hatton_2005a], structural explanations point to how the disruption of local economies by global forces spurs out-migration [@piore_1979; @wallerstein_1979]. Network theory explains for why migration streams often continue to flow in full force even after wage differentials decrease [@massey_1987], while work on the "migration industry" shows how brokers, recruiters, smugglers, and other "entrepreneurs" initiate and maintain migrant flows [@hernandez-leon_2013]. However, there is little reason to believe that the economic, structural, network, and institutional forces that shape migration of heterosexual immigrants differ from those that affect LGB immigrants. Although these theories do much to help understand broad patterns of migration, they falter in explaining increasing rates of LGB migration.  

The problem lies in two conspicuous absences in mainstream migration theory. The first is the lack of a large role for the state. Outside of violent contexts triggering refugee flows [@fitzgerald_2018], scholars of migration rarely focus on the political factors that both constrain and enable migration in sending and receiving countries. In recent years, some research has emerged that does consider political variables explicitly. For example, on the receiving country side, @fitzgerald_2014 show that safeguards for immigrant rights are important predictors of immigration, even in models that control for the usual "gravity model" economic, distance, and network variables. Other scholars have looked at sending-country policies relevant to emigration, such as dual citizenship laws [@leblang_2017] and autocratic restraints on exit [@miller_2018]. State policy relevant to particular subgroups or not obviously related to migration, however, has received little study.  

Second, the dominant migration literature fails to consider how identity might shape migration desires. Recent research in "lifestyle migration" [@benson_2012] begins to probe the non-economic hopes and aspirations that might encourage settling in a new country. And although gender is slowly being recognized as an integral consideration in studies of migration [@lutz_2010; @hondagneu-sotelo_2012], sexuality has received comparably little attention. Moving beyond the dominant migration theories synthesized by Massey et al. [-@massey_1999], this paper sheds light on how the intersection of state policy and sexuality shapes migration decisions. 

<!-- As immigrants in same-sex couples become more prevalent in the U.S., new theory is needed to explain -->

<!-- @garip_2012 argues that migration theories arise within historical contexts to explain the most prevalent type of migration at the time. -->

<!-- Micro- and macroeconomic theories underscore that promise of material gain is a frequent motivation to migrate [@hatton_2005a]. Yet migration decisions rarely occur at the individual level; proponents of the so-called New Economics of Labor Migration (NELM) argue that the migration decision is a family affair devised to mitigate risk and diversify income streams [@stark_1985]. Another influential explanation for why migration streams often continue to flow in full force even after wage differentials decrease lies in network theory; migrants share information and resources to lower the cost of migration and settling in the destination country [@massey_1987]. World Systems Theory    -->

<!-- These three theories have proven hugely influential in migration studies.  -->



# Data
We merge individual-level data on immigrants in the U.S. with state- and country-level variables from a variety of datasets. The individual data come from the 2008 to 2019 American Community Survey (ACS). Each year, the ACS surveys a 1% sample of the U.S. population about their education, occupation, income, family structure, immigration status, country of origin, location, and a variety of other individual and household attributes. Although the ACS began in 2000, variables on same-sex partners were not reliable until 2008 [@u.s.censusbureau_2013]. We limit the sample to individuals who immigrated at the age of 18 or older. The 11 years of survey data contain `r nrow(filter (acs_wide, same_sex == T))` same-sex couples that include at least one immigrant, for a total of `r nrow(filter(acs_coupled_imms, same_sex == T))` immigrants in same-sex couples. These immigrants are compared to `r nrow(filter (acs_wide, same_sex == F))` corresponding different-sex couples (containing `r nrow(filter(acs_coupled_imms, same_sex == F))` individual immigrants).  

Our explanatory variables of interest are the LGBT policy context in country of origin and U.S. state of residence. To create the U.S. state policy index, we compile data from the Movement Advancement Project, a leading LGBT organization in the U.S. that collects data on a number of relevant policies. Our state index encompasses both progressive policies (full marriage equality, state recognition of civil unions and domestic partnerships, ban on all employment and housing discrimination based on sexual orientation, hate crime protections based on sexual orientation, legal joint adoption by same-sex couples, and a ban on conversation therapy for minors) and regressive policies (criminalization of sodomy, state constitutional bans of marriage equality, religious freedom exemptions to discriminate against same-sex couples in adoption, and state-level bans on local non-discrimination ordinances encompassing sexual orientation). The state index ranges from `r min(acs_couple_policy$state_policy, na.rm = T)` to `r max(acs_couple_policy$state_policy, na.rm = T)`, and the mean score of country of origin for immigrant in our sample is `r mean(acs_couple_policy$state_policy, na.rm = T)`.

We measure the origin country policy environment using the LGBT Policy Index [@velasco_2018]. This index comprises 14 policies, many similar to those above, but including additional policies like the death penalty for homosexual acts, propaganda laws limiting free speech for LGBT communities, and equal age of consent between same-sex and opposite-sex couples. Both indices are created by summing the net total of progressive policies (scored $+1$) over regressive policies (scored $-1$). The state index ranges from `r min(acs_couple_policy$origin_score, na.rm = T)` to `r max(acs_couple_policy$origin_score, na.rm = T)`, and the mean score of country of origin for immigrant in our sample is `r mean(acs_couple_policy$origin_score, na.rm = T)`.  

Immigrants are assigned state index scores (destination policy environment) based on their self-reported state of residence during the year of the ACS survey. They are assigned country index scores (origin policy environment) based on their year of immigration. Since the country policy index begins at 1991, we anyone who immigrated before 1991 gets assigned the 1991 value.  

Our country- and state-level controls come from a variety of sources. Country-of-origin controls for bilateral distance, contiguous border, common official language, common ethnic language, and whether the country was a former colony of the U.S. come from CEPII's GeoDist dataset. Difference in wages (in 1000s of 2011 US dollars) come from the Penn World Table, and we rely on World Bank data for differences in unemployment rates. We use Polity5 measures of democratization of the country of origin. For state controls, we use per capita income by year from the Bureau of Economic Analysis and state-level annual unemployment rates from the Bureau of Labor Statistics.  

For our individual-level analysis we include individual controls from the ACS for reported sex, age, education (with categories for less than high school, high school, some college, and college), log positive income, and a binary indicator for income reported to be 0 or less. 


# Analytic Strategy
Our first goal is to isolate the effects of country-of-origin LGBT policy on the immigration of immigrants in same-sex couples. The ideal survey would follow potential immigrants over time and have information about sexual orientation, allowing us to estimate how the probability of migrating and choice of U.S. state of residence vary by sexual orientation. This ideal dataset does not exist, but we approximate it at the macro level. We take the number of immigrants in same-sex couples from a given country and a given year of immigration and divide by the total number of immigrants from that country-year. If sending-country LGBT policy has no effect on migration rates of LGB immigrants, then we would expect these proportions to be similar between countries. However, LGBT policy may covary with potential confounders such as country income, unemployment, democratization, and relationship to the U.S., so we control for these variables in our preferred model and estimate using ordinary least squares (OLS) regression. We also specify models with country fixed or random effects to account for unobserved heterogeneity within countries. All of these models also have country-clustered standard errors.  

Our next set of models focus on U.S. state LGBT policy. We reshape the data so that each observation is the proportion of immigrants in same-sex couples from country $x$ in state $y$ in year $z$. We regress this proportion on state and sending-country policy scores, controlling for the same country- and state-level attributes as in the previous set of models. We include state and country-of-origin fixed effects, and cluster errors at the state level.  

Our final set of models turns toward the individual: conditional on immigrating to the U.S., do immigrant in same-sex couples choose more LGBT-friendly states to reside in? This part of the analysis uses ordered logistic regression to predict the policy index of state of residence. Whereas the full U.S. state policy index ranges from `r min(acs_couple_policy$state_policy, na.rm = T)` to `r max(acs_couple_policy$state_policy, na.rm = T)`, we break up the index into three "bins": repressive (0 and less), neutral (1 or 2), and progressive (3 and greater). We control for individual attributes that could possibly confound our results and include survey-year fixed effects and country-clustered standard errors.


# Results
## Descriptive statistics
We first estimate total numbers of immigrants in same- and different-sex couples, applying survey weights to obtain population-level estimates from the ACS. Figure \ref{fig:total-pop} shows that whereas numbers of different-sex immigrant couples have steadily increased over the period of study, numbers of same-sex immigrant couples have increased much more rapidly, especially since the the 2013 Supreme Court decision overturning DOMA.  

Figure \ref{fig:policy-desc} charts the average country-of-origin and U.S.-state policy score for the immigrants in our sample over time, comparing means for immigrants in same- and different-sex couples. The left panel shows that country-of-origin index at time of migration is generally higher for immigrants in same-sex couples, especially in recent years. Immigrants in same-sex couples tend to come from more progressive countries. The left panel indicates less of a difference in U.S. state policies, although states where immigrants in same-sex couples live tend to score somewhat higher.  


```{r policy-desc, fig.cap = 'Mean country-of-origin and U.S. state policy index score for immigrants in same- and different-sex couples, 2008-2019, with 95% confidence intervals.'}
acs_ind_survey <- acs_couple_policy %>% as_survey_design(ids = cluster, weights = perwt)

origin_df <- acs_ind_survey %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(`Policy Score` = survey_mean(origin_score, vartype = "ci", na.rm = T)) %>%
  mutate(var = 'Country-of-Origin Index')

state_df <- acs_ind_survey %>%
  mutate(same_sex = ifelse(same_sex == T, 'Same-Sex', 'Different-Sex')) %>%
  group_by(year, same_sex) %>%
  summarize(`Policy Score` = survey_mean(state_policy, vartype = "ci", na.rm = T)) %>%
  mutate(var = 'U.S. State Index')

bind_rows(origin_df, state_df) %>%
  rename(Year = year) %>%
  ggplot(aes(x = Year, y = `Policy Score`, 
             color = same_sex)) +
  geom_line() +
  geom_ribbon(aes(ymin = `Policy Score_low`, ymax = `Policy Score_upp`, 
                  fill = same_sex, col = NULL), alpha = .2) +
  facet_wrap(~var, scales = "free") +
  theme(legend.justification=c(1,0),
        legend.position=c(.25,.65))
```

```{r state-ranks, eval = F}
same_tab <- acs_wide %>%
  filter(same_sex == T) %>%
  group_by(state) %>%
  count(wt = hhwt) %>%
  mutate(n = n/12) %>%
  arrange(desc(n)) %>%
  .[1:10,] %>%
  rownames_to_column() %>%
  select(`Same-sex rank` = rowname, State = state)

dif_tab <- acs_wide %>%
  filter(same_sex == F) %>%
  group_by(state) %>%
  count(wt = hhwt) %>%
  mutate(n = n/12) %>%
  arrange(desc(n)) %>%
  .[1:10,] %>%
  rownames_to_column() %>%
  select(`Different-sex rank` = rowname, `State ` = state)

bind_cols(dif_tab, ` ` = '', same_tab) %>%
  kable(booktabs = T,
        linesep = '',
        caption = 'States ranked by average estimated number of couples containing one or two immigrants')

```

```{r country-tab}
country_tab <- acs_coupled_imms %>%
  group_by(bpld, same_sex) %>%
  count(wt = perwt) %>%
  pivot_wider(names_from = 'same_sex', values_from = 'n') %>%
  mutate(prop_samesex = round(100*`TRUE` / `FALSE`, 2)) %>%
  arrange(desc(prop_samesex)) %>%
  .[1:10,] %>%
  mutate(prop_samesex = paste0(prop_samesex, ' %')) %>%
  rownames_to_column() %>%
  left_join(acs_couple_policy %>%
              group_by(bpld) %>%
              summarize(`Mean policy score` = 
                          weighted.mean(origin_score, na.rm = T, w = perwt))) %>%
  select(Rank = rowname, `Country of origin` = bpld, `Proportion same-sex` = prop_samesex,
         `Mean policy score`)

country_tab %>%
  kable(booktabs = T, 
        linesep = '',
        caption = 'Sending countries ranked bby proportion immigrant couples with same-sex partners')


country_vec <- country_tab$`Mean policy score`
names(country_vec) <- country_tab$`Country of origin`
```

```{r state-tab}
state_tab <- acs_wide %>%
  filter(state != 'District of Columbia') %>%
  group_by(state, same_sex) %>%
  count(wt = hhwt) %>%
  pivot_wider(names_from = 'same_sex', values_from = 'n') %>%
  mutate(prop_samesex = round(100*`TRUE` / `FALSE`, 2)) %>%
  arrange(desc(prop_samesex)) %>%
  .[1:10,] %>%
  mutate(prop_samesex = case_when(
    nchar(prop_samesex) == 4 ~ paste0(prop_samesex, ' %'),
    nchar(prop_samesex) == 3 ~ paste0(prop_samesex, '0 %'),
    nchar(prop_samesex) == 1 ~ paste0(prop_samesex, '.00 %'))) %>%
  left_join(acs_couple_policy %>%
              group_by(state) %>%
              summarize(`Mean policy score` = 
                          weighted.mean(state_policy, na.rm = T, w = perwt))) %>%
  rownames_to_column() %>%
  select(Rank = rowname, `State` = state, `Proportion same-sex` = prop_samesex,
         `Mean policy score`)

state_tab %>%
  kable(booktabs = T, 
        linesep = '',
        caption = 'States ranked by proportion immigrant couples with same-sex partners')

state_vec <- state_tab$`Mean policy score`
names(state_vec) <- state_tab$`State`
```

Table \ref{tab:country-tab} ranks the proportion of U.S. immigrants in same-sex couples based on country of origin, averaging over the 11 years of survey data. The top sending countries mostly hold more progressive policies, but Singapore, Malaysia, and Zimbabwe maintain generally repressive policies at the year of departure of the immigrants in our sample. Table \ref{tab:state-tab} similarly ranks U.S. state by the proportion of immigrants in same-sex couples, averaging over the period of interest. Although states with progressive policies make the top of the list, Mississippi is somewhat repressive, and Montana, Missouri, and Florida hold more neutral policies.


## Models
```{r country-props}
ag <- lm(prop_same_sex ~ origin_score, 
         data = acs_prop_yrimmig_policy) 

# ag_country <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
#                    wage_dif + unemp_dif + polity5, 
#          data = acs_prop_yrimmig_policy)

ag_country_orig <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + polity5 + origin_score, 
         data = acs_prop_yrimmig_policy)

ag_country_orig_fe <- lm(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + polity5 + origin_score + bpld, 
         data = acs_prop_yrimmig_policy)

ag_country_orig_re <- lmer(prop_same_sex ~ distw + contig + comlang_off + comlang_ethno + colony +
                   wage_dif + unemp_dif + polity5 + origin_score + (1|bpld), 
         data = acs_prop_yrimmig_policy) 

se_list <- list()
mod_list <- list(ag, ag_country_orig, ag_country_orig_fe, 
                 ag_country_orig_re)
for(mod_num in 1:3){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], cluster = c("bpld")))[, 2]
}
se_list[[4]] <- NULL


stargazer(mod_list,
          header = F, 
          model.names = F,
          keep = all.vars(formula(ag_country_orig)[-2]),
          add.lines = list(c('Country-clustered SEs?', rep('yes', 3), 'NA'),
                           c('Country FEs?', 'no', 'no', 'yes', 'no'),
                           c('Country REs?', 'no', 'no', 'no', 'yes')),
          se = se_list,
          keep.stat = c('n', 'rsq'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('+', '*', '**', '***'),
          notes = c("+p<0.1; *p<0.05; **p<0.01; ***p<0.001"), 
          notes.append = F,
          label = 'tab:country-props',
          title = 'Percent of immigrants in same-sex couples by year of immigration and country of origin.')
```

Our first set of models predicts the percent of immigrants in same-sex couples by country of origin and year of immigration (Table \ref{tab:country-props}). Model 1 regresses this proportion on only our variable of interest: LGBT policy score in country of origin. We see that countries with more progressive LGBT policy tend to send more immigrants to the U.S. who end up in same-sex couples. The average proportion of immigrants in same-sex couples is only `r `mean(acs_prop_yrimmig_policy$prop_same_sex, na.rm = T)` percent, so an increase of `r coef(ag)[[2]]` per point increase in LGBT policy score represents a substantive effect.  

The other models in Table \ref{tab:country-props} assess the robustness of this finding. Model 2 includes typical controls from gravity models of immigration [e.g. @fitzgerald_2014] along with a measure of democratization. The coefficient for country-of-origin score reduces slightly but remains highly significant. Notably, it is estimated to be three times the effect size of democratization score; the LGBT policy environment matters much more than the overall progressiveness of government policy. Models 3 and 4 include country-of-origin fixed and random effects, respectively. Although in the fixed effects model coefficient for origin score is reduced by half compared to Model 1, it remains significant at the $\alpha = 0.1$ level. The corresponding coefficient random effects model remains large and statistically significant.

```{r state-props}
state_prop <- lm(same_prop ~ origin_score + state_policy, data = acs_dyad_policy)

state_prop_fe <- lm(same_prop ~ state_unemploy + state_income + state + 
                        origin_score + state_policy, 
                       data = acs_dyad_policy)

state_prop_fe2 <- lm(same_prop ~ state_policy + origin_score + distw + contig + 
                          comlang_off + comlang_ethno + colony +
                          wage_dif + unemp_dif + polity5 + 
                           state_unemploy + state_income + Country + state, 
                       data = acs_dyad_policy)

# state_prop_2013 <- lm(same_prop ~ post_2013*(state_policy + origin_score), 
#                        data = mutate(acs_dyad_policy, post_2013 = (year > 2013)))
# state_prop_2013_2 <- lm(same_prop ~ post_2013*(state_policy + origin_score) + distw + contig + 
#                           comlang_off + comlang_ethno + colony +
#                           wage_dif + unemp_dif + polity5 + 
#                            state_unemploy + state_income + Country + state, 
#                        data = mutate(acs_dyad_policy, post_2013 = (year > 2013)))


se_list <- list()
mod_list <- list(state_prop, state_prop_fe, state_prop_fe2)

for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], cluster = c("state")))[, 2]
}


stargazer(mod_list,
          header = F, 
          keep = c(all.vars(formula(state_prop_fe2)[-2])[1:12], 'post_2013'),
          add.lines = list(c('State-clustered SEs?', rep('yes', 3)),
                           c('State FEs?', 'no', 'yes', 'yes'),
                           c('Country FEs?', 'no', 'no', 'yes')),
          se = se_list,
          keep.stat = c('n', 'rsq'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('+', '*', '**', '***'),
          notes = c("+p<0.1; *p<0.05; **p<0.01; ***p<0.001"), 
          notes.append = F,
          label = 'tab:state-props',
          title = 'Percent same-sex in by country of origin, U.S. state, and survey year.')

origin_effect <- sd(acs_couple_policy$origin_score, na.rm = T)*coef(state_prop)[['origin_score']]
state_effect <- sd(acs_couple_policy$state_policy, na.rm = T)*coef(state_prop)[['state_policy']]

```

Table \ref{tab:state-props} presents models of U.S. state-level proportion of immigrants in same-sex couples, from a given country of origin in a given survey year. Model 1 contains only two predictors: U.S. state policy score in the survey year and country-of-origin policy score at the mean year of immigration. Although more LGBT-friendly policies in both locations are associated with higher numbers of immigrants in same-sex couples, country-of-origin LGBT policy is a stronger predictor than U.S. state policy, even considering the somewhat different scale of these variables. A one-standard deviation increase origin score is associated with a `r origin_effect` percentage-point increase of immigrants in same-sex couples, whereas the corresponding state policy effect is `r state_effect` percentage points.  

Model 2 adds state-level controls and fixed effects. Immigrants in same-sex couples may be attracted to progressive states for their economic rather than political benefits. Indeed, in this model, the coefficient for state policy is reduced and rendered insignificant. Model 3 adds country-of-origin controls and fixed effects. The state policy effect remains imprecisely estimated, but country-of-origin policy has increased in strength. More progressive sending countries are more represented among same-sex couples, while U.S. state policy appears to have little influence on their settlement patterns, at least in the aggregate.

```{r ord}
ord_basic <- polr(state_policy_binned ~ same_sex + as.factor(year),
                data = acs_couple_policy_small, Hess = T)
ord_orig <- polr(state_policy_binned ~ same_sex*origin_score + as.factor(year),
                data = acs_couple_policy_small, Hess = T)
ord_interact <- polr(state_policy_binned ~ same_sex*(origin_score + sex + age + educ + 
                   nchild + log_income + no_income + yrimmig) + as.factor(year),
                data = acs_couple_policy_small, Hess = T)

se_list <- list()
mod_list <- list(ord_basic, ord_orig, ord_interact)
for(mod_num in 1:length(mod_list)){
  se_list[[mod_num]] <- coef(summary(mod_list[[mod_num]], cluster = c("bpld")))[, 2]
}

stargazer(mod_list,
          header = F, 
          add.lines = list(c('Country-clustered SEs?', rep('yes', 3)),
                           c('Survey year FEs?', rep('yes', 3))),
          se = se_list,
          omit = c('Constant', 'year'),
          keep.stat = c('n', 'rsq'),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          star.char = c('+', '*', '**', '***'),
          notes = c("+p<0.1; *p<0.05; **p<0.01; ***p<0.001"), 
          notes.append = F,
          no.space = T,
          label = 'tab:ord',
          title = 'Individual ordered logit analysis of three-category state policy score')

newdat <- data.frame(same_sex = rep(c(F, T), 12), year = rep(2008:2019, each = 2))
ord_probs <- cbind(newdat,
      predict(ord_basic, 
        newdat,
        type = 'probs')) %>%
  group_by(same_sex) %>%
  summarize(Repressive = mean(Repressive),
            Neutral = mean(Neutral),
            Progressive = mean(Progressive)) 

#table(acs_couple_policy$state_policy_binned) 

```

Our final set of models turn to the individual. Conditional on migrating to the U.S., do immigrants in same-sex couples choose to live in more progressive states than their heterosexual counterparts? Table \ref{tab:ord} presents ordered logit models predicting whether an individual partnered immigrant lives in a U.S. state with repressive, neutral, or progressive LGBT policies, pooling data across survey years. Model 1 includes only one regressor: an indicator for whether the immigrant is in a same-sex couple. The positive coefficient indicates that immigrants in same-sex couples indeed tend to live in states with more LGBT-friendly policies. The predicted probability for an immigrant in a different-sex couple to live in a state with progressive LGBT policies is `r ord_probs[[1, 'Progressive']]`, whereas the corresponding probability for those in same-sex couples is `r ord_probs[[2, 'Progressive']]`. At the repressive end of the policy spectrum, the predicted probabilities are `r ord_probs[[1, 'Repressive']]` and `r ord_probs[[2, 'Repressive']]` for different- and same-sex couples, respectively.  

How does country-of-origin context mediate this results? Model 2 adds sending-country LGBT policy score at the time of immigration to the regression, interacting it with the same-sex indicator. The coefficient for the same-sex indicator remains positive and significant, but we see opposite effects of the origin-score coefficient for immigrants in different- and same-sex couples. For different-sex couples, hailing from a more progressive country is associated with living in a more repressive U.S. state. For same-sex couples, the result is in the opposite direction: those from progressive countries tend to live in more progressive U.S. states.  

Model 3 controls for possible individual confounders, interacting them with the same-sex indicator. If immigrants in same-sex couples also tend to have more education, higher income, different family structures, or less years of age, they may be choosing more progressive states due to other policies or economic conditions. As shown in Table \ref{tab:ord}, the effects from Model 2 remain strong and in the same directions.  

```{r sim, fig.cap = 'Predicted probabilities of U.S. state LGBT policy progressiveness for individual immigrants in different- and same-sex couples, based on policy score of sending country, with 95% confidence intervals.'}
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

acs.means <- acs_couple_policy %>% 
  summarize(across(c(age, origin_score, yrimmig, nchild, log_income), mean, na.rm = T))
acs.modes <- acs_couple_policy %>% 
  summarize(across(c(educ, no_income, sex), Mode))

#Make a dataframe that's the mode of the factor variables vs. mean - one row data frame
#Two dataframes, one for same-sex and one for not. And then make two plots.
plot.dat <- bind_rows(rep(list(bind_cols(acs.means, acs.modes)),14)) %>%
  mutate(origin_score = -3:10, year = 2014)

plot.dat.same <- plot.dat %>%
  mutate(same_sex = T)
plot.dat.dif <- plot.dat %>%
  mutate(same_sex = F)

# Confidence intervals
set.seed(1858)
sims <- 500
sim_mod <- list(sims)
pseudeo_mod <- ord_interact
k <- length(coef(ord_interact))
theta_mat <- rmvnorm(sims, mean=c(coef(ord_interact), ord_interact$zeta),
                              sigma=vcovCL(ord_interact, cluster = ~ bpld))

for (i in 1:sims) {
  theta <- as.numeric(theta_mat[i,])
  pseudeo_mod$coefficients <- theta[1:k]
  pseudeo_mod$zeta <- theta[(k+1):length(theta)]
  sim_mod[[i]] <- as.data.frame(cbind(i,-3:10, predict(pseudeo_mod, 
                                   newdata=plot.dat.same, type="probs")))
  names(sim_mod[[i]]) <- c("iter","origin_score", names(sim_mod[[i]])[3:5]) 
}
sim_mod_same <- bind_rows(sim_mod) %>%
  pivot_longer(3:5, names_to = 'state_policy_binned', values_to = 'phat') %>%
  #gather(state_policy_binned, phat, -iter, -origin_score) %>%
  group_by(origin_score, state_policy_binned) %>%
  dplyr::summarize(phat.se = sd(phat),
                   phat.mean = mean(phat),
                   phat.lo = phat.mean - 1.96*phat.se,
                   phat.hi = phat.mean + 1.96*phat.se) %>%
  mutate(same_sex = 'Same-Sex')


sims <- 250
sim_mod <- list(sims)
pseudeo_mod <- ord_interact
k <- length(coef(ord_interact))
theta_mat <- rmvnorm(sims, mean=c(coef(ord_interact), ord_interact$zeta),
                              sigma=vcovCL(ord_interact, cluster = ~ bpld))

for (i in 1:sims) {
  theta <- as.numeric(theta_mat[i,])
  pseudeo_mod$coefficients <- theta[1:k]
  pseudeo_mod$zeta <- theta[(k+1):length(theta)]
  sim_mod[[i]] <- as.data.frame(cbind(i,-3:10, predict(pseudeo_mod, 
                                   newdata=plot.dat.dif, type="probs")))
  names(sim_mod[[i]]) <- c("iter","origin_score", names(sim_mod[[i]])[3:5]) 
}
sim_mod_dif<- bind_rows(sim_mod) %>%
  pivot_longer(3:5, names_to = 'state_policy_binned', values_to = 'phat') %>%
  #gather(state_policy_binned, phat, -iter, -origin_score) %>%
  group_by(origin_score, state_policy_binned) %>%
  dplyr::summarize(phat.se = sd(phat),
                   phat.mean = mean(phat),
                   phat.lo = phat.mean - 1.96*phat.se,
                   phat.hi = phat.mean + 1.96*phat.se) %>%
  mutate(same_sex = 'Different-Sex')

sim_df <- bind_rows(sim_mod_same, sim_mod_dif)
sim_df %>%
  ggplot(aes(x=origin_score, y=phat.mean, col=state_policy_binned)) +
  geom_line() + 
  geom_ribbon(aes(ymin=phat.lo, ymax=phat.hi, 
                  fill = state_policy_binned, col = NULL), alpha = .2) +
  facet_wrap(~same_sex) +
  xlab('LGBT policy score for country of origin') +
  ylab('Predicted probability of U.S. state residence') +
  theme(legend.justification=c(1,0),
        legend.position=c(.95,.38))

same_pred <- filter(sim_df, same_sex == 'Same-Sex', origin_score == 10, 
       state_policy_binned == 'Progressive') %>% 
  pull(phat.mean)

dif_pred <- filter(sim_df, same_sex == 'Different-Sex', origin_score == 10, 
       state_policy_binned == 'Progressive') %>% 
  pull(phat.mean)

same_pred2 <- filter(sim_df, same_sex == 'Same-Sex', origin_score == 10, 
       state_policy_binned == 'Repressive') %>% 
  pull(phat.mean)

dif_pred2 <- filter(sim_df, same_sex == 'Different-Sex', origin_score == 10, 
       state_policy_binned == 'Repressive') %>% 
  pull(phat.mean)
```

To help interpret these results, Figure \ref{fig:sim} contains predicted probabilities of residing in progressive, neutral, or repressive U.S. states. Each panel predicts these probabilities for a typical immigrant in the dataset, based on means for continuous and modes for categorical variables while varying sending-country policy score. The only difference between the two panels is the value for the same-sex indicator.  

The figure shows opposite trends for same- and different-sex couples. Overall, immigrants tend to live in more progressive states, but the moderating effect of origin score is quite different for the two groups. The panel for same-sex couples shows that these immigrants tend to live in U.S. states with similar LGBT policy contexts to those of their countries of origin. Immigrants in same-sex couples from more repressive countries are less likely to live in more progressive U.S. states, but as the origin-country score increases, so does the probability of living in a progressive state For immigrants in different-sex couples, on the other hand, increasingly progressive country-of-origin policies are associated with a *lower* probability of residing in a progressive U.S. state, accompanied by a *higher* probability of living in a repressive U.S. state. At the high end of the origin-score policy range, the difference in predicted probabilities is significant: typical immigrants in same-sex couples are `r 100*(same_pred - dif_pred)` percentage points more likely to live in progressive states and  `r 100*(dif_pred - same_pred)` percentage points less likely to live in repressive states.

# References
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\noindent


